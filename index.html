<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Stock</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.4/qz-tray.min.js"></script>

    
    

    <style>
        :root {
            --sidebar-width: 250px;
            --navbar-height: 60px;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1050;
            overflow-y: auto;
        }

        .sidebar.show {
            transform: translateX(0);
        }

        @media (min-width: 768px) {
            .sidebar {
                position: static;
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-brand {
            font-size: 1.25rem;
            font-weight: bold;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
        }

        .sidebar-brand:hover {
            color: white;
        }

        .sidebar-brand i {
            margin-right: 0.5rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            color: white;
            background-color: rgba(255,255,255,0.1);
            border-left-color: white;
        }

        .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.2);
            border-left-color: #ffc107;
        }

        .nav-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            margin-left: 0;
        }

        @media (min-width: 768px) {
            .main-content {
                margin-left: var(--sidebar-width);
            }
        }

        .top-navbar {
            height: var(--navbar-height);
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .content-area {
            padding: 2rem;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .btn-actions {
            display: flex;
            gap: 5px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border: 2px dashed #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            display: none;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-preview.show {
            display: block;
        }

        .stock-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .stock-indicator.high { background-color: #28a745; }
        .stock-indicator.medium { background-color: #ffc107; }
        .stock-indicator.low { background-color: #dc3545; }
        .stock-indicator.empty { background-color: #6c757d; }

        .alert-custom {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }

        /* Agregar estos estilos CSS para los indicadores de stock */

/* Indicadores de stock */
.stock-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
}

.stock-indicator.empty {
    background-color: #dc3545; /* Rojo - Sin stock */
}

.stock-indicator.low {
    background-color: #ffc107; /* Amarillo - Stock bajo */
}

.stock-indicator.medium {
    background-color: #17a2b8; /* Azul - Stock medio */
}

.stock-indicator.high {
    background-color: #28a745; /* Verde - Stock bueno */
}

/* Efectos hover para los botones de acciones */
.btn-actions .btn {
    transition: all 0.2s ease;
}

.btn-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Estilos para filas inactivas */
.table-secondary.opacity-75 {
    opacity: 0.6;
}

.table-secondary.opacity-75 .text-primary {
    color: #6c757d !important;
}

/* Responsive para la tabla */
@media (max-width: 768px) {
    .btn-group .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .btn-group .dropdown-toggle::after {
        font-size: 0.6rem;
    }
}

/* Mejoras visuales para la tabla */
.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.img-thumbnail {
    border: 1px solid #dee2e6;
    transition: transform 0.2s ease;
}

.img-thumbnail:hover {
    transform: scale(1.1);
}

/* Estilo para campos monospace */
.font-monospace {
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.85rem;
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.7.7-1.4 1.4 1.4 1.4-.7.7L6 6.4l-1.4 1.4-.7-.7L5.3 6 3.9 4.6l.7-.7L6 5.3l1.4-1.4z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-valid,
.form-select.is-valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.69-.04L4.62 4l1.63 2.69.69.04-2.32-3.82z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Mejoras visuales para el formulario */
.modal-header {
    border-bottom: 2px solid #dee2e6;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.text-danger {
    color: #dc3545 !important;
}

.border-bottom {
    border-bottom: 1px solid #dee2e6 !important;
}

/* Estilo para los dividers de sección */
h6.border-bottom {
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.875rem;
    letter-spacing: 0.05em;
}

/* Mejoras para el checkbox */
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-check-label {
    font-weight: 500;
}

/* Estilos para el alert de información */
.alert-info {
    background-color: #e7f3ff;
    border-color: #b3d7ff;
    color: #055a8c;
    border-radius: 0.375rem;
}

/* Estilos específicos para el formulario de zonas */
.modal-zona .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.modal-zona .form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.modal-zona .form-check-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Mejoras para los iconos */
.form-label i {
    color: #6c757d;
}

.form-check-label i {
    color: #198754;
}

.alert-heading i {
    color: #0dcaf0;
}

/* Estilos para validación */
.form-control.is-valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.69-.04L4.62 4l1.63 2.69.69.04-2.32-3.82z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.7.7-1.4 1.4 1.4 1.4-.7.7L6 6.4l-1.4 1.4-.7-.7L5.3 6 3.9 4.6l.7-.7L6 5.3l1.4-1.4z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Estilos para el alert de información */
.alert-info {
    background-color: #e7f3ff;
    border-color: #b3d7ff;
    color: #055a8c;
    border-radius: 0.375rem;
}

.alert-info .alert-heading {
    color: #055a8c;
    font-weight: 600;
}

/* Animación suave para cambios de estado */
.form-control {
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, background-image 0.15s ease-in-out;
}

.form-check-input {
    transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

/* Mejoras para dispositivos móviles */
@media (max-width: 576px) {
    .modal-zona .modal-dialog {
        margin: 0.5rem;
    }
    
    .modal-zona .form-text {
        font-size: 0.8rem;
    }
    
    .modal-zona .alert {
        padding: 0.75rem;
    }
    
    .modal-zona .alert small {
        font-size: 0.8rem;
    }
}

/* Estados hover para mejor UX */
.btn:hover {
    transform: translateY(-1px);
    transition: transform 0.15s ease-in-out;
}

.form-control:hover:not(:focus) {
    border-color: #86b7fe;
}

/* Estilo especial para campos requeridos */
.form-label .text-danger {
    font-weight: bold;
}

/* Mejora del modal header */
.modal-header {
    border-bottom: 2px solid #dee2e6;
}

.modal-header .modal-title {
    font-weight: 600;
    display: flex;
    align-items: center;
}

/* Estilo para el texto de ayuda */
.form-text {
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-text i {
    color: #6c757d;
}

/* Stock específico */
.stock-card {
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stock-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.badge-stock {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
    font-weight: 500;
}

.deposito-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
}

.deposito-indicator.central { background-color: #007bff; }
.deposito-indicator.vendedor { background-color: #28a745; }
.deposito-indicator.cliente { background-color: #17a2b8; }

/* Estados de stock */
.stock-sin { background-color: #e74c3c; color: white; }
.stock-bajo { background-color: #f39c12; color: white; }
.stock-medio { background-color: #3498db; color: white; }
.stock-ok { background-color: #27ae60; color: white; }

/* Animaciones */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.pulse-animation {
    animation: pulse 2s infinite;
}

/* Responsive mejoras */
@media (max-width: 768px) {
    .stock-card .card-body h3 {
        font-size: 1.5rem;
    }
    
    #stockTabs .nav-link {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
    
    .table-responsive {
        border: none;
    }
}

/* Loading states */
.loading-overlay {
    position: relative;
}

.loading-overlay::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Filtros mejorados */
.filtros-avanzados {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

/* Badges personalizados */
.badge-tipo-deposito {
    font-size: 0.7rem;
    padding: 0.25em 0.5em;
}

.badge-tipo-deposito.central { background-color: #495057; }
.badge-tipo-deposito.vendedor { background-color: #28a745; }
.badge-tipo-deposito.cliente { background-color: #17a2b8; }

/* Tooltips y hints */
.hint-text {
    font-size: 0.75rem;
    color: #6c757d;
    font-style: italic;
}

.required-field::after {
    content: ' *';
    color: #dc3545;
}


.item-orden {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #dee2e6;
}

.progress {
    height: 8px !important;
}

.badge {
    font-size: 0.85em;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    background-color: #6972da;
}

.modal-xl {
    max-width: 95%;
}

@media (max-width: 768px) {
    .modal-xl {
        max-width: 100%;
        margin: 0;
    }
    
    .btn-group-sm {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
}


.spinner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(2px);
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.spinner-overlay.show {
    opacity: 1;
    visibility: visible;
}

.spinner-backdrop {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 10px;
    padding: 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.spinner-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.spinner-text {
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 500;
}

.loading-overlay {
    position: relative;
}

.loading-overlay::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
}

@media (max-width: 768px) {
    .spinner-content {
        padding: 1.5rem;
        margin: 1rem;
    }
}

 #tabla-proveedores tr:hover {
        background-color: #f8f9fa;
    }

    #tabla-proveedores .table-secondary {
        background-color: #e9ecef !important;
    }

    #tabla-proveedores .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    /* Responsive para pantallas pequeñas */
    @media (max-width: 768px) {
        #tabla-proveedores th,
        #tabla-proveedores td {
            font-size: 0.85rem;
            padding: 0.5rem 0.25rem;
        }
        
        #tabla-proveedores .btn-group-sm .btn {
            padding: 0.15rem 0.3rem;
            font-size: 0.75rem;
        }
    }

    /* Indicador de carga */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    /* Badges personalizados */
    .badge {
        font-size: 0.75em;
    }

    /* Truncar texto largo */
    .text-truncate {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
    }

      /* Estilos para la tabla de proveedores */
    #tabla-proveedores tr:hover {
        background-color: #f8f9fa;
    }

    #tabla-proveedores .table-secondary {
        background-color: #e9ecef !important;
    }

    #tabla-proveedores .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.875rem;
    }

    /* Responsive para pantallas pequeñas */
    @media (max-width: 768px) {
        #tabla-proveedores th,
        #tabla-proveedores td {
            font-size: 0.85rem;
            padding: 0.5rem 0.25rem;
        }
        
        #tabla-proveedores .btn-group-sm .btn {
            padding: 0.15rem 0.25rem;
            font-size: 0.75rem;
        }
    }

    /* Badges personalizados */
    .badge {
        font-size: 0.75em;
        font-weight: 500;
    }

    /* Truncar texto largo en tablas */
    .text-truncate {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
    }

    /* Cards de estadísticas */
    .card h4 {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .card small {
        color: #6c757d;
        font-size: 0.75rem;
    }

    /* Estilos específicos para el modal de ajuste */
#modalAjuste .modal-header {
    border-bottom: 3px solid #ffc107;
}

#modalAjuste .form-label {
    font-weight: 600;
    color: #495057;
}

#modalAjuste .form-label .text-danger {
    font-weight: 700;
}

#modalAjuste .form-control:focus,
#modalAjuste .form-select:focus {
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

#modalAjuste .btn-primary {
    background-color: #28a745;
    border-color: #28a745;
}

#modalAjuste .btn-primary:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

/* Estilos para los alerts de información */
#stock-actual-info .alert {
    margin-bottom: 1rem;
}

#preview-ajuste .alert {
    margin-bottom: 0;
}

/* Animaciones suaves */
#stock-actual-info,
#preview-ajuste {
    transition: all 0.3s ease;
}

/* Indicadores visuales para tipos de ajuste */
#ajuste_tipo option[value="INCREMENTO"] {
    color: #28a745;
}

#ajuste_tipo option[value="DECREMENTO"] {
    color: #dc3545;
}

#ajuste_tipo option[value="CORRECCION"] {
    color: #17a2b8;
}

/* Responsive para dispositivos móviles */
@media (max-width: 768px) {
    #modalAjuste .modal-dialog {
        margin: 0.5rem;
    }
    
    #modalAjuste .row .col-md-4,
    #modalAjuste .row .col-md-6 {
        margin-bottom: 1rem;
    }
    
    #modalAjuste .form-text {
        font-size: 0.8rem;
    }
}

/* Estados de validación mejorados */
#modalAjuste .was-validated .form-control:valid,
#modalAjuste .was-validated .form-select:valid {
    border-color: #28a745;
}

#modalAjuste .was-validated .form-control:invalid,
#modalAjuste .was-validated .form-select:invalid {
    border-color: #dc3545;
}

/* Loading state para el botón */
#modalAjuste .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

#modalAjuste .btn-primary .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Estilos específicos para el modal de transferencia */
#modalTransferencia .modal-header {
    border-bottom: 3px solid #28a745;
}

#modalTransferencia .form-label {
    font-weight: 600;
    color: #495057;
}

#modalTransferencia .form-label .text-danger {
    font-weight: 700;
}

#modalTransferencia .form-control:focus,
#modalTransferencia .form-select:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

#modalTransferencia .btn-primary {
    background-color: #28a745;
    border-color: #28a745;
}

#modalTransferencia .btn-primary:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

#modalTransferencia .btn-primary:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
}

/* Estilos para los alerts de información */
#stock-disponible-info .alert {
    margin-bottom: 1rem;
}

#preview-transferencia .alert {
    margin-bottom: 0;
}

/* Animaciones suaves */
#stock-disponible-info,
#preview-transferencia {
    transition: all 0.3s ease;
}

/* Indicadores visuales para tipos de depósito */
.form-select option[data-tipo="CENTRAL"] {
    background-color: #e3f2fd;
}

.form-select option[data-tipo="VENDEDOR"] {
    background-color: #e8f5e8;
}

.form-select option[data-tipo="CLIENTE"] {
    background-color: #fff3e0;
}

/* Responsive para dispositivos móviles */
@media (max-width: 768px) {
    #modalTransferencia .modal-dialog {
        margin: 0.5rem;
    }
    
    #modalTransferencia .row .col-md-4,
    #modalTransferencia .row .col-md-6,
    #modalTransferencia .row .col-md-12 {
        margin-bottom: 1rem;
    }
    
    #modalTransferencia .form-text {
        font-size: 0.8rem;
    }
    
    #modalTransferencia .alert ul {
        font-size: 0.875rem;
    }
}

/* Estados de validación mejorados */
#modalTransferencia .was-validated .form-control:valid,
#modalTransferencia .was-validated .form-select:valid {
    border-color: #28a745;
}

#modalTransferencia .was-validated .form-control:invalid,
#modalTransferencia .was-validated .form-select:invalid {
    border-color: #dc3545;
}

/* Loading state para el botón */
#modalTransferencia .btn-primary .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Estilos para preview de transferencia */
#preview-transferencia .alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

#preview-transferencia .alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

#preview-transferencia .alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

/* Estilos para stock disponible */
#stock-disponible-info .alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

#stock-disponible-info .alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

/* Iconos en labels */
#modalTransferencia .form-label i {
    color: #28a745;
}

/* Separadores visuales */
#modalTransferencia .row + .row {
    margin-top: 0.5rem;
}

/* Mejoras para el textarea */
#trans_observaciones {
    resize: vertical;
    min-height: 80px;
}

/* Contador de caracteres para textarea */
.char-counter {
    text-align: right;
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

/* Estados especiales para campos */
.field-success {
    border-color: #28a745 !important;
    background-color: #f8fff9;
}

.field-warning {
    border-color: #ffc107 !important;
    background-color: #fffdf5;
}

.field-error {
    border-color: #dc3545 !important;
    background-color: #fff5f5;
}

/* Estilos específicos para el modal de categorías */
.modal-categoria .form-control {
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.modal-categoria .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.modal-categoria .form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.modal-categoria .alert-info {
    background-color: #e7f3ff;
    border-color: #b3d7ff;
    color: #055a8c;
}

/* Indicadores visuales para categorías */
.categoria-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.categoria-badge i {
    color: #6c757d;
}

/* Mejorar la tabla de categorías */
#tabla-categorias .btn-group {
    gap: 2px;
}

#tabla-categorias .btn-group .btn {
    border-radius: 0.25rem;
}

/* Animaciones suaves */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.075);
}

/* Estados de categorías */
.badge.bg-success {
    background-color: #28a745 !important;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
}

.badge.bg-info {
    background-color: #17a2b8 !important;
}

/* Responsive para categorías */
@media (max-width: 768px) {
    .modal-categoria .modal-dialog {
        margin: 0.5rem;
    }
    
    #tabla-categorias .btn-group {
        flex-direction: column;
        gap: 1px;
    }
    
    #tabla-categorias .btn-group .btn {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
}

.etiqueta-preview-rollo {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 4px;
}

.etiqueta-preview-rollo:hover {
    transform: scale(1.02);
    transition: transform 0.2s ease;
}

#info-rollo-columnas {
    border-left: 4px solid #0d6efd;
}

#info-rollo-columnas ul {
    padding-left: 1.2rem;
}

#info-rollo-columnas li {
    margin-bottom: 0.3rem;
}

/* Estilos específicos para el modal mejorado */
        .productos-compra-mejorado {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
        }
        
        .producto-compra-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        
        .producto-compra-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .producto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
        }
        
        .producto-numero {
            background: #6f42c1;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: bold;
        }
        
        .producto-resumen {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .producto-acciones {
            display: flex;
            gap: 0.25rem;
        }
        
        .btn-accion {
            padding: 0.125rem 0.25rem;
            font-size: 0.75rem;
        }
        
        .producto-form-expandible {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
        }
        
        .navegacion-productos {
            background: #f8f9fa;
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .contador-productos {
            font-weight: bold;
            color: #495057;
        }
        
        .scroll-controls {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 0.5rem;
            border-top: 1px solid #dee2e6;
            text-align: center;
        }
        
        .producto-expandido {
            border-left: 4px solid #28a745;
        }
        
        .producto-con-errores {
            border-left: 4px solid #dc3545;
            background-color: #fff5f5;
        }
        
        .error-list {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #fff5f5;
            border-radius: 0.25rem;
        }
        
        .producto-buscador {
            position: sticky;
            top: 50px;
            background: white;
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
            z-index: 9;
        }
        
        .producto-collapsed .producto-form-expandible {
            display: none;
        }
        
        .producto-collapsed .fa-chevron-up:before {
            content: "\f078"; /* chevron-down */
        }

        .producto-fila {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            padding: 1rem;
            transition: box-shadow 0.2s;
        }
        
        .producto-fila:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .producto-numero {
            background: #0d6efd;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
        }
        
        .btn-eliminar {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .total-compra {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .input-precio {
            text-align: right;
        }
        
        .iva-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .mercaderia-info {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* Estilos para el autocomplete - agregar a tu CSS existente */
    .autocomplete-container {
        position: relative;
        width: 100%;
    }

    .autocomplete-input {
        width: 100%;
        padding: 8px 12px 8px 40px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .autocomplete-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .autocomplete-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        z-index: 2;
    }

    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .autocomplete-results.show { display: block; }
    .autocomplete-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.2s ease;
    }
    .autocomplete-item:hover, .autocomplete-item.selected { background-color: #f8f9fa; }
    .autocomplete-item-code { font-weight: 600; color: #007bff; font-size: 13px; }
    .autocomplete-item-description { color: #495057; font-size: 14px; margin-top: 2px; }
    .autocomplete-item-price { color: #28a745; font-size: 12px; float: right; font-weight: 500; }
    .autocomplete-clear {
        position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        background: none; border: none; color: #6c757d; cursor: pointer; display: none; z-index: 2;
    }
    .autocomplete-clear.show { display: block; }
    </style>
   
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-brand">
                    <i class="fas fa-boxes"></i>
                    Sistema Stock
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="mercaderias">
                        <i class="fas fa-box"></i>Mercaderías
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="categorias">
                        <i class="fas fa-tags"></i>Categorías
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="depositos">
                        <i class="fas fa-warehouse"></i>Depósitos
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="stock">
                        <i class="fas fa-cubes"></i>Control de Stock
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="transferencias">
                        <i class="fas fa-truck"></i>Transferencias
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="movimientos">
                        <i class="fas fa-exchange-alt"></i>Movimientos
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="clientes">
                        <i class="fas fa-users"></i>Clientes
                    </a>
                </div>

                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="zonas">
                        <i class="fas fa-user-tie"></i>Zonas
                    </a>
                </div>
                
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="vendedores">
                        <i class="fas fa-user-tie"></i>Vendedores
                    </a>
                </div>
                <div class="nav-item">
    <a href="#" class="nav-link" data-page="proveedores">
        <i class="fas fa-truck"></i>
        <span>Proveedores</span>
    </a>
</div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="etiquetas">
                        <i class="fas fa-tags"></i>Etiquetas
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-page="reportes">
                        <i class="fas fa-chart-line"></i>Reportes
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navbar -->
            <div class="top-navbar">
                <div>
                    <button class="btn btn-outline-secondary d-md-none" id="toggleSidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <span class="h5 mb-0 ms-2" id="pageTitle">Dashboard</span>
                </div>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>Usuario
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page-content active">
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stats-card">
                                <div class="stats-value text-primary" id="totalMercaderias">-</div>
                                <div class="stats-label">Mercaderías Activas</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stats-card">
                                <div class="stats-value text-success" id="totalDepositos">-</div>
                                <div class="stats-label">Depósitos Activos</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stats-card">
                                <div class="stats-value text-warning" id="stockBajo">-</div>
                                <div class="stats-label">Productos Stock Bajo</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stats-card">
                                <div class="stats-value text-info" id="transferenciasPendientes">-</div>
                                <div class="stats-label">Transferencias Pendientes</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-8 mb-4">
                            <div class="chart-container">
                                <h5>Movimientos Recientes</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Tipo</th>
                                                <th>Mercadería</th>
                                                <th>Cantidad</th>
                                                <th>Depósito</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ultimosMovimientos-dashboard">
                                            <tr>
                                                <td colspan="5" class="text-center">Cargando...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h5>Alertas del Sistema</h5>
                                <div id="alertasContainer">
                                    <div class="alert alert-warning" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="alertasCount">0</span> productos con stock bajo
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mercaderías Page -->
                <div id="mercaderias" class="page-content">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2><i class="fas fa-boxes me-2"></i>Gestión de Mercaderías</h2>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" onclick="abrirModalMercaderia()">
                                        <i class="fas fa-plus me-2"></i>Nueva Mercadería
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="generarEtiquetasLote()">
                                        <i class="fas fa-tags me-2"></i>Etiquetas en Lote
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Filtros de Búsqueda
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Filtro de Búsqueda -->
                    <div class="col-md-4">
                        <label class="form-label">Buscar</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="filtro-busqueda" 
                                   placeholder="SKU, descripción, código...">
                        </div>
                    </div>

                    <!-- Filtro de Categoría -->
                    <div class="col-md-3">
                        <label class="form-label">Categoría</label>
                        <select class="form-select" id="filtro-categoria">
                            <option value="">Todas las categorías</option>
                            <!-- Se llena dinámicamente -->
                        </select>
                    </div>

                    <!-- Filtro de Stock -->
                    <div class="col-md-2">
                        <label class="form-label">Stock</label>
                        <select class="form-select" id="filtro-stock">
                            <option value="">Todos</option>
                            <option value="con_stock">Con Stock</option>
                            <option value="sin_stock">Sin Stock</option>
                            <option value="stock_bajo">Stock Bajo</option>
                        </select>
                    </div>

                    <!-- Filtro de Estado -->
                    <div class="col-md-2">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="filtro-activo">
                            <option value="">Todos</option>
                            <option value="1">Activos</option>
                            <option value="0">Inactivos</option>
                        </select>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex flex-column gap-2">
                            <button type="button" 
                                    class="btn btn-outline-secondary btn-sm" 
                                    onclick="limpiarFiltrosMercaderias()"
                                    title="Limpiar filtros">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contador de Resultados -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="contador-mercaderias">
                                Cargando mercaderías...
                            </small>
                            <div class="btn-group btn-group-sm">
                                <button type="button" 
                                        class="btn btn-outline-primary" 
                                        onclick="imprimirEtiquetasSeleccionadas()"
                                        title="Imprimir etiquetas seleccionadas">
                                    <i class="fas fa-print me-1"></i>Imprimir Seleccionadas
                                </button>
                                <button type="button" 
                                        class="btn btn-outline-info" 
                                        onclick="loadMercaderias()"
                                        title="Recargar mercaderías">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                </button>
                                <button type="button" 
                                        class="btn btn-outline-secondary" 
                                        onclick="recargarCategorias()"
                                        title="Recargar categorías">
                                    <i class="fas fa-tags me-1"></i>Recargar Categorías
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                    <!-- Tabla de Mercaderías -->
                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Imagen</th>
                                            <th>SKU</th>
                                            <th>Descripción</th>
                                            <th>Code 128</th>
                                            <th>Precio Venta</th>
                                            <th>Stock</th>
                                            <th>Categoría</th>
                                            <th>Proveedores</th> 
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-mercaderias">
                                        <tr>
                                            <td colspan="9" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                

<div id="categorias" class="page-content">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-tags me-2"></i>Gestión de Categorías</h2>
                <button type="button" class="btn btn-primary" onclick="abrirModalCategoria()">
                    <i class="fas fa-plus me-2"></i>Nueva Categoría
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="filtro-categoria-busqueda" placeholder="Buscar categoría...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filtro-categoria-activo">
                <option value="">Todos los estados</option>
                <option value="1">Solo activas</option>
                <option value="0">Solo inactivas</option>
            </select>
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-outline-primary" onclick="aplicarFiltrosCategorias()">
                <i class="fas fa-filter me-2"></i>Filtrar
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltrosCategorias()">
                <i class="fas fa-eraser me-2"></i>Limpiar
            </button>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-info" onclick="cargarCategorias()">
                <i class="fas fa-sync-alt me-2"></i>Actualizar
            </button>
        </div>
    </div>

    <!-- Tabla de categorías -->
    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Categoría</th>
                            <th>Mercaderías</th>
                            <th>Estado</th>
                            <th>Fecha Creación</th>
                            <th>Última Modificación</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-categorias">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Estadísticas de filtros -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted" id="info-filtros-categorias">
                    Mostrando todas las categorías
                </small>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="exportarCategorias()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="actualizarCategorias()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
                <!-- 🏗️ SECCIÓN HTML: Página de Depósitos (Agregar en index.html) -->
<div id="depositos" class="page-content">
    <!-- Header con estadísticas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><i class="fas fa-warehouse me-2"></i>Gestión de Depósitos</h2>
                <button type="button" class="btn btn-primary" onclick="abrirModalDeposito()">
                    <i class="fas fa-plus me-2"></i>Nuevo Depósito
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas de depósitos -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3 class="card-title" id="stat-depositos-total">0</h3>
                    <p class="card-text">Total Depósitos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="card-title" id="stat-depositos-activos">0</h3>
                    <p class="card-text">Activos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 class="card-title" id="stat-items-stock">0</h3>
                    <p class="card-text">Items en Stock</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h3 class="card-title" id="stat-valor-total">$0</h3>
                    <p class="card-text">Valor Total</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-3">
        <div class="col-md-4">
            <select class="form-select" id="filtro-tipo-deposito" onchange="filtrarDepositos()">
                <option value="">Todos los tipos</option>
                <option value="CENTRAL">Central</option>
                <option value="VENDEDOR">Vendedores</option>
                <option value="CLIENTE">Clientes</option>
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="filtro-estado-deposito" onchange="filtrarDepositos()">
                <option value="">Todos los estados</option>
                <option value="1">Activos</option>
                <option value="0">Inactivos</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="text" class="form-control" id="buscar-deposito" 
                   placeholder="Buscar por nombre..." onkeyup="filtrarDepositos()">
        </div>
    </div>

    <!-- Tabla de depósitos -->
    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Entidad</th>
                            <th>Dirección</th>
                            <th>Items en Stock</th>
                            <th>Valor Stock</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-depositos">
                        <tr>
                            <td colspan="8" class="text-center">Cargando depósitos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



                <!-- Stock Page -->
                <div id="stock" class="page-content">
    
    <!-- Header y estadísticas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><i class="fas fa-cubes me-2"></i>Control de Stock</h2>
                <div class="btn-group">
                    <button type="button" class="btn btn-success" onclick="abrirCompraDirectaSimple()">
                        <i class="fas fa-plus me-2"></i>Registrar Compra
                    </button>
                    <button type="button" class="btn btn-info" onclick="abrirModalTransferencia()">
                        <i class="fas fa-exchange-alt me-2"></i>Transferir Stock
                    </button>
                    <button type="button" class="btn btn-warning" onclick="abrirModalAjuste()">
                        <i class="fas fa-tools me-2"></i>Ajustar Stock
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white stock-card">
                <div class="card-body text-center">
                    <h3 class="card-title" id="stat-productos-total">0</h3>
                    <p class="card-text">Total Productos</p>
                    <small class="text-white-50" id="stat-productos-activos">0 activos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white stock-card">
                <div class="card-body text-center">
                    <h3 class="card-title" id="stat-stock-bajo">0</h3>
                    <p class="card-text">Stock Bajo</p>
                    <small class="text-white-50" id="stat-productos-criticos">0 críticos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white stock-card">
                <div class="card-body text-center">
                    <h3 class="card-title" id="stat-sin-stock">0</h3>
                    <p class="card-text">Sin Stock</p>
                    <small class="text-white-50" id="stat-productos-sin-movimiento">0 sin movimiento</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white stock-card">
                <div class="card-body text-center">
                    <h3 class="card-title" id="stat-valor-total">$0</h3>
                    <p class="card-text">Valor Total</p>
                    <small class="text-white-50" id="stat-valor-utilidad">$0 utilidad pot.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Pestañas de navegación -->
    <ul class="nav nav-tabs mb-3" id="stockTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="vista-general-tab" data-bs-toggle="tab" 
                    data-bs-target="#vista-general" type="button" role="tab">
                <i class="fas fa-table me-2"></i>Vista General
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="por-deposito-tab" data-bs-toggle="tab" 
                    data-bs-target="#por-deposito" type="button" role="tab">
                <i class="fas fa-warehouse me-2"></i>Por Depósito
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="alertas-tab" data-bs-toggle="tab" 
                    data-bs-target="#alertas" type="button" role="tab">
                <i class="fas fa-exclamation-triangle me-2"></i>Alertas
                <span class="badge bg-danger ms-1" id="badge-alertas-count" style="display: none;">0</span>
            </button>
        </li>
        
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="movimientos-tab" data-bs-toggle="tab" 
                    data-bs-target="#movimientos" type="button" role="tab">
                <i class="fas fa-history me-2"></i>Movimientos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reportes-tab" data-bs-toggle="tab" 
                    data-bs-target="#reportes" type="button" role="tab">
                <i class="fas fa-chart-line me-2"></i>Reportes
            </button>
        </li>
    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content" id="stockTabContent">
        
        <!-- Vista General -->
        <div class="tab-pane fade show active" id="vista-general" role="tabpanel">
            <!-- Controles superiores -->
            <div class="row mb-3">
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filtro-categoria-stock" onchange="filtrarStock()">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filtro-estado-stock" onchange="filtrarStock()">
                        <option value="">Todos los estados</option>
                        <option value="SIN_STOCK">Sin Stock</option>
                        <option value="STOCK_BAJO">Stock Bajo</option>
                        <option value="STOCK_MEDIO">Stock Medio</option>
                        <option value="STOCK_OK">Stock OK</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="buscar-stock" 
                           placeholder="Buscar por SKU o descripción..." onkeyup="debounceFilter()">
                </div>
                <div class="col-md-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="incluir-sin-stock" checked onchange="filtrarStock()">
                        <label class="form-check-label" for="incluir-sin-stock">
                            <small>Incluir sin stock</small>
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="btn-group btn-group-sm w-100">
                        <button class="btn btn-outline-secondary" onclick="limpiarFiltrosStock()">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                        <button class="btn btn-outline-info" onclick="exportarStock()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <button class="btn btn-outline-success" onclick="refrescarStock()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Información de filtros -->
            <div class="row mb-2">
                <div class="col-12">
                    <small class="text-muted" id="info-filtros-stock">Mostrando todos los productos</small>
                    <span class="badge bg-light text-dark ms-2" id="contador-productos-stock">0 productos</span>
                </div>
            </div>

            <!-- Tabla de stock general -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 100px;">SKU</th>
                            <th>Descripción</th>
                            <th style="width: 120px;">Categoría</th>
                            <th style="width: 80px;" class="text-center">Central</th>
                            <th style="width: 80px;" class="text-center">Vendedores</th>
                            <th style="width: 80px;" class="text-center">Clientes</th>
                            <th style="width: 80px;" class="text-center">Total</th>
                            <th style="width: 80px;" class="text-center">Stock Mín.</th>
                            <th style="width: 100px;" class="text-center">Estado</th>
                            <th style="width: 120px;" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-stock-general">
                        <tr>
                            <td colspan="10" class="text-center">
                                <div class="d-flex justify-content-center align-items-center py-3">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Cargando stock...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <nav aria-label="Paginación de stock">
                        <ul class="pagination pagination-sm" id="paginacion-stock">
                            <!-- Se genera dinámicamente -->
                        </ul>
                    </nav>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center justify-content-end">
                        <small class="text-muted me-2">Mostrar:</small>
                        <select class="form-select form-select-sm" style="width: auto;" id="limite-stock" onchange="filtrarStock()">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                        <small class="text-muted ms-2">por página</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Por Depósito -->
        <div class="tab-pane fade" id="por-deposito" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-4">
                    <select class="form-select" id="selector-deposito" onchange="cargarStockDeposito()">
                        <option value="">Seleccionar depósito...</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <div id="info-deposito-seleccionado" class="alert alert-info d-none">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="texto-info-deposito"></span>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="exportarStockDeposito()" title="Exportar stock del depósito">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="imprimirEtiquetasDeposito()" title="Imprimir etiquetas">
                                    <i class="fas fa-tags"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>SKU</th>
                            <th>Descripción</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-center">Stock Mín.</th>
                            <th class="text-end">Valor Unit.</th>
                            <th class="text-end">Valor Total</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-stock-deposito">
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-warehouse fa-2x mb-2 text-muted"></i><br>
                                Seleccione un depósito para ver su stock
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alertas -->
        <div class="tab-pane fade" id="alertas" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="alert alert-warning border-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <h6 class="mb-1">Productos que requieren atención</h6>
                                <small>Stock por debajo del mínimo establecido</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="filtro-urgencia-alertas" onchange="filtrarAlertas()">
                            <option value="">Todas las prioridades</option>
                            <option value="CRITICO">Crítico</option>
                            <option value="ALTO">Alto</option>
                            <option value="MEDIO">Medio</option>
                            <option value="BAJO">Bajo</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="actualizarAlertas()">
                            <i class="fas fa-sync me-1"></i>Actualizar
                        </button>
                        <button class="btn btn-success btn-sm" onclick="resolverAlertasSeleccionadas()">
                            <i class="fas fa-check me-1"></i>Resolver Selec.
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="select-all-alertas" onchange="toggleSelectAllAlertas()">
                            </th>
                            <th style="width: 80px;">Prioridad</th>
                            <th style="width: 100px;">SKU</th>
                            <th>Descripción</th>
                            <th style="width: 80px;" class="text-center">Actual</th>
                            <th style="width: 80px;" class="text-center">Mínimo</th>
                            <th style="width: 80px;" class="text-center">Faltante</th>
                            <th style="width: 150px;">Depósito</th>
                            <th style="width: 120px;" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-alertas-stock">
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="d-flex justify-content-center align-items-center py-3">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Cargando alertas...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Movimientos -->

        <!-- Reportes -->
        <div class="tab-pane fade" id="reportes" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Valoración por Depósito</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="chart-valoracion-depositos" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Rotación de Stock</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="chart-rotacion-stock" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Resumen Ejecutivo</h6>
                        </div>
                        <div class="card-body">
                            <div id="resumen-ejecutivo">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Generando resumen...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- Transferencias Page -->
                <div id="transferencias" class="page-content">
    <div class="container-fluid">
        <!-- Header con botones de acción -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h4 class="mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>
                    Órdenes de Transferencia
                </h4>
                <small class="text-muted">Gestión de transferencias entre depósitos</small>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-primary" onclick="abrirModalNuevaOrden()">
                    <i class="fas fa-plus me-1"></i>
                    Nueva Orden
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="cargarTransferencias()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Actualizar
                </button>
            </div>
        </div>

        <!-- Filtros y búsqueda -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="filtro-estado-transferencia">
                            <option value="">Todos los estados</option>
                            <option value="PENDIENTE">Pendiente</option>
                            <option value="PARCIAL">Parcial</option>
                            <option value="COMPLETADA">Completada</option>
                            <option value="CANCELADA">Cancelada</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Depósito Origen</label>
                        <select class="form-select" id="filtro-origen-transferencia">
                            <option value="">Todos los depósitos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Depósito Destino</label>
                        <select class="form-select" id="filtro-destino-transferencia">
                            <option value="">Todos los depósitos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Buscar</label>
                        <input type="text" class="form-control" id="buscar-transferencia" 
                               placeholder="Número de orden...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-primary" onclick="filtrarTransferencias()">
                            <i class="fas fa-filter me-1"></i>
                            Aplicar Filtros
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltrosTransferencias()">
                            <i class="fas fa-times me-1"></i>
                            Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas rápidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-warning" id="stat-pendientes">0</h5>
                        <p class="card-text">Pendientes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <h5 class="card-title text-info" id="stat-parciales">0</h5>
                        <p class="card-text">Parciales</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="card-title text-success" id="stat-completadas">0</h5>
                        <p class="card-text">Completadas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <h5 class="card-title text-danger" id="stat-canceladas">0</h5>
                        <p class="card-text">Canceladas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de transferencias -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Lista de Órdenes de Transferencia</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Fecha</th>
                                <th>Origen</th>
                                <th>Destino</th>
                                <th>Estado</th>
                                <th>Items</th>
                                <th>Progreso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaTransferencias">
                            <tr>
                                <td colspan="8" class="text-center">Cargando transferencias...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- Movimientos Page -->
                <!-- Movimientos Page - VERSIÓN CORREGIDA -->
<div id="movimientos" class="page-content">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-exchange-alt me-2"></i>Movimientos de Stock</h2>
                <div class="btn-group">
                    <button type="button" class="btn btn-success" onclick="nuevoMovimiento()">
                        <i class="fas fa-plus me-2"></i>Nuevo Movimiento
                    </button>
                    <button type="button" class="btn btn-info" onclick="exportarMovimientos()">
                        <i class="fas fa-download me-2"></i>Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas Superiores -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-value text-primary" id="total-movimientos-hoy">-</div>
                <div class="stats-label">Movimientos Hoy</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-value text-success" id="ingresos-hoy">-</div>
                <div class="stats-label">Ingresos Hoy</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-value text-warning" id="salidas-hoy">-</div>
                <div class="stats-label">Salidas Hoy</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-value text-info" id="valor-movido">-</div>
                <div class="stats-label">Valor Total</div>
            </div>
        </div>
    </div>

    <!-- Filtros Mejorados -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtros de Movimientos
                        <span class="badge bg-info ms-2" id="contador-movimientos">0 movimientos</span>
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Primera fila de filtros -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Tipo de Movimiento</label>
                            <select class="form-select" id="filtro-tipo-movimiento" onchange="filtrarMovimientos()">
                                <option value="">Todos los tipos</option>
                                <option value="COMPRA">Compras</option>
                                <option value="VENTA">Ventas</option>
                                <option value="TRANSFERENCIA">Transferencias</option>
                                <option value="AJUSTE">Ajustes</option>
                                <option value="DEVOLUCION">Devoluciones</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Desde</label>
                            <input type="date" class="form-control" id="fecha-desde-movimientos" onchange="filtrarMovimientos()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Hasta</label>
                            <input type="date" class="form-control" id="fecha-hasta-movimientos" onchange="filtrarMovimientos()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Depósito</label>
                            <select class="form-select" id="filtro-deposito-movimientos" onchange="filtrarMovimientos()">
                                <option value="">Todos los depósitos</option>
                                <!-- Opciones cargadas dinámicamente -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Segunda fila de filtros -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Buscar Mercadería</label>
                            <input type="text" class="form-control" id="buscar-mercaderia-movimientos" 
                                   placeholder="Código SKU o descripción..." onkeyup="filtrarMovimientos()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Usuario</label>
                            <select class="form-select" id="filtro-usuario-movimientos" onchange="filtrarMovimientos()">
                                <option value="">Todos los usuarios</option>
                                <!-- Opciones cargadas dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Documento</label>
                            <input type="text" class="form-control" id="filtro-documento-movimientos" 
                                   placeholder="Número de documento..." onkeyup="filtrarMovimientos()">
                        </div>
                    </div>
                    
                    <!-- Botones de filtros rápidos -->
                    <div class="row">
                        <div class="col-12">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="filtrarMovimientosHoy()">
                                    <i class="fas fa-calendar-day"></i> Hoy
                                </button>
                                <button class="btn btn-outline-info" onclick="filtrarMovimientosSemana()">
                                    <i class="fas fa-calendar-week"></i> Esta Semana
                                </button>
                                <button class="btn btn-outline-warning" onclick="filtrarMovimientosMes()">
                                    <i class="fas fa-calendar-alt"></i> Este Mes
                                </button>
                                <button class="btn btn-outline-success" onclick="verMovimientosPendientes()">
                                    <i class="fas fa-clock"></i> Pendientes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla Principal de Movimientos -->
    <div class="table-responsive">
        <table class="table table-hover table-sm">
            <thead class="table-dark">
                <tr>
                    <th style="width: 120px;">
                        <i class="fas fa-calendar"></i> Fecha/Hora
                    </th>
                    <th style="width: 100px;">
                        <i class="fas fa-tag"></i> Tipo
                    </th>
                    <th style="width: 100px;">
                        <i class="fas fa-barcode"></i> SKU
                    </th>
                    <th>
                        <i class="fas fa-box"></i> Mercadería
                    </th>
                    <th style="width: 150px;">
                        <i class="fas fa-arrow-right"></i> Origen
                    </th>
                    <th style="width: 150px;">
                        <i class="fas fa-arrow-left"></i> Destino
                    </th>
                    <th style="width: 80px;" class="text-center">
                        <i class="fas fa-hashtag"></i> Cantidad
                    </th>
                    <th style="width: 100px;" class="text-end">
                        <i class="fas fa-dollar-sign"></i> Valor Unit.
                    </th>
                    <th style="width: 120px;">
                        <i class="fas fa-file-alt"></i> Documento
                    </th>
                    <th style="width: 100px;">
                        <i class="fas fa-user"></i> Usuario
                    </th>
                    <th style="width: 100px;" class="text-center">
                        <i class="fas fa-cogs"></i> Acciones
                    </th>
                </tr>
            </thead>
            <tbody id="tabla-movimientos-principal">
                <tr>
                    <td colspan="11" class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Cargando movimientos...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="d-flex align-items-center">
                <span class="text-muted">
                    Mostrando <span id="movimientos-desde">0</span> a <span id="movimientos-hasta">0</span> 
                    de <span id="movimientos-total">0</span> movimientos
                </span>
            </div>
        </div>
        <div class="col-md-6">
            <nav>
                <ul class="pagination pagination-sm justify-content-end" id="paginacion-movimientos">
                    <!-- Generado dinámicamente -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- Gráficos de Análisis -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-chart-pie me-2"></i>Movimientos por Tipo (Últimos 7 días)</h5>
                <canvas id="grafico-tipos-movimiento" width="400" height="200"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-chart-line me-2"></i>Tendencia de Movimientos</h5>
                <canvas id="grafico-tendencia-movimientos" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

                <!-- Clientes Page -->
                <div id="clientes" class="page-content">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-users me-2"></i>Gestión de Clientes</h2>
                <button type="button" class="btn btn-primary" onclick="abrirModalCliente()">
                    <i class="fas fa-plus me-2"></i>Nuevo Cliente
                </button>
            </div>
        </div>
    </div>

    <!-- FILTROS DE CLIENTES -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
                        <span class="badge bg-info ms-2" id="contador-clientes-filtros">0 clientes</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Búsqueda general -->
                        <div class="col-md-3">
                            <label for="filtro-clientes-busqueda" class="form-label small">Buscar cliente</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="filtro-clientes-busqueda" 
                                       placeholder="Razón social, CUIT...">
                            </div>
                        </div>

                        <!-- Filtro por Vendedor -->
                        <div class="col-md-2">
                            <label for="filtro-clientes-vendedor" class="form-label small">Vendedor</label>
                            <select class="form-select" id="filtro-clientes-vendedor">
                                <option value="">Todos los vendedores</option>
                            </select>
                        </div>

                        <!-- Filtro por Zona -->
                        <div class="col-md-2">
                            <label for="filtro-clientes-zona" class="form-label small">Zona</label>
                            <select class="form-select" id="filtro-clientes-zona">
                                <option value="">Todas las zonas</option>
                            </select>
                        </div>

                        <!-- Filtro por Estado -->
                        <div class="col-md-2">
                            <label for="filtro-clientes-activo" class="form-label small">Estado</label>
                            <select class="form-select" id="filtro-clientes-activo">
                                <option value="">Todos</option>
                                <option value="1">Activos</option>
                                <option value="0">Inactivos</option>
                            </select>
                        </div>

                        <!-- Filtro por Depósito -->
                        <div class="col-md-2">
                            <label for="filtro-clientes-deposito" class="form-label small">Depósito</label>
                            <select class="form-select" id="filtro-clientes-deposito">
                                <option value="">Todos</option>
                                <option value="1">Con depósito</option>
                                <option value="0">Sin depósito</option>
                            </select>
                        </div>

                        <!-- Filtro por Condición IVA -->
                        <div class="col-md-1">
                            <label for="filtro-clientes-iva" class="form-label small">IVA</label>
                            <select class="form-select" id="filtro-clientes-iva">
                                <option value="">Todos</option>
                                <option value="Responsable Inscripto">Resp. Inscripto</option>
                                <option value="Monotributo">Monotributo</option>
                                <option value="Exento">Exento</option>
                                <option value="Consumidor Final">Cons. Final</option>
                            </select>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-primary" onclick="aplicarFiltrosClientes()">
                                    <i class="fas fa-search me-2"></i>Filtrar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltrosClientes()">
                                    <i class="fas fa-times me-2"></i>Limpiar
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="exportarClientesFiltrados()">
                                    <i class="fas fa-download me-2"></i>Exportar
                                </button>
                            </div>
                            
                            <!-- Filtros rápidos -->
                            <div class="btn-group ms-3">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="aplicarFiltroRapidoClientes('activos')">
                                    <i class="fas fa-check me-1"></i>Solo activos
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="aplicarFiltroRapidoClientes('con_deposito')">
                                    <i class="fas fa-warehouse me-1"></i>Con depósito
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="aplicarFiltroRapidoClientes('sin_stock')">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Sin stock
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Clientes -->
    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Razón Social</th>
                            <th>CUIT</th>
                            <th>Vendedor</th>
                            <th>Zona</th>
                            <th>Email/Teléfono</th>
                            <th>Localidad</th>
                            <th>Depósito</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-clientes">
                        <tr>
                            <td colspan="9" class="text-center">Cargando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Estadísticas de filtros -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted" id="info-filtros-clientes">
                    Mostrando todos los clientes
                </small>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="toggleVistaCompacta('clientes')">
                        <i class="fas fa-compress-alt"></i> Vista compacta
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="actualizarClientes()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NUEVA PÁGINA DE GESTIÓN DE ZONAS -->
<div id="zonas" class="page-content">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-map-marker-alt me-2"></i>Gestión de Zonas</h2>
                    <button type="button" class="btn btn-primary" onclick="abrirModalZona()">
                        <i class="fas fa-plus me-2"></i>Nueva Zona
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="filtro-zona-busqueda" placeholder="Buscar zona...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filtro-zona-activo">
                    <option value="">Todos los estados</option>
                    <option value="1">Solo activas</option>
                    <option value="0">Solo inactivas</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-primary" onclick="aplicarFiltrosZonas()">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltrosZonas()">
                    <i class="fas fa-eraser me-2"></i>Limpiar
                </button>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-info" onclick="cargarZonas()">
                    <i class="fas fa-sync-alt me-2"></i>Actualizar
                </button>
            </div>
        </div>

        <!-- Tabla de zonas -->
        <div class="row">
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Zona</th>
                                <th>Clientes</th>
                                <th>Estado</th>
                                <th>Fecha Creación</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-zonas">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Estadísticas y información de filtros -->
        <div class="row mt-3">
            <div class="col-md-6">
                <small class="text-muted" id="info-filtros-zonas">Cargando zonas...</small>
            </div>
            <div class="col-md-6 text-end">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportarZonas()">
                    <i class="fas fa-download me-1"></i>Exportar
                </button>
            </div>
        </div>

        <!-- Paginación (si es necesaria) -->
        <div class="row mt-3">
            <div class="col-12">
                <nav aria-label="Paginación de zonas">
                    <ul class="pagination justify-content-center" id="paginacion-zonas">
                        <!-- Se llena dinámicamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>


                <!-- Vendedores Page -->
                <div id="vendedores" class="page-content">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2><i class="fas fa-user-tie me-2"></i>Gestión de Vendedores</h2>
                                <button type="button" class="btn btn-primary" onclick="abrirModalVendedor()">
                                    <i class="fas fa-plus me-2"></i>Nuevo Vendedor
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                           <div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-dark">
            <tr>
                <th>Razón Social</th>
                <th>CUIT</th>
                <th>Email</th>
                <th>Teléfono</th>
                <th>Localidad</th>
                <th>Depósito</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-vendedores">
            <tr>
                <td colspan="8" class="text-center">Cargando...</td>
            </tr>
        </tbody>
    </table>
</div>
                        </div>
                    </div>
                </div>

                <!-- Proveedores Page -->
<!-- Proveedores Page -->
<div id="proveedores" class="page-content" >
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-truck me-2"></i>Gestión de Proveedores</h2>
                <button class="btn btn-primary" onclick="abrirModalProveedor()">
                    <i class="fas fa-plus me-2"></i>Nuevo Proveedor
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary" id="stat-proveedores-total">0</h4>
                    <small class="text-muted">Total Proveedores</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success" id="stat-proveedores-activos">0</h4>
                    <small class="text-muted">Activos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-danger" id="stat-proveedores-inactivos">0</h4>
                    <small class="text-muted">Inactivos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-info" id="stat-compras-mes">0</h4>
                    <small class="text-muted">Compras del Mes</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <label for="filtro-proveedores-busqueda" class="form-label">Buscar</label>
                    <input type="text" 
                           id="filtro-proveedores-busqueda" 
                           class="form-control" 
                           placeholder="Buscar por razón social, CUIT, email...">
                </div>
                <div class="col-md-3">
                    <label for="filtro-proveedores-estado" class="form-label">Estado</label>
                    <select id="filtro-proveedores-estado" class="form-select">
                        <option value="">Todos los estados</option>
                        <option value="1">Activos</option>
                        <option value="0">Inactivos</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-outline-primary me-2" onclick="aplicarFiltrosProveedores()">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                    <button class="btn btn-outline-secondary me-2" onclick="limpiarFiltrosProveedores()">
                        <i class="fas fa-eraser me-1"></i>Limpiar
                    </button>
                    <button class="btn btn-outline-success" onclick="exportarProveedores()">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div id="info-filtros-proveedores">
                        <small class="text-muted">Mostrando todos los proveedores</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Proveedores -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Lista de Proveedores</h6>
            <button class="btn btn-outline-primary btn-sm" onclick="actualizarProveedores()">
                <i class="fas fa-sync me-1"></i>Actualizar
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="min-width: 200px;">Proveedor</th>
                            <th style="width: 130px;">CUIT</th>
                            <th style="min-width: 180px;">Contacto</th>
                            <th style="width: 120px;">Fecha Alta</th>
                            <th style="width: 100px;" class="text-center">Estado</th>
                            <th style="width: 160px;" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-proveedores">
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">Cargando proveedores...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
    



                <!-- Etiquetas Page -->
                <div id="etiquetas" class="page-content">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-tags me-2"></i>Generación de Etiquetas</h2>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Generar Etiqueta Individual</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Seleccionar Mercadería</label>
                                        <select class="form-select" id="etiqueta-mercaderia">
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label">Ancho (mm)</label>
                                                <input type="number" class="form-control" id="etiqueta-ancho" value="100">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label">Alto (mm)</label>
                                                <input type="number" class="form-control" id="etiqueta-alto" value="70">
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="generarEtiquetaIndividual()">
                                        <i class="fas fa-print me-2"></i>Generar Etiqueta
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Vista Previa</h5>
                                </div>
                                <div class="card-body text-center">
                                    <div id="previewEtiquetaContainer">
                                        <p class="text-muted">Selecciona una mercadería para ver la vista previa</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reportes Page -->
                <div id="reportes" class="page-content">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="fas fa-chart-line me-2"></i>Reportes y Análisis</h2>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                    <h5>Reporte de Stock</h5>
                                    <p class="text-muted">Estado actual del inventario</p>
                                    <button class="btn btn-outline-primary" onclick="generarReporteStock()">
                                        <i class="fas fa-download me-2"></i>Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-exchange-alt fa-3x text-success mb-3"></i>
                                    <h5>Movimientos</h5>
                                    <p class="text-muted">Historial de movimientos</p>
                                    <button class="btn btn-outline-success" onclick="generarReporteMovimientos()">
                                        <i class="fas fa-download me-2"></i>Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                                    <h5>Performance Vendedores</h5>
                                    <p class="text-muted">Análisis de vendedores</p>
                                    <button class="btn btn-outline-info" onclick="generarReporteVendedores()">
                                        <i class="fas fa-download me-2"></i>Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestión de Proveedores -->
<div class="modal fade" id="modalProveedoresMercaderia" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-truck me-2"></i>
                    Gestionar Proveedores - <span id="mercaderia-nombre"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Información de la mercadería -->
                <div class="alert alert-info mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>SKU:</strong> <span id="mercaderia-sku"></span><br>
                            <strong>Descripción:</strong> <span id="mercaderia-descripcion"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Precio Venta:</strong> $<span id="mercaderia-precio-venta"></span><br>
                            <strong>Stock Actual:</strong> <span id="mercaderia-stock"></span>
                        </div>
                    </div>
                </div>

                <!-- Formulario para agregar/editar proveedor -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-plus me-2"></i>
                            <span id="form-title">Agregar Proveedor</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="formProveedorMercaderia">
                            <input type="hidden" id="mercaderia-id-form" name="mercaderia_id">
                            <input type="hidden" id="editando-relacion-id" name="relacion_id">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Proveedor <span class="text-danger">*</span></label>
                                    <select class="form-select" id="select-proveedor" name="proveedor_id" required>
                                        <option value="">Seleccionar proveedor...</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Precio Compra <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="precio-compra" 
                                               name="precio_compra" step="0.01" min="0" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Moneda</label>
                                    <select class="form-select" id="moneda" name="moneda">
                                        <option value="ARS">ARS</option>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <label class="form-label">Tiempo Entrega (días)</label>
                                    <input type="number" class="form-control" id="tiempo-entrega" 
                                           name="tiempo_entrega_dias" value="7" min="1">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Cantidad Mínima</label>
                                    <input type="number" class="form-control" id="cantidad-minima" 
                                           name="cantidad_minima_pedido" value="1" min="1">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Descuento (%)</label>
                                    <input type="number" class="form-control" id="descuento" 
                                           name="descuento_porcentaje" value="0" min="0" max="100" step="0.01">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Código del Proveedor</label>
                                    <input type="text" class="form-control" id="codigo-proveedor" 
                                           name="codigo_producto_proveedor" placeholder="Ej: ABC-001">
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">Condiciones de Pago</label>
                                    <input type="text" class="form-control" id="condiciones-pago" 
                                           name="condiciones_pago" placeholder="Ej: 30 días">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Observaciones</label>
                                    <textarea class="form-control" id="observaciones" name="observaciones" 
                                              rows="1" placeholder="Notas adicionales..."></textarea>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="es-principal" 
                                               name="es_proveedor_principal">
                                        <label class="form-check-label" for="es-principal">
                                            <strong>Proveedor Principal</strong>
                                            <small class="text-muted">(Solo puede haber uno por mercadería)</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary" id="btn-guardar-proveedor">
                                    <i class="fas fa-save me-2"></i>Guardar Proveedor
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" onclick="limpiarFormProveedor()">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de proveedores actuales -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Proveedores Actuales
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="loading-proveedores" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                        
                        <div class="table-responsive" id="tabla-proveedores-container" style="display: none;">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>Precio</th>
                                        <th>Entrega</th>
                                        <th>Cant. Mín.</th>
                                        <th>Código</th>
                                        <th>Principal</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-proveedores-mercaderia">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="no-proveedores" class="text-center py-4" style="display: none;">
                            <i class="fas fa-truck fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No hay proveedores asignados</h6>
                            <p class="text-muted">Utiliza el formulario de arriba para agregar proveedores</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Compra Directa Simple -->
    <div class="modal fade" id="modalCompraDirectaSimple" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shopping-cart text-success"></i> 
                        Compra Directa
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Datos del comprobante -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label class="form-label">Proveedor *</label>
                            <select id="compra-proveedor" class="form-select" required>
                                <option value="">Seleccionar proveedor...</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Fecha Documento *</label>
                            <input type="date" id="compra-fecha" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Fecha Venc. Doc.</label>
                            <input type="date" id="compra-fecha-vencimiento" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">N° Remito</label>
                            <input type="text" id="compra-remito" class="form-control" placeholder="R-001">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">N° Factura</label>
                            <input type="text" id="compra-factura" class="form-control" placeholder="F-001">
                        </div>
                    </div>

                    <!-- Botón para agregar productos -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Productos</h6>
                        <button type="button" class="btn btn-primary btn-sm" onclick="agregarProductoCompra()">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </div>

                    <!-- Lista de productos -->
                    <div id="productos-container">
    <!-- Mensaje inicial cuando no hay productos -->
    <div class="text-center text-muted py-4" id="mensaje-vacio">
        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
        <p>No hay productos agregados. Haz clic en "Agregar Producto" para comenzar.</p>
    </div>
    
    <!-- Los productos se agregarán aquí dinámicamente con JavaScript -->
</div>

                    <!-- Observaciones -->
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <label class="form-label">Observaciones</label>
                            <textarea id="compra-observaciones" class="form-control" rows="2" 
                                     placeholder="Observaciones de la compra..."></textarea>
                        </div>
                        <div class="col-md-4">
                            <!-- Totales -->
                            <div class="total-compra">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <strong id="subtotal-display">$0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>IVA:</span>
                                    <strong id="iva-display">$0.00</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span class="h6">TOTAL:</span>
                                    <strong class="h5 text-success" id="total-display">$0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="guardarCompraSimple()">
                        <i class="fas fa-check"></i> Guardar Compra
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea desvincular este proveedor de la mercadería?</p>
                <p class="text-muted mb-0">Esta acción se puede revertir más tarde.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-eliminar">
                    <i class="fas fa-trash me-2"></i>Eliminar
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal Configuración de Impresora de Red -->
<div class="modal fade" id="modalConfigImpresora" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurar Impresora de Red</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Configure la dirección IP y puerto de su impresora de red
                </div>
                
                <div class="mb-3">
                    <label for="impresora-ip" class="form-label">Dirección IP</label>
                    <input type="text" class="form-control" id="impresora-ip" 
                           placeholder="192.168.1.100" value="192.168.1.100">
                    <div class="form-text">IP de la impresora en su red local</div>
                </div>
                
                <div class="mb-3">
                    <label for="impresora-puerto" class="form-label">Puerto</label>
                    <input type="number" class="form-control" id="impresora-puerto" 
                           placeholder="9100" value="9100">
                    <div class="form-text">Puerto estándar: 9100</div>
                </div>

                <div class="border-start border-primary ps-3">
                    <h6 class="text-primary">¿Cómo encontrar la IP?</h6>
                    <small class="text-muted">
                        • Imprima una página de configuración desde la impresora<br>
                        • Use el panel de la impresora > Red > Estado<br>
                        • Consulte su router para ver dispositivos conectados
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarConfigImpresora()">
                    <i class="fas fa-save me-2"></i>Guardar y Probar
                </button>
            </div>
        </div>
    </div>
</div>


    <!-- Modal Nueva/Editar Mercadería -->
    <div class="modal fade" id="modalMercaderia" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMercaderiaTitle">Nueva Mercadería</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formMercaderia" novalidate>
                        <input type="hidden" id="mercaderia_id">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">SKU *</label>
                                    <input type="text" class="form-control" id="codigo_sku" required>
                                    <div class="invalid-feedback">El SKU es requerido</div>
                                </div>
                                
                                

                                <div class="mb-3">
                                    <label class="form-label">Descripción *</label>
                                    <textarea class="form-control" id="descripcion" rows="3" required></textarea>
                                    <div class="invalid-feedback">La descripción es requerida</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Categoría</label>
                                    <select class="form-select" id="id_categoria">
                                        <option value="">Seleccionar categoría</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Precio Costo</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="precio_costo" step="0.01" min="0">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Precio Venta</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="precio_venta" step="0.01" min="0">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Stock Mínimo</label>
                                    <input type="number" class="form-control" id="stock_minimo" step="0.01" min="0">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Unidad de Medida</label>
                                    <input type="text" class="form-control" id="unidad_medida">
                                </div>

                                <!-- Imagen del Producto -->
                                <div class="mb-3">
                                    <label class="form-label">Imagen del Producto</label>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="imagen_input" accept="image/*" onchange="previewImage(this)">
                                        <button type="button" class="btn btn-outline-danger" onclick="eliminarImagen()" id="btn-eliminar-imagen" style="display:none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="image-preview" id="image-preview">
                                        <img id="preview-img" src="" alt="Vista previa">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarMercaderia()">
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="modalAjuste" tabindex="-1" aria-labelledby="modalAjusteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Header del Modal -->
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalAjusteLabel">
                    <i class="fas fa-tools me-2"></i>
                    Ajustar Stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <!-- Formulario -->
            <form id="formAjuste" novalidate>
                <div class="modal-body">
                    <!-- Información de stock actual -->
                    <div id="stock-actual-info" class="mb-3">
                        <!-- Aquí se carga dinámicamente la info del stock actual -->
                    </div>

                    <div class="row">
                        <!-- Selección de Mercadería -->
                        <div class="col-md-6 mb-3">
                            <label for="ajuste_mercaderia" class="form-label">
                                <i class="fas fa-box me-1"></i>
                                Mercadería <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="ajuste_mercaderia" required>
                                <option value="">Seleccionar mercadería...</option>
                                <!-- Opciones se cargan dinámicamente -->
                            </select>
                            <div class="invalid-feedback">
                                Debe seleccionar una mercadería
                            </div>
                        </div>

                        <!-- Selección de Depósito -->
                        <div class="col-md-6 mb-3">
                            <label for="ajuste_deposito" class="form-label">
                                <i class="fas fa-warehouse me-1"></i>
                                Depósito <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="ajuste_deposito" required>
                                <option value="">Seleccionar depósito...</option>
                                <!-- Opciones se cargan dinámicamente -->
                            </select>
                            <div class="invalid-feedback">
                                Debe seleccionar un depósito
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Tipo de Ajuste -->
                        <div class="col-md-4 mb-3">
                            <label for="ajuste_tipo" class="form-label">
                                <i class="fas fa-adjust me-1"></i>
                                Tipo de Ajuste <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="ajuste_tipo" required>
                                <option value="">Seleccionar tipo...</option>
                                <option value="INCREMENTO">
                                    <i class="fas fa-plus-circle"></i> Incrementar Stock
                                </option>
                                <option value="DECREMENTO">
                                    <i class="fas fa-minus-circle"></i> Decrementar Stock
                                </option>
                                <option value="CORRECCION">
                                    <i class="fas fa-edit"></i> Corrección (Ajustar a cantidad exacta)
                                </option>
                            </select>
                            <div class="invalid-feedback">
                                Debe seleccionar un tipo de ajuste
                            </div>
                        </div>

                        <!-- Cantidad -->
                        <div class="col-md-4 mb-3">
                            <label for="ajuste_cantidad" class="form-label">
                                <i class="fas fa-hashtag me-1"></i>
                                Cantidad <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="ajuste_cantidad" 
                                   min="0" 
                                   step="1" 
                                   placeholder="0"
                                   required>
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Ingrese la cantidad a ajustar
                                </small>
                            </div>
                            <div class="invalid-feedback">
                                La cantidad debe ser mayor a 0
                            </div>
                        </div>

                        <!-- Motivo -->
                        <div class="col-md-4 mb-3">
                            <label for="ajuste_motivo" class="form-label">
                                <i class="fas fa-tag me-1"></i>
                                Motivo <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="ajuste_motivo" required>
                                <option value="">Seleccionar motivo...</option>
                                <option value="Inventario">Ajuste por Inventario</option>
                                <option value="Merma">Merma de Producto</option>
                                <option value="Devolución">Devolución de Cliente</option>
                                <option value="Error Sistema">Corrección Error Sistema</option>
                                <option value="Rotura">Producto Dañado/Roto</option>
                                <option value="Vencimiento">Producto Vencido</option>
                                <option value="Transferencia">Ajuste por Transferencia</option>
                                <option value="Otro">Otro Motivo</option>
                            </select>
                            <div class="invalid-feedback">
                                Debe especificar un motivo
                            </div>
                        </div>
                    </div>

                    <!-- Preview del Ajuste -->
                    <div id="preview-ajuste" class="mb-3">
                        <!-- Aquí se muestra el preview dinámico del ajuste -->
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-3">
                        <label for="ajuste_observaciones" class="form-label">
                            <i class="fas fa-comment me-1"></i>
                            Observaciones
                        </label>
                        <textarea class="form-control" 
                                  id="ajuste_observaciones" 
                                  rows="3" 
                                  placeholder="Detalles adicionales sobre el ajuste (opcional)"></textarea>
                        <div class="form-text">
                            <small>
                                <i class="fas fa-lightbulb me-1"></i>
                                Información adicional que ayude a entender el motivo del ajuste
                            </small>
                        </div>
                    </div>

                    <!-- Alerta de Información -->
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            <strong>Información importante:</strong>
                            <ul class="mb-0 mt-1">
                                <li><strong>Incremento:</strong> Suma la cantidad al stock actual</li>
                                <li><strong>Decremento:</strong> Resta la cantidad del stock actual</li>
                                <li><strong>Corrección:</strong> Establece el stock exacto a la cantidad indicada</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Footer del Modal -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        Guardar Ajuste
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- =============================================
     MODAL DE TRANSFERENCIA DE STOCK
     ============================================= -->
<div class="modal fade" id="modalTransferencia" tabindex="-1" aria-labelledby="modalTransferenciaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Header del Modal -->
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalTransferenciaLabel">
                    <i class="fas fa-exchange-alt me-2"></i>
                    Transferir Stock
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <!-- Formulario -->
            <form id="formTransferencia" novalidate>
                <div class="modal-body">
                    <!-- Información de stock disponible -->
                    <div id="stock-disponible-info" class="mb-3">
                        <!-- Aquí se carga dinámicamente la info del stock disponible -->
                    </div>

                    <div class="row">
                        <!-- Selección de Mercadería -->
                        <div class="col-md-12 mb-3">
                            <label for="trans_mercaderia" class="form-label">
                                <i class="fas fa-box me-1"></i>
                                Mercadería <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="trans_mercaderia" required>
                                <option value="">Seleccionar mercadería...</option>
                                <!-- Opciones se cargan dinámicamente -->
                            </select>
                            <div class="invalid-feedback">
                                Debe seleccionar una mercadería
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Depósito Origen -->
                        <div class="col-md-6 mb-3">
                            <label for="trans_origen" class="form-label">
                                <i class="fas fa-warehouse me-1"></i>
                                Depósito Origen <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="trans_origen" required>
                                <option value="">Seleccionar origen...</option>
                                <!-- Opciones se cargan dinámicamente -->
                            </select>
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Depósito desde donde se transferirá el stock
                                </small>
                            </div>
                            <div class="invalid-feedback">
                                Debe seleccionar un depósito origen
                            </div>
                        </div>

                        <!-- Depósito Destino -->
                        <div class="col-md-6 mb-3">
                            <label for="trans_destino" class="form-label">
                                <i class="fas fa-warehouse me-1"></i>
                                Depósito Destino <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="trans_destino" required>
                                <option value="">Seleccionar destino...</option>
                                <!-- Opciones se cargan dinámicamente -->
                            </select>
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Depósito donde se recibirá el stock
                                </small>
                            </div>
                            <div class="invalid-feedback">
                                Debe seleccionar un depósito destino diferente al origen
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Cantidad -->
                        <div class="col-md-4 mb-3">
                            <label for="trans_cantidad" class="form-label">
                                <i class="fas fa-hashtag me-1"></i>
                                Cantidad <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="trans_cantidad" 
                                   min="1" 
                                   step="1" 
                                   placeholder="Cantidad a transferir"
                                   required>
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="cantidad-info">Ingrese la cantidad a transferir</span>
                                </small>
                            </div>
                            <div class="invalid-feedback">
                                La cantidad debe ser mayor a 0 y no exceder el stock disponible
                            </div>
                        </div>

                        <!-- Motivo -->
                        <div class="col-md-4 mb-3">
                            <label for="trans_motivo" class="form-label">
                                <i class="fas fa-tag me-1"></i>
                                Motivo <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="trans_motivo" required>
                                <option value="">Seleccionar motivo...</option>
                                <option value="Envío a Vendedor">Envío a Vendedor</option>
                                <option value="Entrega a Cliente">Entrega a Cliente</option>
                                <option value="Reposición Stock">Reposición de Stock</option>
                                <option value="Redistribución">Redistribución entre Depósitos</option>
                                <option value="Devolución">Devolución de Mercadería</option>
                                <option value="Traslado Central">Traslado a Central</option>
                                <option value="Ajuste Inventario">Ajuste de Inventario</option>
                                <option value="Otro">Otro Motivo</option>
                            </select>
                            <div class="invalid-feedback">
                                Debe especificar un motivo
                            </div>
                        </div>

                        <!-- Número de Documento -->
                        <div class="col-md-4 mb-3">
                            <label for="trans_documento" class="form-label">
                                <i class="fas fa-file-alt me-1"></i>
                                Nº Documento
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="trans_documento" 
                                   placeholder="Opcional"
                                   maxlength="50">
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Remito, orden, etc. (opcional)
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Preview de la Transferencia -->
                    <div id="preview-transferencia" class="mb-3">
                        <!-- Aquí se muestra el preview dinámico de la transferencia -->
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-3">
                        <label for="trans_observaciones" class="form-label">
                            <i class="fas fa-comment me-1"></i>
                            Observaciones
                        </label>
                        <textarea class="form-control" 
                                  id="trans_observaciones" 
                                  rows="3" 
                                  placeholder="Detalles adicionales sobre la transferencia (opcional)"
                                  maxlength="500"></textarea>
                        <div class="form-text">
                            <small>
                                <i class="fas fa-lightbulb me-1"></i>
                                Información adicional que ayude a documentar la transferencia
                            </small>
                        </div>
                    </div>

                    <!-- Alerta de Información -->
                    <div class="alert alert-info d-flex align-items-start" role="alert">
                        <i class="fas fa-info-circle me-2 mt-1"></i>
                        <div>
                            <strong>Información importante:</strong>
                            <ul class="mb-0 mt-1">
                                <li>La transferencia se registra inmediatamente</li>
                                <li>El stock se resta del depósito origen y se suma al destino</li>
                                <li>Se genera un movimiento de stock automáticamente</li>
                                <li>Verifique que los datos sean correctos antes de confirmar</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Alerta de Advertencia -->
                    <div class="alert alert-warning d-flex align-items-start d-none" id="alerta-advertencia" role="alert">
                        <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                        <div>
                            <strong>Advertencia:</strong>
                            <span id="mensaje-advertencia"></span>
                        </div>
                    </div>
                </div>

                <!-- Footer del Modal -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-exchange-alt me-1"></i>
                        Realizar Transferencia
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>





<!-- 🏗️ MODAL: Crear/Editar Depósito -->
<div class="modal fade" id="modalDeposito" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDepositoTitle">Nuevo Depósito</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formDeposito">
                    <input type="hidden" id="deposito_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deposito_nombre" class="form-label">
                                    Nombre del Depósito <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="deposito_nombre" 
                                       placeholder="Ej: Depósito Norte" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deposito_tipo" class="form-label">
                                    Tipo <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="deposito_tipo" required onchange="tipoDepositoChanged()">
                                    <option value="">Seleccionar tipo</option>
                                    <option value="CENTRAL">Central</option>
                                    <option value="VENDEDOR">Vendedor</option>
                                    <option value="CLIENTE">Cliente</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Selección de entidad (aparece solo si es VENDEDOR o CLIENTE) -->
                    <div class="row" id="seccion-entidad" style="display: none;">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="deposito_entidad" class="form-label">
                                    Seleccionar Entidad <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="deposito_entidad">
                                    <option value="">Seleccionar...</option>
                                </select>
                                <small class="form-text text-muted">
                                    Solo se muestran entidades que no tienen depósito asignado
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="deposito_direccion" class="form-label">Dirección</label>
                                <textarea class="form-control" id="deposito_direccion" rows="2"
                                          placeholder="Dirección completa del depósito"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="deposito_activo" checked>
                                    <label class="form-check-label" for="deposito_activo">
                                        Depósito activo
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarDeposito()">
                    <i class="fas fa-save me-2"></i>
                    <span id="btnGuardarDepositoText">Guardar Depósito</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-categoria" id="modalCategoria" tabindex="-1" aria-labelledby="modalCategoriaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCategoriaTitle">
                    <i class="fas fa-tags me-2"></i>Nueva Categoría
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCategoria" novalidate>
                    <input type="hidden" id="categoria_id">
                    
                    <div class="mb-3">
                        <label for="categoria_nombre" class="form-label">
                            <i class="fas fa-tag me-1"></i>
                            Nombre de la Categoría <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="categoria_nombre" 
                               placeholder="Ej: Electrónicos, Hogar, Ropa..." 
                               required 
                               maxlength="255"
                               autocomplete="off">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Ingrese un nombre descriptivo para la categoría (máximo 255 caracteres)
                        </div>
                        <div class="invalid-feedback">
                            Por favor ingrese un nombre válido para la categoría
                        </div>
                    </div>

                    <!-- Estado activo/inactivo -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="categoria_activo" 
                                   checked>
                            <label class="form-check-label" for="categoria_activo">
                                <i class="fas fa-power-off me-1"></i>
                                Categoría activa
                            </label>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Las categorías inactivas no aparecerán en los formularios de mercaderías
                        </div>
                    </div>

                    <!-- Información adicional -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-lightbulb me-2"></i>Información sobre Categorías
                        </h6>
                        <small>
                            • Las categorías ayudan a organizar y clasificar las mercaderías<br>
                            • Cada mercadería debe estar asignada a una categoría<br>
                            • Los nombres de categoría deben ser únicos en el sistema<br>
                            • Al desactivar una categoría, no se podrán asignar nuevas mercaderías
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarCategoria()">
                    <i class="fas fa-save me-2"></i>
                    <span id="btnGuardarCategoriaText">Guardar Categoría</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 🏗️ MODAL: Ver Stock del Depósito -->
<div class="modal fade" id="modalStockDeposito" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalStockTitle">Stock del Depósito</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Mercadería</th>
                                <th>SKU</th>
                                <th>Cantidad</th>
                                <th>Stock Mínimo</th>
                                <th>Precio Unit.</th>
                                <th>Valor Total</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-stock-deposito">
                            <tr>
                                <td colspan="7" class="text-center">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row mb-3" id="botones-exportacion-stock">
    <div class="col-md-8">
        <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-success btn-sm" onclick="exportarStockExcel()">
                <i class="fas fa-file-excel me-1"></i>Exportar Excel
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="exportarStockPDF()">
                <i class="fas fa-file-pdf me-1"></i>Exportar PDF
            </button>
            <button type="button" class="btn btn-info btn-sm" onclick="actualizarStockDeposito()">
                <i class="fas fa-sync me-1"></i>Actualizar
            </button>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-1"></i>Más opciones
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportarStockCSV()">
                        <i class="fas fa-file-csv me-2"></i>Exportar CSV
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="imprimirListaStock()">
                        <i class="fas fa-print me-2"></i>Lista para Imprimir
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="exportarStockCompleto()">
                        <i class="fas fa-file-archive me-2"></i>Reporte Completo
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <small class="text-muted">
            <i class="fas fa-clock me-1"></i>
            <span id="timestamp-stock">Última actualización: --:--</span>
        </small>
    </div>
</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Orden de Transferencia -->
<div class="modal fade" id="modalNuevaOrden" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Nueva Orden de Transferencia
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNuevaOrden">
                <div class="modal-body">
                    <!-- Información general -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Depósito Origen *</label>
                            <select class="form-select" id="nuevo_origen" required>
                                <option value="">Seleccionar origen...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Depósito Destino *</label>
                            <select class="form-select" id="nuevo_destino" required>
                                <option value="">Seleccionar destino...</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="nuevo_observaciones" rows="2" 
                                      placeholder="Comentarios adicionales..."></textarea>
                        </div>
                    </div>

                    <!-- Items de la orden -->
                    <div class="border rounded p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Items de la Orden</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarItemOrden()">
                                <i class="fas fa-plus me-1"></i>
                                Agregar Item
                            </button>
                        </div>
                        <div id="itemsOrden">
                            <!-- Los items se agregarán dinámicamente aquí -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        Crear Orden
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Detalles de Orden -->
<div class="modal fade" id="modalDetallesOrden" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>
                    Detalles de Orden <span id="detalle_numero_orden"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
    <!-- SECCIÓN 1: Información general y cantidades -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>
                        Información General
                    </h6>
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong>Número de Orden:</strong> 
                            <span id="resumen_numero_orden" class="text-primary">-</span>
                        </div>
                        <div class="col-12 mb-2">
                            <strong>Estado:</strong> 
                            <span id="resumen_estado_orden">-</span>
                        </div>
                        <div class="col-12 mb-2">
                            <strong>Fecha:</strong> 
                            <span id="resumen_fecha_orden">-</span>
                        </div>
                        <div class="col-12 mb-2">
                            <strong>Origen:</strong> 
                            <span id="resumen_deposito_origen">-</span>
                        </div>
                        <div class="col-12">
                            <strong>Destino:</strong> 
                            <span id="resumen_deposito_destino">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-calculator me-2"></i>
                        Resumen de Cantidades
                    </h6>
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong>Total Items:</strong> 
                            <span id="resumen_total_items" class="badge bg-primary">0</span>
                        </div>
                        <div class="col-12 mb-2">
                            <strong>Cantidad Solicitada:</strong> 
                            <span id="resumen_cantidad_solicitada" class="fw-bold">0</span>
                        </div>
                        <div class="col-12 mb-2">
                            <strong>Cantidad Enviada:</strong> 
                            <span id="resumen_cantidad_enviada" class="fw-bold text-success">0</span>
                        </div>
                        <div class="col-12">
                            <strong>Cantidad Pendiente:</strong> 
                            <span id="resumen_cantidad_pendiente" class="fw-bold text-warning">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 2: Progreso general -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-chart-line me-2"></i>
                        Progreso General
                    </h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Completado</span>
                        <span id="resumen_porcentaje" class="fw-bold">0%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div id="barra_progreso_orden" 
                             class="progress-bar bg-secondary" 
                             role="progressbar" 
                             style="width: 0%" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 3: Estadísticas visuales -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-chart-pie me-2"></i>
                        Estado de Items
                    </h6>
                    <div id="estadisticas_visuales">
                        <!-- Se llena dinámicamente con la función JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 4: Tabla de detalles (tu código existente de la tabla) -->
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Detalles de Items
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Producto</th>
                            <th>Solicitado</th>
                            <th>Enviado</th>
                            <th>Pendiente</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaDetalleItems">
                        <!-- Se llena dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
            

            <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
    <button type="button" class="btn btn-warning" id="btnCancelarOrden" onclick="cancelarOrden()">
                    <i class="fas fa-ban me-1"></i>
                    Cancelar Orden
                </button>
   
    <button type="button" 
            class="btn btn-primary" 
            onclick="generarDocumentoOrden(ordenActual?.orden?.id)">
        <i class="fas fa-file-alt me-1"></i>
        Documento Completo
    </button>
    
    <button type="button" 
            class="btn btn-success" 
            onclick="generarListaPreparacion(ordenActual?.orden?.id)">
        <i class="fas fa-clipboard-list me-1"></i>
        Lista Preparación
    </button>
</div>
        </div>
    </div>
</div>

<!-- Modal Envío Parcial -->
<div class="modal fade" id="modalEnvioParcial" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shipping-fast me-2"></i>
                    Envío Parcial
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEnvioParcial">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Mercadería</label>
                        <input type="text" class="form-control" id="envio_mercaderia" readonly>
                        <input type="hidden" id="envio_detalle_id">
                        <input type="hidden" id="envio_orden_id">
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Cantidad Solicitada</label>
                            <input type="number" class="form-control" id="envio_solicitada" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ya Enviado</label>
                            <input type="number" class="form-control" id="envio_enviada" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cantidad Pendiente</label>
                            <input type="number" class="form-control" id="envio_pendiente" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cantidad a Enviar *</label>
                            <input type="number" class="form-control" id="envio_cantidad" required min="0.01" step="0.01">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Número de Documento</label>
                        <input type="text" class="form-control" id="envio_documento" 
                               placeholder="Ej: ENV-001, GUIA-123...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane me-1"></i>
                        Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- NUEVO MODAL PARA CREAR/EDITAR ZONAS -->
<div class="modal fade modal-zona" id="modalZona" tabindex="-1" aria-labelledby="modalZonaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalZonaTitle">
                    <i class="fas fa-map-marker-alt me-2"></i>Nueva Zona
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formZona" novalidate>
                    <input type="hidden" id="zona_id">
                    
                    <div class="mb-3">
                        <label for="zona_nombre" class="form-label">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            Nombre de la Zona <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="zona_nombre" 
                               placeholder="Ej: Centro, Norte, Sur, Oeste..." 
                               required 
                               maxlength="255"
                               autocomplete="off">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Ingrese un nombre descriptivo para la zona (máximo 255 caracteres)
                        </div>
                        <div class="invalid-feedback">
                            Por favor ingrese un nombre válido para la zona
                        </div>
                    </div>

                    <!-- Estado activo/inactivo -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="zona_activo" 
                                   checked>
                            <label class="form-check-label" for="zona_activo">
                                <i class="fas fa-power-off me-1"></i>
                                Zona activa
                            </label>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Las zonas inactivas no aparecerán en los formularios de clientes
                        </div>
                    </div>

                    <!-- Información adicional -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-lightbulb me-2"></i>Información sobre Zonas
                        </h6>
                        <small>
                            • Las zonas ayudan a organizar y agrupar clientes por ubicación geográfica<br>
                            • Cada cliente puede estar asignado a una zona<br>
                            • Los nombres de zona deben ser únicos en el sistema<br>
                            • Al desactivar una zona, no se podrán asignar nuevos clientes
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarZona()">
                    <i class="fas fa-save me-2"></i>
                    <span id="btnGuardarZonaText">Guardar Zona</span>
                </button>
            </div>
        </div>
    </div>
</div>

    <div class="modal fade" id="modalVendedor" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalVendedorTitle">Nuevo Vendedor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formVendedor">
                    <input type="hidden" id="vendedor_id" name="vendedor_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="razonSocial" class="form-label">Razón Social *</label>
                                <input type="text" class="form-control" id="razonSocial" name="razonSocial" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cuit" class="form-label">CUIT *</label>
                                <input type="text" class="form-control" id="cuit" name="cuit" required placeholder="XX-XXXXXXXX-X">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="condicionIVA" class="form-label">Condición IVA</label>
                                <select class="form-select" id="condicionIVA" name="condicionIVA">
                                    <option value="">Seleccionar...</option>
                                    <option value="Responsable Inscripto">Responsable Inscripto</option>
                                    <option value="Monotributo">Monotributo</option>
                                    <option value="Exento">Exento</option>
                                    <option value="Consumidor Final">Consumidor Final</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="telefono" name="telefono">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="codigoPostal" class="form-label">Código Postal</label>
                                <input type="text" class="form-control" id="codigoPostal" name="codigoPostal">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="domicilio" class="form-label">Domicilio</label>
                        <textarea class="form-control" id="domicilio" name="domicilio" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="localidad" class="form-label">Localidad</label>
                                <input type="text" class="form-control" id="localidad" name="localidad">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="provincia" class="form-label">Provincia</label>
                                <input type="text" class="form-control" id="provincia" name="provincia">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="tiene_deposito" name="tiene_deposito" checked>
                            <label class="form-check-label" for="tiene_deposito">
                                Tiene depósito propio
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarVendedor()">
                    <i class="fas fa-save me-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalProveedor" tabindex="-1" aria-labelledby="modalProveedorTitle" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <!-- Cambié a modal-xl para más espacio -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalProveedorTitle">Nuevo Proveedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formProveedor">
                <input type="hidden" id="proveedor_id" name="proveedor_id" value="">
                
                <div class="modal-body">
                    <!-- Información Básica -->
                    <div class="row g-3">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="fas fa-building me-2"></i>Información Básica</h6>
                            <hr>
                        </div>
                        
                        <div class="col-md-8">
                            <label for="proveedor_razonSocial" class="form-label">
                                Razón Social <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="proveedor_razonSocial" 
                                   name="razonSocial" required maxlength="255"
                                   placeholder="Razón social del proveedor">
                            <div class="invalid-feedback">
                                La razón social es requerida
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="proveedor_cuit" class="form-label">CUIT</label>
                            <input type="text" class="form-control" id="proveedor_cuit" 
                                   name="cuit" maxlength="20"
                                   placeholder="30-12345678-9">
                        </div>

                        <!-- NUEVO CAMPO: Condición IVA -->
                        <div class="col-md-6">
                            <label for="proveedor_condicionIVA" class="form-label">
                                Condición IVA <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="proveedor_condicionIVA" 
                                    name="condicionIVA" required>
                                <option value="">Seleccionar condición...</option>
                                <option value="Responsable Inscripto">Responsable Inscripto</option>
                                <option value="Exento">Exento</option>
                                <option value="Monotributo">Monotributo</option>
                                <option value="No Responsable">No Responsable</option>
                                <option value="Consumidor Final">Consumidor Final</option>
                            </select>
                            <div class="invalid-feedback">
                                La condición IVA es requerida
                            </div>
                        </div>

                        <!-- NUEVO CAMPO: Contacto -->
                        <div class="col-md-6">
                            <label for="proveedor_contacto" class="form-label">
                                Persona de Contacto 
                            </label>
                            <input type="text" class="form-control" id="proveedor_contacto" 
                                   name="contacto"  maxlength="100"
                                   placeholder="Nombre del contacto principal">
                            <div class="invalid-feedback">
                                El contacto es requerido
                            </div>
                        </div>
                    </div>

                    <!-- Información de Contacto -->
                    <div class="row g-3 mt-2">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="fas fa-phone me-2"></i>Información de Contacto</h6>
                            <hr>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="proveedor_telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="proveedor_telefono" 
                                   name="telefono" maxlength="50"
                                   placeholder="+54 261 123-4567">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="proveedor_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="proveedor_email" 
                                   name="email" maxlength="255"
                                   placeholder="contacto@proveedor.com">
                        </div>

                        <!-- NUEVO CAMPO: Sitio Web -->
                        <div class="col-md-12">
                            <label for="proveedor_sitioWeb" class="form-label">
                                Sitio Web 
                            </label>
                            <input type="url" class="form-control" id="proveedor_sitioWeb" 
                                   name="sitioWeb"  maxlength="255"
                                   placeholder="https://www.proveedor.com">
                            <div class="invalid-feedback">
                                El sitio web es requerido y debe tener formato válido
                            </div>
                        </div>
                    </div>

                    <!-- Información de Ubicación -->
                    <div class="row g-3 mt-2">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="fas fa-map-marker-alt me-2"></i>Información de Ubicación</h6>
                            <hr>
                        </div>
                        
                        <div class="col-12">
                            <label for="proveedor_domicilio" class="form-label">Domicilio</label>
                            <textarea class="form-control" id="proveedor_domicilio" 
                                      name="domicilio" rows="2" maxlength="500"
                                      placeholder="Dirección completa del proveedor"></textarea>
                        </div>

                        <!-- NUEVO CAMPO: Localidad -->
                        <div class="col-md-4">
                            <label for="proveedor_localidad" class="form-label">
                                Localidad 
                            </label>
                            <input type="text" class="form-control" id="proveedor_localidad" 
                                   name="localidad"  maxlength="255"
                                   placeholder="Ciudad o localidad">
                            <div class="invalid-feedback">
                                La localidad es requerida
                            </div>
                        </div>

                        <!-- NUEVO CAMPO: Provincia -->
                        <div class="col-md-4">
                            <label for="proveedor_provincia" class="form-label">
                                Provincia <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="proveedor_provincia" 
                                    name="provincia" required>
                                <option value="">Seleccionar provincia...</option>
                                <option value="Buenos Aires">Buenos Aires</option>
                                <option value="Catamarca">Catamarca</option>
                                <option value="Chaco">Chaco</option>
                                <option value="Chubut">Chubut</option>
                                <option value="Ciudad Autónoma de Buenos Aires">CABA</option>
                                <option value="Córdoba">Córdoba</option>
                                <option value="Corrientes">Corrientes</option>
                                <option value="Entre Ríos">Entre Ríos</option>
                                <option value="Formosa">Formosa</option>
                                <option value="Jujuy">Jujuy</option>
                                <option value="La Pampa">La Pampa</option>
                                <option value="La Rioja">La Rioja</option>
                                <option value="Mendoza">Mendoza</option>
                                <option value="Misiones">Misiones</option>
                                <option value="Neuquén">Neuquén</option>
                                <option value="Río Negro">Río Negro</option>
                                <option value="Salta">Salta</option>
                                <option value="San Juan">San Juan</option>
                                <option value="San Luis">San Luis</option>
                                <option value="Santa Cruz">Santa Cruz</option>
                                <option value="Santa Fe">Santa Fe</option>
                                <option value="Santiago del Estero">Santiago del Estero</option>
                                <option value="Tierra del Fuego">Tierra del Fuego</option>
                                <option value="Tucumán">Tucumán</option>
                            </select>
                            <div class="invalid-feedback">
                                La provincia es requerida
                            </div>
                        </div>

                        <!-- NUEVO CAMPO: Código Postal -->
                        <div class="col-md-4">
                            <label for="proveedor_codigoPostal" class="form-label">
                                Código Postal 
                            </label>
                            <input type="text" class="form-control" id="proveedor_codigoPostal" 
                                   name="codigoPostal"  maxlength="10"
                                   placeholder="5500"
                                   pattern="[0-9]{4,8}">
                            <div class="invalid-feedback">
                                El código postal es requerido (solo números)
                            </div>
                        </div>
                    </div>

                    <!-- Estado -->
                    <div class="row g-3 mt-2">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="fas fa-cog me-2"></i>Configuración</h6>
                            <hr>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       id="proveedor_activo" name="activo" checked>
                                <label class="form-check-label" for="proveedor_activo">
                                    <strong>Proveedor Activo</strong>
                                    <small class="text-muted d-block">Determina si el proveedor está disponible</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Información de validación -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Los campos marcados con <span class="text-danger">*</span> son obligatorios.
                                    El CUIT se validará automáticamente y debe ser único en el sistema.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Guardar Proveedor
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Estadísticas Proveedor -->
<div class="modal fade" id="modalEstadisticasProveedor" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Estadísticas del Proveedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="contenidoEstadisticasProveedor">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación Proveedor -->
<div class="modal fade" id="modalConfirmarEliminacionProveedor" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>¿Está seguro de que desea eliminar este proveedor?</strong>
                </div>
                <p class="mb-1"><strong>Proveedor:</strong> <span id="proveedor-eliminar-nombre"></span></p>
                <p class="mb-3"><strong>CUIT:</strong> <span id="proveedor-eliminar-cuit"></span></p>
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        Esta acción no se puede deshacer. El proveedor y todos sus datos asociados serán eliminados permanentemente.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminacionProveedor">
                    <i class="fas fa-trash"></i> Eliminar Proveedor
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCliente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalClienteTitle">Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCliente" novalidate>
                    <input type="hidden" id="cliente_id" name="cliente_id">
                    
                    <div class="row">
                        <!-- Información Básica -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_razonSocial" class="form-label">
                                    Razón Social <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="cliente_razonSocial" 
                                       name="razonSocial" required minlength="2" maxlength="255"
                                       placeholder="Razón social del cliente">
                                <div class="invalid-feedback">
                                    La razón social es requerida (mínimo 2 caracteres)
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_cuit" class="form-label">
                                    CUIT <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="cliente_cuit" 
                                       name="cuit" required pattern="^\d{2}-\d{8}-\d{1}$|^\d{11}$"
                                       placeholder="XX-XXXXXXXX-X" maxlength="13">
                                <div class="invalid-feedback">
                                    CUIT requerido en formato XX-XXXXXXXX-X
                                </div>
                                <div class="form-text">
                                    Se formateará automáticamente mientras escribes
                                </div>
                            </div>
                        </div>

                        <!-- Vendedor y Zona -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_vendedorId" class="form-label">
                                    Vendedor <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="cliente_vendedorId" 
                                        name="vendedorId" required>
                                    <option value="">Seleccionar vendedor...</option>
                                </select>
                                <div class="invalid-feedback">
                                    Debe seleccionar un vendedor
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_zonaId" class="form-label">
                                    Zona <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="cliente_zonaId" 
                                        name="zonaId" required>
                                    <option value="">Seleccionar zona...</option>
                                </select>
                                <div class="invalid-feedback">
                                    Debe seleccionar una zona
                                </div>
                            </div>
                        </div>

                        <!-- Condición IVA -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_condicionIVA" class="form-label">Condición IVA</label>
                                <select class="form-select" id="cliente_condicionIVA" name="condicionIVA">
                                    <option value="">Seleccionar...</option>
                                    <option value="Responsable Inscripto">Responsable Inscripto</option>
                                    <option value="Monotributo">Monotributo</option>
                                    <option value="Exento">Exento</option>
                                    <option value="Consumidor Final">Consumidor Final</option>
                                    <option value="No Responsable">No Responsable</option>
                                </select>
                            </div>
                        </div>

                        <!-- Depósito -->
                        <div class="col-md-6">
                            <div class="mb-3 d-flex align-items-center">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" 
                                           id="cliente_tiene_deposito" name="tiene_deposito">
                                    <label class="form-check-label" for="cliente_tiene_deposito">
                                        Tiene depósito propio
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Información de Contacto -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">Información de Contacto</h6>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="cliente_email" 
                                       name="email" maxlength="255"
                                       placeholder="cliente@ejemplo.com">
                                <div class="invalid-feedback">
                                    Email debe tener un formato válido
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="cliente_telefono" 
                                       name="telefono" maxlength="50"
                                       placeholder="Ej: (011) 1234-5678">
                            </div>
                        </div>

                        <!-- Información de Dirección -->
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">Dirección</h6>
                        </div>

                        <div class="col-12">
                            <div class="mb-3">
                                <label for="cliente_domicilio" class="form-label">Domicilio</label>
                                <textarea class="form-control" id="cliente_domicilio" 
                                          name="domicilio" rows="2" maxlength="500"
                                          placeholder="Calle, número, piso, departamento..."></textarea>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="cliente_localidad" class="form-label">Localidad</label>
                                <input type="text" class="form-control" id="cliente_localidad" 
                                       name="localidad" maxlength="100"
                                       placeholder="Localidad">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="cliente_provincia" class="form-label">Provincia</label>
                                <select class="form-select" id="cliente_provincia" name="provincia">
                                    <option value="">Seleccionar...</option>
                                    <option value="Buenos Aires">Buenos Aires</option>
                                    <option value="CABA">CABA</option>
                                    <option value="Catamarca">Catamarca</option>
                                    <option value="Chaco">Chaco</option>
                                    <option value="Chubut">Chubut</option>
                                    <option value="Córdoba">Córdoba</option>
                                    <option value="Corrientes">Corrientes</option>
                                    <option value="Entre Ríos">Entre Ríos</option>
                                    <option value="Formosa">Formosa</option>
                                    <option value="Jujuy">Jujuy</option>
                                    <option value="La Pampa">La Pampa</option>
                                    <option value="La Rioja">La Rioja</option>
                                    <option value="Mendoza">Mendoza</option>
                                    <option value="Misiones">Misiones</option>
                                    <option value="Neuquén">Neuquén</option>
                                    <option value="Río Negro">Río Negro</option>
                                    <option value="Salta">Salta</option>
                                    <option value="San Juan">San Juan</option>
                                    <option value="San Luis">San Luis</option>
                                    <option value="Santa Cruz">Santa Cruz</option>
                                    <option value="Santa Fe">Santa Fe</option>
                                    <option value="Santiago del Estero">Santiago del Estero</option>
                                    <option value="Tierra del Fuego">Tierra del Fuego</option>
                                    <option value="Tucumán">Tucumán</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="cliente_codigoPostal" class="form-label">Código Postal</label>
                                <input type="text" class="form-control" id="cliente_codigoPostal" 
                                       name="codigoPostal" maxlength="10"
                                       placeholder="1234">
                            </div>
                        </div>
                    </div>

                    <!-- Información de validación -->
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Los campos marcados con <span class="text-danger">*</span> son obligatorios.
                                    El CUIT se validará automáticamente y debe ser único en el sistema.
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarCliente()">
                    <i class="fas fa-save me-2"></i>
                    <span id="btnGuardarClienteText">Guardar Cliente</span>
                </button>
            </div>
        </div>
    </div>
</div>



    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
   
        // Variables globales
        const API_BASE_URL = '/api/v1';
        let currentPage = 'dashboard';
        let authToken = null;
        let dashboardData = {};
        let mercaderias = [];
        let categorias = [];
        // Variable global para vendedores
        let vendedores = [];
        let clientes = [];
        let zonas = [];
        let clientesFiltrados = [];
        let vendedoresParaFiltro = [];
        let zonasParaFiltro = [];
let depositos = [];
let depositosFiltrados = [];
let isEditingDeposito = false;
let filtroStockTimeout = null;
let alertasSeleccionadas = [];
let reportesData = {};

let stockGeneral = [];
let stockFiltrado = [];
let alertasStock = [];
let movimientosStock = [];
let depositosDisponibles = [];
let mercaderiasDisponibles = [];
let stockPaginaActual = 1;
let stockTotalPaginas = 1;
let stockLimitePorPagina = 50;

let mercaderiaSeleccionada = null;
let proveedoresMercaderia = [];
let todosLosProveedores = [];
let editandoRelacion = null;
let categoriasMercaderias = [];
// Variables para control de carga
let cargandoMercaderias = false;
let cargandoPagina = false;
let paginaActual = '';


let proveedores = [];

let zonasFiltradas = [];
let paginaActualZonas = 1;
const zonasPorPagina = 10;


let isSpinnerShowing = false;
let spinnerShowTimeout = null;
let spinnerHideTimeout = null;

// Variables globales para compras
let comprasData = {
    proveedores: [],
    mercaderiasDisponibles: [],
    depositosDisponibles: [],
    comprasRecientes: []
};


let categoriasFiltradas = [];
let paginaActualCategorias = 1;
let categoriasPorPagina = 15;
// =============================================
// VARIABLES GLOBALES TRANSFERENCIAS
// =============================================
let transferenciasData = [];
let ordenActual = null;
let itemOrdenCounter = 0;

let autocompleteInstances = {};

// Variables globales para QZ Tray
let qzTrayReady = false;
let qzTrayConfig = null;
let impresoresQZ = [];



// =============================================
// 💾 SISTEMA DE PERSISTENCIA DE FILTROS
// =============================================

class FiltrosPersistentes {
    constructor(modulo) {
        this.modulo = modulo; // 'clientes', 'proveedores', 'mercaderias'
        this.storageKey = `filtros_${modulo}`;
    }

    // Guardar filtros en localStorage
    guardarFiltros(filtros) {
        try {
            localStorage.setItem(this.storageKey, JSON.stringify(filtros));
            console.log(`✅ Filtros guardados para ${this.modulo}:`, filtros);
        } catch (error) {
            console.error('Error guardando filtros:', error);
        }
    }

    // Recuperar filtros desde localStorage
    recuperarFiltros() {
        try {
            const filtrosGuardados = localStorage.getItem(this.storageKey);
            return filtrosGuardados ? JSON.parse(filtrosGuardados) : {};
        } catch (error) {
            console.error('Error recuperando filtros:', error);
            return {};
        }
    }

    // Limpiar filtros guardados
    limpiarFiltrosGuardados() {
        localStorage.removeItem(this.storageKey);
        console.log(`🗑️ Filtros limpiados para ${this.modulo}`);
    }

    // Aplicar filtros guardados a los elementos del DOM
    aplicarFiltrosGuardados() {
        const filtros = this.recuperarFiltros();
        
        Object.keys(filtros).forEach(filtroId => {
            const elemento = document.getElementById(filtroId);
            if (elemento && filtros[filtroId] !== undefined) {
                if (elemento.type === 'checkbox') {
                    elemento.checked = filtros[filtroId];
                } else {
                    elemento.value = filtros[filtroId];
                }
            }
        });

        return filtros;
    }
}

// 🆕 FUNCIÓN AUXILIAR: Aplicar filtros guardados
function aplicarFiltrosGuardados(filtros) {
    try {
        console.log('🔧 Aplicando filtros guardados:', filtros);
        
        // Restaurar valores en el DOM
        if (document.getElementById('filtro-busqueda')) {
            document.getElementById('filtro-busqueda').value = filtros.busqueda;
        }
        if (document.getElementById('filtro-categoria')) {
            document.getElementById('filtro-categoria').value = filtros.categoria;
        }
        if (document.getElementById('filtro-stock')) {
            document.getElementById('filtro-stock').value = filtros.stock;
        }
        if (document.getElementById('filtro-activo')) {
            document.getElementById('filtro-activo').value = filtros.activo;
        }
        
        // Verificar si hay filtros activos
        const hayFiltrosActivos = Object.values(filtros).some(valor => 
            valor !== '' && valor !== null && valor !== undefined
        );
        
        if (hayFiltrosActivos) {
            console.log('🎯 Aplicando filtros activos...');
            setTimeout(() => {
                aplicarFiltrosMercaderias();
            }, 50);
        }
        
    } catch (error) {
        console.error('❌ Error aplicando filtros guardados:', error);
    }
}


// =============================================
// 🔧 FUNCIONES MEJORADAS PARA CLIENTES
// =============================================

// Instancia para filtros de clientes
const filtrosClientes = new FiltrosPersistentes('clientes');

// Instancias para otros módulos
const filtrosProveedores = new FiltrosPersistentes('proveedores');
let filtrosMercaderiasInstance = null;

function getFiltrosMercaderias() {
    if (!filtrosMercaderiasInstance) {
        filtrosMercaderiasInstance = new FiltrosPersistentes('mercaderias');
        console.log('✅ Instancia filtrosMercaderias creada');
    }
    return filtrosMercaderiasInstance;
}

// Función mejorada para aplicar filtros de clientes
async function aplicarFiltrosClientes(guardarEnStorage = true) {
    const busqueda = document.getElementById('filtro-clientes-busqueda')?.value || '';
    const vendedor = document.getElementById('filtro-clientes-vendedor')?.value || '';
    const zona = document.getElementById('filtro-clientes-zona')?.value || '';
    const activo = document.getElementById('filtro-clientes-activo')?.value || '';
    const deposito = document.getElementById('filtro-clientes-deposito')?.value || '';
    const iva = document.getElementById('filtro-clientes-iva')?.value || '';
    
    // Guardar filtros si se solicita
    if (guardarEnStorage) {
        const filtrosActuales = {
            'filtro-clientes-busqueda': busqueda,
            'filtro-clientes-vendedor': vendedor,
            'filtro-clientes-zona': zona,
            'filtro-clientes-activo': activo,
            'filtro-clientes-deposito': deposito,
            'filtro-clientes-iva': iva
        };
        filtrosClientes.guardarFiltros(filtrosActuales);
    }
    
    try {
        const params = new URLSearchParams();
        if (busqueda) params.append('search', busqueda);
        if (vendedor) params.append('vendedorId', vendedor);
        if (zona) params.append('zona', zona);
        if (activo !== '') params.append('activo', activo);
        if (deposito !== '') params.append('tiene_deposito', deposito);
        if (iva) params.append('iva', iva);
        
        const url = `/clientes${params.toString() ? '?' + params.toString() : ''}`;
        const response = await apiRequest(url);
        
        if (response.success) {
            clientes = response.data;
            renderTablaClientes();
            
            const totalResults = clientes.length;
            actualizarContadorFiltrosClientes(totalResults);
            actualizarInfoFiltrosClientes(busqueda, vendedor, zona, activo, deposito, iva);
            
            console.log(`🔍 Filtros aplicados: ${totalResults} cliente(s)`);
        } else {
            showAlert('Error al aplicar filtros', 'danger');
        }
        
    } catch (error) {
        console.error('Error aplicando filtros de clientes:', error);
        showAlert('Error al aplicar filtros', 'danger');
    }
}

// Función mejorada para limpiar filtros de clientes
function limpiarFiltrosClientes() {
    // Limpiar campos del DOM
    document.getElementById('filtro-clientes-busqueda').value = '';
    document.getElementById('filtro-clientes-vendedor').value = '';
    document.getElementById('filtro-clientes-zona').value = '';
    document.getElementById('filtro-clientes-activo').value = '';
    document.getElementById('filtro-clientes-deposito').value = '';
    document.getElementById('filtro-clientes-iva').value = '';
    
    // Limpiar localStorage
    filtrosClientes.limpiarFiltrosGuardados();
    
    // Recargar todos los clientes
    loadClientes();
    
    showAlert('Filtros limpiados', 'info');
}

// Función para restaurar filtros al cargar la página
function restaurarFiltrosClientes() {
    const filtrosGuardados = filtrosClientes.aplicarFiltrosGuardados();
    
    // Si hay filtros guardados, aplicarlos
    if (Object.keys(filtrosGuardados).length > 0) {
        console.log('🔄 Restaurando filtros de clientes...');
        // Aplicar filtros sin volver a guardar en storage
        setTimeout(() => aplicarFiltrosClientes(false), 500);
    }
}
/******************************************/



        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners de navegación
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    showPage(page);
                });
            });

            // Sidebar toggle para móviles
            document.getElementById('toggleSidebar')?.addEventListener('click', function() {
                document.querySelector('.sidebar').classList.toggle('show');
            });

            // Cargar datos iniciales
            loadDashboard();
            cargarCategorias();
            console.log('🔧 DOM cargado - cargando configuración inicial...');
    
    // Esperar un momento para que todo esté listo
    setTimeout(async () => {
        try {
            const response = await apiRequest('/etiquetas/configuracion');
            if (response.success) {
                configImpresora = response.data;  // ← PRIMERA ASIGNACIÓN
                console.log('✅ configImpresora cargada inicialmente:', configImpresora);
                actualizarEstadoImpresora();
            }
        } catch (error) {
            console.error('Error carga inicial:', error);
            // Asignar configuración por defecto
            configImpresora = crearConfiguracionPorDefecto();
        }
    }, 1000);
        });

        // Navegación
        function showPage(pageName) {
            // Actualizar navegación activa
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

            // Mostrar página
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageName).classList.add('active');

            // Actualizar título
            const titles = {
                dashboard: 'Dashboard',
                mercaderias: 'Gestión de Mercaderías',
                depositos: 'Gestión de Depósitos',
                stock: 'Control de Stock',
                transferencias: 'Órdenes de Transferencia',
                movimientos: 'Movimientos de Stock',
                clientes: 'Gestión de Clientes',
                vendedores: 'Gestión de Vendedores',
                proveedores: 'Gestión de Proveedores',
                zonas: 'Gestión de Zonas',
                etiquetas: 'Generación de Etiquetas',
                reportes: 'Reportes y Análisis'
            };
            document.getElementById('pageTitle').textContent = titles[pageName] || pageName;

            currentPage = pageName;

            // Cargar datos específicos de la página
            switch(pageName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'mercaderias':
                    loadMercaderias();
                    renderTablaMercaderias(); // Se renderiza automáticamente

                    break;
                case 'depositos':
                    loadDepositos();
                    break;
                case 'stock':
                    loadStock();
                    break;
                case 'transferencias':
                    loadTransferencias();
                    break;
                case 'movimientos':
                    loadMetricasMovimientosHoy();
                    filtrarMovimientos(); //
                    break;
                case 'clientes':
                    loadClientes();
                    break;
                case 'vendedores':
                    loadVendedores();
                    break;
                case 'proveedores':
                    loadProveedores();
                    break;
                case 'zonas':
                    cargarZonas();
                    break;
                case 'etiquetas':
                    loadEtiquetas();
                    break;
                case 'reportes':
                    loadReportes();
                    break;
            }
        }

        // Funciones de API
        async function apiRequest(endpoint, method = 'GET', data = null, options = {}) {
    const url = `${API_BASE_URL}${endpoint}`;
    const config = {
        method,
        headers: {
            'Content-Type': 'application/json',
            ...(authToken && { 'Authorization': `Bearer ${authToken}` })
        },
        ...(data && { body: JSON.stringify(data) }),
        ...options
    };
    
    try {
        const response = await fetch(url, config);
        const responseData = await response.json();
        if (!response.ok) {
            throw new Error(responseData.message || 'Error en la solicitud');
        }
        return responseData;
    } catch (error) {
        console.error('API Error:', error);
        showAlert('Error: ' + error.message, 'danger');
        throw error;
    }
}

        // Dashboard
        async function loadDashboard() {
    try {
        const response = await apiRequest('/reportes/dashboard');
        dashboardData = response.data;

        // Métricas del dashboard principal
        document.getElementById('totalMercaderias').textContent = dashboardData.metricas.total_mercaderias;
        document.getElementById('totalDepositos').textContent = dashboardData.metricas.total_depositos;
        document.getElementById('stockBajo').textContent = dashboardData.metricas.stock_bajo;
        document.getElementById('transferenciasPendientes').textContent = dashboardData.metricas.transferencias_pendientes;
        document.getElementById('alertasCount').textContent = dashboardData.metricas.stock_bajo;

        // ✅ MÉTRICAS SUPERIORES DE MOVIMIENTOS (LAS QUE FALTABAN)
        document.getElementById('total-movimientos-hoy').textContent = dashboardData.metricas.movimientos_hoy || 0;
        
        // Para las otras métricas necesitas obtenerlas del backend o calcularlas
        // Si no están disponibles en el backend, puedes hacer llamadas adicionales:
        
        // Opción A: Si ya están en dashboardData.metricas
        document.getElementById('ingresos-hoy').textContent = dashboardData.metricas.ingresos_hoy || '-';
        document.getElementById('salidas-hoy').textContent = dashboardData.metricas.salidas_hoy || '-';
        document.getElementById('valor-movido').textContent = dashboardData.metricas.valor_movido_hoy || '-';

        // Opción B: Si necesitas calcularlas por separado
        await loadMetricasMovimientosHoy();

        // Cargar últimos movimientos
        loadUltimosMovimientos(dashboardData.ultimos_movimientos);

    } catch (error) {
        console.error('Error cargando dashboard:', error);
        
        // En caso de error, mostrar valores por defecto
        document.getElementById('total-movimientos-hoy').textContent = '0';
        document.getElementById('ingresos-hoy').textContent = '0';
        document.getElementById('salidas-hoy').textContent = '0';
        document.getElementById('valor-movido').textContent = '$0';
        
        // Datos de prueba para desarrollo
        loadDashboardDemo();
    }
}

        function loadDashboardDemo() {
            document.getElementById('totalMercaderias').textContent = '150';
            document.getElementById('totalDepositos').textContent = '8';
            document.getElementById('stockBajo').textContent = '12';
            document.getElementById('transferenciasPendientes').textContent = '5';
            document.getElementById('alertasCount').textContent = '12';

            const movimientosDemo = [
                { fecha_movimiento: '2024-01-15', tipo_movimiento: 'COMPRA', mercaderia: 'Producto A', cantidad: 10, deposito: 'Central' },
                { fecha_movimiento: '2024-01-14', tipo_movimiento: 'TRANSFERENCIA', mercaderia: 'Producto B', cantidad: 5, deposito: 'Vendedor 1' }
            ];
            loadUltimosMovimientos(movimientosDemo);
        }

        async function loadMetricasMovimientosHoy() {
    try {
        const hoy = new Date().toISOString().split('T')[0];
        
        // Llamada específica para obtener métricas detalladas de hoy
        const response = await apiRequest(`/movimientos?fecha_desde=${hoy}&fecha_hasta=${hoy}&include_stats=true`);
        
        if (response.success && response.resumen) {
            const stats = response.resumen;
            
            // Asignar métricas calculadas
            document.getElementById('ingresos-hoy').textContent = stats.ingresos || 0;
            document.getElementById('salidas-hoy').textContent = stats.salidas || 0;
            
            // Formatear valor total
            const valorTotal = stats.valor_total_movimientos || 0;
            document.getElementById('valor-movido').textContent = new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 0
            }).format(valorTotal);
        }
    } catch (error) {
        console.error('Error cargando métricas de movimientos:', error);
        // Mantener valores por defecto si falla
    }
}

        function loadUltimosMovimientos(movimientos) {
            const tbody = document.getElementById('ultimosMovimientos-dashboard');
            if (!movimientos || movimientos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay movimientos recientes</td></tr>';
                return;
            }

            tbody.innerHTML = movimientos.map(mov => `
                <tr>
                    <td>${new Date(mov.fecha_movimiento).toLocaleDateString()}</td>
                    <td><span class="badge bg-primary">${mov.tipo_movimiento}</span></td>
                    <td>${mov.mercaderia}</td>
                    <td>${mov.cantidad}</td>
                    <td>${mov.deposito_destino}</td>
                </tr>
            `).join('');
        }

        // Mercaderías
    async function loadMercaderias() {
    // ⚠️ CRÍTICO: Evitar múltiples cargas simultáneas
    if (cargandoMercaderias) {
        console.log('⚠️ Ya hay una carga de mercaderías en progreso, saltando...');
        return;
    }

    try {
        cargandoMercaderias = true;
        console.log('🔄 Iniciando carga completa de mercaderías...');
        
        // Mostrar spinner SOLO en la tabla
        showElementSpinner('tabla-mercaderias', 'Cargando mercaderías...');
        
        // 🆕 NUEVO: Cargar categorías PRIMERO para los filtros
        await cargarCategoriasParaFiltros();
        
        // Paso 1: Cargar mercaderías básicas
        console.log('📦 1/3 - Cargando datos básicos de mercaderías...');
        const response = await apiRequest('/mercaderias');
        
        if (!response.success || !response.data) {
            throw new Error('No se pudieron cargar las mercaderías');
        }
        
        mercaderias = response.data;
        console.log(`✅ Cargadas ${mercaderias.length} mercaderías básicas`);
        
        // Paso 2: Renderizar tabla INMEDIATAMENTE (sin proveedores)
        console.log('🎨 2/3 - Renderizando tabla básica...');
        renderTablaMercaderias();
        
        // Paso 3: Cargar proveedores EN SEGUNDO PLANO (sin spinner)
        console.log('🚚 3/3 - Cargando información de proveedores en segundo plano...');
        await cargarProveedoresEnSegundoPlano();
        
        // Paso 4: Re-renderizar con información completa
        console.log('🔄 Actualizando tabla con información de proveedores...');
        renderTablaMercaderias();
        
        // Paso 5: Actualizar estadísticas
        console.log('📊 Actualizando estadísticas...');
        if (typeof actualizarEstadisticasMercaderias === 'function') {
            actualizarEstadisticasMercaderias();
        }
        
        // 🆕 NUEVO: Inicializar filtros
        inicializarFiltrosMercaderias();

        setTimeout(() => {
            const filtrosRestaurados = restaurarFiltrosMercaderias();
            if (!filtrosRestaurados && mercaderias) {
                actualizarContadorFiltrosMercaderias(mercaderias.length, mercaderias.length);
            }
        }, 2000); // ⬅️ CAMBIAR de 200 a 2000 milisegundos
        
        console.log('✅ Carga completa de mercaderías finalizada');
        
    } catch (error) {
        console.error('❌ Error cargando mercaderías:', error);
        showAlert('Error al cargar mercaderías: ' + error.message, 'danger');
        
        // Mostrar datos demo en caso de error
        loadMercaderiasDemo();
        
    } finally {
        // ⚠️ CRÍTICO: SIEMPRE ocultar spinner y liberar flag
        //hideElementSpinner('tabla-mercaderias');
        cargandoMercaderias = false;
        console.log('🏁 Proceso de carga finalizado');
    }
}


        function loadMercaderiasDemo() {
            mercaderias = [
                {
                    id: 1,
                    codigo_sku: 'DEMO-001',
                    descripcion: 'Producto Demo 1',
                    precio_venta: 100,
                    stock_total: 50,
                    stock_minimo: 10,
                    categoria: 'Demo',
                    activo: 1,
                    imagen: null
                }
            ];
            renderizarTablaMercaderias();
        }

        function renderizarTablaMercaderias() {
            const tbody = document.getElementById('tabla-mercaderias');
            
            if (mercaderias.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No se encontraron mercaderías</td></tr>';
                return;
            }

            tbody.innerHTML = mercaderias.map(mercaderia => `
                <tr ${!mercaderia.activo ? 'class="table-secondary"' : ''}>
                    <td>
                        ${mercaderia.imagen ? 
                            `<img src="${mercaderia.imagen}" alt="Imagen" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : 
                            `<div style="width: 50px; height: 50px; background-color: #f8f9fa; border: 1px dashed #dee2e6; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-image text-muted"></i>
                            </div>`
                        }
                    </td>
                    <td><strong>${mercaderia.codigo_sku}</strong></td>
                    <td>${mercaderia.descripcion}</td>
                    
                    <td>$${parseFloat(mercaderia.precio_venta || 0).toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                    <td>
                        ${getStockIndicator(mercaderia.stock_total, mercaderia.stock_minimo)}
                        <span>${mercaderia.stock_total || 0}</span>
                    </td>
                    <td>${mercaderia.categoria || 'Sin categoría'}</td>
                    <td>
                        <span class="badge ${mercaderia.activo ? 'bg-success' : 'bg-secondary'}">
                            ${mercaderia.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editarMercaderia(${mercaderia.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="generarEtiqueta(${mercaderia.id})" title="Etiqueta">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="duplicarMercaderia(${mercaderia.id})" title="Duplicar">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStockIndicator(stock, stockMinimo) {
            if (stock === 0) return '<span class="stock-indicator empty"></span>';
            if (stock <= stockMinimo) return '<span class="stock-indicator low"></span>';
            if (stock <= stockMinimo * 2) return '<span class="stock-indicator medium"></span>';
            return '<span class="stock-indicator high"></span>';
        }

        // Stubs para otras funciones de carga
        async function loadDepositos() {
            const tbody = document.getElementById('tabla-depositos');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Datos de depósitos en desarrollo</td></tr>';
        }

        async function loadStock() {
    try {
        console.log('🔄 Iniciando carga de control de stock...');
        
        // Verificar que los elementos del DOM existen
        if (!document.getElementById('tabla-stock-general')) {
            console.warn('⚠️ Elementos de stock no encontrados en el DOM');
            return;
        }
        
        showAlert('Cargando datos de stock...', 'info');
        
        // Cargar datos básicos
        await Promise.all([
            cargarStockGeneral(),
            cargarDepositos(),
            cargarMercaderias(),
            cargarEstadisticasStock()
        ]);
        
        // Configurar event listeners
        configurarEventListeners();
        
        console.log('✅ Control de stock cargado exitosamente');
        showAlert('Datos de stock cargados exitosamente', 'success');
        
    } catch (error) {
        console.error('❌ Error cargando stock:', error);
        showAlert('Error al cargar datos de stock', 'danger');
    }
}
        async function loadTransferencias() {
            const tbody = document.getElementById('tablaTransferencias');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Datos de transferencias en desarrollo</td></tr>';
        }

        async function loadMovimientos() {
            const tbody = document.getElementById('tabla-movimientos-principal');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Datos de movimientos en desarrollo</td></tr>';
        }

        async function loadClientes() {
            const tbody = document.getElementById('tabla-clientes');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Datos de clientes en desarrollo</td></tr>';
        }

        async function loadVendedores() {
            const tbody = document.getElementById('tabla-vendedores');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Datos de vendedores en desarrollo</td></tr>';
        }

        async function loadEtiquetas() {
            // Cargar selectores de mercaderías para etiquetas
            try {
                const response = await apiRequest('/mercaderias');
                const select = document.getElementById('etiqueta-mercaderia');
                select.innerHTML = '<option value="">Seleccionar...</option>';
                response.data.forEach(mercaderia => {
                    const option = document.createElement('option');
                    option.value = mercaderia.id;
                    option.textContent = `${mercaderia.codigo_sku} - ${mercaderia.descripcion}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando mercaderías para etiquetas:', error);
            }
        }

        async function loadReportes() {
            // Página de reportes ya está cargada estáticamente
        }

        // Funciones de mercaderías
        async function cargarCategorias() {
            try {
                const response = await apiRequest('/categorias');
                categorias = response.data;
                llenarSelectCategorias();
            } catch (error) {
                console.error('Error cargando categorías:', error);
                // Categorías demo
                categorias = [
                    { id: 1, descripcion: 'Electrónicos' },
                    { id: 2, descripcion: 'Ropa' },
                    { id: 3, descripcion: 'Hogar' }
                ];
                llenarSelectCategorias();
            }
        }

        function llenarSelectCategorias() {
            const selects = ['id_categoria', 'filtro-categoria'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    categorias.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.id;
                        option.textContent = categoria.categoria;
                        select.appendChild(option);
                    });
                }
            });
        }

        function abrirModalMercaderia() {
    // Limpiar formulario
    document.getElementById('mercaderia_id').value = '';
    document.getElementById('modalMercaderiaTitle').textContent = 'Nueva Mercadería';
    document.getElementById('formMercaderia').reset();
    limpiarPreviews();
    
    // 🔧 AGREGAR ESTA LÍNEA:
    cargarCategoriasEnSelect();  // 👈 NUEVA FUNCIÓN
    
    // Mostrar modal
    new bootstrap.Modal(document.getElementById('modalMercaderia')).show();
}

async function cargarCategoriasEnSelect() {
    try {
        console.log('🔄 Cargando categorías en select...');
        
        const response = await apiRequest('/categorias');
        console.log('📡 Respuesta de /categorias:', response);
        
        if (response.success && response.data) {
            const select = document.getElementById('id_categoria');
            
            if (!select) {
                console.error('❌ Elemento id_categoria no encontrado');
                return;
            }
            
            console.log('✅ Elemento id_categoria encontrado');
            
            // Limpiar y agregar opción por defecto
            select.innerHTML = '<option value="">Seleccionar categoría...</option>';
            
            // Agregar categorías activas
            response.data
                .filter(categoria => categoria.activo == 1)
                .forEach(categoria => {
                    console.log(`  - Agregando categoría: ${categoria.categoria} (ID: ${categoria.id})`);
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    option.textContent = categoria.categoria;
                    select.appendChild(option);
                });
            
            console.log(`✅ ${response.data.length} categorías cargadas exitosamente`);
            
        } else {
            console.error('❌ Error en respuesta:', response?.message || 'Sin datos');
            mostrarCategoriasDemo();
        }
        
    } catch (error) {
        console.error('💥 Error cargando categorías:', error);
        mostrarCategoriasDemo();
    }
}

// 2. FUNCIÓN AUXILIAR PARA CATEGORÍAS DEMO
function mostrarCategoriasDemo() {
    console.log('🔄 Mostrando categorías demo...');
    
    const select = document.getElementById('id_categoria');
    if (select) {
        select.innerHTML = `
            <option value="">Seleccionar categoría...</option>
            <option value="1">Electrónicos</option>
            <option value="2">Herramientas</option>
            <option value="3">Materiales</option>
            <option value="4">Repuestos</option>
            <option value="5">Accesorios</option>
        `;
        console.log('✅ Categorías demo cargadas');
    }
}



// Función para editar mercadería
async function editarMercaderia(id) {
    try {
        // Buscar la mercadería por ID
        const response = await apiRequest(`/mercaderias/${id}`);
        
        if (!response.success) {
            showAlert('Error al cargar la mercadería', 'danger');
            return;
        }
        
        const mercaderia = response.data;
        
        // 🔧 CARGAR CATEGORÍAS ANTES DE LLENAR EL FORMULARIO:
        await cargarCategoriasEnSelect();  // 👈 NUEVA FUNCIÓN
        
        // Llenar el formulario con los datos existentes
        document.getElementById('mercaderia_id').value = mercaderia.id;
        document.getElementById('codigo_sku').value = mercaderia.codigo_sku || '';
        document.getElementById('descripcion').value = mercaderia.descripcion || '';
        document.getElementById('precio_costo').value = mercaderia.precio_costo || 0;
        document.getElementById('precio_venta').value = mercaderia.precio_venta || 0;
        document.getElementById('stock_minimo').value = mercaderia.stock_minimo || 0;
        document.getElementById('unidad_medida').value = mercaderia.unidad_medida || '';
        document.getElementById('id_categoria').value = mercaderia.id_categoria || '';
        
        // Manejar imagen si existe
        if (mercaderia.imagen) {
            document.getElementById('preview-img').src = mercaderia.imagen;
            document.getElementById('image-preview').classList.add('show');
            document.getElementById('btn-eliminar-imagen').style.display = 'block';
        } else {
            limpiarPreviews();
        }
        
        // Cambiar el título del modal
        document.getElementById('modalMercaderiaTitle').textContent = 'Editar Mercadería';
        
        // Mostrar el modal
        new bootstrap.Modal(document.getElementById('modalMercaderia')).show();
        
    } catch (error) {
        console.error('Error editando mercadería:', error);
        showAlert('Error al cargar los datos de la mercadería', 'danger');
    }
}

// Función para duplicar mercadería
async function duplicarMercaderia(id) {
    try {
        if (!confirm('¿Estás seguro de que quieres duplicar esta mercadería?')) {
            return;
        }
        
        const response = await apiRequest(`/mercaderias/${id}/duplicate`, {
            method: 'POST'
        });
        
        if (response.success) {
            showAlert('Mercadería duplicada exitosamente', 'success');
            
            // 🆕 CAMBIO: Usar nueva función que preserva filtros
            await recargarMercaderiasConFiltros();
            
            if (response.data && response.data.id) {
                setTimeout(() => {
                    if (confirm('¿Quieres editar la mercadería duplicada ahora?')) {
                        editarMercaderia(response.data.id);
                    }
                }, 500);
            }
        } else {
            showAlert(response.message || 'Error al duplicar la mercadería', 'danger');
        }
        
    } catch (error) {
        console.error('Error duplicando mercadería:', error);
        showAlert('Error al duplicar la mercadería', 'danger');
    }
}

async function cambiarEstadoMercaderia(id) {
    try {
        const mercaderia = mercaderias.find(m => m.id == id);
        if (!mercaderia) return;

        const accion = mercaderia.activo ? 'desactivar' : 'activar';
        
        if (!confirm(`¿Estás seguro de que quieres ${accion} esta mercadería?`)) {
            return;
        }

        const response = await apiRequest(`/mercaderias/${id}/toggle-active`, {
            method: 'PUT'
        });

        if (response.success) {
            showAlert(`Mercadería ${accion}da exitosamente`, 'success');
            
            // 🆕 CAMBIO: Usar nueva función que preserva filtros
            await recargarMercaderiasConFiltros();
            
        } else {
            showAlert(response.message || `Error al ${accion} la mercadería`, 'danger');
        }
    } catch (error) {
        console.error('Error cambiando estado de mercadería:', error);
        showAlert('Error al cambiar el estado de la mercadería', 'danger');
    }
}

async function guardarMercaderia() {
    const form = document.getElementById('formMercaderia');
    
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    // CLAVE: Detectar si estamos editando o creando
    const mercaderiaId = document.getElementById('mercaderia_id').value;
    const isEditing = mercaderiaId && mercaderiaId !== '';

    const formData = {
        codigo_sku: document.getElementById('codigo_sku').value,
        descripcion: document.getElementById('descripcion').value,
        precio_costo: parseFloat(document.getElementById('precio_costo').value) || 0,
        precio_venta: parseFloat(document.getElementById('precio_venta').value) || 0,
        stock_minimo: parseFloat(document.getElementById('stock_minimo').value) || 0,
        unidad_medida: document.getElementById('unidad_medida').value,
        id_categoria: document.getElementById('id_categoria').value || null
    };

    const previewImg = document.getElementById('preview-img');
    if (previewImg.src && previewImg.src !== window.location.href) {
        formData.imagen = previewImg.src;
    }

    try {
        let response;
        
        if (isEditing) {
            response = await apiRequest(`/mercaderias/${mercaderiaId}`, 'PUT', formData);
            showAlert('Mercadería actualizada exitosamente', 'success');
        } else {
            response = await apiRequest('/mercaderias', 'POST', formData);
            showAlert('Mercadería creada exitosamente', 'success');
        }

        bootstrap.Modal.getInstance(document.getElementById('modalMercaderia')).hide();
        
        // 🆕 SOLUCIÓN: Preservar filtros antes de recargar
        await recargarMercaderiasConFiltros();
        
    } catch (error) {
        console.error('Error guardando mercadería:', error);
        showAlert('Error al guardar la mercadería', 'danger');
    }
}

// 🆕 NUEVA FUNCIÓN: Recargar preservando filtros
async function recargarMercaderiasConFiltros() {
    try {
        console.log('🔄 Recargando mercaderías preservando filtros...');
        
        // 1. Obtener filtros actuales antes de recargar
        const filtrosActuales = obtenerFiltrosActualesMercaderias();
        console.log('💾 Filtros actuales capturados:', filtrosActuales);
        
        // 2. Recargar datos
        await loadMercaderias();
        
        // 3. Aplicar filtros inmediatamente después de cargar
        setTimeout(() => {
            aplicarFiltrosGuardados(filtrosActuales);
        }, 100); // Timeout corto para asegurar que DOM esté actualizado
        
        console.log('✅ Recarga con filtros completada');
        
    } catch (error) {
        console.error('❌ Error recargando con filtros:', error);
        // Fallback: recargar normal
        await loadMercaderias();
    }
}

// 🆕 FUNCIÓN AUXILIAR: Obtener filtros actuales
function obtenerFiltrosActualesMercaderias() {
    return {
        busqueda: document.getElementById('filtro-busqueda')?.value || '',
        categoria: document.getElementById('filtro-categoria')?.value || '',
        stock: document.getElementById('filtro-stock')?.value || '',
        activo: document.getElementById('filtro-activo')?.value || ''
    };
}

        // Funciones de imagen
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (!file.type.match('image.*')) {
                    showAlert('Solo se permiten archivos de imagen', 'danger');
                    input.value = '';
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('La imagen no puede ser mayor a 5MB', 'danger');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').classList.add('show');
                    document.getElementById('btn-eliminar-imagen').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function eliminarImagen() {
            document.getElementById('imagen_input').value = '';
            document.getElementById('preview-img').src = '';
            document.getElementById('image-preview').classList.remove('show');
            document.getElementById('btn-eliminar-imagen').style.display = 'none';
        }

        function limpiarPreviews() {
            eliminarImagen();
        }

       

        

function limpiarFiltrosMercaderias() {
    ['filtro-busqueda', 'filtro-categoria', 'filtro-stock', 'filtro-activo'].forEach(campoId => {
        const elemento = document.getElementById(campoId);
        if (elemento) elemento.value = '';
    });
    
    // 🆕 CAMBIO 9: Limpiar filtros usando getFiltrosMercaderias()
    try {
        const filtrosInstance = getFiltrosMercaderias();
        filtrosInstance.limpiarFiltrosGuardados();
    } catch (error) {
        console.warn('⚠️ No se pudieron limpiar los filtros guardados:', error);
    }
    
    if (mercaderias && Array.isArray(mercaderias)) {
        renderTablaMercaderias();
        actualizarContadorFiltrosMercaderias(mercaderias.length, mercaderias.length);
    }
    
    console.log('🧹 Filtros de mercaderías limpiados');
}

        // Función para generar etiquetas en lote
async function generarEtiquetasLote() {
    try {
        // Verificar que hay mercaderías cargadas
        if (!mercaderias || mercaderias.length === 0) {
            showAlert('No hay mercaderías disponibles para generar etiquetas', 'warning');
            return;
        }

        // Crear el modal dinámicamente si no existe
        if (!document.getElementById('modalEtiquetasLote')) {
            crearModalEtiquetasLote();
        }

        // Limpiar selecciones anteriores
        document.getElementById('lista-mercaderias-etiquetas').innerHTML = '';
        document.getElementById('contador-seleccionadas').textContent = '0';

        // Llenar la lista de mercaderías disponibles
        llenarListaMercaderiasEtiquetas();

        // Mostrar el modal
        new bootstrap.Modal(document.getElementById('modalEtiquetasLote')).show();

    } catch (error) {
        console.error('Error abriendo modal de etiquetas en lote:', error);
        showAlert('Error al abrir el generador de etiquetas', 'danger');
    }
}

// Crear el modal de etiquetas en lote
function crearModalEtiquetasLote() {
    const modalHTML = `
        <div class="modal fade" id="modalEtiquetasLote" tabindex="-1" aria-labelledby="modalEtiquetasLoteLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEtiquetasLoteLabel">
                            <i class="fas fa-tags me-2"></i>Generar Etiquetas en Lote
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Configuración de etiquetas -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Etiquetas por fila</label>
                                <select class="form-select" id="etiquetas-por-fila">
                                    <option value="2">2 etiquetas</option>
                                    <option value="3" selected>3 etiquetas</option>
                                    <option value="4">4 etiquetas</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tamaño de etiqueta</label>
                                <select class="form-select" id="tamano-etiqueta">
                                    <option value="pequeno">Pequeño (70x50mm)</option>
                                    <option value="mediano" selected>Mediano (100x70mm)</option>
                                    <option value="grande">Grande (120x80mm)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Búsqueda y filtros -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="buscar-mercaderia-etiquetas" 
                                       placeholder="Buscar mercadería por descripción o código...">
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="seleccionarTodasMercaderias()">
                                        <i class="fas fa-check-square me-1"></i>Todas
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deseleccionarTodasMercaderias()">
                                        <i class="fas fa-square me-1"></i>Ninguna
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Contador de seleccionadas -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Mercaderías seleccionadas: <strong id="contador-seleccionadas">0</strong>
                        </div>

                        <!-- Lista de mercaderías -->
                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                            <div id="lista-mercaderias-etiquetas">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="procesarEtiquetasLote()">
                            <i class="fas fa-download me-2"></i>Generar PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Agregar al body
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Agregar event listener para búsqueda
    document.getElementById('buscar-mercaderia-etiquetas').addEventListener('input', filtrarMercaderiasEtiquetas);
}

// Llenar la lista de mercaderías para etiquetas
function llenarListaMercaderiasEtiquetas() {
    const lista = document.getElementById('lista-mercaderias-etiquetas');
    
    const mercaderiasHTML = mercaderias.map(mercaderia => `
        <div class="form-check mercaderia-item-etiqueta" data-mercaderia-id="${mercaderia.id}">
            <input class="form-check-input mercaderia-checkbox" type="checkbox" 
                   value="${mercaderia.id}" id="mercaderia-${mercaderia.id}"
                   onchange="actualizarContadorSeleccionadas()">
            <label class="form-check-label w-100" for="mercaderia-${mercaderia.id}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${mercaderia.descripcion}</strong><br>
                        <small class="text-muted">
                            SKU: ${mercaderia.codigo_sku || 'N/A'} | 
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">Stock: ${mercaderia.stock_total || 0}</span>
                        <br>
                        <small class="text-muted">$${(mercaderia.precio_venta || 0).toLocaleString()}</small>
                    </div>
                </div>
            </label>
        </div>
        <hr class="my-2">
    `).join('');

    lista.innerHTML = mercaderiasHTML;
}

// Filtrar mercaderías en el modal de etiquetas
function filtrarMercaderiasEtiquetas() {
    const busqueda = document.getElementById('buscar-mercaderia-etiquetas').value.toLowerCase();
    const items = document.querySelectorAll('.mercaderia-item-etiqueta');

    items.forEach(item => {
        const texto = item.textContent.toLowerCase();
        if (texto.includes(busqueda)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Seleccionar todas las mercaderías visibles
function seleccionarTodasMercaderias() {
    const checkboxes = document.querySelectorAll('.mercaderia-checkbox');
    checkboxes.forEach(checkbox => {
        const item = checkbox.closest('.mercaderia-item-etiqueta');
        if (item.style.display !== 'none') {
            checkbox.checked = true;
        }
    });
    actualizarContadorSeleccionadas();
}

// Deseleccionar todas las mercaderías
function deseleccionarTodasMercaderias() {
    const checkboxes = document.querySelectorAll('.mercaderia-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    actualizarContadorSeleccionadas();
}

// Actualizar contador de mercaderías seleccionadas
function actualizarContadorSeleccionadas() {
    const seleccionadas = document.querySelectorAll('.mercaderia-checkbox:checked').length;
    document.getElementById('contador-seleccionadas').textContent = seleccionadas;
}

// Procesar la generación de etiquetas en lote
async function procesarEtiquetasLote() {
    try {
        // Obtener mercaderías seleccionadas
        const checkboxes = document.querySelectorAll('.mercaderia-checkbox:checked');
        const mercaderiaIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (mercaderiaIds.length === 0) {
            showAlert('Selecciona al menos una mercadería', 'warning');
            return;
        }

        // Obtener configuración
        const etiquetasPorFila = document.getElementById('etiquetas-por-fila').value;
        const tamanoEtiqueta = document.getElementById('tamano-etiqueta').value;

        // Mapear tamaños
        const tamanos = {
            'pequeno': { width: 70, height: 50 },
            'mediano': { width: 100, height: 70 },
            'grande': { width: 120, height: 80 }
        };

        const tamanosSeleccionados = tamanos[tamanoEtiqueta];

        // Mostrar indicador de carga
        const btnGenerar = event.target;
        const textoOriginal = btnGenerar.innerHTML;
        btnGenerar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
        btnGenerar.disabled = true;

        // Realizar solicitud al backend
        const response = await fetch('/api/v1/etiquetas/pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mercaderiaIds: mercaderiaIds,
                labelWidth: tamanosSeleccionados.width,
                labelHeight: tamanosSeleccionados.height,
                labelsPerRow: parseInt(etiquetasPorFila)
            })
        });

        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }

        // Descargar el PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `etiquetas_lote_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);

        // Mostrar mensaje de éxito
        showAlert(`Etiquetas generadas exitosamente para ${mercaderiaIds.length} mercadería(s)`, 'success');

        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalEtiquetasLote')).hide();

    } catch (error) {
        console.error('Error generando etiquetas en lote:', error);
        showAlert('Error al generar las etiquetas. Intenta nuevamente.', 'danger');
    } finally {
        // Restaurar botón
        const btnGenerar = event.target;
        btnGenerar.innerHTML = textoOriginal;
        btnGenerar.disabled = false;
    }
}

        function generarEtiquetaIndividual() {
            const mercaderiaId = document.getElementById('etiqueta-mercaderia').value;
            if (!mercaderiaId) {
                showAlert('Selecciona una mercadería', 'warning');
                return;
            }
            generarEtiqueta(mercaderiaId);
        }

        // Stubs para otras funciones
        function abrirModalDeposito() { console.log('Abrir modal depósito'); }
        function abrirModalCliente() { console.log('Abrir modal cliente'); }
        function abrirModalVendedor() { console.log('Abrir modal vendedor'); }
        function abrirModalCompra() { console.log('Abrir modal compra'); }
        function abrirModalTransferencia() { console.log('Abrir modal transferencia'); }
        function generarReporteStock() { console.log('Generar reporte stock'); }
        function generarReporteMovimientos() { console.log('Generar reporte movimientos'); }
        function generarReporteVendedores() { console.log('Generar reporte vendedores'); }

        // Función de alerta
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function logout() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                window.location.href = '/login';
            }
        }

        // Función para renderizar la tabla de mercaderías
function renderTablaMercaderias() {
    const tbody = document.getElementById('tabla-mercaderias');
    
    if (!tbody) {
        console.error('No se encontró el elemento tabla-mercaderias');
        return;
    }
    
    // Si no hay mercaderías o el array está vacío
    if (!mercaderias || mercaderias.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                    No se encontraron mercaderías
                </td>
            </tr>
        `;
        return;
    }

    // Renderizar cada mercadería
    tbody.innerHTML = mercaderias.map(mercaderia => {
        // Valores por defecto para campos que pueden estar undefined
        const stockTotal = mercaderia.stock_total || 0;
        const stockMinimo = mercaderia.stock_minimo || 0;
        const precioVenta = mercaderia.precio_venta || 0;
        const categoria = mercaderia.categoria || mercaderia.categoria_nombre || 'Sin categoría';
        const activo = mercaderia.activo !== undefined ? mercaderia.activo : 1;
        
        const proveedoresInfo = generarInfoProveedores(mercaderia);
        
        return `
            <tr>
                <!-- Tus columnas existentes (imagen, SKU, descripción, etc.) -->
                <td>
                    ${mercaderia.imagen_url ? 
                        `<img src="${mercaderia.imagen_url}" class="img-thumbnail" style="width: 50px; height: 50px;">` :
                        '<div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="fas fa-image text-muted"></i></div>'
                    }
                </td>
                <td><span class="text-primary fw-medium">${mercaderia.codigo_sku || 'N/A'}</span></td>
                <td>
                    <div class="d-flex flex-column">
                        <span class="fw-medium">${mercaderia.descripcion || 'Sin descripción'}</span>
                        ${mercaderia.codigo_ean13 ? `<small class="text-muted">EAN: ${mercaderia.codigo_ean13}</small>` : ''}
                    </div>
                </td>
                <td>
                    ${mercaderia.codigo_barras ? 
                        `<span class="badge bg-info">${mercaderia.codigo_barras}</span>` : 
                        '<span class="text-muted">N/A</span>'
                    }
                </td>
                <td><span class="text-success fw-medium">$${parseFloat(mercaderia.precio_venta || 0).toFixed(2)}</span></td>
                <td>
                    <span class="badge ${mercaderia.stock_actual <= mercaderia.stock_minimo ? 'bg-danger' : 'bg-success'}">
                        ${mercaderia.stock_actual || 0}
                    </span>
                </td>
                <td><span class="badge bg-secondary">${mercaderia.categoria || 'Sin categoría'}</span></td>
                
                <!-- NUEVA COLUMNA: Proveedores -->
                <td>${proveedoresInfo}</td>
                
                <td>
                    <span class="badge ${mercaderia.activo ? 'bg-success' : 'bg-danger'}">
                        ${mercaderia.activo ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editarMercaderia(${mercaderia.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="gestionarProveedores(${mercaderia.id})" title="Gestionar Proveedores">
                            <i class="fas fa-truck"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="eliminarMercaderia(${mercaderia.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Función auxiliar para obtener indicador visual de stock
function getStockIndicator(stock, stockMinimo) {
    if (Number(stock) === 0) {
        return '<span class="stock-indicator empty" title="Sin stock"></span>';
    }
    if (stock <= stockMinimo) {
        return '<span class="stock-indicator low" title="Stock bajo"></span>';
    }
    if (stock <= stockMinimo * 2) {
        return '<span class="stock-indicator medium" title="Stock medio"></span>';
    }
    return '<span class="stock-indicator high" title="Stock bueno"></span>';
}

// Función auxiliar para obtener clase de color del stock
function getStockColorClass(stock, stockMinimo) {
    if (stock === 0) return 'text-danger';
    if (stock <= stockMinimo) return 'text-warning';
    if (stock <= stockMinimo * 2) return 'text-info';
    return 'text-success';
}

// Funciones auxiliares para las acciones adicionales
async function toggleActiveMercaderia(id, estadoActual) {
    try {
        const accion = estadoActual ? 'desactivar' : 'activar';
        
        if (!confirm(`¿Estás seguro de que quieres ${accion} esta mercadería?`)) {
            return;
        }

        const response = await apiRequest(`/mercaderias/${id}/toggle-active`, {
            method: 'PUT'
        });

        if (response.success) {
            showAlert(`Mercadería ${accion}da exitosamente`, 'success');
            await loadMercaderias(); // Recargar la tabla
            renderTablaMercaderias(); // Se renderiza automáticamente

        } else {
            showAlert(response.message || `Error al ${accion} la mercadería`, 'danger');
        }
    } catch (error) {
        console.error('Error cambiando estado de mercadería:', error);
        showAlert('Error al cambiar el estado de la mercadería', 'danger');
    }
}

function verHistorialStock(id) {
    // TODO: Implementar modal de historial de stock
    console.log('Ver historial de stock para mercadería:', id);
    showAlert('Funcionalidad de historial en desarrollo', 'info');
}

async function eliminarMercaderia(id) {
    try {
        if (!confirm('¿Estás seguro de que quieres eliminar esta mercadería? Esta acción no se puede deshacer.')) {
            return;
        }
        const response = await apiRequest(`/mercaderias/${id}`, 'DELETE');
        

        if (response.success) {
            showAlert('Mercadería eliminada exitosamente', 'success');
            await loadMercaderias(); // Recargar la tabla
            renderTablaMercaderias(); // Se renderiza automáticamente

        } else {
            showAlert(response.message || 'Error al eliminar la mercadería', 'danger');
        }
    } catch (error) {
        console.error('Error eliminando mercadería:', error);
        showAlert('Error al eliminar la mercadería', 'danger');
    }
}

async function loadVendedores() {
    try {
        const response = await apiRequest('/vendedores');
        if (response.success) {
            vendedores = response.data;
            renderTablaVendedores();
        } else {
            throw new Error(response.message || 'Error al cargar vendedores');
        }
    } catch (error) {
        console.error('Error cargando vendedores:', error);
        loadVendedoresDemo();
    }
}

// Función demo en caso de error de conexión
function loadVendedoresDemo() {
    vendedores = [
        {
            vendedorId: 1,
            razonSocial: 'Vendedor Demo S.A.',
            cuit: '20-12345678-9',
            email: 'demo@vendedor.com',
            telefono: '11-1234-5678',
            localidad: 'Buenos Aires',
            tiene_deposito: 1,
            activo: 1
        }
    ];
    renderTablaVendedores();
}

// Función para renderizar la tabla de vendedores
function renderTablaVendedores() {
    const tbody = document.getElementById('tabla-vendedores');
    
    if (!tbody) {
        console.error('No se encontró el elemento tabla-vendedores');
        return;
    }
    
    if (!vendedores || vendedores.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-user-tie fa-2x mb-2"></i><br>
                    No se encontraron vendedores
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = vendedores.map(vendedor => {
        const activo = vendedor.activo !== undefined ? vendedor.activo : 1;
        
        return `
            <tr ${!activo ? 'class="table-secondary opacity-75"' : ''}>
                <td>
                    <div class="d-flex flex-column">
                        <span class="fw-medium">${vendedor.razonSocial || 'Sin nombre'}</span>
                    </div>
                </td>
                <td>
                    <span class="text-primary fw-medium">${vendedor.cuit || 'N/A'}</span>
                </td>
                <td>
                    ${vendedor.email ? 
                        `<a href="mailto:${vendedor.email}" class="text-decoration-none">${vendedor.email}</a>` : 
                        '<span class="text-muted">No especificado</span>'
                    }
                </td>
                <td>
                    ${vendedor.telefono ? 
                        `<a href="tel:${vendedor.telefono}" class="text-decoration-none">${vendedor.telefono}</a>` : 
                        '<span class="text-muted">No especificado</span>'
                    }
                </td>
                <td>
                    <span>${vendedor.localidad || 'No especificada'}</span>
                </td>
                <td class="text-center">
                    ${vendedor.tiene_deposito ? 
                        '<span class="badge bg-success"><i class="fas fa-warehouse me-1"></i>Sí</span>' : 
                        '<span class="badge bg-secondary"><i class="fas fa-times me-1"></i>No</span>'
                    }
                </td>
                <td class="text-center">
                    ${activo ? 
                        '<span class="badge bg-success">Activo</span>' : 
                        '<span class="badge bg-danger">Inactivo</span>'
                    }
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="editarVendedor(${vendedor.vendedorId})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="verStockVendedor(${vendedor.vendedorId})" title="Ver Stock">
                            <i class="fas fa-boxes"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="verClientesVendedor(${vendedor.vendedorId})" title="Ver Clientes">
                            <i class="fas fa-users"></i>
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="toggleVendedorActivo(${vendedor.vendedorId}, ${activo})" title="${activo ? 'Desactivar' : 'Activar'}">
                            <i class="fas fa-${activo ? 'eye-slash' : 'eye'}"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="eliminarVendedor(${vendedor.vendedorId})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Función para abrir el modal de vendedor
function abrirModalVendedor() {
    // Limpiar formulario
    limpiarFormularioVendedor();
    
    // Configurar modal para nuevo vendedor
    document.getElementById('modalVendedorTitle').textContent = 'Nuevo Vendedor';
    document.getElementById('tiene_deposito').checked = true; // Valor por defecto
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalVendedor'));
    modal.show();
    
    // Enfocar primer campo
    setTimeout(() => {
        document.getElementById('razonSocial').focus();
    }, 300);
}

// Función guardarVendedor mejorada con lógica de depósitos
async function guardarVendedor() {
    const form = document.getElementById('formVendedor');
    
    // Validar formulario usando HTML5 validation
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    // CLAVE: Detectar si estamos editando o creando
    const vendedorId = document.getElementById('vendedor_id').value;
    const isEditing = vendedorId && vendedorId !== '';

    // Construir objeto con los datos del formulario
    const vendedorData = {
        razonSocial: document.getElementById('razonSocial').value.trim(),
        cuit: document.getElementById('cuit').value.trim(),
        condicionIVA: document.getElementById('condicionIVA').value,
        email: document.getElementById('email').value.trim(),
        telefono: document.getElementById('telefono').value.trim(),
        domicilio: document.getElementById('domicilio').value.trim(),
        localidad: document.getElementById('localidad').value.trim(),
        provincia: document.getElementById('provincia').value.trim(),
        codigoPostal: document.getElementById('codigoPostal').value.trim(),
        tiene_deposito: document.getElementById('tiene_deposito').checked ? 1 : 0
    };

    // Validaciones adicionales personalizadas
    if (!vendedorData.razonSocial) {
        showAlert('La razón social es requerida', 'warning');
        document.getElementById('razonSocial').focus();
        return;
    }

    if (!vendedorData.cuit) {
        showAlert('El CUIT es requerido', 'warning');
        document.getElementById('cuit').focus();
        return;
    }

    // Validar formato de CUIT (opcional)
    if (vendedorData.cuit && !/^\d{2}-\d{8}-\d{1}$/.test(vendedorData.cuit)) {
        if (!/^\d{11}$/.test(vendedorData.cuit.replace(/\D/g, ''))) {
            showAlert('El CUIT debe tener un formato válido (XX-XXXXXXXX-X)', 'warning');
            document.getElementById('cuit').focus();
            return;
        }
    }

    // Validar email si se proporciona
    if (vendedorData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(vendedorData.email)) {
        showAlert('El email debe tener un formato válido', 'warning');
        document.getElementById('email').focus();
        return;
    }

    // 🔧 NUEVA VALIDACIÓN: Advertir sobre cambios en depósito al editar
    if (isEditing) {
        const tieneDepositoActual = await obtenerEstadoDepositoVendedor(vendedorId);
        const tieneDepositoNuevo = vendedorData.tiene_deposito === 1;

        // Si está intentando desactivar un depósito existente, advertir
        if (tieneDepositoActual && !tieneDepositoNuevo) {
            const confirmacion = confirm(
                '⚠️ ADVERTENCIA: Estás intentando desactivar el depósito del vendedor.\n\n' +
                'Esto solo será posible si:\n' +
                '• El depósito no tiene stock actual\n' +
                '• El depósito no tiene movimientos registrados\n' +
                '• No hay transferencias pendientes\n\n' +
                '¿Deseas continuar?'
            );
            
            if (!confirmacion) {
                return; // Cancelar la operación
            }
        }

        // Si está activando un depósito, mostrar información
        if (!tieneDepositoActual && tieneDepositoNuevo) {
            showAlert('Se creará un nuevo depósito para este vendedor', 'info');
        }
    }

    try {
        let response;
        
        if (isEditing) {
            // ACTUALIZAR vendedor existente
            response = await apiRequest(`/vendedores/${vendedorId}`, 'PUT', vendedorData);
            /*response = await apiRequest(`/vendedores/${vendedorId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(vendedorData)
            });*/
            
            if (response.success) {
                // 🔧 MENSAJE ESPECÍFICO según el cambio de depósito
                let mensaje = 'Vendedor actualizado exitosamente';
                
                if (response.data) {
                    const tieneDepositoFinal = response.data.deposito_id ? true : false;
                    const solicitoDeposito = vendedorData.tiene_deposito === 1;
                    
                    if (solicitoDeposito && tieneDepositoFinal) {
                        if (response.data.deposito_id && !response.data.deposito_activo) {
                            mensaje += '. Depósito reactivado.';
                        } else {
                            mensaje += '. Depósito creado.';
                        }
                    } else if (!solicitoDeposito && !tieneDepositoFinal) {
                        mensaje += '. Depósito desactivado.';
                    }
                }
                
                showAlert(mensaje, 'success');
            } else {
                throw new Error(response.message || 'Error al actualizar vendedor');
            }
        } else {
            // CREAR nuevo vendedor
            response = await apiRequest(`/vendedores`, 'POST', vendedorData);
            /*response = await apiRequest('/vendedores', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(vendedorData)
            });*/
            
            if (response.success) {
                let mensaje = 'Vendedor creado exitosamente';
                if (vendedorData.tiene_deposito) {
                    mensaje += ' con depósito';
                }
                showAlert(mensaje, 'success');
            } else {
                throw new Error(response.message || 'Error al crear vendedor');
            }
        }

        // Cerrar modal y recargar datos
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalVendedor'));
        if (modal) {
            modal.hide();
        }
        
        // Recargar lista de vendedores
        await loadVendedores();
        
        // Si hay función de renderizado específica, llamarla
        if (typeof renderTablaVendedores === 'function') {
            renderTablaVendedores();
        }
        
        // Limpiar formulario para próximo uso
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById('vendedor_id').value = '';
        
    } catch (error) {
        console.error('Error guardando vendedor:', error);
        
        // 🔧 MANEJO ESPECÍFICO de errores de depósito
        let mensajeError = error.message || 'Error al guardar vendedor';
        
        if (error.message && error.message.includes('depósito')) {
            // Mostrar mensaje específico de depósito con más detalle
            if (error.message.includes('stock actual')) {
                mensajeError = '❌ No se puede desactivar el depósito porque tiene stock.\n\nPrimero debe transferir todo el stock a otro depósito.';
            } else if (error.message.includes('movimientos registrados')) {
                mensajeError = '❌ No se puede desactivar el depósito porque tiene movimientos históricos.\n\nPor motivos de auditoría, los depósitos con historial no pueden desactivarse.';
            } else if (error.message.includes('transferencias pendientes')) {
                mensajeError = '❌ No se puede desactivar el depósito porque tiene transferencias pendientes.\n\nComplete o cancele las transferencias pendientes primero.';
            }
            
            // Mostrar alert específico para errores de depósito
            showAlert(mensajeError, 'warning');
            
            // Revertir el checkbox si fue error de depósito
            if (isEditing) {
                const estadoOriginal = await obtenerEstadoDepositoVendedor(vendedorId);
                document.getElementById('tiene_deposito').checked = estadoOriginal;
            }
        } else {
            showAlert(mensajeError, 'danger');
        }
    }
}

// 🔧 NUEVA FUNCIÓN: Obtener estado actual del depósito del vendedor
async function obtenerEstadoDepositoVendedor(vendedorId) {
    try {
        const response = await apiRequest(`/vendedores/${vendedorId}`);
        if (response.success && response.data) {
            return response.data.deposito_id && response.data.deposito_activo;
        }
        return false;
    } catch (error) {
        console.error('Error obteniendo estado de depósito:', error);
        return false;
    }
}

// 🔧 NUEVA FUNCIÓN: Verificar detalles del depósito antes de cambios
async function verificarDetallesDeposito(vendedorId) {
    try {
        const response = await apiRequest(`/vendedores/${vendedorId}/stock`);
        if (response.success) {
            return {
                tieneStock: response.data && response.data.length > 0,
                cantidadItems: response.data ? response.data.length : 0,
                estadisticas: response.estadisticas || {}
            };
        }
        return { tieneStock: false, cantidadItems: 0, estadisticas: {} };
    } catch (error) {
        console.error('Error verificando detalles de depósito:', error);
        return { tieneStock: false, cantidadItems: 0, estadisticas: {} };
    }
}

// Función auxiliar para validar CUIT (opcional)
function validarCUIT(cuit) {
    // Remover guiones y espacios
    const cuitLimpio = cuit.replace(/\D/g, '');
    
    if (cuitLimpio.length !== 11) {
        return false;
    }
    
    // Validación de dígito verificador
    const multiplicadores = [5, 4, 3, 2, 7, 6, 5, 4, 3, 2];
    let suma = 0;
    
    for (let i = 0; i < 10; i++) {
        suma += parseInt(cuitLimpio[i]) * multiplicadores[i];
    }
    
    const resto = suma % 11;
    const digitoVerificador = resto < 2 ? resto : 11 - resto;
    
    return parseInt(cuitLimpio[10]) === digitoVerificador;
}

// Función auxiliar para formatear CUIT automáticamente
function formatearCUIT(input) {
    let valor = input.value.replace(/\D/g, '');
    
    if (valor.length >= 2) {
        valor = valor.substring(0, 2) + '-' + valor.substring(2);
    }
    if (valor.length >= 11) {
        valor = valor.substring(0, 11) + '-' + valor.substring(11, 12);
    }
    
    input.value = valor;
}

// Event listener para formatear CUIT automáticamente (agregar al DOM)
/*document.addEventListener('DOMContentLoaded', function() {
    const cuitInput = document.getElementById('cuit');
    if (cuitInput) {
        cuitInput.addEventListener('input', function() {
            formatearCUIT(this);
        });
        
        cuitInput.addEventListener('blur', function() {
            const cuitValue = this.value.replace(/\D/g, '');
            if (cuitValue.length === 11 && !validarCUIT(this.value)) {
                showAlert('El CUIT ingresado no es válido', 'warning');
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
});*/

// Función para limpiar el formulario de vendedor
// 🔧 FUNCIÓN MEJORADA: Limpiar formulario de vendedor
function limpiarFormularioVendedor() {
    const form = document.getElementById('formVendedor');
    if (form) {
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById('vendedor_id').value = '';
        
        // Remover clases de validación
        const inputs = form.querySelectorAll('.is-invalid, .is-valid');
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        
        // Limpiar badges informativos
        const badges = form.querySelectorAll('.badge');
        badges.forEach(badge => badge.remove());
        
        // Resetear tooltips
        const checkboxDeposito = document.getElementById('tiene_deposito');
        if (checkboxDeposito) {
            checkboxDeposito.title = '';
        }
    }
}

// 🔧 FUNCIÓN MEJORADA: Editar vendedor con información de depósito
async function editarVendedor(id) {
    try {
        const response = await apiRequest(`/vendedores/${id}`);
        
        if (!response.success) {
            showAlert('Error al cargar el vendedor', 'danger');
            return;
        }
        
        const vendedor = response.data;
        
        // Limpiar formulario primero
        limpiarFormularioVendedor();
        
        // Llenar el formulario con datos existentes
        document.getElementById('vendedor_id').value = vendedor.vendedorId;
        document.getElementById('razonSocial').value = vendedor.razonSocial || '';
        document.getElementById('cuit').value = vendedor.cuit || '';
        document.getElementById('condicionIVA').value = vendedor.condicionIVA || '';
        document.getElementById('email').value = vendedor.email || '';
        document.getElementById('telefono').value = vendedor.telefono || '';
        document.getElementById('domicilio').value = vendedor.domicilio || '';
        document.getElementById('localidad').value = vendedor.localidad || '';
        document.getElementById('provincia').value = vendedor.provincia || '';
        document.getElementById('codigoPostal').value = vendedor.codigoPostal || '';
        
        // 🔧 MANEJO MEJORADO del checkbox de depósito
        const tieneDepositoActivo = vendedor.deposito_id && vendedor.deposito_activo;
        document.getElementById('tiene_deposito').checked = tieneDepositoActivo;
        
        // Agregar tooltip informativo si tiene depósito
        const checkboxDeposito = document.getElementById('tiene_deposito');
        if (tieneDepositoActivo) {
            checkboxDeposito.title = `Depósito activo: ${vendedor.deposito_nombre || 'Depósito del vendedor'}`;
            
            // Verificar si tiene stock para mostrar advertencia
            if (vendedor.items_con_stock > 0) {
                const label = checkboxDeposito.parentElement.querySelector('label');
                if (label && !label.querySelector('.badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-warning ms-2';
                    badge.textContent = `${vendedor.items_con_stock} items con stock`;
                    badge.title = 'Este depósito tiene productos con stock. No se puede desactivar.';
                    label.appendChild(badge);
                }
            }
        } else {
            checkboxDeposito.title = 'Marcar para crear un depósito para este vendedor';
        }
        
        // Configurar modal para edición
        document.getElementById('modalVendedorTitle').textContent = 'Editar Vendedor';
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalVendedor'));
        modal.show();
        
        // Enfocar primer campo
        setTimeout(() => {
            document.getElementById('razonSocial').focus();
        }, 300);
        
    } catch (error) {
        console.error('Error editando vendedor:', error);
        showAlert('Error al cargar los datos del vendedor', 'danger');
    }
}

// 🔧 Event listener para el checkbox de depósito (información en tiempo real)
document.addEventListener('DOMContentLoaded', function() {
    const tieneDepositoCheckbox = document.getElementById('tiene_deposito');
    if (tieneDepositoCheckbox) {
        tieneDepositoCheckbox.addEventListener('change', async function() {
            const vendedorId = document.getElementById('vendedor_id').value;
            
            // Si estamos editando y se está desactivando el depósito
            if (vendedorId && !this.checked) {
                const detalles = await verificarDetallesDeposito(vendedorId);
                
                if (detalles.tieneStock) {
                    showAlert(`⚠️ Advertencia: Este depósito tiene ${detalles.cantidadItems} productos con stock. No podrá desactivarse.`, 'warning');
                }
            }
        });
    }
});

// Función para eliminar vendedor
async function eliminarVendedor(id) {
    if (!confirm('¿Estás seguro de que quieres eliminar este vendedor? Esta acción no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await apiRequest(`/vendedores/${id}`, 'DELETE');
        
        if (response.success) {
            showAlert('Vendedor eliminado exitosamente', 'success');
            loadVendedores();
        } else {
            showAlert(response.message || 'Error al eliminar vendedor', 'danger');
        }
    } catch (error) {
        console.error('Error eliminando vendedor:', error);
        showAlert('Error al eliminar vendedor', 'danger');
    }
}

// Función para toggle activo/inactivo
async function toggleVendedorActivo(id, estadoActual) {
    const nuevoEstado = !estadoActual;
    const accion = nuevoEstado ? 'activar' : 'desactivar';
    
    if (!confirm(`¿Estás seguro de que quieres ${accion} este vendedor?`)) {
        return;
    }
    
    try {
        const response = await apiRequest(`/vendedores/${id}`, 'PUT', { activo: nuevoEstado ? 1 : 0 });
        
        if (response.success) {
            showAlert(`Vendedor ${accion}do exitosamente`, 'success');
            loadVendedores();
        } else {
            showAlert(`Error al ${accion} vendedor`, 'danger');
        }
    } catch (error) {
        console.error(`Error al ${accion} vendedor:`, error);
        showAlert(`Error al ${accion} vendedor`, 'danger');
    }
}

// Función para ver stock del vendedor
async function verStockVendedor(id) {
    try {
        const response = await apiRequest(`/vendedores/${id}/stock`);
        
        if (response.success) {
            // Mostrar modal o página con el stock del vendedor
            showAlert(`Stock del vendedor cargado (${response.data.length} items)`, 'info');
            // Aquí puedes implementar un modal o redireccionar a una página de stock
        } else {
            showAlert('Error al cargar stock del vendedor', 'danger');
        }
    } catch (error) {
        console.error('Error cargando stock:', error);
        showAlert('Error al cargar stock del vendedor', 'danger');
    }
}

// Función para ver clientes del vendedor
async function verClientesVendedor(id) {
    try {
        const response = await apiRequest(`/vendedores/${id}/clientes`);
        
        if (response.success) {
            // Mostrar modal o página con los clientes del vendedor
            showAlert(`Clientes del vendedor cargados (${response.data.length} clientes)`, 'info');
            // Aquí puedes implementar un modal o redireccionar a una página de clientes
        } else {
            showAlert('Error al cargar clientes del vendedor', 'danger');
        }
    } catch (error) {
        console.error('Error cargando clientes:', error);
        showAlert('Error al cargar clientes del vendedor', 'danger');
    }
}

// Función para cargar clientes desde el API
async function loadClientes() {
    try {
        const response = await apiRequest('/clientes');
        if (response.success && response.data) {
            clientes = response.data;
            renderTablaClientes();
            console.log('✅ Clientes cargados desde API:', clientes.length);
        } else {
            console.warn('⚠️ API devolvió respuesta sin datos:', response);
            throw new Error(response.message || 'Error al cargar clientes');
        }
    } catch (error) {
        console.error('❌ Error cargando clientes desde API:', error);
        console.log('🔄 Cargando datos demo...');
        loadClientesDemo();
    }
}

// Función demo en caso de error de conexión
function loadClientesDemo() {
    clientes = [
        {
            clienteId: 1,
            razonSocial: 'Cliente Demo S.R.L.',
            cuit: '30-12345678-9',
            email: 'demo@cliente.com',
            telefono: '11-9876-5432',
            localidad: 'La Plata',
            vendedor_nombre: 'Vendedor Demo',
            zona_nombre: 'Centro',
            tiene_deposito: 0,
            activo: 1
        }
    ];
    renderTablaClientes();
}

// Función para renderizar la tabla de clientes
function renderTablaClientes() {
    const tbody = document.getElementById('tabla-clientes');
    
    if (!tbody) {
        console.error('No se encontró el elemento tabla-clientes');
        return;
    }
    
    if (!clientes || clientes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="fas fa-users fa-2x mb-2"></i><br>
                    No se encontraron clientes
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = clientes.map(cliente => {
        const activo = cliente.activo !== undefined ? cliente.activo : 1;
        
        return `
            <tr ${!activo ? 'class="table-secondary opacity-75"' : ''}>
                <td>
                    <div class="d-flex flex-column">
                        <span class="fw-medium">${cliente.razonSocial || 'Sin nombre'}</span>
                    </div>
                </td>
                <td>
                    <span class="text-primary fw-medium">${cliente.cuit || 'N/A'}</span>
                </td>
                <td>
                    <span class="badge bg-info">${cliente.vendedor_nombre || cliente.vendedorId || 'No asignado'}</span>
                </td>
                <td>
                    <span class="badge bg-secondary">${cliente.zona_nombre || cliente.zonaId || 'No asignada'}</span>
                </td>
                <td>
                    <div class="d-flex flex-column small">
                        ${cliente.email ? 
                            `<a href="mailto:${cliente.email}" class="text-decoration-none text-truncate" style="max-width: 150px;">${cliente.email}</a>` : 
                            '<span class="text-muted">Sin email</span>'
                        }
                        ${cliente.telefono ? 
                            `<a href="tel:${cliente.telefono}" class="text-decoration-none">${cliente.telefono}</a>` : 
                            '<span class="text-muted">Sin teléfono</span>'
                        }
                    </div>
                </td>
                <td>
                    <span>${cliente.localidad || 'No especificada'}</span>
                </td>
                <td class="text-center">
                    ${cliente.tiene_deposito ? 
                        '<span class="badge bg-success"><i class="fas fa-warehouse me-1"></i>Sí</span>' : 
                        '<span class="badge bg-secondary"><i class="fas fa-times me-1"></i>No</span>'
                    }
                </td>
                <td class="text-center">
                    ${activo ? 
                        '<span class="badge bg-success">Activo</span>' : 
                        '<span class="badge bg-danger">Inactivo</span>'
                    }
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="editarCliente(${cliente.clienteId})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="verStockCliente(${cliente.clienteId})" title="Ver Stock">
                            <i class="fas fa-boxes"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="verPedidosCliente(${cliente.clienteId})" title="Ver Pedidos">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="toggleClienteActivo(${cliente.clienteId}, ${activo})" title="${activo ? 'Desactivar' : 'Activar'}">
                            <i class="fas fa-${activo ? 'eye-slash' : 'eye'}"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="eliminarCliente(${cliente.clienteId})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Función para cargar zonas
async function cargarZonas() {
    try {
        const response = await apiRequest('/zonas');
        if (response.success) {
            zonas = response.data;
            const select = document.getElementById('cliente_zonaId');
            select.innerHTML = '<option value="">Seleccionar zona...</option>';
            zonas.forEach(zona => {
                const option = document.createElement('option');
                option.value = zona.zonaId;
                option.textContent = zona.zona;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error cargando zonas:', error);
        // Fallback con zonas demo
        const select = document.getElementById('cliente_zonaId');
        select.innerHTML = `
            <option value="">Seleccionar zona...</option>
            <option value="1">Centro</option>
            <option value="2">Norte</option>
            <option value="3">Sur</option>
        `;
    }
}

// Función para cargar vendedores en el select
async function cargarVendedoresEnSelect(selectId = 'cliente_vendedorId') {
    try {
        console.log(`🔄 Cargando vendedores en select ${selectId}...`);
        
        const select = document.getElementById(selectId);
        if (!select) {
            console.error(`❌ Elemento ${selectId} no encontrado`);
            return false;
        }
        
        // Mostrar estado de carga
        select.innerHTML = '<option value="">Cargando vendedores...</option>';
        select.disabled = true;
        
        const response = await apiRequest('/vendedores');
        console.log('📡 Respuesta de /vendedores:', response);
        
        if (response.success && response.data) {
            select.innerHTML = '<option value="">Seleccionar vendedor...</option>';
            
            // Filtrar solo vendedores activos
            const vendedoresActivos = response.data.filter(vendedor => vendedor.activo == 1);
            
            vendedoresActivos.forEach(vendedor => {
                console.log(`  - Agregando vendedor: ${vendedor.razonSocial} (ID: ${vendedor.vendedorId})`);
                const option = document.createElement('option');
                option.value = vendedor.vendedorId;
                option.textContent = vendedor.razonSocial;
                select.appendChild(option);
            });
            
            console.log(`✅ ${vendedoresActivos.length} vendedores cargados exitosamente`);
            select.disabled = false;
            return true;
            
        } else {
            console.error('❌ Error en respuesta:', response.message);
            return false;
        }
        
    } catch (error) {
        console.error('💥 Error cargando vendedores:', error);
        
        // Fallback con vendedores demo en caso de error
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = `
                <option value="">Seleccionar vendedor...</option>
                <option value="1">Vendedor Demo</option>
            `;
            select.disabled = false;
        }
        return false;
    }
}

async function cargarZonasEnSelect(selectId = 'cliente_zonaId') {
    try {
        console.log(`🔄 Cargando zonas en select ${selectId}...`);
        
        const select = document.getElementById(selectId);
        if (!select) {
            console.error(`❌ Elemento ${selectId} no encontrado`);
            return false;
        }
        
        // Mostrar estado de carga
        select.innerHTML = '<option value="">Cargando zonas...</option>';
        select.disabled = true;
        
        const response = await apiRequest('/zonas');
        console.log('📡 Respuesta de /zonas:', response);
        
        if (response.success && response.data) {
            select.innerHTML = '<option value="">Seleccionar zona...</option>';
            
            // Filtrar solo zonas activas
            const zonasActivas = response.data.filter(zona => zona.activo == 1);
            
            zonasActivas.forEach(zona => {
                console.log(`  - Agregando zona: ${zona.zona} (ID: ${zona.zonaId})`);
                const option = document.createElement('option');
                option.value = zona.zonaId;
                option.textContent = zona.zona;
                select.appendChild(option);
            });
            
            console.log(`✅ ${zonasActivas.length} zonas cargadas exitosamente`);
            select.disabled = false;
            return true;
            
        } else {
            console.error('❌ Error en respuesta:', response.message);
            return false;
        }
        
    } catch (error) {
        console.error('💥 Error cargando zonas:', error);
        
        // Fallback con zonas demo en caso de error
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = `
                <option value="">Seleccionar zona...</option>
                <option value="1">Centro</option>
                <option value="2">Norte</option>
                <option value="3">Sur</option>
                <option value="4">Este</option>
                <option value="5">Oeste</option>
            `;
            select.disabled = false;
        }
        return false;
    }
}

// Función auxiliar para mostrar zonas de demostración
function mostrarZonasDemo() {
    console.log('🔄 Mostrando zonas demo...');
    
    const select = document.getElementById('cliente_zonaId');
    if (select) {
        select.innerHTML = `
            <option value="">Seleccionar zona...</option>
            <option value="1">Centro</option>
            <option value="2">Norte</option>
            <option value="3">Sur</option>
            <option value="4">Este</option>
            <option value="5">Oeste</option>
        `;
        console.log('✅ Zonas demo cargadas');
    }
}


// Función para abrir el modal de cliente
async function abrirModalCliente() {
    try {
        console.log('🆕 Abriendo modal para nuevo cliente');
        
        // Limpiar formulario
        limpiarFormularioCliente();
        
        // Configurar modal para nuevo cliente
        document.getElementById('modalClienteTitle').textContent = 'Nuevo Cliente';
        document.getElementById('cliente_tiene_deposito').checked = false;
        
        // Cargar vendedores y zonas ANTES de mostrar el modal
        console.log('⏳ Cargando vendedores y zonas...');
        
        const [vendedoresCargados, zonasCargadas] = await Promise.all([
            cargarVendedoresEnSelect('cliente_vendedorId'),
            cargarZonasEnSelect('cliente_zonaId')
        ]);
        
        // Verificar que se cargaron correctamente
        if (!vendedoresCargados) {
            console.warn('⚠️ No se pudieron cargar los vendedores');
        }
        
        if (!zonasCargadas) {
            console.warn('⚠️ No se pudieron cargar las zonas');
        }
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalCliente'));
        modal.show();
        
        // Enfocar primer campo
        setTimeout(() => {
            document.getElementById('cliente_razonSocial').focus();
        }, 300);
        
        console.log('✅ Modal de nuevo cliente abierto correctamente');
        
    } catch (error) {
        console.error('💥 Error abriendo modal de cliente:', error);
        showAlert('Error al preparar el formulario de cliente: ' + error.message, 'danger');
    }
}

// Función guardarCliente mejorada (similar a guardarVendedor)
async function guardarCliente() {
    const form = document.getElementById('formCliente');
    
    // Validar formulario usando HTML5 validation
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    // CLAVE: Detectar si estamos editando o creando
    const clienteId = document.getElementById('cliente_id').value;
    const isEditing = clienteId && clienteId !== '';

    // Construir objeto con los datos del formulario
    const clienteData = {
        razonSocial: document.getElementById('cliente_razonSocial').value.trim(),
        cuit: document.getElementById('cliente_cuit').value.trim(),
        vendedorId: document.getElementById('cliente_vendedorId').value,
        zonaId: document.getElementById('cliente_zonaId').value,
        condicionIVA: document.getElementById('cliente_condicionIVA').value,
        email: document.getElementById('cliente_email').value.trim(),
        telefono: document.getElementById('cliente_telefono').value.trim(),
        domicilio: document.getElementById('cliente_domicilio').value.trim(),
        localidad: document.getElementById('cliente_localidad').value.trim(),
        provincia: document.getElementById('cliente_provincia').value.trim(),
        codigoPostal: document.getElementById('cliente_codigoPostal').value.trim(),
        tiene_deposito: document.getElementById('cliente_tiene_deposito').checked ? 1 : 0
    };

    // Validaciones adicionales personalizadas
    if (!clienteData.razonSocial) {
        showAlert('La razón social es requerida', 'warning');
        document.getElementById('cliente_razonSocial').focus();
        return;
    }

    if (!clienteData.cuit) {
        showAlert('El CUIT es requerido', 'warning');
        document.getElementById('cliente_cuit').focus();
        return;
    }

    if (!clienteData.vendedorId) {
        showAlert('El vendedor es requerido', 'warning');
        document.getElementById('cliente_vendedorId').focus();
        return;
    }

    if (!clienteData.zonaId) {
        showAlert('La zona es requerida', 'warning');
        document.getElementById('cliente_zonaId').focus();
        return;
    }

    // Validar formato de CUIT (opcional)
    if (clienteData.cuit && !/^\d{2}-\d{8}-\d{1}$/.test(clienteData.cuit)) {
        if (!/^\d{11}$/.test(clienteData.cuit.replace(/\D/g, ''))) {
            showAlert('El CUIT debe tener un formato válido (XX-XXXXXXXX-X)', 'warning');
            document.getElementById('cliente_cuit').focus();
            return;
        }
    }

    // Validar email si se proporciona
    if (clienteData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(clienteData.email)) {
        showAlert('El email debe tener un formato válido', 'warning');
        document.getElementById('cliente_email').focus();
        return;
    }

    try {
        let response;
        
        if (isEditing) {
            // ACTUALIZAR cliente existente
            response = await apiRequest(`/clientes/${clienteId}`, 'PUT', clienteData);
            /*response = await apiRequest(`/clientes/${clienteId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(clienteData)
            });*/
            
            if (response.success) {
                showAlert('Cliente actualizado exitosamente', 'success');
            } else {
                throw new Error(response.message || 'Error al actualizar cliente');
            }
        } else {
            // CREAR nuevo cliente
            response = await apiRequest(`/clientes`, 'POST', clienteData);
            /*response = await apiRequest('/clientes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(clienteData)
            });*/
            
            if (response.success) {
                showAlert('Cliente creado exitosamente', 'success');
            } else {
                throw new Error(response.message || 'Error al crear cliente');
            }
        }

        // Cerrar modal y recargar datos
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalCliente'));
        if (modal) {
            modal.hide();
        }
        
        // Recargar lista de clientes
        await loadClientes();
        
        // Si hay función de renderizado específica, llamarla
        if (typeof renderTablaClientes === 'function') {
            renderTablaClientes();
        }
        
        // Limpiar formulario para próximo uso
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById('cliente_id').value = '';
        
    } catch (error) {
        console.error('Error guardando cliente:', error);
        showAlert(error.message || 'Error al guardar cliente', 'danger');
    }
}

// Función auxiliar para validar CUIT (reutilizable para cliente y vendedor)
function validarCUITCliente(cuit) {
    // Remover guiones y espacios
    const cuitLimpio = cuit.replace(/\D/g, '');
    
    if (cuitLimpio.length !== 11) {
        return false;
    }
    
    // Validación de dígito verificador
    const multiplicadores = [5, 4, 3, 2, 7, 6, 5, 4, 3, 2];
    let suma = 0;
    
    for (let i = 0; i < 10; i++) {
        suma += parseInt(cuitLimpio[i]) * multiplicadores[i];
    }
    
    const resto = suma % 11;
    const digitoVerificador = resto < 2 ? resto : 11 - resto;
    
    return parseInt(cuitLimpio[10]) === digitoVerificador;
}

// Función auxiliar para formatear CUIT automáticamente en cliente
function formatearCUITCliente(input) {
    let valor = input.value.replace(/\D/g, '');
    
    if (valor.length >= 2) {
        valor = valor.substring(0, 2) + '-' + valor.substring(2);
    }
    if (valor.length >= 11) {
        valor = valor.substring(0, 11) + '-' + valor.substring(11, 12);
    }
    
    input.value = valor;
}

// Event listeners para formatear CUIT automáticamente (agregar al DOM)
document.addEventListener('DOMContentLoaded', function() {
    const cuitClienteInput = document.getElementById('cliente_cuit');
    if (cuitClienteInput) {
        cuitClienteInput.addEventListener('input', function() {
            formatearCUITCliente(this);
        });
        
        cuitClienteInput.addEventListener('blur', function() {
            const cuitValue = this.value.replace(/\D/g, '');
            if (cuitValue.length === 11 && !validarCUITCliente(this.value)) {
                showAlert('El CUIT ingresado no es válido', 'warning');
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    // Validación en tiempo real para email
    const emailClienteInput = document.getElementById('cliente_email');
    if (emailClienteInput) {
        emailClienteInput.addEventListener('blur', function() {
            const emailValue = this.value.trim();
            if (emailValue && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
                showAlert('El email debe tener un formato válido', 'warning');
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    // Validación para campos requeridos
    const camposRequeridos = [
        'cliente_razonSocial',
        'cliente_cuit',
        'cliente_vendedorId',
        'cliente_zonaId'
    ];

    camposRequeridos.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });

            field.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                }
            });
        }
    });
});

// Función para limpiar el formulario de cliente
function limpiarFormularioCliente() {
    const form = document.getElementById('formCliente');
    if (form) {
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById('cliente_id').value = '';
        
        // Remover clases de validación
        const inputs = form.querySelectorAll('.is-invalid, .is-valid');
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        
        // Limpiar selects
        const vendedorSelect = document.getElementById('cliente_vendedorId');
        const zonaSelect = document.getElementById('cliente_zonaId');
        
        if (vendedorSelect) {
            vendedorSelect.innerHTML = '<option value="">Seleccionar vendedor...</option>';
        }
        
        if (zonaSelect) {
            zonaSelect.innerHTML = '<option value="">Seleccionar zona...</option>';
        }
    }
}

async function recargarSelectsVendedores() {
    const selectsVendedores = document.querySelectorAll('select[id*="vendedor"]');
    
    for (const select of selectsVendedores) {
        await cargarVendedoresEnSelect(select.id);
    }
}

// Función para recargar todos los selects de zonas en la página
async function recargarSelectsZonas() {
    const selectsZonas = document.querySelectorAll('select[id*="zona"]');
    
    for (const select of selectsZonas) {
        await cargarZonasEnSelect(select.id);
    }
}




// Función auxiliar para verificar disponibilidad de CUIT
async function verificarCUITCliente(cuit, excludeId = null) {
    try {
        const url = excludeId 
            ? `/clientes/validate/cuit/${encodeURIComponent(cuit)}?excludeId=${excludeId}`
            : `/clientes/validate/cuit/${encodeURIComponent(cuit)}`;
            
        const response = await apiRequest(url);
        return response.disponible;
    } catch (error) {
        console.error('Error verificando CUIT:', error);
        return true; // Asumir disponible si hay error
    }
}

// Función auxiliar para verificar disponibilidad de email
async function verificarEmailCliente(email, excludeId = null) {
    try {
        const url = excludeId 
            ? `/clientes/validate/email/${encodeURIComponent(email)}?excludeId=${excludeId}`
            : `/clientes/validate/email/${encodeURIComponent(email)}`;
            
        const response = await apiRequest(url);
        return response.disponible;
    } catch (error) {
        console.error('Error verificando email:', error);
        return true; // Asumir disponible si hay error
    }
}

// Función para validación en tiempo real de CUIT único
async function validarCUITUnicoCliente() {
    const cuitInput = document.getElementById('cliente_cuit');
    const clienteId = document.getElementById('cliente_id').value;
    const cuitValue = cuitInput.value.trim();
    
    if (cuitValue && cuitValue.length >= 11) {
        const disponible = await verificarCUITCliente(cuitValue, clienteId);
        
        if (!disponible) {
            showAlert('Este CUIT ya está registrado', 'warning');
            cuitInput.classList.add('is-invalid');
            return false;
        } else {
            cuitInput.classList.remove('is-invalid');
            return true;
        }
    }
    
    return true;
}

// Función mejorada para editar cliente que conserva filtros
async function editarCliente(id) {
    try {
        console.log(`🔧 Editando cliente ID: ${id}`);
        
        // Paso 1: Obtener datos del cliente
        const response = await apiRequest(`/clientes/${id}`);
        
        if (!response.success) {
            showAlert('Error al cargar el cliente', 'danger');
            return;
        }
        
        const cliente = response.data;
        console.log('📊 Datos del cliente:', cliente);
        
        // Paso 2: Cargar datos en los selects ANTES de mostrar el modal
        console.log('⏳ Cargando vendedores y zonas...');
        
        const [vendedoresCargados, zonasCargadas] = await Promise.all([
            cargarVendedoresEnSelect('cliente_vendedorId'),
            cargarZonasEnSelect('cliente_zonaId')
        ]);
        
        // Verificar que se cargaron correctamente
        if (!vendedoresCargados) {
            console.warn('⚠️ No se pudieron cargar los vendedores');
        }
        
        if (!zonasCargadas) {
            console.warn('⚠️ No se pudieron cargar las zonas');
        }
        
        // Paso 3: Llenar el formulario con los datos del cliente
        console.log('📝 Llenando formulario...');
        
        document.getElementById('cliente_id').value = cliente.clienteId;
        document.getElementById('cliente_razonSocial').value = cliente.razonSocial || '';
        document.getElementById('cliente_cuit').value = cliente.cuit || '';
        document.getElementById('cliente_condicionIVA').value = cliente.condicionIVA || '';
        document.getElementById('cliente_email').value = cliente.email || '';
        document.getElementById('cliente_telefono').value = cliente.telefono || '';
        document.getElementById('cliente_domicilio').value = cliente.domicilio || '';
        document.getElementById('cliente_localidad').value = cliente.localidad || '';
        document.getElementById('cliente_provincia').value = cliente.provincia || '';
        document.getElementById('cliente_codigoPostal').value = cliente.codigoPostal || '';
        document.getElementById('cliente_tiene_deposito').checked = cliente.tiene_deposito == 1;
        
        // Paso 4: Seleccionar los valores correspondientes en los selects
        // Usar setTimeout para asegurar que el DOM se haya actualizado
        setTimeout(() => {
            if (cliente.vendedorId) {
                const vendedorSelect = document.getElementById('cliente_vendedorId');
                vendedorSelect.value = cliente.vendedorId;
                console.log(`✅ Vendedor seleccionado: ${cliente.vendedorId}`);
            }
            
            if (cliente.zonaId) {
                const zonaSelect = document.getElementById('cliente_zonaId');
                zonaSelect.value = cliente.zonaId;
                console.log(`✅ Zona seleccionada: ${cliente.zonaId}`);
            }
        }, 100);
        
        // Paso 5: Configurar y mostrar el modal
        document.getElementById('modalClienteTitle').textContent = 'Editar Cliente';
        
        const modal = new bootstrap.Modal(document.getElementById('modalCliente'));
        modal.show();
        
        // Enfocar primer campo después de mostrar el modal
        setTimeout(() => {
            document.getElementById('cliente_razonSocial').focus();
        }, 300);
        
        console.log('✅ Modal de edición abierto correctamente');
        
    } catch (error) {
        console.error('💥 Error editando cliente:', error);
        showAlert('Error al cargar los datos del cliente: ' + error.message, 'danger');
    }
}
// Función para eliminar cliente
async function eliminarCliente(id) {
    if (!confirm('¿Estás seguro de que quieres eliminar este cliente? Esta acción no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await apiRequest(`/clientes/${id}`, 'DELETE');
        
        if (response.success) {
            showAlert('Cliente eliminado exitosamente', 'success');
            loadClientes();
        } else {
            showAlert(response.message || 'Error al eliminar cliente', 'danger');
        }
    } catch (error) {
        console.error('Error eliminando cliente:', error);
        showAlert('Error al eliminar cliente', 'danger');
    }
}

// Función para toggle activo/inactivo
async function toggleClienteActivo(id, estadoActual) {
    const nuevoEstado = !estadoActual;
    const accion = nuevoEstado ? 'activar' : 'desactivar';
    
    if (!confirm(`¿Estás seguro de que quieres ${accion} este cliente?`)) {
        return;
    }
    
    try {
        const response = await apiRequest(`/clientes/${id}`, 'PUT', { activo: nuevoEstado ? 1 : 0 });
        
        if (response.success) {
            showAlert(`Cliente ${accion}do exitosamente`, 'success');
            loadClientes();
        } else {
            showAlert(`Error al ${accion} cliente`, 'danger');
        }
    } catch (error) {
        console.error(`Error al ${accion} cliente:`, error);
        showAlert(`Error al ${accion} cliente`, 'danger');
    }
}

// Función para ver stock del cliente
async function verStockCliente(id) {
    try {
        const response = await apiRequest(`/clientes/${id}/stock`);
        
        if (response.success) {
            // Mostrar modal o página con el stock del cliente
            const stockItems = response.data.length;
            if (stockItems > 0) {
                showAlert(`Stock del cliente cargado (${stockItems} items)`, 'info');
                // Aquí puedes implementar un modal o redireccionar a una página de stock
            } else {
                showAlert('El cliente no tiene stock en su depósito', 'warning');
            }
        } else {
            showAlert('Error al cargar stock del cliente', 'danger');
        }
    } catch (error) {
        console.error('Error cargando stock:', error);
        showAlert('Error al cargar stock del cliente', 'danger');
    }
}

// Función para ver pedidos del cliente
async function verPedidosCliente(id) {
    try {
        const response = await apiRequest(`/clientes/${id}/pedidos`);
        
        if (response.success) {
            // Mostrar modal o página con los pedidos del cliente
            const pedidosCount = response.data.length;
            if (pedidosCount > 0) {
                showAlert(`Pedidos del cliente cargados (${pedidosCount} pedidos)`, 'info');
                // Aquí puedes implementar un modal o redireccionar a una página de pedidos
            } else {
                showAlert('El cliente no tiene pedidos registrados', 'warning');
            }
        } else {
            showAlert('Error al cargar pedidos del cliente', 'danger');
        }
    } catch (error) {
        console.error('Error cargando pedidos:', error);
        showAlert('Error al cargar pedidos del cliente', 'danger');
    }
}

// Función para toggle depósito del cliente
async function toggleDepositoCliente(id, tieneDeposito) {
    const accion = !tieneDeposito ? 'habilitar' : 'deshabilitar';
    
    if (!confirm(`¿Estás seguro de que quieres ${accion} el depósito para este cliente?`)) {
        return;
    }
    
    try {
        const response = await apiRequest(`/clientes/${id}/deposito/toggle`, 'PUT');
        
        if (response.success) {
            showAlert(`Depósito ${accion}do exitosamente`, 'success');
            loadClientes();
        } else {
            showAlert(`Error al ${accion} depósito`, 'danger');
        }
    } catch (error) {
        console.error(`Error al ${accion} depósito:`, error);
        showAlert(`Error al ${accion} depósito`, 'danger');
    }
}





// Función auxiliar para verificar disponibilidad de nombre de zona
async function verificarNombreZona(nombre, excludeId = null) {
    try {
        const url = excludeId 
            ? `/zonas/validate/nombre/${encodeURIComponent(nombre)}?excludeId=${excludeId}`
            : `/zonas/validate/nombre/${encodeURIComponent(nombre)}`;
            
        const response = await apiRequest(url);
        return response.disponible;
    } catch (error) {
        console.error('Error verificando nombre de zona:', error);
        return true; // Asumir disponible si hay error
    }
}

// Event listeners para validación en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const zonaNombreInput = document.getElementById('zona_nombre');
    if (zonaNombreInput) {
        // Validación en tiempo real del nombre
        zonaNombreInput.addEventListener('input', function() {
            const valor = this.value.trim();
            
            // Remover caracteres inválidos automáticamente
            if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ0-9\s\-_\.]*$/.test(valor)) {
                this.value = valor.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ0-9\s\-_\.]/g, '');
                showAlert('Solo se permiten letras, números, espacios y guiones', 'warning');
            }
            
            // Validar longitud
            if (valor.length > 100) {
                this.classList.add('is-invalid');
            } else if (valor.length >= 2) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-invalid', 'is-valid');
            }
        });
        
        zonaNombreInput.addEventListener('blur', function() {
            const valor = this.value.trim();
            
            if (!valor) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else if (valor.length < 2) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
                showAlert('El nombre debe tener al menos 2 caracteres', 'warning');
            } else if (valor.length > 100) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
                showAlert('El nombre no puede exceder 100 caracteres', 'warning');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    }

    // Event listener para el estado activo
    const zonaActivoCheckbox = document.getElementById('zona_activo');
    if (zonaActivoCheckbox) {
        zonaActivoCheckbox.addEventListener('change', function() {
            const zonaId = document.getElementById('zona_id').value;
            
            // Si estamos editando una zona existente y se está desactivando, advertir
            if (zonaId && !this.checked) {
                if (!confirm('¿Estás seguro de desactivar esta zona? Los clientes existentes mantendrán la asignación, pero no se podrán asignar nuevos clientes a esta zona.')) {
                    this.checked = true; // Revertir el cambio
                }
            }
        });
    }
});

// Función para limpiar el formulario de zona
function limpiarFormularioZona() {
    const form = document.getElementById('formZona');
    if (form) {
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById('zona_id').value = '';
        
        // Remover clases de validación
        const inputs = form.querySelectorAll('.is-invalid, .is-valid');
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        
        // Activar por defecto
        document.getElementById('zona_activo').checked = true;
    }
}



// Función mejorada para eliminar zona
async function eliminarZona(id) {
    try {
        // Verificar si tiene clientes primero (desde datos locales si están disponibles)
        let clientesCount = 0;
        
        if (typeof zonas !== 'undefined') {
            const zona = zonas.find(z => z.zonaId == id);
            clientesCount = zona ? (zona.clientes_count || zona.total_clientes || 0) : 0;
        }
        
        // Si no tenemos datos locales, consultar al servidor
        if (clientesCount === 0) {
            try {
                const clientesResponse = await apiRequest(`/clientes?zona=${id}`);
                if (clientesResponse.success) {
                    clientesCount = clientesResponse.data.length;
                }
            } catch (error) {
                console.warn('No se pudo verificar clientes asociados:', error);
            }
        }
        
        if (clientesCount > 0) {
            showAlert(`No se puede eliminar la zona porque tiene ${clientesCount} cliente(s) asignado(s)`, 'warning');
            return;
        }
        
        if (!confirm('¿Estás seguro de que quieres eliminar esta zona? Esta acción no se puede deshacer.')) {
            return;
        }
        
        const response = await apiRequest(`/zonas/${id}`, {
            method: 'DELETE'
        });
        
        if (response.success) {
            showAlert('Zona eliminada exitosamente', 'success');
            await loadZonas();
            
            if (typeof actualizarEstadisticasZonas === 'function') {
                actualizarEstadisticasZonas();
            }
        } else {
            showAlert(response.message || 'Error al eliminar zona', 'danger');
        }
        
    } catch (error) {
        console.error('Error eliminando zona:', error);
        showAlert('Error al eliminar zona', 'danger');
    }
}

// Función para validación en tiempo real de nombre único
async function validarNombreUnicoZona() {
    const nombreInput = document.getElementById('zona_nombre');
    const zonaId = document.getElementById('zona_id').value;
    const nombreValue = nombreInput.value.trim();
    
    if (nombreValue && nombreValue.length >= 2) {
        const disponible = await verificarNombreZona(nombreValue, zonaId);
        
        if (!disponible) {
            showAlert('Este nombre de zona ya existe', 'warning');
            nombreInput.classList.add('is-invalid');
            nombreInput.classList.remove('is-valid');
            return false;
        } else {
            nombreInput.classList.remove('is-invalid');
            nombreInput.classList.add('is-valid');
            return true;
        }
    }
    
    return true;
}

// Función auxiliar para capitalizar texto (mejorar presentación)
function capitalizarZona(texto) {
    return texto.split(' ')
                .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase())
                .join(' ');
}

// Event listener adicional para capitalización automática
document.addEventListener('DOMContentLoaded', function() {
    const zonaNombreInput = document.getElementById('zona_nombre');
    if (zonaNombreInput) {
        zonaNombreInput.addEventListener('blur', function() {
            if (this.value.trim()) {
                this.value = capitalizarZona(this.value.trim());
            }
        });
    }
});

// Función para editar zona
async function editarZona(id) {
    try {
        const response = await apiRequest(`/zonas/${id}`);
        
        if (!response.success) {
            showAlert('Error al cargar la zona', 'danger');
            return;
        }
        
        const zona = response.data;
        
        // Llenar el formulario
        document.getElementById('zona_id').value = zona.zonaId;
        document.getElementById('zona_nombre').value = zona.zona || '';
        document.getElementById('zona_activo').checked = zona.activo == 1;
        
        document.getElementById('modalZonaTitle').textContent = 'Editar Zona';
        new bootstrap.Modal(document.getElementById('modalZona')).show();
        
    } catch (error) {
        console.error('Error editando zona:', error);
        // Buscar en datos locales como fallback
        const zona = zonas.find(z => z.zonaId == id);
        if (zona) {
            document.getElementById('zona_id').value = zona.zonaId;
            document.getElementById('zona_nombre').value = zona.zona || '';
            document.getElementById('zona_activo').checked = zona.activo == 1;
            
            document.getElementById('modalZonaTitle').textContent = 'Editar Zona';
            new bootstrap.Modal(document.getElementById('modalZona')).show();
        } else {
            showAlert('Error al cargar los datos de la zona', 'danger');
        }
    }
}

// Función para eliminar zona
async function eliminarZona(id) {
    // Verificar si tiene clientes
    const zona = zonas.find(z => z.zonaId == id);
    const clientesCount = zona ? (zona.clientes_count || zona.total_clientes || 0) : 0;
    
    if (clientesCount > 0) {
        showAlert('No se puede eliminar la zona porque tiene clientes asignados', 'warning');
        return;
    }
    
    if (!confirm('¿Estás seguro de que quieres eliminar esta zona? Esta acción no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await apiRequest(`/zonas/${id}`, 'DELETE');
        
        if (response.success) {
            showAlert('Zona eliminada exitosamente', 'success');
            loadZonas();
        } else {
            showAlert(response.message || 'Error al eliminar zona', 'danger');
        }
    } catch (error) {
        console.error('Error eliminando zona:', error);
        showAlert('Error al eliminar zona', 'danger');
    }
}

// Función para toggle activo/inactivo
async function toggleZonaActiva(id, estadoActual) {
    const nuevoEstado = !estadoActual;
    const accion = nuevoEstado ? 'activar' : 'desactivar';
    
    if (!confirm(`¿Estás seguro de que quieres ${accion} esta zona?`)) {
        return;
    }
    
    try {
        const response = await apiRequest(`/zonas/${id}`, 'PUT', { activo: nuevoEstado ? 1 : 0 });
        
        if (response.success) {
            showAlert(`Zona ${accion}da exitosamente`, 'success');
            loadZonas();
        } else {
            showAlert(`Error al ${accion} zona`, 'danger');
        }
    } catch (error) {
        console.error(`Error al ${accion} zona:`, error);
        showAlert(`Error al ${accion} zona`, 'danger');
    }
}




async function cargarZonas() {
    try {
        const response = await apiRequest('/zonas');
        if (response.success) {
            zonas = response.data;
            const select = document.getElementById('cliente_zonaId');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar zona...</option>';
                zonas.filter(zona => zona.activo == 1).forEach(zona => {
                    const option = document.createElement('option');
                    option.value = zona.zonaId;
                    option.textContent = zona.zona;
                    select.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error cargando zonas:', error);
        // Fallback con zonas demo
        const select = document.getElementById('cliente_zonaId');
        if (select) {
            select.innerHTML = `
                <option value="">Seleccionar zona...</option>
                <option value="1">Zona Norte</option>
                <option value="2">Zona Sur</option>
                <option value="3">Centro</option>
                <option value="4">Zona Este</option>
            `;
        }
    }
}

// Función para cargar datos para filtros
async function cargarDatosFiltrosClientes() {
    try {
        // Cargar vendedores para filtro
        const responseVendedores = await apiRequest('/vendedores');
        if (responseVendedores.success) {
            vendedoresParaFiltro = responseVendedores.data;
            const selectVendedor = document.getElementById('filtro-clientes-vendedor');
            selectVendedor.innerHTML = '<option value="">Todos los vendedores</option>';
            vendedoresParaFiltro.forEach(vendedor => {
                const option = document.createElement('option');
                option.value = vendedor.vendedorId;
                option.textContent = vendedor.razonSocial;
                selectVendedor.appendChild(option);
            });
        }

        // Cargar zonas para filtro
        const responseZonas = await apiRequest('/zonas');
        if (responseZonas.success) {
            zonasParaFiltro = responseZonas.data;
            const selectZona = document.getElementById('filtro-clientes-zona');
            selectZona.innerHTML = '<option value="">Todas las zonas</option>';
            zonasParaFiltro.forEach(zona => {
                const option = document.createElement('option');
                option.value = zona.zonaId;
                option.textContent = zona.zona;
                selectZona.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error cargando datos para filtros:', error);
        // Cargar datos demo
        cargarDatosFiltrosDemo();
    }
}

// Función demo para filtros
function cargarDatosFiltrosDemo() {
    // Vendedores demo
    const selectVendedor = document.getElementById('filtro-clientes-vendedor');
    selectVendedor.innerHTML = `
        <option value="">Todos los vendedores</option>
        <option value="1">Vendedor Demo</option>
        <option value="2">Juan Pérez</option>
        <option value="3">María González</option>
    `;

    // Zonas demo
    const selectZona = document.getElementById('filtro-clientes-zona');
    selectZona.innerHTML = `
        <option value="">Todas las zonas</option>
        <option value="1">Zona Norte</option>
        <option value="2">Zona Sur</option>
        <option value="3">Centro</option>
    `;
}



// Función para limpiar filtros de clientes
function limpiarFiltrosClientes() {
    document.getElementById('filtro-clientes-busqueda').value = '';
    document.getElementById('filtro-clientes-vendedor').value = '';
    document.getElementById('filtro-clientes-zona').value = '';
    document.getElementById('filtro-clientes-activo').value = '';
    document.getElementById('filtro-clientes-deposito').value = '';
    document.getElementById('filtro-clientes-iva').value = '';
    
    // Recargar todos los clientes
    loadClientes();
    
    // Actualizar información
    actualizarContadorFiltrosClientes(clientes.length);
    document.getElementById('info-filtros-clientes').textContent = 'Mostrando todos los clientes';
    
    showAlert('Filtros limpiados', 'info');
}

// Función para aplicar filtros rápidos
function aplicarFiltroRapidoClientes(tipo) {
    // Limpiar filtros primero
    limpiarFiltrosClientes();
    
    switch(tipo) {
        case 'activos':
            document.getElementById('filtro-clientes-activo').value = '1';
            break;
        case 'con_deposito':
            document.getElementById('filtro-clientes-deposito').value = '1';
            break;
        case 'sin_stock':
            // Este filtro requiere una consulta especial al backend
            showAlert('Consultando clientes sin stock...', 'info');
            break;
    }
    
    // Aplicar el filtro
    if (tipo !== 'sin_stock') {
        aplicarFiltrosClientes();
    }
}

// Función para actualizar contador de filtros
function actualizarContadorFiltrosClientes(cantidad) {
    const contador = document.getElementById('contador-clientes-filtros');
    if (contador) {
        contador.textContent = `${cantidad} cliente${cantidad !== 1 ? 's' : ''}`;
    }
}

// Función para actualizar información de filtros aplicados
function actualizarInfoFiltrosClientes(busqueda, vendedor, zona, activo, deposito, iva) {
    const filtrosAplicados = [];
    
    if (busqueda) filtrosAplicados.push(`Búsqueda: "${busqueda}"`);
    if (vendedor) {
        const vendedorNombre = vendedoresParaFiltro.find(v => v.vendedorId == vendedor)?.razonSocial || vendedor;
        filtrosAplicados.push(`Vendedor: ${vendedorNombre}`);
    }
    if (zona) {
        const zonaNombre = zonasParaFiltro.find(z => z.zonaId == zona)?.zona || zona;
        filtrosAplicados.push(`Zona: ${zonaNombre}`);
    }
    if (activo !== '') filtrosAplicados.push(`Estado: ${activo === '1' ? 'Activos' : 'Inactivos'}`);
    if (deposito !== '') filtrosAplicados.push(`Depósito: ${deposito === '1' ? 'Con depósito' : 'Sin depósito'}`);
    if (iva) filtrosAplicados.push(`IVA: ${iva}`);
    
    const infoElement = document.getElementById('info-filtros-clientes');
    if (filtrosAplicados.length > 0) {
        infoElement.textContent = `Filtros aplicados: ${filtrosAplicados.join(' | ')}`;
    } else {
        infoElement.textContent = 'Mostrando todos los clientes';
    }
}

// Función para exportar clientes filtrados
function exportarClientesFiltrados() {
    if (!clientes || clientes.length === 0) {
        showAlert('No hay clientes para exportar', 'warning');
        return;
    }

    // Crear CSV
    const headers = ['Razón Social', 'CUIT', 'Email', 'Teléfono', 'Localidad', 'Vendedor', 'Zona', 'Depósito', 'Estado'];
    const csvContent = [
        headers.join(','),
        ...clientes.map(cliente => [
            `"${cliente.razonSocial || ''}"`,
            cliente.cuit || '',
            cliente.email || '',
            cliente.telefono || '',
            cliente.localidad || '',
            `"${cliente.vendedor_nombre || ''}"`,
            `"${cliente.zona_nombre || ''}"`,
            cliente.tiene_deposito ? 'Sí' : 'No',
            cliente.activo ? 'Activo' : 'Inactivo'
        ].join(','))
    ].join('\n');

    // Descargar archivo
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `clientes_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();

    showAlert(`Exportados ${clientes.length} clientes`, 'success');
}

// Función para toggle vista compacta
function toggleVistaCompacta(seccion) {
    const tabla = document.querySelector(`#tabla-${seccion}`);
    if (tabla) {
        tabla.classList.toggle('table-sm');
        const btn = event.target.closest('button');
        const icon = btn.querySelector('i');
        
        if (tabla.classList.contains('table-sm')) {
            icon.className = 'fas fa-expand-alt';
            btn.title = 'Vista normal';
        } else {
            icon.className = 'fas fa-compress-alt';
            btn.title = 'Vista compacta';
        }
    }
}

// Función para actualizar clientes
function actualizarClientes() {
    showAlert('Actualizando clientes...', 'info');
    loadClientes();
}

const loadClientesOriginal = loadClientes;
loadClientes = async function() {
    await loadClientesOriginal();
    await cargarDatosFiltrosClientes();
    
    // Restaurar filtros guardados
    setTimeout(() => {
        restaurarFiltrosClientes();
    }, 100);
    
    actualizarContadorFiltrosClientes(clientes.length);
};

// Agregar event listeners para filtros automáticos
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar filtros al presionar Enter en el campo de búsqueda
    document.getElementById('filtro-clientes-busqueda')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            aplicarFiltrosClientes();
        }
    });
    
    // Aplicar filtros automáticamente al cambiar selects
    const selectsAutoFilter = [
        'filtro-clientes-vendedor',
        'filtro-clientes-zona', 
        'filtro-clientes-activo',
        'filtro-clientes-deposito'
    ];
    
    selectsAutoFilter.forEach(selectId => {
        document.getElementById(selectId)?.addEventListener('change', function() {
            // Aplicar filtros con un pequeño delay para mejor UX
            setTimeout(aplicarFiltrosClientes, 300);
        });
    });
});

// Función para mejorar la UX del modal de zonas
document.addEventListener('DOMContentLoaded', function() {
    const modalZona = document.getElementById('modalZona');
    
    if (modalZona) {
        // Agregar clase específica al modal
        modalZona.classList.add('modal-zona');
        
        // Event listener para cuando se abre el modal
        modalZona.addEventListener('shown.bs.modal', function() {
            const nombreInput = document.getElementById('zona_nombre');
            if (nombreInput) {
                nombreInput.focus();
            }
        });
        
        // Event listener para cuando se cierra el modal
        modalZona.addEventListener('hidden.bs.modal', function() {
            limpiarFormularioZona();
        });
        
        // Prevenir cierre accidental con Escape si hay datos
        modalZona.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const nombreInput = document.getElementById('zona_nombre');
                if (nombreInput && nombreInput.value.trim()) {
                    if (!confirm('¿Estás seguro de que quieres cerrar? Se perderán los datos ingresados.')) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }
            }
        });
        
        // Submit del formulario con Enter
        const formZona = document.getElementById('formZona');
        if (formZona) {
            formZona.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    guardarZona();
                }
            });
        }
    }
});

// Función para actualizar el texto del botón según el modo
function actualizarBotonGuardarZona(isEditing) {
    const btnText = document.getElementById('btnGuardarZonaText');
    if (btnText) {
        btnText.textContent = isEditing ? 'Actualizar Zona' : 'Guardar Zona';
    }
}

// Hook para actualizar el texto del botón cuando se edita
const editarZonaOriginal = editarZona;
if (typeof editarZona === 'function') {
    editarZona = function(id) {
        actualizarBotonGuardarZona(true);
        return editarZonaOriginal(id);
    };
}

// Hook para actualizar el texto del botón cuando se crea nueva
const abrirModalZonaOriginal = abrirModalZona;
if (typeof abrirModalZona === 'function') {
    abrirModalZona = function() {
        actualizarBotonGuardarZona(false);
        return abrirModalZonaOriginal();
    };
}

// Cargar todos los depósitos
async function loadDepositos() {
    try {
        showLoading('tabla-depositos');
        
        const response = await apiRequest('/depositos');
        
        if (response.success && response.data) {
            depositos = response.data;
            depositosFiltrados = [...depositos];
            renderTablaDepositos();
            actualizarEstadisticasDepositos();
        } else {
            throw new Error(response.message || 'Error al cargar depósitos');
        }
    } catch (error) {
        console.error('Error cargando depósitos:', error);
        showAlert('Error al cargar depósitos: ' + error.message, 'danger');
        document.getElementById('tabla-depositos').innerHTML = 
            '<tr><td colspan="8" class="text-center text-danger">Error al cargar datos</td></tr>';
    }
}

// Renderizar tabla de depósitos
function renderTablaDepositos() {
    const tbody = document.getElementById('tabla-depositos');
    
    if (!depositosFiltrados || depositosFiltrados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay depósitos registrados</td></tr>';
        return;
    }

    tbody.innerHTML = depositosFiltrados.map(deposito => {
        const tipoClase = {
            'CENTRAL': 'badge bg-primary',
            'VENDEDOR': 'badge bg-success', 
            'CLIENTE': 'badge bg-info'
        };

        const estadoClase = deposito.activo ? 'badge bg-success' : 'badge bg-secondary';
        const estadoTexto = deposito.activo ? 'Activo' : 'Inactivo';

        const entidadInfo = deposito.entity_id ? 
            `<small class="text-muted d-block">${deposito.entidad_nombre || 'N/A'}</small>` : 
            '<small class="text-muted">-</small>';

        const stockItems = deposito.total_items || 0;
        const valorStock = deposito.valor_total ? `$${Number(deposito.valor_total).toLocaleString()}` : '$0';

        return `
            <tr ${!deposito.activo ? 'class="table-secondary"' : ''}>
                <td>
                    <strong>${deposito.nombre}</strong>
                    ${deposito.direccion ? `<small class="text-muted d-block">${deposito.direccion}</small>` : ''}
                </td>
                <td><span class="${tipoClase[deposito.tipo] || 'badge bg-secondary'}">${deposito.tipo}</span></td>
                <td>${entidadInfo}</td>
                <td>${deposito.direccion || '<em class="text-muted">Sin dirección</em>'}</td>
                <td>
                    <span class="badge ${stockItems > 0 ? 'bg-info' : 'bg-light text-dark'}">${stockItems}</span>
                    ${stockItems > 0 ? `<button class="btn btn-sm btn-outline-info ms-1" onclick="verStockDeposito(${deposito.id})" title="Ver detalle"><i class="fas fa-eye"></i></button>` : ''}
                </td>
                <td>${valorStock}</td>
                <td><span class="${estadoClase}">${estadoTexto}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editarDeposito(${deposito.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${stockItems > 0 ? '' : `
                        <button class="btn btn-outline-danger" onclick="eliminarDeposito(${deposito.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                        `}
                        <button class="btn btn-outline-info" onclick="verMovimientosDeposito(${deposito.id})" title="Ver movimientos">
                            <i class="fas fa-history"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Actualizar estadísticas de depósitos
function actualizarEstadisticasDepositos() {
    const total = depositos.length;
    const activos = depositos.filter(d => d.activo).length;
    const totalItems = depositos.reduce((sum, d) => sum + (d.total_items || 0), 0);
    const valorTotal = depositos.reduce((sum, d) => sum + (Number(d.valor_total) || 0), 0);

    document.getElementById('stat-depositos-total').textContent = total;
    document.getElementById('stat-depositos-activos').textContent = activos;
    document.getElementById('stat-items-stock').textContent = totalItems;
    document.getElementById('stat-valor-total').textContent = `$${valorTotal.toLocaleString()}`;
}

// Filtrar depósitos
function filtrarDepositos() {
    const filtroTipo = document.getElementById('filtro-tipo-deposito').value;
    const filtroEstado = document.getElementById('filtro-estado-deposito').value;
    const busqueda = document.getElementById('buscar-deposito').value.toLowerCase();

    depositosFiltrados = depositos.filter(deposito => {
        const cumpleTipo = !filtroTipo || deposito.tipo === filtroTipo;
        const cumpleEstado = filtroEstado === '' || deposito.activo.toString() === filtroEstado;
        const cumpleBusqueda = !busqueda || 
            deposito.nombre.toLowerCase().includes(busqueda) ||
            (deposito.entidad_nombre && deposito.entidad_nombre.toLowerCase().includes(busqueda));

        return cumpleTipo && cumpleEstado && cumpleBusqueda;
    });

    renderTablaDepositos();
}

// =============================================
// 📝 FUNCIONES DE MODAL
// =============================================

// Abrir modal para nuevo depósito
function abrirModalDeposito() {
    isEditingDeposito = false;
    limpiarFormularioDeposito();
    document.getElementById('modalDepositoTitle').textContent = 'Nuevo Depósito';
    document.getElementById('btnGuardarDepositoText').textContent = 'Crear Depósito';
    document.getElementById('seccion-entidad').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('modalDeposito'));
    modal.show();
}

// Editar depósito existente
async function editarDeposito(id) {
    try {
        const response = await apiRequest(`/depositos/${id}`);
        
        if (response.success && response.data) {
            const deposito = response.data;
            isEditingDeposito = true;
            
            document.getElementById('modalDepositoTitle').textContent = 'Editar Depósito';
            document.getElementById('btnGuardarDepositoText').textContent = 'Actualizar Depósito';
            
            // Llenar formulario
            document.getElementById('deposito_id').value = deposito.id;
            document.getElementById('deposito_nombre').value = deposito.nombre || '';
            document.getElementById('deposito_tipo').value = deposito.tipo || '';
            document.getElementById('deposito_direccion').value = deposito.direccion || '';
            document.getElementById('deposito_activo').checked = deposito.activo;
            
            // Manejar entidad si es necesario
            if (deposito.tipo === 'VENDEDOR' || deposito.tipo === 'CLIENTE') {
                await tipoDepositoChanged();
                if (deposito.entity_id) {
                    document.getElementById('deposito_entidad').value = deposito.entity_id;
                }
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalDeposito'));
            modal.show();
        }
    } catch (error) {
        console.error('Error cargando depósito:', error);
        showAlert('Error al cargar depósito: ' + error.message, 'danger');
    }
}

// Cambio en tipo de depósito
async function tipoDepositoChanged() {
    const tipo = document.getElementById('deposito_tipo').value;
    const seccionEntidad = document.getElementById('seccion-entidad');
    const selectEntidad = document.getElementById('deposito_entidad');
    
    if (tipo === 'VENDEDOR' || tipo === 'CLIENTE') {
        seccionEntidad.style.display = 'block';
        selectEntidad.required = true;
        
        // Cargar entidades disponibles
        await cargarEntidadesSinDeposito(tipo);
    } else {
        seccionEntidad.style.display = 'none';
        selectEntidad.required = false;
        selectEntidad.innerHTML = '<option value="">Seleccionar...</option>';
    }
}

// Cargar entidades sin depósito
async function cargarEntidadesSinDeposito(tipo) {
    try {
        const endpoint = tipo === 'VENDEDOR' ? '/vendedores/sin-deposito' : '/clientes/sin-deposito';
        const response = await apiRequest(endpoint);
        
        const selectEntidad = document.getElementById('deposito_entidad');
        selectEntidad.innerHTML = '<option value="">Seleccionar...</option>';
        
        if (response.success && response.data) {
            response.data.forEach(entidad => {
                const nombre = tipo === 'VENDEDOR' ? entidad.razonSocial : entidad.razonSocial;
                const id = tipo === 'VENDEDOR' ? entidad.vendedorId : entidad.clienteId;
                selectEntidad.innerHTML += `<option value="${id}">${nombre}</option>`;
            });
        }
        
        // Si estamos editando, mantener la selección actual
        if (isEditingDeposito) {
            const depositoActual = depositos.find(d => d.id == document.getElementById('deposito_id').value);
            if (depositoActual && depositoActual.entity_id) {
                // Agregar opción actual aunque ya tenga depósito
                const nombre = depositoActual.entidad_nombre;
                selectEntidad.innerHTML += `<option value="${depositoActual.entity_id}" selected>${nombre} (actual)</option>`;
            }
        }
    } catch (error) {
        console.error('Error cargando entidades:', error);
        showAlert('Error al cargar entidades disponibles', 'warning');
    }
}

// Limpiar formulario
function limpiarFormularioDeposito() {
    document.getElementById('formDeposito').reset();
    document.getElementById('deposito_id').value = '';
    document.getElementById('deposito_activo').checked = true;
    document.getElementById('seccion-entidad').style.display = 'none';
}

// =============================================
// 📝 FUNCIONES CRUD
// =============================================

// Guardar depósito (crear o actualizar)
async function guardarDeposito() {
    try {
        const form = document.getElementById('formDeposito');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const id = document.getElementById('deposito_id').value;
        const tipo = document.getElementById('deposito_tipo').value;
        
        const datosDeposito = {
            nombre: document.getElementById('deposito_nombre').value.trim(),
            tipo: tipo,
            direccion: document.getElementById('deposito_direccion').value.trim(),
            activo: document.getElementById('deposito_activo').checked
        };

        // Agregar entity_id si es necesario
        if (tipo === 'VENDEDOR' || tipo === 'CLIENTE') {
            const entityId = document.getElementById('deposito_entidad').value;
            if (!entityId) {
                showAlert('Debe seleccionar una entidad para este tipo de depósito', 'warning');
                return;
            }
            datosDeposito.entity_id = parseInt(entityId);
        }

        let response;
        if (isEditingDeposito && id) {
            response = await apiRequest(`/depositos/${id}`, 'PUT', datosDeposito);
        } else {
            response = await apiRequest('/depositos', 'POST', datosDeposito);
        }

        if (response.success) {
            showAlert(
                isEditingDeposito ? 'Depósito actualizado exitosamente' : 'Depósito creado exitosamente',
                'success'
            );
            
            // Cerrar modal y recargar
            bootstrap.Modal.getInstance(document.getElementById('modalDeposito')).hide();
            await loadDepositos();
        } else {
            throw new Error(response.message || 'Error al guardar depósito');
        }
    } catch (error) {
        console.error('Error guardando depósito:', error);
        showAlert('Error al guardar depósito: ' + error.message, 'danger');
    }
}

// Eliminar depósito
async function eliminarDeposito(id) {
    const deposito = depositos.find(d => d.id === id);
    if (!deposito) return;

    const confirmacion = await mostrarConfirmacion(
        '¿Eliminar Depósito?',
        `¿Está seguro de que desea eliminar el depósito "${deposito.nombre}"?`,
        'danger'
    );

    if (confirmacion) {
        try {
            const response = await apiRequest(`/depositos/${id}`, 'DELETE');
            
            if (response.success) {
                showAlert('Depósito eliminado exitosamente', 'success');
                await loadDepositos();
            } else {
                throw new Error(response.message || 'Error al eliminar depósito');
            }
        } catch (error) {
            console.error('Error eliminando depósito:', error);
            showAlert('Error al eliminar depósito: ' + error.message, 'danger');
        }
    }
}

// =============================================
// 📝 FUNCIONES ADICIONALES
// =============================================


// =============================================
// FUNCIÓN AUXILIAR: Mostrar información adicional del stock
// =============================================
function mostrarInfoAdicionalStock(response, modalElement) {
    try {
        console.log('📋 Iniciando mostrarInfoAdicionalStock...');
        console.log('Response recibida:', response);
        
        // Buscar o crear contenedor para info adicional
        let infoContainer = modalElement.querySelector('.modal-info-adicional');
        if (!infoContainer) {
            console.log('🔧 Creando nuevo contenedor modal-info-adicional');
            infoContainer = document.createElement('div');
            infoContainer.className = 'modal-info-adicional mt-3';
            
            // Agregar el contenedor al modal-body
            const modalBody = modalElement.querySelector('.modal-body');
            if (modalBody) {
                modalBody.appendChild(infoContainer);
                console.log('✅ Contenedor agregado al modal-body');
            } else {
                console.warn('⚠️ No se encontró .modal-body en el modal');
                return;
            }
        }
        
        // Verificar si hay información para mostrar
        if (!response || !response.success) {
            console.log('❌ Response inválida o sin éxito');
            infoContainer.innerHTML = '';
            return;
        }
        
        // =============================================
        // EXTRAER DATOS SEGÚN LA ESTRUCTURA REAL
        // =============================================
        
        // Información del depósito (siempre presente)
        const deposito = response.deposito;
        
        // Array de stock (puede venir como 'stock' o 'data')
        const stockData = response.stock || response.data || [];
        
        // Estadísticas (puede venir o no)
        const estadisticas = response.estadisticas;
        
        // Alertas (opcional)
        const alertas = response.alertas || [];
        
        // Movimientos recientes (opcional)
        const movimientosRecientes = response.movimientos_recientes || [];
        
        // Total (para compatibilidad con StockController)
        const total = response.total || stockData.length;
        
        let infoHtml = '';
        
        // =============================================
        // INFORMACIÓN DEL DEPÓSITO
        // =============================================
        if (deposito) {
            console.log('🏢 Mostrando información del depósito:', deposito.nombre);
            
            infoHtml += `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-warehouse me-2"></i>
                            Información del Depósito
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row mb-0">
                                    <dt class="col-5">Nombre:</dt>
                                    <dd class="col-7"><strong>${deposito.nombre || 'N/A'}</strong></dd>
                                    
                                    <dt class="col-5">Tipo:</dt>
                                    <dd class="col-7">
                                        <span class="badge bg-secondary">${deposito.tipo || 'N/A'}</span>
                                    </dd>
                                    
                                    ${deposito.entidad_nombre ? `
                                    <dt class="col-5">Entidad:</dt>
                                    <dd class="col-7">${deposito.entidad_nombre}</dd>
                                    ` : ''}
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row mb-0">
                                    ${deposito.direccion ? `
                                    <dt class="col-5">Dirección:</dt>
                                    <dd class="col-7">${deposito.direccion}</dd>
                                    ` : ''}
                                    
                                    ${deposito.telefono ? `
                                    <dt class="col-5">Teléfono:</dt>
                                    <dd class="col-7">${deposito.telefono}</dd>
                                    ` : ''}
                                    
                                    ${deposito.email ? `
                                    <dt class="col-5">Email:</dt>
                                    <dd class="col-7">${deposito.email}</dd>
                                    ` : ''}
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // =============================================
        // ESTADÍSTICAS DEL STOCK
        // =============================================
        let stats = estadisticas;
        
        // Si no vienen estadísticas del servidor, calcularlas del array de stock
        if (!stats && stockData.length > 0) {
            console.log('📊 Calculando estadísticas del array de stock');
            stats = {
                total_items: stockData.length,
                total_cantidad: stockData.reduce((sum, item) => {
                    return sum + parseFloat(item.cantidad || item.stock_actual || 0);
                }, 0),
                valor_total: stockData.reduce((sum, item) => {
                    const cantidad = parseFloat(item.cantidad || item.stock_actual || 0);
                    const precio = parseFloat(item.precio_venta || item.precio_unitario || 0);
                    return sum + (cantidad * precio);
                }, 0),
                items_bajo_stock: stockData.filter(item => {
                    const cantidad = parseFloat(item.cantidad || item.stock_actual || 0);
                    const stockMin = parseFloat(item.stock_minimo || 0);
                    return cantidad > 0 && cantidad <= stockMin;
                }).length,
                items_sin_stock: stockData.filter(item => {
                    const cantidad = parseFloat(item.cantidad || item.stock_actual || 0);
                    return cantidad === 0;
                }).length
            };
        }
        
        // Mostrar estadísticas si están disponibles
        if (stats && (stats.total_items > 0 || total > 0)) {
            console.log('📊 Mostrando estadísticas del stock');
            
            // Usar datos del servidor o calculados
            const totalItems = stats.total_items || total || stockData.length;
            const totalCantidad = stats.cantidad_total_unidades || stats.cantidad_total || 0;
            const valorTotal = stats.valor_total || 0;
            const itemsBajoStock = stats.items_bajo_stock || stats.items_con_stock_bajo || 0;
            const itemsSinStock = stats.items_sin_stock || stats.sin_stock || 0;
            
            infoHtml += `
                <div class="card mt-3">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Estadísticas del Stock
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 col-md-3 mb-2">
                                <div class="bg-primary text-white rounded p-2">
                                    <i class="fas fa-boxes d-block mb-1"></i>
                                    <div class="small">Total Items</div>
                                    <div class="fw-bold">${totalItems}</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="bg-info text-white rounded p-2">
                                    <i class="fas fa-cubes d-block mb-1"></i>
                                    <div class="small">Total Unidades</div>
                                    <div class="fw-bold">${totalCantidad}</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="bg-warning text-dark rounded p-2">
                                    <i class="fas fa-exclamation-triangle d-block mb-1"></i>
                                    <div class="small">Stock Bajo</div>
                                    <div class="fw-bold">${itemsBajoStock}</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="bg-danger text-white rounded p-2">
                                    <i class="fas fa-times-circle d-block mb-1"></i>
                                    <div class="small">Sin Stock</div>
                                    <div class="fw-bold">${itemsSinStock}</div>
                                </div>
                            </div>
                        </div>
                        ${valorTotal > 0 ? `
                        <hr>
                        <div class="text-center">
                            <div class="bg-secondary text-white rounded p-2 d-inline-block">
                                <i class="fas fa-dollar-sign me-1"></i>
                                <strong>Valor Total: $${Number(valorTotal).toLocaleString('es-AR', {minimumFractionDigits: 2})}</strong>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // =============================================
        // ALERTAS DE STOCK (si existen)
        // =============================================
        if (alertas && alertas.length > 0) {
            console.log('⚠️ Mostrando alertas de stock');
            infoHtml += `
                <div class="card mt-3">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Alertas de Stock (${alertas.length})
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            ${alertas.slice(0, 6).map(alerta => `
                                <div class="col-md-6 mb-2">
                                    <div class="alert alert-warning py-2 mb-2">
                                        <small>
                                            <strong>${alerta.descripcion}</strong><br>
                                            Stock: ${alerta.cantidad} (Mín: ${alerta.stock_minimo})
                                        </small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${alertas.length > 6 ? `
                            <div class="text-center">
                                <small class="text-muted">Y ${alertas.length - 6} alertas más...</small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // =============================================
        // MOVIMIENTOS RECIENTES (si existen)
        // =============================================
        if (movimientosRecientes && movimientosRecientes.length > 0) {
            console.log('📦 Mostrando movimientos recientes');
            infoHtml += `
                <div class="card mt-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>
                            Últimos Movimientos (${movimientosRecientes.length})
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Mercadería</th>
                                        <th>Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${movimientosRecientes.slice(0, 5).map(mov => `
                                        <tr>
                                            <td><small>${new Date(mov.fecha).toLocaleDateString('es-AR')}</small></td>
                                            <td><span class="badge badge-sm bg-secondary">${mov.tipo}</span></td>
                                            <td><small>${mov.mercaderia}</small></td>
                                            <td class="text-center"><strong>${mov.cantidad}</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${movimientosRecientes.length > 5 ? `
                            <div class="text-center mt-2">
                                <small class="text-muted">Y ${movimientosRecientes.length - 5} movimientos más...</small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // =============================================
        // ÚLTIMA ACTUALIZACIÓN
        // =============================================
        const fechaConsulta = response.fecha_consulta || new Date().toISOString();
        infoHtml += `
            <div class="mt-3 text-muted small text-center">
                <i class="fas fa-clock me-1"></i>
                Consultado: ${new Date(fechaConsulta).toLocaleString('es-AR')}
            </div>
        `;
        
        // =============================================
        // APLICAR EL HTML GENERADO
        // =============================================
        if (infoHtml.trim() === '') {
            console.log('📭 No hay contenido para mostrar');
            infoContainer.style.display = 'none';
        } else {
            infoContainer.innerHTML = infoHtml;
            infoContainer.style.display = 'block';
            console.log('✅ Información adicional del stock mostrada correctamente');
        }
        
    } catch (error) {
        console.error('❌ Error mostrando información adicional:', error);
        
        // Mostrar error en el contenedor si existe
        const infoContainer = modalElement?.querySelector('.modal-info-adicional');
        if (infoContainer) {
            infoContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error cargando información adicional: ${error.message}
                </div>
            `;
        }
    }
}
// =============================================
// FUNCIONES DE UTILIDAD ADICIONALES
// =============================================

// Limpiar modal antes de cerrar
function limpiarModalStock() {
    const tbody = document.getElementById('tabla-stock-deposito');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center">Cargando...</td>
            </tr>
        `;
    }
    
    // Limpiar info adicional
    const modalElement = document.getElementById('modalStockDeposito');
    if (modalElement) {
        const infoContainer = modalElement.querySelector('.modal-info-adicional');
        if (infoContainer) {
            infoContainer.remove();
        }
    }
}

// Agregar event listener para limpiar modal al cerrar
document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('modalStockDeposito');
    if (modalElement) {
        modalElement.addEventListener('hidden.bs.modal', limpiarModalStock);
    }
});

// Ver movimientos del depósito
async function verMovimientosDeposito(depositoId) {
    // Esta función podría abrir otra modal o redirigir a la página de movimientos con filtro
    showPage('movimientos');
    // Aquí podrías agregar lógica para filtrar por depósito específico
}

// =============================================
// 📝 FUNCIONES DE UTILIDAD
// =============================================

// Mostrar loading en tabla
function showLoading(elementId) {
    document.getElementById(elementId).innerHTML = 
        '<tr><td colspan="8" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>Cargando...</td></tr>';
}

// Función para mostrar confirmación (debes tenerla en tu sistema)
async function mostrarConfirmacion(titulo, mensaje, tipo = 'warning') {
    return confirm(`${titulo}\n\n${mensaje}`);
    // Reemplaza esto con tu sistema de modales de confirmación si tienes uno más elegante
}

// =============================================
// 📝 INICIALIZACIÓN
// =============================================

// Agregar al switch de showPage() en tu JavaScript principal:
// case 'depositos':
//     loadDepositos();
//     break;

console.log('🏗️ Gestión de Depósitos cargada correctamente');

// =============================================
// 📝 FUNCIONES DE CARGA DE DATOS
// =============================================

// Cargar depósitos disponibles
async function cargarDepositos() {
    try {
        const response = await apiRequest('/stock/depositos-disponibles');
        if (response.success) {
            depositosDisponibles = response.data || [];
            actualizarSelectoresDepositos();
        }
    } catch (error) {
        console.error('Error cargando depósitos:', error);
        depositosDisponibles = [];
    }
}
////*************************************************////
console.log('🚀 Iniciando definición de MercaderiaAutocomplete...');

// 1. DEFINIR LA CLASE INMEDIATAMENTE (sin condicionales)
window.MercaderiaAutocomplete = class {
    constructor(containerOrOptions, optionsOrCallback) {
        console.log('🔧 Constructor MercaderiaAutocomplete llamado con:', containerOrOptions, optionsOrCallback);
        
        // Manejar diferentes formatos de parámetros
        if (typeof containerOrOptions === 'string') {
            // Formato: new MercaderiaAutocomplete(containerId, options)
            this.container = document.getElementById(containerOrOptions);
            this.options = optionsOrCallback || {};
        } else if (containerOrOptions && typeof containerOrOptions === 'object') {
            // Formato: new MercaderiaAutocomplete({container: element, onSelect: callback})
            if (typeof containerOrOptions.container === 'string') {
                this.container = document.getElementById(containerOrOptions.container);
            } else {
                this.container = containerOrOptions.container;
            }
            this.options = containerOrOptions;
        } else {
            throw new Error('MercaderiaAutocomplete: formato de parámetros inválido');
        }
        
        // Validar contenedor
        if (!this.container) {
            console.error('❌ Contenedor no encontrado:', containerOrOptions);
            throw new Error('MercaderiaAutocomplete: contenedor no encontrado');
        }
        
        // Configurar opciones
        this.onSelect = this.options.onSelect || function() {};
        this.placeholder = this.options.placeholder || 'Buscar mercadería...';
        this.apiUrl = '/api/v1/mercaderias/buscar';
        this.currentProducts = [];
        this.searchTimeout = null;
        
        console.log('✅ MercaderiaAutocomplete inicializando...');
        this.init();
    }
    
    init() {
        // Crear estructura HTML
        this.container.innerHTML = `
            <div style="position: relative;">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control mercaderia-search-input" 
                           placeholder="${this.placeholder}" 
                           autocomplete="off">
                    <button class="btn btn-outline-secondary clear-btn" type="button" 
                            style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="autocomplete-results" style="
                    position: absolute; 
                    top: 100%; 
                    left: 0; 
                    right: 0; 
                    background: white; 
                    border: 1px solid #ddd; 
                    border-top: none; 
                    max-height: 300px; 
                    overflow-y: auto; 
                    z-index: 1050; 
                    display: none;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                </div>
            </div>
        `;
        
        // Obtener referencias de elementos
        this.input = this.container.querySelector('.mercaderia-search-input');
        this.clearBtn = this.container.querySelector('.clear-btn');
        this.results = this.container.querySelector('.autocomplete-results');
        
        // Vincular eventos
        this.bindEvents();
        
        console.log('✅ MercaderiaAutocomplete inicializada correctamente');
    }
    
    bindEvents() {
        // Event listener para el input
        this.input.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            
            // Mostrar/ocultar botón limpiar
            this.clearBtn.style.display = value ? 'block' : 'none';
            
            // Buscar si hay suficientes caracteres
            if (value.length >= 2) {
                // Debounce: cancelar búsqueda anterior
                if (this.searchTimeout) {
                    clearTimeout(this.searchTimeout);
                }
                
                // Nueva búsqueda después de 300ms
                this.searchTimeout = setTimeout(() => {
                    this.search(value);
                }, 300);
            } else {
                this.hideResults();
            }
        });
        
        // Event listener para el botón limpiar
        this.clearBtn.addEventListener('click', () => {
            this.clear();
        });
        
        // Ocultar resultados al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) {
                this.hideResults();
            }
        });
        
        // Navegación con teclado
        this.input.addEventListener('keydown', (e) => {
            const items = this.results.querySelectorAll('.autocomplete-item');
            const activeItem = this.results.querySelector('.autocomplete-item.active');
            let currentIndex = activeItem ? Array.from(items).indexOf(activeItem) : -1;
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    currentIndex = Math.min(currentIndex + 1, items.length - 1);
                    this.highlightItem(currentIndex);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    currentIndex = Math.max(currentIndex - 1, -1);
                    this.highlightItem(currentIndex);
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (activeItem) {
                        const index = parseInt(activeItem.dataset.index);
                        this.selectProduct(index);
                    }
                    break;
                    
                case 'Escape':
                    this.hideResults();
                    break;
            }
        });
    }
    
    async search(query) {
        try {
            console.log('🔍 Buscando:', query);
            
            // Construir URL de búsqueda
            const url = `${this.apiUrl}?q=${encodeURIComponent(query)}&limit=10`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success && Array.isArray(data.data)) {
                this.currentProducts = data.data;
                this.showResults();
                console.log('✅ Encontrados:', this.currentProducts.length, 'productos');
            } else {
                console.warn('⚠️ Respuesta inesperada:', data);
                this.currentProducts = [];
                this.showNoResults();
            }
        } catch (error) {
            console.error('❌ Error buscando mercaderías:', error);
            this.currentProducts = [];
            this.showError(error.message);
        }
    }
    
    showResults() {
        if (this.currentProducts.length > 0) {
            this.results.innerHTML = this.currentProducts.map((product, index) => `
                <div class="autocomplete-item p-2 border-bottom" 
                     data-index="${index}"
                     onclick="window.selectMercaderiaGlobal('${this.container.id}', ${index})"
                     onmouseover="this.classList.add('active')"
                     onmouseout="this.classList.remove('active')"
                     style="cursor: pointer; transition: background-color 0.2s;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${product.codigo_sku || 'Sin código'}</strong>
                            <br>
                            <span>${product.descripcion || 'Sin descripción'}</span>
                            ${product.categoria ? `<br><small class="text-muted">${product.categoria}</small>` : ''}
                        </div>
                        <div class="text-end">
                            ${product.precio_costo ? `<small class="text-success">$${parseFloat(product.precio_costo).toFixed(2)}</small>` : ''}
                            ${product.stock_actual !== undefined ? `<br><small class="text-info">Stock: ${product.stock_actual}</small>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            this.results.style.display = 'block';
        } else {
            this.showNoResults();
        }
    }
    
    showNoResults() {
        this.results.innerHTML = '<div class="p-3 text-muted text-center">No se encontraron productos</div>';
        this.results.style.display = 'block';
    }
    
    showError(message) {
        this.results.innerHTML = `<div class="p-3 text-danger text-center">Error: ${message}</div>`;
        this.results.style.display = 'block';
    }
    
    hideResults() {
        this.results.style.display = 'none';
        this.results.querySelectorAll('.autocomplete-item').forEach(item => {
            item.classList.remove('active');
        });
    }
    
    highlightItem(index) {
        const items = this.results.querySelectorAll('.autocomplete-item');
        
        // Remover highlight anterior
        items.forEach(item => item.classList.remove('active'));
        
        // Agregar highlight al nuevo item
        if (index >= 0 && index < items.length) {
            items[index].classList.add('active');
            items[index].scrollIntoView({ block: 'nearest' });
        }
    }
    
    selectProduct(index) {
        if (index >= 0 && index < this.currentProducts.length) {
            const product = this.currentProducts[index];
            console.log('✅ Producto seleccionado:', product);
            
            // Actualizar input
            this.input.value = `${product.codigo_sku} - ${product.descripcion}`;
            
            // Ocultar resultados
            this.hideResults();
            
            // Llamar callback
            if (typeof this.onSelect === 'function') {
                this.onSelect(product);
            }
        }
    }
    
    clear() {
        this.input.value = '';
        this.clearBtn.style.display = 'none';
        this.hideResults();
        this.currentProducts = [];
        this.input.focus();
    }
    
    focus() {
        if (this.input) {
            this.input.focus();
        }
    }
    
    isValid() {
        return this.input && this.input.value.trim().length > 0;
    }
    
    getSelected() {
        // Intentar encontrar el producto seleccionado basado en el valor del input
        if (this.input && this.input.value) {
            const inputValue = this.input.value;
            return this.currentProducts.find(product => 
                inputValue.includes(product.codigo_sku) || 
                inputValue.includes(product.descripcion)
            ) || null;
        }
        return null;
    }
    
    setValue(product) {
        if (product) {
            this.input.value = `${product.codigo_sku} - ${product.descripcion}`;
            this.clearBtn.style.display = 'block';
        }
    }
};

// 2. FUNCIÓN GLOBAL DE SELECCIÓN
window.selectMercaderiaGlobal = function(containerId, index) {
    // Buscar la instancia del autocomplete por su contenedor
    if (window.autocompletesProductos) {
        const autocomplete = Object.values(window.autocompletesProductos).find(ac => 
            ac.container && ac.container.id === containerId
        );
        
        if (autocomplete) {
            autocomplete.selectProduct(index);
            return;
        }
    }
    
    // Fallback: buscar en autocompleteInstances
    if (window.autocompleteInstances) {
        const autocomplete = Object.values(window.autocompleteInstances).find(ac => 
            ac.container && ac.container.id === containerId
        );
        
        if (autocomplete) {
            autocomplete.selectProduct(index);
            return;
        }
    }
    
    console.warn('⚠️ No se encontró instancia de autocomplete para:', containerId);
};

// 3. FUNCIÓN MEJORADA PARA CREAR AUTOCOMPLETE DE PRODUCTO
window.crearAutocompleteProducto = function(productoId) {
    console.log('🚀 Creando autocomplete para producto:', productoId);
    
    try {
        // Verificar que la clase esté definida
        if (typeof window.MercaderiaAutocomplete === 'undefined') {
            throw new Error('MercaderiaAutocomplete no está definida');
        }
        
        const containerId = `producto-${productoId}-autocomplete`;
        
        // Verificar si ya existe el contenedor
        let container = document.getElementById(containerId);
        if (!container) {
            // Buscar el select existente y reemplazarlo
            const selectElement = document.querySelector(`#producto-${productoId} select`);
            if (selectElement) {
                // Crear contenedor para autocomplete
                const parentDiv = selectElement.parentElement;
                container = document.createElement('div');
                container.id = containerId;
                container.className = 'autocomplete-container';
                parentDiv.replaceChild(container, selectElement);
                console.log('✅ Contenedor creado:', containerId);
            } else {
                throw new Error(`No se encontró select para producto ${productoId}`);
            }
        }
        
        if (container) {
            const autocomplete = new window.MercaderiaAutocomplete(containerId, {
                placeholder: 'Buscar mercadería por código o descripción...',
                onSelect: function(mercaderia) {
                    console.log(`✅ Mercadería seleccionada en producto ${productoId}:`, mercaderia);
                    
                    // Auto-completar campos
                    const productoRow = document.querySelector(`#producto-${productoId}`);
                    if (productoRow) {
                        // Llenar ID oculto
                        const mercaderiaIdInput = productoRow.querySelector('.mercaderia-id, input[type="hidden"]');
                        if (mercaderiaIdInput) {
                            mercaderiaIdInput.value = mercaderia.id;
                        }
                        
                        // Auto-completar precio si está disponible
                        const precioInput = productoRow.querySelector('.precio-input, input[name*="precio"], input[type="number"]');
                        if (precioInput && mercaderia.precio_costo && !precioInput.value) {
                            precioInput.value = parseFloat(mercaderia.precio_costo).toFixed(2);
                        }
                        
                        // Trigger evento para recalcular totales
                        if (typeof calcularSubtotalProducto === 'function') {
                            calcularSubtotalProducto(productoId);
                        } else if (typeof calcularTotales === 'function') {
                            calcularTotales();
                        }
                    }
                    
                    // Guardar referencia de la mercadería seleccionada
                    if (!window.productosCompra) window.productosCompra = {};
                    window.productosCompra[productoId] = {
                        ...window.productosCompra[productoId],
                        mercaderia_seleccionada: mercaderia
                    };
                }
            });
            
            // Guardar referencia del autocomplete
            if (!window.autocompletesProductos) window.autocompletesProductos = {};
            window.autocompletesProductos[productoId] = autocomplete;
            
            // Hacer foco después de un breve delay
            setTimeout(() => {
                autocomplete.focus();
            }, 100);
            
            console.log('✅ Autocomplete creado exitosamente para producto:', productoId);
            return autocomplete;
        }
        
    } catch (error) {
        console.error('❌ Error creando autocomplete:', error);
        
        // Fallback: crear input simple
        const containerId = `producto-${productoId}-autocomplete`;
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `
                <input type="text" class="form-control" 
                       placeholder="Escribir nombre del producto (modo manual)">
                <small class="text-warning">⚠️ Autocomplete no disponible - modo manual</small>
            `;
        }
        
        return null;
    }
};

// 4. CSS PARA MEJORAR LA APARIENCIA
const style = document.createElement('style');
style.textContent = `
    .autocomplete-item:hover {
        background-color: #f8f9fa !important;
    }
    
    .autocomplete-item.active {
        background-color: #e3f2fd !important;
    }
    
    .autocomplete-results {
        border-radius: 0 0 0.375rem 0.375rem;
    }
    
    .autocomplete-container {
        position: relative;
    }
`;
document.head.appendChild(style);

console.log('✅ MercaderiaAutocomplete definida completamente');
console.log('🔧 Funciones disponibles:', {
    MercaderiaAutocomplete: typeof window.MercaderiaAutocomplete,
    crearAutocompleteProducto: typeof window.crearAutocompleteProducto,
    selectMercaderiaGlobal: typeof window.selectMercaderiaGlobal
});

////*********************************************************////
function crearAutocompleteProducto(productoId) {
    console.log('🚀 Creando autocomplete para producto:', productoId);
    
    const containerId = `producto-${productoId}-autocomplete`;
    
    // ✅ VERIFICACIÓN CRÍTICA: Comprobar que MercaderiaAutocomplete existe
    if (typeof window.MercaderiaAutocomplete === 'undefined') {
        console.error('❌ MercaderiaAutocomplete no está definida');
        
        // FALLBACK: Crear input simple funcional
        let container = document.getElementById(containerId);
        if (!container) {
            const selectElement = document.querySelector(`#producto-${productoId} select`);
            if (selectElement) {
                const parentDiv = selectElement.parentElement;
                container = document.createElement('div');
                container.id = containerId;
                container.innerHTML = `
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" 
                               placeholder="Escribir nombre del producto (modo manual)"
                               list="mercaderias-datalist-${productoId}">
                        <input type="hidden" class="mercaderia-id">
                    </div>
                    <datalist id="mercaderias-datalist-${productoId}">
                        <!-- Se llenarán dinámicamente -->
                    </datalist>
                    <small class="text-warning">⚠️ Autocomplete avanzado no disponible - usando modo básico</small>
                `;
                parentDiv.replaceChild(container, selectElement);
                
                // Agregar funcionalidad básica de búsqueda
                const input = container.querySelector('input[type="text"]');
                const datalist = container.querySelector('datalist');
                
                input.addEventListener('input', async function(e) {
                    const query = e.target.value.trim();
                    if (query.length >= 2) {
                        try {
                            const response = await fetch(`/api/v1/mercaderias/buscar?q=${encodeURIComponent(query)}`);
                            const data = await response.json();
                            
                            if (data.success && Array.isArray(data.data)) {
                                datalist.innerHTML = data.data.map(item => 
                                    `<option value="${item.codigo_sku} - ${item.descripcion}" data-id="${item.id}" data-precio="${item.precio_costo || ''}">`
                                ).join('');
                            }
                        } catch (error) {
                            console.error('Error en búsqueda básica:', error);
                        }
                    }
                });
                
                console.log('✅ Fallback básico creado para producto:', productoId);
            }
        }
        return null;
    }
    
    // ✅ SI MERCADERIAAUTOCOMPLETE EXISTE, CONTINUAR NORMALMENTE
    let container = document.getElementById(containerId);
    if (!container) {
        const selectElement = document.querySelector(`#producto-${productoId} select`);
        if (selectElement) {
            const parentDiv = selectElement.parentElement;
            container = document.createElement('div');
            container.id = containerId;
            parentDiv.replaceChild(container, selectElement);
        }
    }
    
    if (container) {
        try {
            const autocomplete = new MercaderiaAutocomplete(containerId, {
                placeholder: 'Buscar mercadería por código o descripción...',
                onSelect: function(mercaderia) {
                    console.log(`✅ Mercadería seleccionada en producto ${productoId}:`, mercaderia);
                    
                    // Auto-completar precio si está disponible
                    const productoRow = document.querySelector(`#producto-${productoId}`);
                    if (productoRow) {
                        // Llenar ID oculto
                        const mercaderiaIdInput = productoRow.querySelector('.mercaderia-id, input[type="hidden"]');
                        if (mercaderiaIdInput) {
                            mercaderiaIdInput.value = mercaderia.id;
                        }
                        
                        const precioInput = productoRow.querySelector('.precio-input, input[type="number"]:nth-of-type(2)');
                        if (precioInput && mercaderia.precio_costo && !precioInput.value) {
                            precioInput.value = parseFloat(mercaderia.precio_costo).toFixed(2);
                        }
                        
                        // Trigger evento para recalcular totales
                        if (typeof calcularSubtotalProducto === 'function') {
                            calcularSubtotalProducto(productoId);
                        } else if (typeof calcularTotales === 'function') {
                            calcularTotales();
                        }
                    }
                    
                    // Guardar referencia de la mercadería seleccionada
                    if (!window.productosCompra) window.productosCompra = {};
                    window.productosCompra[productoId] = {
                        ...window.productosCompra[productoId],
                        mercaderia_seleccionada: mercaderia
                    };
                }
            });
            
            // Guardar referencia del autocomplete
            if (!window.autocompletesProductos) window.autocompletesProductos = {};
            window.autocompletesProductos[productoId] = autocomplete;
            
            return autocomplete;
        } catch (error) {
            console.error('❌ Error creando autocomplete avanzado:', error);
            return null;
        }
    }
    
    return null;
}

// 2. DIAGNÓSTICO: Agregar esta función para verificar el estado
function diagnosticarAutocomplete() {
    console.log('🔍 DIAGNÓSTICO DE AUTOCOMPLETE:');
    console.log('- MercaderiaAutocomplete definida:', typeof window.MercaderiaAutocomplete !== 'undefined');
    console.log('- crearAutocompleteProducto definida:', typeof window.crearAutocompleteProducto !== 'undefined');
    console.log('- autocompletesProductos:', window.autocompletesProductos);
    
    if (typeof window.MercaderiaAutocomplete !== 'undefined') {
        console.log('✅ MercaderiaAutocomplete está disponible');
        try {
            const testContainer = document.createElement('div');
            testContainer.id = 'test-container';
            document.body.appendChild(testContainer);
            
            const testInstance = new window.MercaderiaAutocomplete('test-container', {
                onSelect: () => console.log('Test OK')
            });
            
            document.body.removeChild(testContainer);
            console.log('✅ MercaderiaAutocomplete funciona correctamente');
        } catch (error) {
            console.error('❌ Error probando MercaderiaAutocomplete:', error);
        }
    } else {
        console.error('❌ MercaderiaAutocomplete NO está definida');
        
        // Buscar dónde debería estar definida
        console.log('🔍 Buscando definiciones en el código...');
        const scripts = document.querySelectorAll('script');
        let encontrado = false;
        
        scripts.forEach((script, index) => {
            if (script.textContent && script.textContent.includes('MercaderiaAutocomplete')) {
                console.log(`📜 Script ${index} contiene MercaderiaAutocomplete`);
                encontrado = true;
            }
        });
        
        if (!encontrado) {
            console.error('❌ No se encontró definición de MercaderiaAutocomplete en ningún script');
        }
    }
}

// 3. EJECUTAR DIAGNÓSTICO AUTOMÁTICAMENTE
setTimeout(diagnosticarAutocomplete, 1000);

// 4. COMANDO MANUAL PARA EJECUTAR DIAGNÓSTICO
// Ejecuta en la consola: diagnosticarAutocomplete()
window.diagnosticarAutocomplete = diagnosticarAutocomplete;
///**********************************************************////

// Cargar mercaderías disponibles
async function cargarMercaderias() {
    try {
        console.log('🌐 Cargando mercaderías desde API...');
        
        const response = await apiRequest('/stock/mercaderias-disponibles');
        
        if (response.success) {
            mercaderiasDisponibles = response.data || [];
            console.log(`✅ Mercaderías cargadas: ${mercaderiasDisponibles.length}`);
            
            // NO llamar automáticamente a actualizar selectores aquí
            // Cada función específica decidirá qué selectores actualizar
        } else {
            throw new Error(response.message || 'Error en la respuesta de la API');
        }
        
    } catch (error) {
        console.error('❌ Error cargando mercaderías desde API:', error);
        mercaderiasDisponibles = [];
        throw error;
    }
}

// Actualizar selectores de mercaderías y depósitos
function actualizarSelectores() {
    console.log('🔄 Actualizando selectores con autocomplete...');
    
    // Configurar autocompletes para mercaderías (reemplaza los select)
    const selectoresMercaderiasConfig = [
        { 
            id: 'compra_mercaderia',
            containerId: 'compra-mercaderia-container', // Nuevo contenedor
            placeholder: 'Buscar mercadería para compra...',
            onSelect: (mercaderia) => {
                console.log('Mercadería seleccionada para compra:', mercaderia);
                // Tu lógica existente cuando seleccionas una mercadería
                // Por ejemplo, actualizar precio, etc.
            }
        },
        {
            id: 'trans_mercaderia',
            containerId: 'trans-mercaderia-container',
            placeholder: 'Buscar mercadería para transferir...',
            onSelect: (mercaderia) => {
                console.log('Mercadería seleccionada para transferencia:', mercaderia);
            }
        },
        {
            id: 'ajuste_mercaderia',
            containerId: 'ajuste-mercaderia-container',
            placeholder: 'Buscar mercadería para ajustar...',
            onSelect: (mercaderia) => {
                console.log('Mercadería seleccionada para ajuste:', mercaderia);
            }
        }
    ];

    // Crear autocompletes
    selectoresMercaderiasConfig.forEach(config => {
        // Verificar si el contenedor existe
        if (document.getElementById(config.containerId)) {
            autocompleteInstances[config.id] = new MercaderiaAutocomplete(config.containerId, {
                placeholder: config.placeholder,
                onSelect: config.onSelect
            });
        }
    });

    // Mantener selectores de depósitos como están (sin cambios)
    actualizarSelectoresDepositos();
    
    console.log('✅ Selectores actualizados con autocomplete');
}

// Cargar categorías en selector de filtros
function cargarCategoriasEnSelector(categorias) {
    const select = document.getElementById('filtro-categoria-stock');
    if (select && categorias.length > 0) {
        select.innerHTML = '<option value="">Todas las categorías</option>';
        categorias.forEach(categoria => {
            const option = document.createElement('option');
            option.value = categoria;
            option.textContent = categoria;
            select.appendChild(option);
        });
    }
}

// Cargar selectores para mercaderías (función auxiliar)
async function cargarSelectoresMercaderias(selectorId) {
    console.log(`🔄 Cargando mercaderías para selector: ${selectorId}`);
    
    // Si no se especifica un selectorId, actualizar todos los selectores genéricos
    if (!selectorId) {
        console.log('📦 Actualizando todos los selectores genéricos');
        await cargarMercaderias();
        /*actualizarSelectoresMercaderias();*/
        actualizarTodosLosSelectoresMercaderias();
        console.log('✅ Todos los selectores de mercaderías actualizados');
        return;
    }

    // Si se especifica un selectorId específico, actualizar solo ese
    const select = document.getElementById(selectorId);
    if (!select) {
        console.error(`❌ Elemento con ID '${selectorId}' no encontrado`);
        return;
    }

    try {
        // Mostrar indicador de carga
        select.innerHTML = '<option value="">Cargando mercaderías...</option>';
        select.disabled = true;

        // Cargar mercaderías si no están disponibles
        if (mercaderiasDisponibles.length === 0) {
            console.log('📦 Cargando mercaderías desde API...');
            await cargarMercaderias();
        }

        // Verificar que se cargaron las mercaderías
        if (mercaderiasDisponibles.length === 0) {
            console.warn('⚠️ No se encontraron mercaderías disponibles');
            select.innerHTML = '<option value="">No hay mercaderías disponibles</option>';
            return;
        }

        // Llenar el selector específico
        select.innerHTML = '<option value="">Seleccionar mercadería...</option>';
        
        mercaderiasDisponibles.forEach(mercaderia => {
            const option = document.createElement('option');
            option.value = mercaderia.id;
            option.textContent = `${mercaderia.codigo_sku} - ${mercaderia.descripcion}`;
            
            // Agregar datos adicionales como atributos
            option.setAttribute('data-precio-costo', mercaderia.precio_costo || 0);
            option.setAttribute('data-precio-venta', mercaderia.precio_venta || 0);
            option.setAttribute('data-stock', mercaderia.stock_total || 0);
            
            select.appendChild(option);
        });

        console.log(`✅ Selector '${selectorId}' cargado con ${mercaderiasDisponibles.length} mercaderías`);

    } catch (error) {
        console.error(`❌ Error cargando selector '${selectorId}':`, error);
        select.innerHTML = '<option value="">Error al cargar mercaderías</option>';
        
        if (typeof showAlert === 'function') {
            showAlert('Error al cargar mercaderías: ' + error.message, 'warning');
        }
    } finally {
        // Rehabilitar el selector
        select.disabled = false;
    }
}

// Función corregida que maneja específicamente el selector pasado como parámetro
async function cargarSelectoresDepositos(selectorId) {
    console.log(`🔄 Cargando depósitos para selector: ${selectorId}`);
    
    const select = document.getElementById(selectorId);
    if (!select) {
        console.error(`❌ Elemento con ID '${selectorId}' no encontrado`);
        return;
    }

    try {
        // Mostrar indicador de carga
        select.innerHTML = '<option value="">Cargando depósitos...</option>';
        select.disabled = true;

        // Cargar depósitos si no están disponibles
        if (depositosDisponibles.length === 0) {
            console.log('📦 Cargando depósitos desde API...');
            await cargarDepositos();
        }

        // Verificar que se cargaron los depósitos
        if (depositosDisponibles.length === 0) {
            console.warn('⚠️ No se encontraron depósitos disponibles');
            select.innerHTML = '<option value="">No hay depósitos disponibles</option>';
            return;
        }

        // Determinar placeholder según el selector
        const placeholder = selectorId === 'compra_deposito' ? 
            'Central (por defecto)' : 
            'Seleccionar depósito...';
        
        // Llenar el selector específico
        select.innerHTML = `<option value="">${placeholder}</option>`;
        
        depositosDisponibles.forEach(deposito => {
            const option = document.createElement('option');
            option.value = deposito.id;
            
            // Crear etiqueta descriptiva
            const label = deposito.tipo === 'CENTRAL' ? 
                deposito.nombre : 
                `${deposito.nombre} (${deposito.entidad_nombre || 'N/A'})`;
            
            option.textContent = label;
            option.setAttribute('data-tipo', deposito.tipo);
            select.appendChild(option);
        });

        console.log(`✅ Selector '${selectorId}' cargado con ${depositosDisponibles.length} depósitos`);

    } catch (error) {
        console.error(`❌ Error cargando selector '${selectorId}':`, error);
        select.innerHTML = '<option value="">Error al cargar depósitos</option>';
        
        // Mostrar alerta al usuario
        if (typeof showAlert === 'function') {
            showAlert('Error al cargar depósitos: ' + error.message, 'warning');
        }
    } finally {
        // Rehabilitar el selector
        select.disabled = false;
    }
}

// =============================================
// 📝 FUNCIONES PARA PESTAÑAS ESPECÍFICAS
// =============================================

// Cargar stock por depósito seleccionado
async function cargarStockDeposito() {
    const depositoId = document.getElementById('selector-deposito').value;
    const tbody = document.getElementById('tabla-stock-deposito');
    
    if (!depositoId) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Seleccione un depósito</td></tr>';
        document.getElementById('info-deposito-seleccionado').classList.add('d-none');
        return;
    }

    try {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Cargando...</td></tr>';
        
        const response = await apiRequest(`/stock/deposito/${depositoId}`);
        
        if (response.success) {
            const stock = response.data;
            const deposito = response.deposito;
            
            // Mostrar información del depósito
            document.getElementById('info-deposito-seleccionado').classList.remove('d-none');
            document.getElementById('texto-info-deposito').textContent = 
                `${deposito.nombre} (${deposito.tipo}) - ${stock.length} productos`;

            if (stock.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay stock en este depósito</td></tr>';
                return;
            }

            tbody.innerHTML = stock.map(item => {
                const estadoStock = determinarEstadoStock(item.cantidad, item.stock_minimo);
                
                return `
                    <tr>
                        <td><strong class="text-primary">${item.codigo_sku || 'N/A'}</strong></td>
                        <td>${item.descripcion}</td>
                        <td class="text-center"><strong>${item.cantidad}</strong></td>
                        <td class="text-center">${item.stock_minimo}</td>
                        <td class="text-end">$${(item.precio_venta || 0).toLocaleString()}</td>
                        <td class="text-end">$${(item.valor_total || 0).toLocaleString()}</td>
                        <td class="text-center">
                            <span class="badge ${estadoStock.clase}">${estadoStock.texto}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning" onclick="abrirAjusteRapido(${item.id}, ${depositoId})" title="Ajustar">
                                    <i class="fas fa-tools"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="abrirTransferenciaRapida(${item.id}, ${depositoId})" title="Transferir">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error cargando stock del depósito:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar datos</td></tr>';
    }
}

// Cargar alertas de stock
async function cargarAlertas() {
    try {
        const response = await apiRequest('/stock/alertas');
        
        if (response.success) {
            alertasStock = response.data;
            renderTablaAlertas();
        }
    } catch (error) {
        console.error('Error cargando alertas:', error);
    }
}

// Renderizar tabla de alertas
function renderTablaAlertas() {
    const tbody = document.getElementById('tabla-alertas-stock');
    
    if (!alertasStock || alertasStock.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-success">¡No hay alertas de stock!</td></tr>';
        return;
    }

    tbody.innerHTML = alertasStock.map(alerta => {
        const prioridadBadge = {
            'CRITICO': 'bg-danger',
            'ALTO': 'bg-warning',
            'MEDIO': 'bg-info',
            'BAJO': 'bg-secondary'
        };

        return `
            <tr>
                <td>
                    <span class="badge ${prioridadBadge[alerta.nivel_urgencia] || 'bg-secondary'}">
                        ${alerta.nivel_urgencia}
                    </span>
                </td>
                <td><strong>${alerta.codigo_sku}</strong></td>
                <td>${alerta.descripcion}</td>
                <td class="text-center"><strong>${alerta.stock_actual}</strong></td>
                <td class="text-center">${alerta.stock_minimo}</td>
                <td class="text-center text-danger">-${alerta.cantidad_faltante}</td>
                <td>${alerta.deposito_nombre} (${alerta.deposito_tipo})</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="solucionarAlerta(${alerta.id}, ${alerta.deposito_id})" title="Comprar">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="transferirParaAlerta(${alerta.id}, ${alerta.deposito_id})" title="Transferir">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Actualizar alertas
async function actualizarAlertas() {
    showAlert('Actualizando alertas...', 'info');
    await cargarAlertas();
    showAlert('Alertas actualizadas', 'success');
}

// =============================================
// 📝 FUNCIONES DE ACCIONES RÁPIDAS
// =============================================

// Ver detalle completo de stock de un producto
async function verDetalleStock(mercaderiaId) {
    try {
        const response = await apiRequest(`/stock/mercaderia/${mercaderiaId}`);
        
        if (response.success) {
            const mercaderia = response.mercaderia;
            const stock = response.data;
            
            let html = `
                <div class="modal fade" id="modalDetalleStock" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Stock Detallado: ${mercaderia.descripcion}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Depósito</th>
                                                <th>Tipo</th>
                                                <th>Entidad</th>
                                                <th>Cantidad</th>
                                                <th>Stock Mín.</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;
            
            stock.forEach(item => {
                const estadoStock = determinarEstadoStock(item.cantidad, item.stock_minimo);
                html += `
                    <tr>
                        <td><strong>${item.deposito_nombre}</strong></td>
                        <td><span class="badge bg-secondary">${item.deposito_tipo}</span></td>
                        <td>${item.entidad_nombre || 'N/A'}</td>
                        <td class="text-center"><strong>${item.cantidad}</strong></td>
                        <td class="text-center">${item.stock_minimo}</td>
                        <td><span class="badge ${estadoStock.clase}">${estadoStock.texto}</span></td>
                    </tr>
                `;
            });
            
            html += `
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <strong>Total: ${response.totales.total_cantidad} unidades en ${response.totales.depositos_con_stock} depósitos</strong>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const modalAnterior = document.getElementById('modalDetalleStock');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            // Agregar y mostrar modal
            document.body.insertAdjacentHTML('beforeend', html);
            const modal = new bootstrap.Modal(document.getElementById('modalDetalleStock'));
            modal.show();
        }
    } catch (error) {
        console.error('Error viendo detalle de stock:', error);
        showAlert('Error al cargar detalle de stock', 'danger');
    }
}

// Abrir ajuste rápido
function abrirAjusteRapido(mercaderiaId, depositoId = null) {
    // Pre-seleccionar mercadería y depósito si se proporcionan
    document.getElementById('ajuste_mercaderia').value = mercaderiaId || '';
    if (depositoId) {
        document.getElementById('ajuste_deposito').value = depositoId;
    }
    
    // Cargar stock actual si ambos están seleccionados
    if (mercaderiaId && depositoId) {
        cargarStockActualAjuste();
    }
    
    abrirModalAjuste();
}

// Abrir transferencia rápida
function abrirTransferenciaRapida(mercaderiaId, depositoOrigenId = null) {
    // Pre-seleccionar mercadería y origen si se proporcionan
    document.getElementById('trans_mercaderia').value = mercaderiaId || '';
    if (depositoOrigenId) {
        document.getElementById('trans_origen').value = depositoOrigenId;
    }
    
    // Verificar stock disponible si ambos están seleccionados
    if (mercaderiaId && depositoOrigenId) {
        verificarStockDisponible();
    }
    
    abrirModalTransferencia();
}

// Solucionar alerta con compra directa
function solucionarAlerta(mercaderiaId, depositoId) {
    abrirModalCompraDirect();
    document.getElementById('compra_mercaderia').value = mercaderiaId;
    document.getElementById('compra_deposito').value = depositoId;
}

// =============================================
// 📝 FUNCIONES AUXILIARES
// =============================================

// Verificar stock disponible para transferencias
async function verificarStockDisponible() {
    const mercaderiaId = document.getElementById('trans_mercaderia').value;
    const depositoId = document.getElementById('trans_origen').value;
    const infoDiv = document.getElementById('stock-disponible-info');
    
    if (!mercaderiaId || !depositoId) {
        infoDiv.textContent = '';
        return;
    }

    try {
        const response = await apiRequest(`/stock/verificar-disponibilidad?mercaderia_id=${mercaderiaId}&deposito_id=${depositoId}`);
        
        if (response.success) {
            const disponible = response.data.cantidad_disponible;
            infoDiv.textContent = `Stock disponible: ${disponible} unidades`;
            infoDiv.className = disponible > 0 ? 'form-text text-success' : 'form-text text-danger';
            
            // Establecer máximo en el input de cantidad
            const cantidadInput = document.getElementById('trans_cantidad');
            cantidadInput.max = disponible;
        }
    } catch (error) {
        console.error('Error verificando stock:', error);
        infoDiv.textContent = 'Error verificando stock disponible';
        infoDiv.className = 'form-text text-danger';
    }
}

// Cargar stock actual para ajustes
async function cargarStockActualAjuste() {
    const mercaderiaId = document.getElementById('ajuste_mercaderia').value;
    const depositoId = document.getElementById('ajuste_deposito').value;
    const stockInput = document.getElementById('ajuste_stock_actual');
    
    if (!mercaderiaId || !depositoId) {
        stockInput.value = '';
        return;
    }

    try {
        const response = await apiRequest(`/stock/verificar-disponibilidad?mercaderia_id=${mercaderiaId}&deposito_id=${depositoId}`);
        
        if (response.success) {
            stockInput.value = `${response.data.cantidad_disponible} unidades`;
            
            // Configurar preview del resultado
            configurarPreviewAjuste();
        }
    } catch (error) {
        console.error('Error cargando stock actual:', error);
        stockInput.value = 'Error cargando stock';
    }
}

// Configurar preview del resultado del ajuste
function configurarPreviewAjuste() {
    const tipoAjuste = document.getElementById('ajuste_tipo').value;
    const cantidad = parseFloat(document.getElementById('ajuste_cantidad').value) || 0;
    const stockActualText = document.getElementById('ajuste_stock_actual').value;
    const previewDiv = document.getElementById('ajuste_resultado_preview');
    
    if (!tipoAjuste || !cantidad || !stockActualText) {
        previewDiv.textContent = '';
        return;
    }

    const stockActual = parseFloat(stockActualText.split(' ')[0]) || 0;
    let resultado;

    switch (tipoAjuste) {
        case 'INCREMENTO':
            resultado = stockActual + cantidad;
            previewDiv.textContent = `Resultado: ${stockActual} + ${cantidad} = ${resultado}`;
            previewDiv.className = 'form-text text-success';
            break;
        case 'DECREMENTO':
            resultado = Math.max(0, stockActual - cantidad);
            previewDiv.textContent = `Resultado: ${stockActual} - ${cantidad} = ${resultado}`;
            previewDiv.className = 'form-text text-warning';
            break;
        case 'CORRECCION':
            previewDiv.textContent = `Resultado: Stock se establecerá en ${cantidad}`;
            previewDiv.className = 'form-text text-info';
            break;
    }
}

// Filtrar movimientos de stock
async function filtrarMovimientos() {
    try {
        const params = new URLSearchParams();
        
        // ✅ Campos que YA se enviaban correctamente
        const tipo = document.getElementById('filtro-tipo-movimiento').value;
        const fechaDesde = document.getElementById('fecha-desde-movimientos').value;
        const fechaHasta = document.getElementById('fecha-hasta-movimientos').value;
        
        // ✅ NUEVOS: Campos que FALTABAN
        const deposito = document.getElementById('filtro-deposito-movimientos').value;
        const mercaderia = document.getElementById('buscar-mercaderia-movimientos').value;
        const usuario = document.getElementById('filtro-usuario-movimientos').value;
        const documento = document.getElementById('filtro-documento-movimientos').value;
        
        // Enviar parámetros al backend (solo si tienen valor)
        if (tipo) params.append('tipo_movimiento', tipo);
        if (fechaDesde) params.append('fecha_desde', fechaDesde);
        if (fechaHasta) params.append('fecha_hasta', fechaHasta);
        
        // ✅ AGREGAR los parámetros que faltaban
        if (deposito) params.append('deposito_id', deposito);
        if (mercaderia) params.append('codigo_mercaderia', mercaderia); // o 'search' si es búsqueda general
        if (usuario) params.append('usuario_id', usuario);
        if (documento) params.append('numero_documento', documento);
        
        // Construir URL con parámetros
        const url = '/stock/movimientos' + (params.toString() ? '?' + params.toString() : '');
        
        console.log('🔍 Filtrando movimientos con URL:', url);
        
        // Realizar petición al backend
        const response = await apiRequest(url);
        
        if (response.success) {
            // Actualizar variable global y renderizar tabla
            movimientosStock = response.data;
            renderTablaMovimientos();
            
            // Actualizar contador
            const contador = document.getElementById('contador-movimientos');
            if (contador) {
                contador.textContent = `${response.data.length} movimientos`;
            }
            
            console.log('✅ Filtros aplicados correctamente:', response.data.length, 'resultados');
        } else {
            console.error('❌ Error al filtrar movimientos:', response.message);
            showAlert('Error al aplicar filtros', 'danger');
        }
        
    } catch (error) {
        console.error('❌ Error en filtrarMovimientos:', error);
        showAlert('Error al filtrar movimientos', 'danger');
    }
}
// Renderizar tabla de movimientos
function renderTablaMovimientos() {
    const tbody = document.getElementById('tabla-movimientos-principal'); // ID único
    
    if (!movimientosStock || movimientosStock.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center text-muted py-4">
                    <i class="fas fa-search me-2"></i>
                    No hay movimientos que coincidan con los filtros aplicados
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = movimientosStock.map(mov => {
        const tipoClase = {
            'COMPRA': 'badge bg-success',
            'VENTA': 'badge bg-primary', 
            'TRANSFERENCIA': 'badge bg-info',
            'AJUSTE': 'badge bg-warning text-dark',
            'DEVOLUCION': 'badge bg-danger'
        };

        const fecha = new Date(mov.fecha_movimiento);
        const fechaFormateada = fecha.toLocaleDateString('es-AR');
        const horaFormateada = fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        
        return `
            <tr>
                <td>
                    <div class="small">
                        <div><strong>${fechaFormateada}</strong></div>
                        <div class="text-muted">${horaFormateada}</div>
                    </div>
                </td>
                <td>
                    <span class="${tipoClase[mov.tipo_movimiento] || 'badge bg-secondary'}">
                        ${mov.tipo_movimiento}
                    </span>
                </td>
                <td><code>${mov.codigo_sku}</code></td>
                <td>
                    <div>
                        <strong>${mov.mercaderia || mov.descripcion}</strong>
                        ${mov.categoria_nombre ? `<div class="small text-muted">${mov.categoria_nombre}</div>` : ''}
                    </div>
                </td>
                <td>
                    <small class="text-muted">
                        ${mov.deposito_origen_nombre || mov.deposito_origen || '-'}
                    </small>
                </td>
                <td>
                    <small class="text-muted">
                        ${mov.deposito_destino_nombre || mov.deposito_destino || '-'}
                    </small>
                </td>
                <td class="text-center">
                    <strong class="text-primary">${mov.cantidad}</strong>
                </td>
                <td class="text-end">
                    ${mov.precio_unitario ? `$${parseFloat(mov.precio_unitario).toFixed(2)}` : '-'}
                </td>
                <td>
                    <small>${mov.numero_documento || '-'}</small>
                </td>
                <td>
                    <small class="text-muted">${mov.usuario_nombre || mov.usuario || '-'}</small>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info btn-sm" onclick="verDetalleMovimiento(${mov.id})" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="Más opciones">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="duplicarMovimiento(${mov.id})">
                                <i class="fas fa-copy me-2"></i>Duplicar
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="imprimirMovimiento(${mov.id})">
                                <i class="fas fa-print me-2"></i>Imprimir
                            </a></li>
                            ${mov.tipo_movimiento === 'TRANSFERENCIA' ? 
                                `<li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-warning" href="#" onclick="anularMovimiento(${mov.id})">
                                    <i class="fas fa-ban me-2"></i>Anular
                                </a></li>` : ''
                            }
                        </ul>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Nuevas funciones específicas para movimientos
function filtrarMovimientosHoy() {
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fecha-desde-movimientos').value = hoy;
    document.getElementById('fecha-hasta-movimientos').value = hoy;
    filtrarMovimientos();
}

function filtrarMovimientosSemana() {
    const hoy = new Date();
    const inicioSemana = new Date(hoy.setDate(hoy.getDate() - hoy.getDay()));
    const finSemana = new Date(hoy.setDate(hoy.getDate() - hoy.getDay() + 6));
    
    document.getElementById('fecha-desde-movimientos').value = inicioSemana.toISOString().split('T')[0];
    document.getElementById('fecha-hasta-movimientos').value = finSemana.toISOString().split('T')[0];
    filtrarMovimientos();
}

function filtrarMovimientosMes() {
    const hoy = new Date();
    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
    
    document.getElementById('fecha-desde-movimientos').value = inicioMes.toISOString().split('T')[0];
    document.getElementById('fecha-hasta-movimientos').value = finMes.toISOString().split('T')[0];
    filtrarMovimientos();
}

function nuevoMovimiento() {
    // Implementar modal para nuevo movimiento
    alert('Funcionalidad de nuevo movimiento - Implementar modal');
}

function verDetalleMovimiento(id) {
    // Implementar panel de detalles
    console.log('Ver detalle del movimiento:', id);
}

function duplicarMovimiento(id) {
    // Implementar duplicación de movimiento
    console.log('Duplicar movimiento:', id);
}

function anularMovimiento(id) {
    if (confirm('¿Está seguro que desea anular este movimiento?')) {
        console.log('Anular movimiento:', id);
    }
}


// Limpiar filtros de movimientos
function limpiarFiltrosMovimientos() {
    // Limpiar TODOS los campos de filtros
    document.getElementById('filtro-tipo-movimiento').value = '';
    document.getElementById('fecha-desde-movimientos').value = '';
    document.getElementById('fecha-hasta-movimientos').value = '';
    document.getElementById('filtro-deposito-movimientos').value = '';
    document.getElementById('buscar-mercaderia-movimientos').value = '';
    document.getElementById('filtro-usuario-movimientos').value = '';
    document.getElementById('filtro-documento-movimientos').value = '';
    
    // Recargar movimientos sin filtros
    filtrarMovimientos();
    
    console.log('🧹 Filtros limpiados');
}
// =============================================
// 📝 FUNCIONES DE MODAL - TRANSFERENCIAS
// =============================================

// Abrir modal de transferencia
async function abrirModalTransferencia() {
    await cargarSelectoresMercaderias('trans_mercaderia');
    await cargarSelectoresDepositos('trans_origen');
    await cargarSelectoresDepositos('trans_destino');
    
    // Configurar eventos
    document.getElementById('trans_mercaderia').addEventListener('change', verificarStockDisponible);
    document.getElementById('trans_origen').addEventListener('change', verificarStockDisponible);
    
    const modal = new bootstrap.Modal(document.getElementById('modalTransferencia'));
    modal.show();
}

// Guardar transferencia
async function guardarTransferencia() {
    try {
        const form = document.getElementById('formTransferencia');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const datosTransferencia = {
            mercaderia_id: parseInt(document.getElementById('trans_mercaderia').value),
            deposito_origen_id: parseInt(document.getElementById('trans_origen').value),
            deposito_destino_id: parseInt(document.getElementById('trans_destino').value),
            cantidad: parseFloat(document.getElementById('trans_cantidad').value),
            motivo: document.getElementById('trans_motivo').value.trim(),
            numero_documento: document.getElementById('trans_documento').value.trim(),
            observaciones: document.getElementById('trans_observaciones').value.trim()
        };

        const response = await apiRequest('/stock/transferir', 'POST', datosTransferencia);

        if (response.success) {
            showAlert('Transferencia realizada exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalTransferencia')).hide();
            form.reset();
            await cargarStockGeneral();
            await cargarEstadisticasStock();
        } else {
            throw new Error(response.message || 'Error al realizar transferencia');
        }
    } catch (error) {
        console.error('Error guardando transferencia:', error);
        showAlert('Error al realizar transferencia: ' + error.message, 'danger');
    }
}

// =============================================
// 📝 FUNCIONES DE MODAL - AJUSTES
// =============================================

// Abrir modal de ajuste
async function abrirModalAjuste() {
    await cargarSelectoresMercaderias('ajuste_mercaderia');
    await cargarSelectoresDepositos('ajuste_deposito');
    
    // Configurar eventos
    document.getElementById('ajuste_mercaderia').addEventListener('change', cargarStockActualAjuste);
    document.getElementById('ajuste_deposito').addEventListener('change', cargarStockActualAjuste);
    document.getElementById('ajuste_tipo').addEventListener('change', configurarPreviewAjuste);
    document.getElementById('ajuste_cantidad').addEventListener('input', configurarPreviewAjuste);
    
    const modal = new bootstrap.Modal(document.getElementById('modalAjuste'));
    modal.show();
}

// Guardar ajuste
async function guardarAjuste() {
    try {
        const form = document.getElementById('formAjuste');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const datosAjuste = {
            mercaderia_id: parseInt(document.getElementById('ajuste_mercaderia').value),
            deposito_id: parseInt(document.getElementById('ajuste_deposito').value),
            tipo_ajuste: document.getElementById('ajuste_tipo').value,
            cantidad: parseFloat(document.getElementById('ajuste_cantidad').value),
            motivo: document.getElementById('ajuste_motivo').value,
            observaciones: document.getElementById('ajuste_observaciones').value.trim()
        };

        const response = await apiRequest('/stock/ajustar', 'POST', datosAjuste);

        if (response.success) {
            showAlert('Ajuste de stock realizado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalAjuste')).hide();
            form.reset();
            await cargarStockGeneral();
            await cargarEstadisticasStock();
        } else {
            throw new Error(response.message || 'Error al ajustar stock');
        }
    } catch (error) {
        console.error('Error guardando ajuste:', error);
        showAlert('Error al ajustar stock: ' + error.message, 'danger');
    }
}

// =============================================
// 📝 INTEGRACIÓN CON LA FUNCIÓN showPage()
// =============================================

// Agregar este caso al switch de showPage() en tu JavaScript principal:
/*
case 'stock':
    loadStock();
    break;
*/

console.log('📊 Funciones de Control de Stock cargadas completamente');

// Event listeners para las pestañas
document.addEventListener('DOMContentLoaded', function() {
    // Configurar cambio de pestañas
    const stockTabs = document.querySelectorAll('#stockTabs button[data-bs-toggle="tab"]');
    stockTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const target = event.target.getAttribute('data-bs-target');
            
            switch(target) {
                case '#por-deposito':
                    if (depositosDisponibles.length === 0) {
                        cargarDepositos();
                    }
                    break;
                case '#alertas':
                    if (alertasStock.length === 0) {
                        cargarAlertas();
                    }
                    break;
                case '#movimientos':
                    if (movimientosStock.length === 0) {
                        filtrarMovimientos();
                    }
                    break;
            }
        });
    });
});

/*******/
// =============================================
// 📝 FUNCIONES DE OPTIMIZACIÓN
// =============================================

// Debounce para filtro de stock (optimiza búsquedas)
function debounceFilter() {
    clearTimeout(filtroStockTimeout);
    filtroStockTimeout = setTimeout(() => {
        filtrarStock();
    }, 300);
}

// Debounce para filtro de movimientos
function debounceFilterMovimientos() {
    clearTimeout(filtroStockTimeout);
    filtroStockTimeout = setTimeout(() => {
        filtrarMovimientos();
    }, 300);
}

// =============================================
// 📝 FUNCIONES DE PAGINACIÓN
// =============================================

// Cambiar página de stock
function cambiarPaginaStock(nuevaPagina) {
    if (nuevaPagina >= 1 && nuevaPagina <= stockTotalPaginas) {
        stockPaginaActual = nuevaPagina;
        filtrarStock();
    }
}

// Renderizar paginación
function renderizarPaginacion(paginaActual, totalPaginas, totalElementos) {
    const paginacionContainer = document.getElementById('paginacion-stock');
    
    if (totalPaginas <= 1) {
        paginacionContainer.innerHTML = '';
        return;
    }

    let html = '';
    
    // Botón anterior
    html += `
        <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cambiarPaginaStock(${paginaActual - 1})" aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
    `;

    // Páginas numeradas (máximo 5 páginas visibles)
    let inicio = Math.max(1, paginaActual - 2);
    let fin = Math.min(totalPaginas, inicio + 4);
    
    if (fin - inicio < 4) {
        inicio = Math.max(1, fin - 4);
    }

    for (let i = inicio; i <= fin; i++) {
        html += `
            <li class="page-item ${i === paginaActual ? 'active' : ''}">
                <a class="page-link" href="#" onclick="cambiarPaginaStock(${i})">${i}</a>
            </li>
        `;
    }

    // Botón siguiente
    html += `
        <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cambiarPaginaStock(${paginaActual + 1})" aria-label="Siguiente">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    `;

    paginacionContainer.innerHTML = html;
}

// =============================================
// 📝 FUNCIONES DE EXPORTACIÓN
// =============================================

// Exportar stock a CSV
function exportarStock() {
    try {
        const headers = ['SKU', 'Descripción', 'Categoría', 'Stock Central', 'Stock Vendedores', 'Stock Clientes', 'Stock Total', 'Stock Mínimo', 'Estado', 'Valor Total'];
        
        const csvContent = [
            headers.join(','),
            ...stockFiltrado.map(item => [
                `"${item.codigo_sku || ''}"`,
                `"${item.descripcion || ''}"`,
                `"${item.categoria || ''}"`,
                item.stock_central || 0,
                item.stock_vendedores || 0,
                item.stock_clientes || 0,
                item.stock_total || 0,
                item.stock_minimo || 0,
                `"${determinarEstadoStock(item.stock_total || 0, item.stock_minimo || 0).texto}"`,
                item.valor_stock || 0
            ].join(','))
        ].join('\n');

        descargarCSV(csvContent, `stock_general_${new Date().toISOString().split('T')[0]}.csv`);
        showAlert('Stock exportado exitosamente', 'success');
    } catch (error) {
        console.error('Error exportando stock:', error);
        showAlert('Error al exportar stock', 'danger');
    }
}

// Exportar stock de depósito específico
function exportarStockDeposito() {
    const depositoId = document.getElementById('selector-deposito').value;
    if (!depositoId) {
        showAlert('Seleccione un depósito primero', 'warning');
        return;
    }

    const deposito = depositosDisponibles.find(d => d.id == depositoId);
    const stockDeposito = obtenerStockDepositoActual();

    if (!stockDeposito || stockDeposito.length === 0) {
        showAlert('No hay stock para exportar en este depósito', 'warning');
        return;
    }

    try {
        const headers = ['SKU', 'Descripción', 'Cantidad', 'Stock Mínimo', 'Valor Unitario', 'Valor Total', 'Estado'];
        
        const csvContent = [
            `# Stock del depósito: ${deposito?.nombre || 'N/A'}`,
            `# Fecha de exportación: ${new Date().toLocaleString('es-AR')}`,
            `# Total de productos: ${stockDeposito.length}`,
            '',
            headers.join(','),
            ...stockDeposito.map(item => [
                `"${item.codigo_sku || ''}"`,
                `"${item.descripcion || ''}"`,
                item.cantidad || 0,
                item.stock_minimo || 0,
                item.precio_venta || 0,
                item.valor_total || 0,
                `"${determinarEstadoStock(item.cantidad || 0, item.stock_minimo || 0).texto}"`
            ].join(','))
        ].join('\n');

        descargarCSV(csvContent, `stock_${deposito?.nombre.replace(/\s+/g, '_').toLowerCase()}_${new Date().toISOString().split('T')[0]}.csv`);
        showAlert('Stock del depósito exportado exitosamente', 'success');
    } catch (error) {
        console.error('Error exportando stock del depósito:', error);
        showAlert('Error al exportar stock del depósito', 'danger');
    }
}

// Exportar movimientos
function exportarMovimientos() {
    if (!movimientosStock || movimientosStock.length === 0) {
        showAlert('No hay movimientos para exportar', 'warning');
        return;
    }

    try {
        const headers = ['Fecha', 'Tipo', 'SKU', 'Mercadería', 'Origen', 'Destino', 'Cantidad', 'Precio Unit.', 'Valor Total', 'Documento', 'Motivo'];
        
        const csvContent = [
            `# Movimientos de Stock`,
            `# Fecha de exportación: ${new Date().toLocaleString('es-AR')}`,
            `# Total de movimientos: ${movimientosStock.length}`,
            '',
            headers.join(','),
            ...movimientosStock.map(mov => [
                `"${new Date(mov.fecha_movimiento).toLocaleDateString('es-AR')}"`,
                `"${mov.tipo_movimiento}"`,
                `"${mov.codigo_sku || ''}"`,
                `"${mov.mercaderia || ''}"`,
                `"${mov.deposito_origen || ''}"`,
                `"${mov.deposito_destino || ''}"`,
                mov.cantidad || 0,
                mov.precio_unitario || 0,
                mov.valor_total || 0,
                `"${mov.numero_documento || ''}"`,
                `"${mov.motivo || ''}"`.replace(/"/g, '""')
            ].join(','))
        ].join('\n');

        descargarCSV(csvContent, `movimientos_stock_${new Date().toISOString().split('T')[0]}.csv`);
        showAlert('Movimientos exportados exitosamente', 'success');
    } catch (error) {
        console.error('Error exportando movimientos:', error);
        showAlert('Error al exportar movimientos', 'danger');
    }
}

// Función auxiliar para descargar CSV
function descargarCSV(contenido, nombreArchivo) {
    const blob = new Blob([contenido], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', nombreArchivo);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// =============================================
// 📝 FUNCIONES DE REFRESCAR DATOS
// =============================================

// Refrescar stock
async function refrescarStock() {
    showAlert('Actualizando datos de stock...', 'info');
    try {
        await cargarStockGeneral();
        await cargarEstadisticasStock();
        showAlert('Stock actualizado exitosamente', 'success');
    } catch (error) {
        console.error('Error refrescando stock:', error);
        showAlert('Error al actualizar stock', 'danger');
    }
}

// Refrescar movimientos
async function refrescarMovimientos() {
    showAlert('Actualizando movimientos...', 'info');
    try {
        await filtrarMovimientos();
        showAlert('Movimientos actualizados exitosamente', 'success');
    } catch (error) {
        console.error('Error refrescando movimientos:', error);
        showAlert('Error al actualizar movimientos', 'danger');
    }
}

// =============================================
// 📝 FUNCIONES DE ALERTAS AVANZADAS
// =============================================

// Filtrar alertas por urgencia
function filtrarAlertas() {
    const urgencia = document.getElementById('filtro-urgencia-alertas').value;
    
    let alertasFiltradas = [...alertasStock];
    
    if (urgencia) {
        alertasFiltradas = alertasFiltradas.filter(alerta => alerta.nivel_urgencia === urgencia);
    }
    
    renderTablaAlertas(alertasFiltradas);
    actualizarBadgeAlertas(alertasFiltradas.length);
}

// Toggle seleccionar todas las alertas
function toggleSelectAllAlertas() {
    const selectAll = document.getElementById('select-all-alertas').checked;
    const checkboxes = document.querySelectorAll('input[name="alerta-checkbox"]');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
    });
    
    actualizarAlertasSeleccionadas();
}

// Actualizar lista de alertas seleccionadas
function actualizarAlertasSeleccionadas() {
    const checkboxes = document.querySelectorAll('input[name="alerta-checkbox"]:checked');
    alertasSeleccionadas = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    const btnResolver = document.querySelector('button[onclick="resolverAlertasSeleccionadas()"]');
    if (btnResolver) {
        btnResolver.disabled = alertasSeleccionadas.length === 0;
        btnResolver.innerHTML = `<i class="fas fa-check me-1"></i>Resolver ${alertasSeleccionadas.length > 0 ? `(${alertasSeleccionadas.length})` : 'Selec.'}`;
    }
}

// Resolver alertas seleccionadas
async function resolverAlertasSeleccionadas() {
    if (alertasSeleccionadas.length === 0) {
        showAlert('Seleccione al menos una alerta para resolver', 'warning');
        return;
    }

    const confirmacion = await mostrarConfirmacion(
        'Resolver Alertas',
        `¿Desea abrir el modal de compra para resolver ${alertasSeleccionadas.length} alerta(s) seleccionada(s)?`,
        'info'
    );

    if (confirmacion) {
        // Por ahora, abrir modal de compra con la primera alerta seleccionada
        const primeraAlerta = alertasStock.find(a => a.id === alertasSeleccionadas[0]);
        if (primeraAlerta) {
            solucionarAlerta(primeraAlerta.id, primeraAlerta.deposito_id);
        }
    }
}

// Actualizar badge de alertas en la pestaña
function actualizarBadgeAlertas(cantidad) {
    const badge = document.getElementById('badge-alertas-count');
    if (badge) {
        if (cantidad > 0) {
            badge.textContent = cantidad;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
}

// =============================================
// 📝 FUNCIONES DE REPORTES Y GRÁFICOS
// =============================================

// Cargar reportes
async function cargarReportes() {
    try {
        // Cargar múltiples reportes en paralelo
        const [valoracionResponse, rotacionResponse, resumenResponse] = await Promise.all([
            apiRequest('/stock/valoracion'),
            apiRequest('/stock/rotacion?dias=30'),
            apiRequest('/stock/resumen')
        ]);

        if (valoracionResponse.success) {
            renderizarGraficoValoracion(valoracionResponse.data, valoracionResponse.totales);
        }

        if (rotacionResponse.success) {
            renderizarGraficoRotacion(rotacionResponse.data, rotacionResponse.resumen);
        }

        if (resumenResponse.success) {
            renderizarResumenEjecutivo(resumenResponse.data);
        }

    } catch (error) {
        console.error('Error cargando reportes:', error);
        document.getElementById('resumen-ejecutivo').innerHTML = 
            '<div class="alert alert-danger">Error al cargar reportes</div>';
    }
}

// Renderizar gráfico de valoración por depósito
function renderizarGraficoValoracion(datos, totales) {
    const ctx = document.getElementById('chart-valoracion-depositos');
    if (!ctx) return;

    // Verificar si Chart.js está disponible
    if (typeof Chart === 'undefined') {
        ctx.parentElement.innerHTML = '<div class="alert alert-info">Chart.js no disponible</div>';
        return;
    }

    const labels = datos.map(d => d.deposito_nombre);
    const valores = datos.map(d => d.valor_costo);
    const colores = datos.map((d, i) => {
        const hue = (i * 137.508) % 360; // Golden angle approximation
        return `hsl(${hue}, 70%, 60%)`;
    });

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: colores,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        font: { size: 10 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const valor = context.parsed;
                            const porcentaje = ((valor / totales.valor_costo_total) * 100).toFixed(1);
                            return `${context.label}: $${valor.toLocaleString()} (${porcentaje}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Renderizar gráfico de rotación
function renderizarGraficoRotacion(datos, resumen) {
    const ctx = document.getElementById('chart-rotacion-stock');
    if (!ctx || typeof Chart === 'undefined') return;

    const labels = ['Sin Movimiento', 'Rotación Baja', 'Rotación Media', 'Rotación Alta'];
    const valores = [
        resumen.sin_movimiento,
        resumen.rotacion_baja,
        resumen.rotacion_media,
        resumen.rotacion_alta
    ];
    const colores = ['#e74c3c', '#f39c12', '#3498db', '#27ae60'];

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Productos',
                data: valores,
                backgroundColor: colores,
                borderColor: colores,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
}

// Renderizar resumen ejecutivo
function renderizarResumenEjecutivo(datos) {
    const container = document.getElementById('resumen-ejecutivo');
    
    const html = `
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-primary">${datos.stock?.total_mercaderias || 0}</h4>
                    <small class="text-muted">Total Productos</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-success">$${(datos.stock?.valor_total || 0).toLocaleString()}</h4>
                    <small class="text-muted">Valor Total Inventario</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-warning">${datos.alertas?.criticas || 0}</h4>
                    <small class="text-muted">Alertas Críticas</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-info">${datos.productos_criticos || 0}</h4>
                    <small class="text-muted">Requieren Atención</small>
                </div>
            </div>
        </div>
        
        <hr class="my-3">
        
        <div class="row">
            <div class="col-12">
                <h6 class="text-muted mb-2">Distribución de Stock por Tipo de Depósito</h6>
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar bg-primary" style="width: 40%">Central</div>
                    <div class="progress-bar bg-success" style="width: 35%">Vendedores</div>
                    <div class="progress-bar bg-info" style="width: 25%">Clientes</div>
                </div>
                <small class="text-muted">
                    <strong>Última actualización:</strong> ${new Date(datos.ultima_actualizacion).toLocaleString('es-AR')}
                </small>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// =============================================
// 📝 FUNCIONES AUXILIARES ADICIONALES
// =============================================

// Obtener stock actual del depósito (para exportación)
function obtenerStockDepositoActual() {
    const tbody = document.getElementById('tabla-stock-deposito');
    const filas = tbody.querySelectorAll('tr');
    
    const stock = [];
    filas.forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        if (celdas.length >= 6 && !fila.textContent.includes('Seleccione')) {
            stock.push({
                codigo_sku: celdas[0].textContent.trim(),
                descripcion: celdas[1].textContent.trim(),
                cantidad: parseFloat(celdas[2].textContent.trim()) || 0,
                stock_minimo: parseFloat(celdas[3].textContent.trim()) || 0,
                precio_venta: parseFloat(celdas[4].textContent.replace(/[$,]/g, '')) || 0,
                valor_total: parseFloat(celdas[5].textContent.replace(/[$,]/g, '')) || 0
            });
        }
    });
    
    return stock;
}

// Ver detalle de movimiento
async function verDetalleMovimiento(movimientoId) {
    try {
        // Mostrar loading
        showAlert('Cargando detalle del movimiento...', 'info');
        
        // Llamada a la API
        const response = await apiRequest(`/stock/movimientos/${movimientoId}`);
        
        if (response.success) {
            const movimiento = response.data;
            mostrarModalDetalleMovimiento(movimiento);
        } else {
            showAlert('Error al obtener detalle del movimiento: ' + response.message, 'danger');
        }
    } catch (error) {
        console.error('Error obteniendo detalle del movimiento:', error);
        showAlert('Error de conexión al obtener detalle del movimiento', 'danger');
    }
}
// Imprimir etiquetas de depósito
function imprimirEtiquetasDeposito() {
    const depositoId = document.getElementById('selector-deposito').value;
    if (!depositoId) {
        showAlert('Seleccione un depósito primero', 'warning');
        return;
    }
    
    // Redirigir a la página de etiquetas con filtro por depósito
    showPage('etiquetas');
    // Aquí podrías preconfigurar el filtro de depósito en la página de etiquetas
}

// =============================================
// 📝 ACTUALIZACIÓN DE LA FUNCIÓN PRINCIPAL
// =============================================

// Actualizar la función loadStock para incluir reportes
const loadStockOriginal = loadStock;
loadStock = async function() {
    try {
        await loadStockOriginal();
        
        // Configurar event listeners para pestañas
        const reportesTab = document.getElementById('reportes-tab');
        if (reportesTab) {
            reportesTab.addEventListener('shown.bs.tab', function() {
                cargarReportes();
            });
        }
        
    } catch (error) {
        console.error('Error en loadStock mejorado:', error);
    }
};

// Función para actualizar filtros con información adicional
function actualizarInfoFiltros() {
    const categoria = document.getElementById('filtro-categoria-stock').value;
    const estado = document.getElementById('filtro-estado-stock').value;
    const busqueda = document.getElementById('buscar-stock').value;
    const incluirSinStock = document.getElementById('incluir-sin-stock').checked;
    
    const filtrosAplicados = [];
    if (categoria) filtrosAplicados.push(`Categoría: ${categoria}`);
    if (estado) filtrosAplicados.push(`Estado: ${estado.replace('_', ' ')}`);
    if (busqueda) filtrosAplicados.push(`Búsqueda: "${busqueda}"`);
    if (!incluirSinStock) filtrosAplicados.push('Excluye productos sin stock');
    
    const infoElement = document.getElementById('info-filtros-stock');
    const contadorElement = document.getElementById('contador-productos-stock');
    
    if (filtrosAplicados.length > 0) {
        infoElement.textContent = `Filtros: ${filtrosAplicados.join(' | ')}`;
    } else {
        infoElement.textContent = 'Mostrando todos los productos';
    }
    
    contadorElement.textContent = `${stockFiltrado.length} producto${stockFiltrado.length !== 1 ? 's' : ''}`;
}

console.log('🔧 Funciones adicionales de Control de Stock cargadas');

// =============================================
// 📝 INTEGRACIÓN CON EL SISTEMA PRINCIPAL
// =============================================

// Sobrescribir la función filtrarStock para incluir mejoras
const filtrarStockOriginal = filtrarStock;
function filtrarStock() {
    try {
        const categoria = getElementValue('filtro-categoria-stock');
        const estado = getElementValue('filtro-estado-stock');
        const busqueda = getElementValue('buscar-stock').toLowerCase();

        stockFiltrado = stockGeneral.filter(item => {
            const cumpleCategoria = !categoria || item.id_categoria == categoria;
            const cumpleEstado = !estado || determinarEstadoStock(item.stock_total || 0, item.stock_minimo || 0).texto.includes(estado.replace('_', ' '));
            const cumpleBusqueda = !busqueda || 
                (item.descripcion && item.descripcion.toLowerCase().includes(busqueda)) ||
                (item.codigo_sku && item.codigo_sku.toLowerCase().includes(busqueda));

            return cumpleCategoria && cumpleEstado && cumpleBusqueda;
        });

        renderTablaStockGeneral();
        actualizarContadorFiltros();
    } catch (error) {
        console.error('Error filtrando stock:', error);
    }
}


// Función para actualizar estadísticas con datos del resumen
function actualizarEstadisticasConResumen(resumen) {
    document.getElementById('stat-productos-total').textContent = resumen.total_mercaderias || 0;
    document.getElementById('stat-productos-activos').textContent = `${(resumen.total_mercaderias - resumen.sin_stock) || 0} con stock`;
    document.getElementById('stat-stock-bajo').textContent = resumen.stock_bajo || 0;
    document.getElementById('stat-productos-criticos').textContent = `${resumen.sin_stock || 0} sin stock`;
    document.getElementById('stat-sin-stock').textContent = resumen.sin_stock || 0;
    document.getElementById('stat-valor-total').textContent = `$${(resumen.valor_total || 0).toLocaleString()}`;
    
    // Calcular utilidad potencial (estimación)
    const valorVenta = (resumen.valor_total || 0) * 1.3; // Asumiendo 30% de margen
    const utilidadPotencial = valorVenta - (resumen.valor_total || 0);
    document.getElementById('stat-valor-utilidad').textContent = `$${utilidadPotencial.toLocaleString()} est.`;
}

// Cargar stock general
async function cargarStockGeneral() {
    try {
        const response = await apiRequest('/stock');
        
        if (response.success) {
            stockGeneral = response.data || [];
            stockFiltrado = [...stockGeneral];
            renderTablaStockGeneral();
            actualizarEstadisticasStock(response.resumen);
        } else {
            throw new Error(response.message || 'Error al cargar stock');
        }
    } catch (error) {
        console.error('Error cargando stock general:', error);
        const tabla = document.getElementById('tabla-stock-general');
        if (tabla) {
            tabla.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error al cargar datos</td></tr>';
        }
    }
}

// Renderizar tabla de stock general
function renderTablaStockGeneral() {
    const tbody = document.getElementById('tabla-stock-general');
    if (!tbody) return;
    
    if (!stockFiltrado || stockFiltrado.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No hay productos registrados</td></tr>';
        return;
    }

    tbody.innerHTML = stockFiltrado.map(item => {
        const stockTotal = item.stock_total || 0;
        const stockMinimo = item.stock_minimo || 0;
        const estadoStock = determinarEstadoStock(stockTotal, stockMinimo);
        
        return `
            <tr>
                <td><strong class="text-primary">${item.codigo_sku || 'N/A'}</strong></td>
                <td>
                    <div class="d-flex flex-column">
                        <span>${item.descripcion || 'Sin descripción'}</span>
                        ${item.codigo_ean13 ? `<small class="text-muted">${item.codigo_ean13}</small>` : ''}
                    </div>
                </td>
                <td><span class="badge bg-secondary">${item.categoria || 'Sin categoría'}</span></td>
                <td class="text-center">
                    <span class="badge bg-primary">${item.stock_central || 0}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-success">${item.stock_vendedores || 0}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-info">${item.stock_clientes || 0}</span>
                </td>
                <td class="text-center">
                    <strong class="fs-6">${stockTotal}</strong>
                </td>
                <td class="text-center">
                    <span class="text-muted">${stockMinimo}</span>
                </td>
                <td class="text-center">
                    <span class="badge ${estadoStock.clase}">${estadoStock.texto}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="verDetalleStock(${item.id})" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="abrirAjusteRapido(${item.id})" title="Ajustar">
                            <i class="fas fa-tools"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="abrirTransferenciaRapida(${item.id})" title="Transferir">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Determinar estado del stock
function determinarEstadoStock(actual, minimo) {
    if (Number(actual) === 0) {
        return { clase: 'bg-danger text-white', texto: 'Sin Stock' };
    } else if (actual <= minimo) {
        return { clase: 'bg-warning text-dark', texto: 'Stock Bajo' };
    } else if (actual <= minimo * 1.5) {
        return { clase: 'bg-info text-white', texto: 'Stock Medio' };
    } else {
        return { clase: 'bg-success text-white', texto: 'Stock OK' };
    }
}

// Actualizar estadísticas de stock
function actualizarEstadisticasStock(resumen) {
    if (!resumen) return;
    
    const elementos = {
        'stat-productos-total': resumen.total_mercaderias || 0,
        'stat-stock-bajo': resumen.stock_bajo || 0,
        'stat-sin-stock': resumen.sin_stock || 0,
        'stat-valor-total': `$${(resumen.valor_total || 0).toLocaleString()}`
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = valor;
        }
    });
}

async function cargarEstadisticasStock() {
    try {
        const response = await apiRequest('/stock/estadisticas');
        
        if (response.success && response.data) {
            const datos = response.data;
            
            // Actualizar elementos si existen
            const elementos = {
                'stat-productos-total': datos.total_productos || 0,
                'stat-productos-activos': `${datos.items_con_stock || 0} con stock`,
                'stat-stock-bajo': datos.stock_bajo || 0,
                'stat-productos-criticos': `${datos.sin_stock || 0} sin stock`,
                'stat-sin-stock': datos.sin_stock || 0,
                'stat-productos-sin-movimiento': '0 sin movimiento',
                'stat-valor-total': `$${(datos.valor_total_costo || 0).toLocaleString()}`,
                'stat-valor-utilidad': `$${((datos.valor_total_venta || 0) - (datos.valor_total_costo || 0)).toLocaleString()} pot.`
            };
            
            Object.entries(elementos).forEach(([id, valor]) => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.textContent = valor;
                }
            });
            
            console.log('✅ Estadísticas de stock actualizadas');
        }
    } catch (error) {
        console.error('Error cargando estadísticas de stock:', error);
        // No mostrar error al usuario, solo logging
    }
}


function limpiarFiltrosStock() {
    const filtros = ['filtro-categoria-stock', 'filtro-estado-stock', 'buscar-stock'];
    filtros.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.value = '';
    });
    
    stockFiltrado = [...stockGeneral];
    renderTablaStockGeneral();
    actualizarContadorFiltros();
}

// Abrir modal de compra
function abrirModalCompra() {
    const modal = document.getElementById('modalCompra');
    if (!modal) {
        console.warn('Modal de compra no encontrado');
        return;
    }
    
    // Cargar selectores
    cargarSelectoresMercaderias('compra_mercaderia');
    cargarSelectoresDepositos('compra_deposito');
    
    // Configurar eventos
    const cantidadInput = document.getElementById('compra_cantidad');
    const precioInput = document.getElementById('compra_precio');
    if (cantidadInput && precioInput) {
        cantidadInput.addEventListener('input', calcularTotalCompra);
        precioInput.addEventListener('input', calcularTotalCompra);
    }
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Calcular total de compra
function calcularTotalCompra() {
    const cantidad = parseFloat(getElementValue('compra_cantidad')) || 0;
    const precio = parseFloat(getElementValue('compra_precio')) || 0;
    const total = cantidad * precio;
    
    const totalElement = document.getElementById('compra_total');
    if (totalElement) {
        totalElement.value = `$${total.toLocaleString()}`;
    }
}



// Abrir modal de transferencia
function abrirModalTransferencia() {
    const modal = document.getElementById('modalTransferencia');
    if (!modal) {
        console.warn('Modal de transferencia no encontrado');
        return;
    }
    
    cargarSelectoresMercaderias('trans_mercaderia');
    cargarSelectoresDepositos('trans_origen');
    cargarSelectoresDepositos('trans_destino');
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Guardar transferencia
async function guardarTransferencia() {
    try {
        const form = document.getElementById('formTransferencia');
        if (!form || !form.checkValidity()) {
            if (form) form.reportValidity();
            return;
        }

        const datosTransferencia = {
            mercaderia_id: parseInt(getElementValue('trans_mercaderia')),
            deposito_origen_id: parseInt(getElementValue('trans_origen')),
            deposito_destino_id: parseInt(getElementValue('trans_destino')),
            cantidad: parseFloat(getElementValue('trans_cantidad')),
            motivo: getElementValue('trans_motivo').trim(),
            numero_documento: getElementValue('trans_documento').trim(),
            observaciones: getElementValue('trans_observaciones').trim()
        };

        const response = await apiRequest('/stock/transferir', 'POST', datosTransferencia);

        if (response.success) {
            showAlert('Transferencia realizada exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalTransferencia'));
            if (modal) {
                modal.hide();
                setTimeout(() => {
        limpiarModalBackdrops(); // ✅ AGREGAR ESTA LÍNEA
    }, 300);
            }
            form.reset();
            await cargarStockGeneral();
        } else {
            throw new Error(response.message || 'Error al realizar transferencia');
        }
    } catch (error) {
        console.error('Error guardando transferencia:', error);
        showAlert('Error al realizar transferencia: ' + error.message, 'danger');
    }
}

// Abrir modal de ajuste
function abrirModalAjuste() {
    const modal = document.getElementById('modalAjuste');
    if (!modal) {
        console.warn('Modal de ajuste no encontrado');
        return;
    }
    
    cargarSelectoresMercaderias('ajuste_mercaderia');
    cargarSelectoresDepositos('ajuste_deposito');
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Guardar ajuste
async function guardarAjuste() {
    try {
        const form = document.getElementById('formAjuste');
        if (!form || !form.checkValidity()) {
            if (form) form.reportValidity();
            return;
        }

        const datosAjuste = {
            mercaderia_id: parseInt(getElementValue('ajuste_mercaderia')),
            deposito_id: parseInt(getElementValue('ajuste_deposito')),
            tipo_ajuste: getElementValue('ajuste_tipo'),
            cantidad: parseFloat(getElementValue('ajuste_cantidad')),
            motivo: getElementValue('ajuste_motivo'),
            observaciones: getElementValue('ajuste_observaciones').trim()
        };

        const response = await apiRequest('/stock/ajustar', 'POST', datosAjuste);

        if (response.success) {
            showAlert('Ajuste de stock realizado exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAjuste'));
            if (modal) modal.hide();
            form.reset();
            await cargarStockGeneral();
        } else {
            throw new Error(response.message || 'Error al ajustar stock');
        }
    } catch (error) {
        console.error('Error guardando ajuste:', error);
        showAlert('Error al ajustar stock: ' + error.message, 'danger');
    }
}

// =============================================
// 📝 FUNCIONES DE SOPORTE
// =============================================

// Actualizar selectores de mercaderías
function actualizarSelectoresMercaderias() {
    console.log('🔄 Actualizando selectores genéricos de mercaderías...');
    
    // Solo selectores genéricos con IDs fijos conocidos
    const selectoresGenericos = [
        'compra_mercaderia', 
        'trans_mercaderia', 
        'ajuste_mercaderia'
    ];
    
    selectoresGenericos.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        if (select && mercaderiasDisponibles.length > 0) {
            console.log(`📋 Actualizando selector genérico: ${selectorId}`);
            
            select.innerHTML = '<option value="">Seleccionar mercadería...</option>';
            mercaderiasDisponibles.forEach(mercaderia => {
                const option = document.createElement('option');
                option.value = mercaderia.id;
                option.textContent = `${mercaderia.codigo_sku} - ${mercaderia.descripcion}`;
                option.setAttribute('data-precio-costo', mercaderia.precio_costo || 0);
                option.setAttribute('data-precio-venta', mercaderia.precio_venta || 0);
                select.appendChild(option);
            });
        } else if (select) {
            console.warn(`⚠️ Selector '${selectorId}' encontrado pero sin mercaderías disponibles`);
        }
    });
    
    console.log('✅ Selectores genéricos actualizados');
}


// Actualizar selectores de depósitos
function actualizarSelectoresDepositos() {
    const selectores = ['compra_deposito', 'trans_origen', 'trans_destino', 'ajuste_deposito', 'selector-deposito'];
    
    selectores.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        if (select && depositosDisponibles.length > 0) {
            const placeholder = selectorId === 'compra_deposito' ? 'Central (por defecto)' : 'Seleccionar depósito...';
            select.innerHTML = `<option value="">${placeholder}</option>`;
            
            depositosDisponibles.forEach(deposito => {
                const option = document.createElement('option');
                option.value = deposito.id;
                const label = deposito.tipo === 'CENTRAL' ? 
                    deposito.nombre : 
                    `${deposito.nombre} (${deposito.entidad_nombre || 'N/A'})`;
                option.textContent = label;
                select.appendChild(option);
            });
        }
    });
}

// Cargar selectores específicos
async function cargarSelectoresMercaderias(selectorId) {
    if (mercaderiasDisponibles.length === 0) {
        await cargarMercaderias();
    }
    /*actualizarSelectoresMercaderias();*/
    actualizarTodosLosSelectoresMercaderias();
}



// Cargar categorías en selector
function cargarCategoriasEnSelector(mercaderias) {
    const select = document.getElementById('filtro-categoria-stock');
    if (!select || !mercaderias) return;
    
    const categorias = [...new Set(mercaderias.map(m => m.categoria).filter(c => c))];
    select.innerHTML = '<option value="">Todas las categorías</option>';
    
    categorias.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        select.appendChild(option);
    });
}

// =============================================
// 📝 FUNCIONES AUXILIARES
// =============================================

// Obtener valor de elemento de forma segura
function getElementValue(id) {
    const element = document.getElementById(id);
    return element ? element.value : '';
}

// Actualizar contador de filtros
function actualizarContadorFiltros() {
    const contador = document.getElementById('contador-productos-stock');
    if (contador) {
        contador.textContent = `${stockFiltrado.length} producto${stockFiltrado.length !== 1 ? 's' : ''}`;
    }
}

// Configurar event listeners
function configurarEventListeners() {
    // Filtros
    const filtros = ['filtro-categoria-stock', 'filtro-estado-stock'];
    filtros.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.addEventListener('change', filtrarStock);
        }
    });
    
    // Búsqueda con debounce
    const busqueda = document.getElementById('buscar-stock');
    if (busqueda) {
        let timeout;
        busqueda.addEventListener('keyup', () => {
            clearTimeout(timeout);
            timeout = setTimeout(filtrarStock, 300);
        });
    }
}

// =============================================
// 📝 FUNCIONES DE ACCIONES RÁPIDAS
// =============================================

// Ver detalle de stock
async function verDetalleStock(mercaderiaId) {
    try {
        const response = await apiRequest(`/stock/mercaderia/${mercaderiaId}`);
        
        if (response.success) {
            const mercaderia = response.mercaderia;
            const stock = response.data;
            
            showAlert(`Stock de ${mercaderia.descripcion}: ${response.totales.total_cantidad} unidades en ${response.totales.depositos_con_stock} depósitos`, 'info');
        }
    } catch (error) {
        console.error('Error viendo detalle de stock:', error);
        showAlert('Error al cargar detalle de stock', 'danger');
    }
}

// Abrir ajuste rápido
function abrirAjusteRapido(mercaderiaId) {
    setTimeout(() => {
        const select = document.getElementById('ajuste_mercaderia');
        if (select) {
            select.value = mercaderiaId;
        }
    }, 100);
    abrirModalAjuste();
}

// Abrir transferencia rápida
function abrirTransferenciaRapida(mercaderiaId) {
    setTimeout(() => {
        const select = document.getElementById('trans_mercaderia');
        if (select) {
            select.value = mercaderiaId;
        }
    }, 100);
    abrirModalTransferencia();
}

// =============================================
// 📝 FUNCIONES DE PESTAÑAS
// =============================================

// Cargar stock por depósito
async function cargarStockDeposito() {
    const depositoId = getElementValue('selector-deposito');
    const tbody = document.getElementById('tabla-stock-deposito');
    
    if (!tbody) return;
    
    if (!depositoId) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Seleccione un depósito</td></tr>';
        return;
    }

    try {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Cargando...</td></tr>';
        
        const response = await apiRequest(`/stock/deposito/${depositoId}`);
        
        if (response.success) {
            const stock = response.data;
            
            if (stock.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay stock en este depósito</td></tr>';
                return;
            }

            tbody.innerHTML = stock.map(item => {
                const estadoStock = determinarEstadoStock(item.cantidad, item.stock_minimo);
                
                return `
                    <tr>
                        <td><strong class="text-primary">${item.codigo_sku || 'N/A'}</strong></td>
                        <td>${item.descripcion}</td>
                        <td class="text-center"><strong>${item.cantidad}</strong></td>
                        <td class="text-center">${item.stock_minimo}</td>
                        <td class="text-end">$${(item.precio_venta || 0).toLocaleString()}</td>
                        <td class="text-end">$${(item.valor_total || 0).toLocaleString()}</td>
                        <td class="text-center">
                            <span class="badge ${estadoStock.clase}">${estadoStock.texto}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning" onclick="abrirAjusteRapido(${item.id})" title="Ajustar">
                                    <i class="fas fa-tools"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="abrirTransferenciaRapida(${item.id})" title="Transferir">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error cargando stock del depósito:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar datos</td></tr>';
    }
}

console.log('📊 Control de Stock cargado correctamente (versión corregida)');

function filtrarStock() {
    try {
        const categoria = getElementValue('filtro-categoria-stock');
        const estado = getElementValue('filtro-estado-stock');
        const busqueda = getElementValue('buscar-stock').toLowerCase().trim();

        stockFiltrado = stockGeneral.filter(item => {
            // El select usa nombres de categoría, no IDs
            // Comparamos item.categoria (texto) con categoria (texto del select)
            const itemCategoria = String(item.categoria || '').trim().toLowerCase();
            const filtroCategoria = String(categoria || '').trim().toLowerCase();
            
            // Comparación de texto (nombres de categoría)
            const cumpleCategoria = !filtroCategoria || itemCategoria === filtroCategoria;
            
            // Manejo mejorado del estado
            const cumpleEstado = !estado || (() => {
                const estadoItem = determinarEstadoStock(
                    Number(item.stock_total) || 0, 
                    Number(item.stock_minimo) || 0
                );
                return estadoItem.texto.toLowerCase().includes(estado.replace('_', ' ').toLowerCase());
            })();
            
            // Búsqueda mejorada con manejo de valores null/undefined
            const cumpleBusqueda = !busqueda || (() => {
                const descripcion = String(item.descripcion || '').toLowerCase();
                const codigoSku = String(item.codigo_sku || '').toLowerCase();
                return descripcion.includes(busqueda) || codigoSku.includes(busqueda);
            })();

            return cumpleCategoria && cumpleEstado && cumpleBusqueda;
        });

        renderTablaStockGeneral();
        actualizarContadorFiltros();
        
        // Opcional: debug para verificar filtros aplicados
        console.log(`Filtros aplicados - Categoría: "${categoria}", Estado: "${estado}", Búsqueda: "${busqueda}"`);
        console.log(`Resultados: ${stockFiltrado.length} de ${stockGeneral.length} productos`);
        
    } catch (error) {
        console.error('Error filtrando stock:', error);
        // Fallback: mostrar todos los productos si hay error
        stockFiltrado = [...stockGeneral];
        renderTablaStockGeneral();
        actualizarContadorFiltros();
    }
}

// Función auxiliar mejorada para obtener valores
function getElementValue(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`Elemento con ID '${id}' no encontrado`);
        return '';
    }
    return element.value.trim();
}

function actualizarContadorFiltros() {
    const contador = document.getElementById('contador-productos-stock');
    if (contador) {
        contador.textContent = `${stockFiltrado.length} producto${stockFiltrado.length !== 1 ? 's' : ''}`;
    }
}

// =============================================
// 📊 CARGAR DATOS PARA COMPRAS
// =============================================

async function cargarDatosCompras() {
    try {
        console.log('🔄 Cargando datos para compras...');
        
        // Cargar proveedores
        const proveedoresResponse = await apiRequest('/proveedores');
        if (proveedoresResponse.success) {
            comprasData.proveedores = proveedoresResponse.data || [];
            console.log(`✅ Proveedores cargados: ${comprasData.proveedores.length}`);
        }

        // Cargar mercaderías (si no están ya cargadas)
        if (mercaderiasDisponibles.length === 0) {
            await cargarMercaderias();
        }
        comprasData.mercaderiasDisponibles = mercaderiasDisponibles;

        // Cargar depósitos (si no están ya cargados)
        if (depositosDisponibles.length === 0) {
            await cargarDepositos();
        }
        comprasData.depositosDisponibles = depositosDisponibles;

        // Llenar selectores
        llenarSelectoresCompras();
        
    } catch (error) {
        console.error('❌ Error cargando datos de compras:', error);
        showAlert('Error al cargar datos para compras', 'warning');
    }
}

function llenarSelectoresCompras() {
    // Llenar selector de proveedores
    const selectProveedor = document.getElementById('compra-proveedor');
    if (selectProveedor) {
        selectProveedor.innerHTML = '<option value="">Seleccionar proveedor...</option>';
        comprasData.proveedores.forEach(proveedor => {
            const option = document.createElement('option');
            option.value = proveedor.proveedorId || proveedor.id;
            option.textContent = proveedor.razonSocial;
            selectProveedor.appendChild(option);
        });
    }

    console.log('✅ Selectores de compras actualizados');
}

// =============================================
// 🛒 FORMULARIO DE COMPRA DIRECTA SIMPLIFICADO
// =============================================



function abrirModalCompraDirect() {
            
            // Limpiar y configurar formulario
            
            // Cargar datos si es necesario
            if (typeof cargarDatosCompras === 'function') {
                cargarDatosCompras();
            }
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalCompraDirecta'));
            modal.show();
        }


        

         function scrollToProductoCompra(id) {
            const elemento = document.getElementById(`producto-compra-${id}`);
            if (elemento) {
                elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Efecto de resaltado
                elemento.style.backgroundColor = '#fff3cd';
                setTimeout(() => {
                    elemento.style.backgroundColor = '';
                }, 2000);
            }
        }

        function scrollProductosTop() {
            document.querySelector('.productos-compra-mejorado').scrollTop = 0;
        }

        function scrollProductosBottom() {
            const container = document.querySelector('.productos-compra-mejorado');
            container.scrollTop = container.scrollHeight;
        }

       

        

        function actualizarDepositoCompra(id, depositoId) {
            const producto = productosCompraData.find(p => p.id === id);
            if (producto) {
                producto.deposito_id = parseInt(depositoId);
            }
        }

        function actualizarLoteCompra(id, lote) {
            const producto = productosCompraData.find(p => p.id === id);
            if (producto) {
                producto.lote = lote;
            }
        }

        function actualizarVencimientoCompra(id, vencimiento) {
            const producto = productosCompraData.find(p => p.id === id);
            if (producto) {
                producto.vencimiento = vencimiento;
            }
        }

        function duplicarProductoCompra(id) {
            const original = productosCompraData.find(p => p.id === id);
            if (original) {
                const duplicado = {
                    ...original,
                    id: contadorProductosCompra,
                    lote: '', // Limpiar lote
                    expandido: true
                };
                
                productosCompraData.push(duplicado);
                renderizarProductoCompra(duplicado);
                scrollToProductoCompra(duplicado.id);
            }
        }

        function moverProductoArriba(id) {
            const index = productosCompraData.findIndex(p => p.id === id);
            if (index > 0) {
                [productosCompraData[index], productosCompraData[index - 1]] = 
                [productosCompraData[index - 1], productosCompraData[index]];
                reordenarProductosCompra();
            }
        }

        function moverProductoAbajo(id) {
            const index = productosCompraData.findIndex(p => p.id === id);
            if (index < productosCompraData.length - 1) {
                [productosCompraData[index], productosCompraData[index + 1]] = 
                [productosCompraData[index + 1], productosCompraData[index]];
                reordenarProductosCompra();
            }
        }

        

        

        

         function llenarSelectProductos(productoId) {
            const select = document.querySelector(`#producto-compra-${productoId} .producto-select`);
            if (select && typeof comprasData !== 'undefined' && comprasData.mercaderiasDisponibles) {
                select.innerHTML = '<option value="">Seleccionar producto...</option>';
                comprasData.mercaderiasDisponibles.forEach(mercaderia => {
                    const option = document.createElement('option');
                    option.value = mercaderia.mercaderiaId || mercaderia.id;
                    option.textContent = `${mercaderia.nombre} - ${mercaderia.codigo || ''}`;
                    select.appendChild(option);
                });
            }
        }

        function cambiarProductoCompra(id, mercaderiaId) {
            const producto = productosCompraData.find(p => p.id === id);
            if (producto) {
                producto.mercaderia_id = mercaderiaId;
                
                // Buscar datos del producto si están disponibles
                if (typeof comprasData !== 'undefined' && comprasData.mercaderiasDisponibles) {
                    const mercaderia = comprasData.mercaderiasDisponibles.find(m => 
                        (m.mercaderiaId || m.id) == mercaderiaId
                    );
                    
                    if (mercaderia) {
                        producto.nombre = mercaderia.nombre;
                        producto.codigo = mercaderia.codigo;
                        
                        // Actualizar precio si está disponible y el actual es 0
                        if (mercaderia.precioCompra && producto.precio === 0) {
                            producto.precio = parseFloat(mercaderia.precioCompra);
                        }
                    }
                }
                
                calcularSubtotalCompra(id);
                actualizarResumenProducto(id);
                validarProductoCompra(id);
            }
        }

        function removerProductoCompraMejorado(id) {
            if (confirm('¿Eliminar este producto?')) {
                productosCompraData = productosCompraData.filter(p => p.id !== id);
                document.getElementById(`producto-compra-${id}`)?.remove();
                
                // Mostrar mensaje si no hay productos
                if (productosCompraData.length === 0) {
                    const mensaje = document.getElementById('mensaje-sin-productos');
                    if (mensaje) {
                        mensaje.style.display = 'block';
                    }
                }
                
            }
        }

        function actualizarCantidadCompra(id, cantidad) {
            const producto = productosCompraData.find(p => p.id === id);
            if (producto) {
                producto.cantidad = parseFloat(cantidad) || 0;
                calcularSubtotalCompra(id);
                actualizarResumenProducto(id);
                validarProductoCompra(id);
            }
        }

        function actualizarPrecioCompra(id, precio) {
            const producto = productosCompraData.find(p => p.id === id);
            if (producto) {
                producto.precio = parseFloat(precio) || 0;
                calcularSubtotalCompra(id);
                actualizarResumenProducto(id);
                validarProductoCompra(id);
            }
        }

        function actualizarResumenProducto(id) {
            const producto = productosCompraData.find(p => p.id === id);
            const elemento = document.getElementById(`producto-compra-${id}`);
            
            if (producto && elemento) {
                const resumen = elemento.querySelector('.producto-resumen');
                if (resumen) {
                    resumen.innerHTML = `
                        ${producto.codigo ? `${producto.codigo} | ` : ''}
                        Cant: ${producto.cantidad} | $${producto.precio.toLocaleString()} | 
                        Subtotal: $${producto.subtotal.toLocaleString()}
                    `;
                }
            }
        }

         function validarProductoCompra(id) {
            const producto = productosCompraData.find(p => p.id === id);
            if (!producto) return;

            producto.errores = [];

            if (!producto.mercaderia_id) {
                producto.errores.push('Seleccione un producto');
            }
            if (producto.cantidad <= 0) {
                producto.errores.push('Cantidad debe ser mayor a 0');
            }
            if (producto.precio <= 0) {
                producto.errores.push('Precio debe ser mayor a 0');
            }

            // Actualizar visualización
            const elemento = document.getElementById(`producto-compra-${id}`);
            if (elemento) {
                elemento.classList.toggle('producto-con-errores', producto.errores.length > 0);
            }
        }

        function validarTodosProductos() {
            let errores = 0;
            productosCompraData.forEach(p => {
                validarProductoCompra(p.id);
                if (p.errores.length > 0) errores++;
            });

            const mensaje = errores > 0 
                ? `Se encontraron ${errores} productos con errores` 
                : '¡Todos los productos están correctos!';
                
            if (typeof showAlert === 'function') {
                showAlert(mensaje, errores > 0 ? 'warning' : 'success');
            } else {
                alert(mensaje);
            }
        }

        function toggleExpandirProducto(id) {
            const elemento = document.getElementById(`producto-compra-${id}`);
            const producto = productosCompraData.find(p => p.id === id);
            
            if (producto && elemento) {
                producto.expandido = !producto.expandido;
                elemento.classList.toggle('producto-expandido', producto.expandido);
                elemento.classList.toggle('producto-collapsed', !producto.expandido);
            }
        }

        function expandirTodosProductos() {
            productosCompraData.forEach(p => {
                p.expandido = true;
                const elemento = document.getElementById(`producto-compra-${p.id}`);
                if (elemento) {
                    elemento.classList.add('producto-expandido');
                    elemento.classList.remove('producto-collapsed');
                }
            });
        }

        function contraerTodosProductos() {
            productosCompraData.forEach(p => {
                p.expandido = false;
                const elemento = document.getElementById(`producto-compra-${p.id}`);
                if (elemento) {
                    elemento.classList.remove('producto-expandido');
                    elemento.classList.add('producto-collapsed');
                }
            });
        }


   window.contadorProductosCompra = 0;
        window.productosCompraData = [];

 let contadorProductosCompra = 0;
        let productosCompraData = [];

          // =============================================
        // 🚀 INICIALIZACIÓN INMEDIATA
        // =============================================
        
        // Ejecutar inmediatamente al cargar el script
        (function() {
            // Inicializar variables globales inmediatamente
            if (typeof window !== 'undefined') {
                window.contadorProductosCompra = window.contadorProductosCompra || 0;
                window.productosCompraData = window.productosCompraData || [];
            }
        })();

        function inicializarVariablesCompra() {
            if (typeof window.productosCompraData === 'undefined') {
                window.productosCompraData = [];
            }
            if (typeof window.contadorProductosCompra === 'undefined') {
                window.contadorProductosCompra = 0;
            }
            
            // Asegurar variables locales
            if (typeof productosCompraData === 'undefined') {
                productosCompraData = window.productosCompraData || [];
            }
            if (typeof contadorProductosCompra === 'undefined') {
                contadorProductosCompra = window.contadorProductosCompra || 0;
            }
        }

window.eliminarProductoCompra = function(productoId) {
    console.log(`🗑️ Eliminando producto: ${productoId}`);
    
    try {
        // Confirmar eliminación
        if (!confirm('¿Está seguro de eliminar este producto?')) {
            return;
        }
        
        // 1. ELIMINAR DEL DOM
        const elementoProducto = document.getElementById('producto-'+productoId);
        if (elementoProducto) {
            elementoProducto.remove();
            console.log(`✅ Elemento ${productoId} removido del DOM`);
        } else {
            console.warn(`⚠️ Elemento ${productoId} no encontrado en DOM`);
        }
        
        // 2. ELIMINAR DEL ARRAY productosCompra (si existe)
        if (typeof productosCompra !== 'undefined' && Array.isArray(productosCompra)) {
            const numeroProducto = parseInt(productoId.replace('producto-', ''));
            productosCompra = productosCompra.filter(p => p.id !== numeroProducto);
            console.log(`✅ Producto removido del array productosCompra`);
        }
        
        // 3. ELIMINAR DEL ARRAY productosCompraData (si existe)
        if (typeof productosCompraData !== 'undefined' && Array.isArray(productosCompraData)) {
            const numeroProducto = parseInt(productoId.replace('producto-', ''));
            productosCompraData = productosCompraData.filter(p => p.id !== numeroProducto);
            console.log(`✅ Producto removido del array productosCompraData`);
        }
        
        // 4. LIMPIAR REFERENCIAS DE AUTOCOMPLETE
        const numeroProducto = productoId.replace('producto-', '');
        if (typeof window.autocompletesProductos !== 'undefined') {
            delete window.autocompletesProductos[numeroProducto];
            console.log(`✅ Referencia de autocomplete eliminada`);
        }
        
        // 5. VERIFICAR SI QUEDAN PRODUCTOS
        const container = document.getElementById('productos-container');
        const productosRestantes = container ? container.querySelectorAll('.producto-item, .producto-compra').length : 0;
        
        if (productosRestantes === 0) {
            mostrarMensajeVacioCompra();
        }
        
        // 6. RECALCULAR TOTALES
        recalcularTotalesCompra();
        
        // 7. MOSTRAR CONFIRMACIÓN
        if (typeof showAlert === 'function') {
            showAlert('Producto eliminado correctamente', 'success');
        } else {
            console.log('✅ Producto eliminado correctamente');
        }
        
    } catch (error) {
        console.error('❌ Error eliminando producto:', error);
        if (typeof showAlert === 'function') {
            showAlert('Error al eliminar producto: ' + error.message, 'danger');
        } else {
            alert('Error al eliminar producto: ' + error.message);
        }
    }
};

function recalcularTotalesCompra() {
    try {
        // Intentar usar función existente de cálculo de totales
        if (typeof calcularTotalesCompraDirecta === 'function') {
            calcularTotalesCompraDirecta();
        } else if (typeof calcularTotalesCompraSimple === 'function') {
            calcularTotalesCompraSimple();
        } else if (typeof calcularTotales === 'function') {
            calcularTotales();
        } else {
            // Cálculo manual básico
            calcularTotalesManual();
        }
    } catch (error) {
        console.error('Error recalculando totales:', error);
    }
}

function calcularTotalesManual() {
    let subtotal = 0;
    let totalIVA = 0;
    
    // Buscar todos los productos activos
    const productos = document.querySelectorAll('.producto-item:not(#mensaje-vacio), .producto-compra:not(#mensaje-vacio)');
    
    productos.forEach(producto => {
        const cantidad = parseFloat(producto.querySelector('.cantidad-input')?.value || 0);
        const precio = parseFloat(producto.querySelector('.precio-input')?.value || 0);
        const iva = parseFloat(producto.querySelector('.iva-input')?.value || 0);
        
        const subtotalProducto = cantidad * precio;
        const ivaProducto = subtotalProducto * (iva / 100);
        
        subtotal += subtotalProducto;
        totalIVA += ivaProducto;
    });
    
    const total = subtotal + totalIVA;
    
    // Actualizar displays de totales
    const subtotalDisplay = document.getElementById('subtotal-compra');
    const ivaDisplay = document.getElementById('iva-compra');
    const totalDisplay = document.getElementById('total-compra');
    
    if (subtotalDisplay) subtotalDisplay.textContent = `$${subtotal.toLocaleString()}`;
    if (ivaDisplay) ivaDisplay.textContent = `$${totalIVA.toLocaleString()}`;
    if (totalDisplay) totalDisplay.textContent = `$${total.toLocaleString()}`;
}

window.eliminarProducto = function(id) {
    // Convertir a formato estándar
    let productoId = id;
    if (!String(id).startsWith('producto-')) {
        productoId = `producto-${id}`;
    }
    
    // Llamar a la función principal
    eliminarProductoCompra(productoId);
};

console.log('✅ Función eliminarProductoCompra cargada correctamente');

function mostrarMensajeVacioCompra() {
    const container = document.getElementById('productos-container');
    if (!container) return;
    
    // Verificar si ya existe el mensaje
    let mensajeVacio = document.getElementById('mensaje-vacio');
    
    if (!mensajeVacio) {
        // Crear mensaje vacío
        const mensajeHTML = `
            <div class="text-center text-muted py-4" id="mensaje-vacio">
                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                <p>No hay productos agregados.</p>
                <p>Haz clic en "Agregar Producto" para comenzar.</p>
            </div>
        `;
        container.insertAdjacentHTML('afterbegin', mensajeHTML);
    } else {
        // Mostrar mensaje existente
        mensajeVacio.style.display = 'block';
    }
}

// =============================================
// FUNCIÓN COMPLETA - agregarProductoCompra() CON AUTOCOMPLETE
// =============================================

// 1. INICIALIZACIÓN DE VARIABLES GLOBALES
if (typeof window.productosCompra === 'undefined') {
    window.productosCompra = [];
}
if (typeof window.contadorProductos === 'undefined') {
    window.contadorProductos = 0;
}
if (typeof window.autocompletesProductos === 'undefined') {
    window.autocompletesProductos = {};
}

// =============================================
// FUNCIÓN MEJORADA: agregarProductoCompra() CON VALIDACIÓN DE PROVEEDOR
// =============================================

window.agregarProductoCompra = function() {
    console.log('🚀 Agregando producto con validación de proveedor...');
    
    try {
        // ✅ VALIDACIÓN OBLIGATORIA DEL PROVEEDOR
        const proveedorId = document.getElementById('compra-proveedor').value;
        if (!proveedorId || proveedorId === '') {
            if (typeof showAlert === 'function') {
                showAlert('Primero debe seleccionar un proveedor', 'warning');
            } else {
                alert('Primero debe seleccionar un proveedor');
            }
            document.getElementById('compra-proveedor').focus();
            return false; // ❌ Detener ejecución si no hay proveedor
        }
        
        // Verificar que MercaderiaAutocomplete esté definida
        if (typeof window.MercaderiaAutocomplete === 'undefined') {
            throw new Error('MercaderiaAutocomplete no está definida. Asegúrate de que el script esté cargado.');
        }
        
        // Incrementar contador
        window.contadorProductos++;
        const productoId = window.contadorProductos;
        
        // Crear objeto producto en el array
        const producto = {
            id: productoId,
            mercaderia_id: '',
            descripcion: '',
            codigo_sku: '',
            cantidad: 1,
            precio: 0,
            iva_porcentaje: 21,
            subtotal: 0,
            iva_monto: 0,
            total: 0,
            proveedor_id: proveedorId // ✅ Guardar el proveedor asociado
        };
        
        // Agregar al array
        window.productosCompra.push(producto);
        
        // Buscar contenedor
        const container = document.getElementById('productos-container');
        if (!container) {
            throw new Error('Contenedor productos-container no encontrado');
        }
        
        // IDs únicos para cada elemento
        const autocompleteId = `autocomplete-${productoId}`;
        
        // Crear HTML del producto
        const productoHTML = `
            <div class="producto-item border rounded p-3 mb-3" id="producto-${productoId}">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Mercadería *</label>
                        <div id="${autocompleteId}" class="autocomplete-container"></div>
                        <input type="hidden" class="mercaderia-id" id="mercaderia-id-${productoId}">
                        <div id="info-${productoId}" class="mt-1"></div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Cantidad *</label>
                        <input type="number" class="form-control cantidad-input" 
                               min="0.01" step="0.01" value="1" 
                               id="cantidad-${productoId}"
                               onchange="actualizarCantidadCompra(${productoId})"
                               required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Precio *</label>
                        <input type="number" class="form-control precio-input" 
                               min="0" step="0.01" value="0" 
                               id="precio-${productoId}"
                               onchange="actualizarPrecioCompra(${productoId})"
                               required>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">IVA %</label>
                        <select class="form-select iva-input" id="iva-${productoId}" 
                                onchange="actualizarIvaCompra(${productoId})">
                            <option value="0">0%</option>
                            <option value="10.5">10.5%</option>
                            <option value="21" selected>21%</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-outline-danger btn-sm d-block" 
                                onclick="eliminarProductoCompra(${productoId})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Totales del producto -->
                <div class="row mt-2">
                    <div class="col-md-12">
                        <small class="text-muted">
                            Subtotal: $<span id="subtotal-${productoId}">0.00</span> | 
                            IVA: $<span id="iva-monto-${productoId}">0.00</span> | 
                            <strong>Total: $<span id="total-${productoId}">0.00</span></strong>
                        </small>
                    </div>
                </div>
            </div>
        `;
        
        // Insertar HTML
        container.insertAdjacentHTML('beforeend', productoHTML);
        
        // Ocultar mensaje vacío
        ocultarMensajeVacioCompraSimple();
        
        // ✅ CREAR AUTOCOMPLETE FILTRADO POR PROVEEDOR
        const autocompleteContainer = document.getElementById(autocompleteId);
        if (autocompleteContainer) {
            const autocomplete = new MercaderiaAutocompleteProveedor(autocompleteContainer, {
                proveedorId: proveedorId, // 🔑 PASAR EL PROVEEDOR SELECCIONADO
                placeholder: 'Buscar mercadería del proveedor...',
                onSelect: (mercaderia) => {
                    console.log('🎯 Mercadería seleccionada:', mercaderia);
                    
                    // Actualizar datos del producto
                    const mercaderiaIdInput = document.getElementById(`mercaderia-id-${productoId}`);
                    const precioInput = document.getElementById(`precio-${productoId}`);
                    const infoDiv = document.getElementById(`info-${productoId}`);
                    
                    if (mercaderiaIdInput) mercaderiaIdInput.value = mercaderia.mercaderia_id || mercaderia.id;
                    if (precioInput && mercaderia.precio_compra) {
                        precioInput.value = parseFloat(mercaderia.precio_compra).toFixed(2);
                    }
                    
                    // Mostrar información adicional
                    if (infoDiv) {
                        infoDiv.innerHTML = `
                            <small class="text-info">
                                <i class="fas fa-info-circle"></i> 
                                SKU: ${mercaderia.codigo_sku || 'N/A'} | 
                                Precio proveedor: $${mercaderia.precio_compra || '0.00'}
                            </small>
                        `;
                    }
                    
                    // Actualizar objeto en array
                    const producto = window.productosCompra.find(p => p.id === productoId);
                    if (producto) {
                        producto.mercaderia_id = mercaderia.mercaderia_id || mercaderia.id;
                        producto.descripcion = mercaderia.descripcion;
                        producto.codigo_sku = mercaderia.codigo_sku;
                        producto.precio = parseFloat(mercaderia.precio_compra) || 0;
                    }
                    
                    // Recalcular totales
                    calcularProductoCompra(productoId);
                }
            });
            
            // Guardar referencia del autocomplete
            if (!window.autocompletesProductos) window.autocompletesProductos = {};
            window.autocompletesProductos[productoId] = autocomplete;
        }
        
        console.log(`✅ Producto ${productoId} agregado correctamente para proveedor ${proveedorId}`);
        
    } catch (error) {
        console.error('❌ Error agregando producto:', error);
        if (typeof showAlert === 'function') {
            showAlert('Error al agregar producto: ' + error.message, 'danger');
        } else {
            alert('Error al agregar producto: ' + error.message);
        }
    }
};

// =============================================
// CLASE MEJORADA: MercaderiaAutocompleteProveedor
// =============================================

class MercaderiaAutocompleteProveedor {
    constructor(container, options = {}) {
        this.container = typeof container === 'string' ? 
            document.getElementById(container) : container;
            
        if (!this.container) {
            throw new Error('MercaderiaAutocompleteProveedor: contenedor no encontrado');
        }
        
        this.options = {
            placeholder: 'Buscar mercadería...',
            onSelect: () => {},
            proveedorId: null, // 🔑 ID del proveedor para filtrar
            ...options
        };
        
        // ✅ URL DINÁMICA BASADA EN PROVEEDOR
        this.apiUrl = this.options.proveedorId ? 
            `/api/v1/proveedores/${this.options.proveedorId}/mercaderias` : 
            '/api/v1/mercaderias/buscar';
            
        this.currentProducts = [];
        
        console.log(`🔍 Autocomplete inicializado para proveedor: ${this.options.proveedorId}`);
        this.init();
    }
    
    init() {
        this.container.innerHTML = `
            <div style="position: relative;">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search text-primary"></i>
                    </span>
                    <input type="text" class="form-control" 
                           placeholder="${this.options.placeholder}" 
                           autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" 
                            style="display: none;" 
                            title="Limpiar búsqueda">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="autocomplete-results" style="
                    position: absolute; 
                    top: 100%; 
                    left: 0; 
                    right: 0; 
                    background: white; 
                    border: 1px solid #ddd; 
                    border-top: none; 
                    max-height: 300px; 
                    overflow-y: auto; 
                    z-index: 1050; 
                    display: none;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                </div>
            </div>
        `;
        
        this.input = this.container.querySelector('input');
        this.clearBtn = this.container.querySelector('button');
        this.results = this.container.querySelector('.autocomplete-results');
        
        this.bindEvents();
    }
    
    bindEvents() {
        let searchTimeout;
        
        // Evento de búsqueda
        this.input.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            this.clearBtn.style.display = value ? 'inline-block' : 'none';
            
            clearTimeout(searchTimeout);
            
            if (value.length >= 2) {
                searchTimeout = setTimeout(() => this.buscarMercaderias(value), 300);
            } else {
                this.hideResults();
            }
        });
        
        // Botón limpiar
        this.clearBtn.addEventListener('click', () => {
            this.input.value = '';
            this.clearBtn.style.display = 'none';
            this.hideResults();
            this.input.focus();
        });
        
        // Ocultar resultados al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) {
                this.hideResults();
            }
        });
    }
    
    async buscarMercaderias(query) {
        try {
            console.log(`🔍 Buscando "${query}" para proveedor ${this.options.proveedorId}...`);
            
            let url, data;
            
            if (this.options.proveedorId) {
                // 🎯 BUSCAR SOLO EN MERCADERÍAS DEL PROVEEDOR
                const response = await apiRequest(`/proveedores/${this.options.proveedorId}/mercaderias`);
                
                if (response.success && response.data) {
                    // Filtrar localmente por el query
                    data = response.data.filter(item => 
                        item.descripcion.toLowerCase().includes(query.toLowerCase()) ||
                        item.codigo_sku.toLowerCase().includes(query.toLowerCase())
                    );
                } else {
                    data = [];
                }
            } else {
                // Fallback: buscar en todas las mercaderías
                const response = await apiRequest(`/mercaderias/buscar?q=${encodeURIComponent(query)}&limit=10`);
                data = response.success ? response.data : [];
            }
            
            this.currentProducts = data;
            this.mostrarResultados(data, query);
            
        } catch (error) {
            console.error('❌ Error en búsqueda:', error);
            this.mostrarError('Error al buscar mercaderías');
        }
    }
    
    mostrarResultados(mercaderias, query) {
        if (!mercaderias || mercaderias.length === 0) {
            this.results.innerHTML = `
                <div class="p-3 text-center text-muted">
                    <i class="fas fa-search"></i><br>
                    No se encontraron mercaderías del proveedor<br>
                    <small>que contengan "${query}"</small>
                </div>
            `;
            this.results.style.display = 'block';
            return;
        }
        
        const html = mercaderias.map(mercaderia => `
            <div class="autocomplete-item p-2 border-bottom" style="cursor: pointer;"
                 data-id="${mercaderia.mercaderia_id || mercaderia.id}"
                 onmouseover="this.style.backgroundColor='#f8f9fa'"
                 onmouseout="this.style.backgroundColor='white'"
                 onclick="window.autocompletesProductos[Object.keys(window.autocompletesProductos).find(key => window.autocompletesProductos[key] === this.closest('.autocomplete-container').autocompleteInstance)].selectMercaderia(${mercaderia.mercaderia_id || mercaderia.id})">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${mercaderia.descripcion}</strong><br>
                        <small class="text-muted">
                            SKU: ${mercaderia.codigo_sku || 'N/A'} | 
                            Código proveedor: ${mercaderia.codigo_producto_proveedor || 'N/A'}
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success">$${mercaderia.precio_compra || '0.00'}</span>
                        ${mercaderia.es_proveedor_principal ? '<br><small class="text-warning">★ Principal</small>' : ''}
                    </div>
                </div>
            </div>
        `).join('');
        
        this.results.innerHTML = html;
        this.results.style.display = 'block';
        
        // Guardar referencia para los clicks
        this.container.autocompleteInstance = this;
    }
    
    mostrarError(mensaje) {
        this.results.innerHTML = `
            <div class="p-3 text-center text-danger">
                <i class="fas fa-exclamation-triangle"></i><br>
                ${mensaje}
            </div>
        `;
        this.results.style.display = 'block';
    }
    
    selectMercaderia(mercaderiaId) {
        const mercaderia = this.currentProducts.find(m => 
            (m.mercaderia_id || m.id) == mercaderiaId
        );
        
        if (mercaderia) {
            this.input.value = `${mercaderia.codigo_sku} - ${mercaderia.descripcion}`;
            this.hideResults();
            this.options.onSelect(mercaderia);
        }
    }
    
    hideResults() {
        this.results.style.display = 'none';
    }
}

// Hacer disponible globalmente
window.MercaderiaAutocompleteProveedor = MercaderiaAutocompleteProveedor;

// =============================================
// FUNCIONES DE MANEJO DE AUTOCOMPLETE
// =============================================

// Función que se ejecuta cuando se selecciona una mercadería del autocomplete
window.seleccionarMercaderiaAutocomplete = function(productoId, mercaderia) {
    console.log(`🎯 Configurando producto ${productoId} con mercadería:`, mercaderia);
    
    // Buscar producto en el array
    const producto = window.productosCompra.find(p => p.id === productoId);
    if (!producto) {
        console.error('❌ Producto no encontrado en array:', productoId);
        return;
    }
    
    // Actualizar datos del producto
    producto.mercaderia_id = mercaderia.id || mercaderia.mercaderiaId || '';
    producto.descripcion = mercaderia.descripcion || '';
    producto.codigo_sku = mercaderia.codigo || mercaderia.sku || '';
    
    // Guardar ID en campo hidden
    const hiddenInput = document.getElementById(`mercaderia-id-${productoId}`);
    if (hiddenInput) {
        hiddenInput.value = producto.mercaderia_id;
    }
    
    // Mostrar información de la mercadería
    const infoDiv = document.getElementById(`info-${productoId}`);
    if (infoDiv) {
        infoDiv.innerHTML = `
            <small class="text-muted">
                <strong>${producto.codigo_sku}</strong> - ${producto.descripcion}
            </small>
        `;
    }
    
    // Auto-completar precio si está disponible
    const precioSugerido = parseFloat(mercaderia.precio) || 0;
    if (precioSugerido > 0) {
        producto.precio = precioSugerido;
        const precioInput = document.getElementById(`precio-${productoId}`);
        if (precioInput) {
            precioInput.value = precioSugerido;
        }
    }
    
    // Recalcular totales del producto
    calcularProductoCompra(productoId);
    
    console.log('✅ Producto configurado correctamente');
};

// =============================================
// FUNCIONES DE CÁLCULOS
// =============================================

// Actualizar cantidad
window.actualizarCantidadCompra = function(productoId) {
    const input = document.getElementById(`cantidad-${productoId}`);
    const producto = window.productosCompra.find(p => p.id === productoId);
    
    if (producto && input) {
        producto.cantidad = parseFloat(input.value) || 0;
        calcularProductoCompra(productoId);
    }
};

// Actualizar precio
window.actualizarPrecioCompra = function(productoId) {
    const input = document.getElementById(`precio-${productoId}`);
    const producto = window.productosCompra.find(p => p.id === productoId);
    
    if (producto && input) {
        producto.precio = parseFloat(input.value) || 0;
        calcularProductoCompra(productoId);
    }
};

// Actualizar IVA
window.actualizarIvaCompra = function(productoId) {
    const select = document.getElementById(`iva-${productoId}`);
    const producto = window.productosCompra.find(p => p.id === productoId);
    
    if (producto && select) {
        producto.iva_porcentaje = parseFloat(select.value) || 0;
        calcularProductoCompra(productoId);
    }
};

// Calcular totales de un producto
window.calcularProductoCompra = function(productoId) {
    const producto = window.productosCompra.find(p => p.id === productoId);
    if (!producto) return;
    
    // Cálculos
    producto.subtotal = producto.cantidad * producto.precio;
    producto.iva_monto = producto.subtotal * (producto.iva_porcentaje / 100);
    producto.total = producto.subtotal + producto.iva_monto;
    
    // Actualizar visualización
    const subtotalSpan = document.getElementById(`subtotal-${productoId}`);
    const ivaSpan = document.getElementById(`iva-monto-${productoId}`);
    const totalSpan = document.getElementById(`total-${productoId}`);
    
    if (subtotalSpan) subtotalSpan.textContent = producto.subtotal.toFixed(2);
    if (ivaSpan) ivaSpan.textContent = producto.iva_monto.toFixed(2);
    if (totalSpan) totalSpan.textContent = producto.total.toFixed(2);
    
    // Recalcular totales generales
    calcularTotalesCompraSimple();
    
    console.log(`💰 Producto ${productoId} recalculado:`, {
        subtotal: producto.subtotal,
        iva: producto.iva_monto,
        total: producto.total
    });
};

// =============================================
// FUNCIÓN DE ELIMINACIÓN
// =============================================

window.eliminarProductoCompra = function(productoId) {
    if (!confirm('¿Está seguro de eliminar este producto?')) {
        return;
    }
    
    console.log(`🗑️ Eliminando producto ${productoId}`);
    
    // Remover del array
    window.productosCompra = window.productosCompra.filter(p => p.id !== productoId);
    
    // Limpiar referencia del autocomplete
    if (window.autocompletesProductos[productoId]) {
        delete window.autocompletesProductos[productoId];
    }
    
    // Remover del DOM
    const elemento = document.getElementById(`producto-${productoId}`);
    if (elemento) {
        elemento.remove();
    }
    
    // Mostrar mensaje si no hay productos
    if (window.productosCompra.length === 0) {
        mostrarMensajeVacioCompraSimple();
    }
    
    // Recalcular totales
    calcularTotalesCompraSimple();
    
    console.log('✅ Producto eliminado. Array actual:', window.productosCompra);
};

// =============================================
// FUNCIÓN DE VALIDACIÓN PARA guardarCompraSimple()
// =============================================

window.validarProductosCompra = function() {
    console.log('🔍 Validando productos para guardar compra...', window.productosCompra);
    
    if (!window.productosCompra || window.productosCompra.length === 0) {
        if (typeof showAlert === 'function') {
            showAlert('Debe agregar al menos un producto', 'warning');
        } else {
            alert('Debe agregar al menos un producto');
        }
        return false;
    }
    
    // Validar cada producto
    let errores = 0;
    window.productosCompra.forEach((producto, index) => {
        const erroresProducto = [];
        
        if (!producto.mercaderia_id) {
            erroresProducto.push('Mercadería no seleccionada');
        }
        if (producto.cantidad <= 0) {
            erroresProducto.push('Cantidad debe ser mayor a 0');
        }
        if (producto.precio <= 0) {
            erroresProducto.push('Precio debe ser mayor a 0');
        }
        
        if (erroresProducto.length > 0) {
            errores++;
            console.warn(`⚠️ Producto ${producto.id} tiene errores:`, erroresProducto);
        }
    });
    
    if (errores > 0) {
        if (typeof showAlert === 'function') {
            showAlert(`Se encontraron ${errores} productos con errores. Complete todos los campos requeridos.`, 'warning');
        } else {
            alert(`Se encontraron ${errores} productos con errores. Complete todos los campos requeridos.`);
        }
        return false;
    }
    
    console.log('✅ Validación exitosa. Productos listos para guardar:', window.productosCompra.length);
    return window.productosCompra; // Retorna el array válido
};

// =============================================
// FUNCIONES AUXILIARES
// =============================================

window.ocultarMensajeVacioCompraSimple = function() {
    const mensaje = document.getElementById('mensaje-vacio');
    if (mensaje) {
        mensaje.style.display = 'none';
    }
};

window.mostrarMensajeVacioCompraSimple = function() {
    const container = document.getElementById('productos-container');
    if (container) {
        container.innerHTML = `
            <div class="text-center text-muted py-4" id="mensaje-vacio">
                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                <p>No hay productos agregados. Haz clic en "Agregar Producto" para comenzar.</p>
            </div>
        `;
    }
};

// Función para calcular totales generales (debe existir en tu código)
if (typeof window.calcularTotalesCompraSimple === 'undefined') {
    window.calcularTotalesCompraSimple = function() {
        if (!window.productosCompra || window.productosCompra.length === 0) return;
        
        let subtotalGeneral = 0;
        let ivaGeneral = 0;
        let totalGeneral = 0;
        
        window.productosCompra.forEach(producto => {
            subtotalGeneral += producto.subtotal || 0;
            ivaGeneral += producto.iva_monto || 0;
            totalGeneral += producto.total || 0;
        });
        
        // Actualizar campos de totales si existen
        const subtotalField = document.getElementById('compra-subtotal-general');
        const ivaField = document.getElementById('compra-iva-general');
        const totalField = document.getElementById('compra-total-general');
        
        if (subtotalField) subtotalField.textContent = '$' + subtotalGeneral.toFixed(2);
        if (ivaField) ivaField.textContent = '$' + ivaGeneral.toFixed(2);
        if (totalField) totalField.textContent = '$' + totalGeneral.toFixed(2);
        
        console.log('💰 Totales generales:', {
            subtotal: subtotalGeneral,
            iva: ivaGeneral,
            total: totalGeneral
        });
    };
}

console.log('✅ Función agregarProductoCompra con autocomplete cargada correctamente');
console.log('🔧 Variables globales inicializadas:', {
    productosCompra: window.productosCompra?.length || 0,
    contadorProductos: window.contadorProductos || 0,
    autocompletesProductos: Object.keys(window.autocompletesProductos || {}).length
});

function toggleCamposOpcionales(productoId) {
    const camposOpcionales = document.getElementById(`campos-opcionales-${productoId}`);
    const toggleLink = document.getElementById(`toggle-opcionales-${productoId}`);
    
    if (camposOpcionales && toggleLink) {
        if (camposOpcionales.classList.contains('d-none')) {
            // Mostrar campos
            camposOpcionales.classList.remove('d-none');
            toggleLink.innerHTML = '<i class="fas fa-minus-circle"></i> Ocultar campos opcionales';
        } else {
            // Ocultar campos
            camposOpcionales.classList.add('d-none');
            toggleLink.innerHTML = '<i class="fas fa-plus-circle"></i> Agregar lote/vencimiento';
        }
    }
}

function filtrarProductosCompra() {
            const termino = document.getElementById('buscar-producto-compra').value.toLowerCase();
            const productos = document.querySelectorAll('.producto-compra-item');
            
            productos.forEach(elemento => {
                const visible = elemento.textContent.toLowerCase().includes(termino);
                elemento.style.display = visible ? 'block' : 'none';
            });
        }

        function limpiarBusquedaProductos() {
            document.getElementById('buscar-producto-compra').value = '';
            filtrarProductosCompra();
        }



function validarPorcentajeIva(input) {
    const valor = parseFloat(input.value);
    const container = input.closest('.producto-compra');
    
    // Limpiar clases anteriores
    input.classList.remove('is-valid', 'is-invalid');
    
    // Validar rango
    if (isNaN(valor) || valor < 0 || valor > 100) {
        input.classList.add('is-invalid');
        mostrarNotificacionTemporal(container, '⚠️ El IVA debe estar entre 0% y 100%', 'warning', 2000);
        return false;
    }
    
    // Sugerencias para valores comunes
    if (valor === 0) {
        mostrarNotificacionTemporal(container, '✅ Producto exento de IVA', 'success', 1500);
    } else if (valor === 10.5) {
        mostrarNotificacionTemporal(container, '✅ IVA reducido (alimentos, medicamentos)', 'info', 2000);
    } else if (valor === 21) {
        mostrarNotificacionTemporal(container, '✅ IVA general (más común)', 'info', 1500);
    } else if (valor === 27) {
        mostrarNotificacionTemporal(container, '✅ IVA adicional (productos suntuarios)', 'info', 2000);
    } else if (valor > 0 && valor < 10.5) {
        mostrarNotificacionTemporal(container, '💡 Valor poco común, verifique si es correcto', 'warning', 2000);
    } else if (valor > 27) {
        mostrarNotificacionTemporal(container, '⚠️ IVA superior al máximo común (27%)', 'warning', 2500);
    }
    
    input.classList.add('is-valid');
    return true;
}

function mostrarNotificacionTemporal(container, mensaje, tipo = 'info', duracion = 2000) {
    // Remover notificaciones anteriores
    const notificacionExistente = container.querySelector('.alert');
    if (notificacionExistente) {
        notificacionExistente.remove();
    }
    
    // Crear nueva notificación
    const notificacion = document.createElement('div');
    notificacion.className = `alert alert-${tipo} alert-dismissible fade show mt-2`;
    notificacion.style.fontSize = '0.85rem';
    notificacion.innerHTML = `<small>${mensaje}</small>`;
    
    container.appendChild(notificacion);
    
    // Auto-remover
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.remove();
        }
    }, duracion);
}

function configurarValidacionFechas() {
    const fechaRecepcion = document.getElementById('compra-fecha');
    const fechaVencimiento = document.getElementById('compra-fecha-vencimiento');
    
    fechaRecepcion.addEventListener('change', function() {
        if (this.value) {
            // Establecer fecha mínima de vencimiento como el día siguiente
            const fechaMinima = new Date(this.value);
            fechaMinima.setDate(fechaMinima.getDate() + 1);
            
            fechaVencimiento.min = fechaMinima.toISOString().split('T')[0];
            
            // Validar fecha existente
            if (fechaVencimiento.value && fechaVencimiento.value < this.value) {
                fechaVencimiento.value = '';
                showAlert('La fecha de vencimiento debe ser igual o posterior a la fecha de recepción', 'info');
            }
        }
    });
}

function mostrarResumenCompra(datosCompra, compraId) {
    const totalItems = datosCompra.items.length;
    const totalImporte = datosCompra.items.reduce((sum, item) => 
        sum + (item.cantidad_recibida * item.precio_con_iva), 0
    );
    
    const mensaje = `
        <strong>📋 Compra registrada exitosamente</strong><br>
        • ID: #${compraId || 'N/A'}<br>
        • ${totalItems} productos<br>
        • Total: $${totalImporte.toLocaleString('es-AR', {minimumFractionDigits: 2})}<br>
        ${datosCompra.fecha_vencimiento_documento ? 
            `• Vencimiento: ${new Date(datosCompra.fecha_vencimiento_documento).toLocaleDateString('es-AR')}` : ''}
    `;
    
    showAlert(mensaje, 'success', 5000);
}

function calcularSubtotalProducto(productoId) {
    try {
        const productoRow = document.getElementById(`producto-${productoId}`);
        if (!productoRow) return;
        
        // Obtener valores
        const cantidadInput = productoRow.querySelector('.cantidad-input');
        const precioInput = productoRow.querySelector('.precio-input');
        const ivaSelect = productoRow.querySelector('.iva-select');
        
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precioUnitario = parseFloat(precioInput.value) || 0;
        const porcentajeIva = parseFloat(ivaSelect.value) || 0;
        
        // Calcular valores
        const subtotalSinIva = cantidad * precioUnitario;
        const ivaUnitario = precioUnitario * (porcentajeIva / 100);
        const ivaMonto = cantidad * ivaUnitario;
        const totalConIva = subtotalSinIva + ivaMonto;
        
        // Actualizar displays
        const subtotalDisplay = document.getElementById(`subtotal-sin-iva-${productoId}`);
        const ivaDisplay = document.getElementById(`iva-monto-${productoId}`);
        const totalDisplay = document.getElementById(`total-con-iva-${productoId}`);
        
        if (subtotalDisplay) subtotalDisplay.textContent = `$${subtotalSinIva.toFixed(2)}`;
        if (ivaDisplay) ivaDisplay.textContent = `$${ivaMonto.toFixed(2)}`;
        if (totalDisplay) totalDisplay.textContent = `$${totalConIva.toFixed(2)}`;
        
        // Trigger función de totales generales si existe
        if (typeof calcularTotalesCompraDirecta === 'function') {
            calcularTotalesCompraDirecta();
        }
        
    } catch (error) {
        console.error('Error calculando subtotal:', error);
    }
}


// =============================================
// ✅ FUNCIÓN PARA VALIDAR PRODUCTOS ANTES DE ENVIAR
// =============================================

function validarProductosCompra() {
    const productos = [];
    const productosItems = document.querySelectorAll('.producto-item');
    
    if (productosItems.length === 0) {
        showAlert('Debe agregar al menos un producto', 'warning');
        return false;
    }
    
    for (let i = 0; i < productosItems.length; i++) {
        const row = productosItems[i];
        const productNumber = i + 1;
        
        // Obtener mercadería del autocomplete
        const autocompleteId = row.id.replace('producto-', '');
        const autocomplete = window.autocompletesProductos?.[autocompleteId];
        const mercaderia = autocomplete?.getSelected();
        
        const cantidad = parseFloat(row.querySelector('.cantidad-input').value) || 0;
        const precio = parseFloat(row.querySelector('.precio-input').value) || 0;
        const ivaPorc = parseFloat(row.querySelector('.iva-select').value) || 0;
        
        // Validaciones
        if (!mercaderia) {
            showAlert(`Debe seleccionar una mercadería en el producto ${productNumber}`, 'warning');
            return false;
        }
        
        if (cantidad <= 0) {
            showAlert(`La cantidad del producto ${productNumber} debe ser mayor a 0`, 'warning');
            return false;
        }
        
        if (precio < 0) {
            showAlert(`El precio del producto ${productNumber} no puede ser negativo`, 'warning');
            return false;
        }
        
        // Validar IVA
        if (ivaPorc < 0 || ivaPorc > 100) {
            showAlert(`El IVA del producto ${productNumber} debe estar entre 0% y 100%`, 'warning');
            return false;
        }
        
        // Obtener campos opcionales
        const lote = row.querySelector('.lote-input')?.value || null;
        const vencimiento = row.querySelector('.vencimiento-input')?.value || null;
        const observaciones = row.querySelector('.observaciones-input')?.value || null;
        
        // Agregar producto validado
        productos.push({
            mercaderia_id: parseInt(mercaderia.id),
            cantidad_recibida: cantidad,
            precio_unitario: precio,
            porcentaje_iva: ivaPorc,
            iva_unitario: precio * (ivaPorc / 100),
            precio_con_iva: precio + (precio * (ivaPorc / 100)),
            numero_lote: lote,
            fecha_vencimiento: vencimiento,
            observaciones: observaciones
        });
    }
    
    return productos;
}



function calcularTotalesCompraDirecta() {
    console.log('🧮 Iniciando cálculo de totales de compra directa');
    
    let subtotalGeneral = 0;
    let ivaTotal = 0;
    let productosEncontrados = 0;
    
    // 🔍 Buscar todos los productos de compra
    const productos = document.querySelectorAll('.producto-item');
    console.log(`📦 Productos encontrados: ${productos.length}`);
    
    productos.forEach((item, index) => {
        try {
            // ✅ CORREGIDO: Buscar .iva-select en lugar de .iva-input
            const cantidadInput = item.querySelector('.cantidad-input');
            const precioInput = item.querySelector('.precio-input');
            const ivaSelect = item.querySelector('.iva-select'); // 🔧 CORREGIDO
            
            // Verificar si existen los elementos
            if (!cantidadInput || !precioInput || !ivaSelect) {
                console.warn(`⚠️ Producto ${index + 1}: Elementos faltantes`, {
                    cantidad: !!cantidadInput,
                    precio: !!precioInput,
                    iva: !!ivaSelect
                });
                return; // Saltar este producto
            }
            
            const cantidad = parseFloat(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const ivaPorc = parseFloat(ivaSelect.value) || 0; // 🔧 CORREGIDO
            
            console.log(`📊 Producto ${index + 1}:`, { cantidad, precio, ivaPorc });
            
            const subtotalSinIva = cantidad * precio;
            const ivaProducto = subtotalSinIva * (ivaPorc / 100);
            
            subtotalGeneral += subtotalSinIva;
            ivaTotal += ivaProducto;
            productosEncontrados++;
            
        } catch (error) {
            console.error(`❌ Error procesando producto ${index + 1}:`, error);
        }
    });
    
    const totalGeneral = subtotalGeneral + ivaTotal;
    
    console.log('📈 Totales calculados:', {
        productos: productosEncontrados,
        subtotal: subtotalGeneral,
        iva: ivaTotal,
        total: totalGeneral
    });
    
    // 🎯 ACTUALIZAR DISPLAYS DE TOTALES (con verificación de existencia)
    
    // Opción 1: Si tienes estos IDs específicos
    const subtotalElement = document.getElementById('compra-subtotal');
    const ivaElement = document.getElementById('compra-iva-total');
    const totalElement = document.getElementById('compra-total');
    
    if (subtotalElement) {
        subtotalElement.textContent = `$${subtotalGeneral.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
        console.log('✅ Subtotal actualizado');
    } else {
        console.warn('⚠️ Elemento #compra-subtotal no encontrado');
    }
    
    if (ivaElement) {
        ivaElement.textContent = `$${ivaTotal.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
        console.log('✅ IVA total actualizado');
    } else {
        console.warn('⚠️ Elemento #compra-iva-total no encontrado');
    }
    
    if (totalElement) {
        totalElement.textContent = `$${totalGeneral.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
        console.log('✅ Total general actualizado');
    } else {
        console.warn('⚠️ Elemento #compra-total no encontrado');
    }
    
    // 🔄 Opción 2: Búsqueda alternativa por clases (si los IDs no existen)
    if (!subtotalElement || !ivaElement || !totalElement) {
        console.log('🔍 Buscando elementos alternativos por clase...');
        
        const subtotalDisplay = document.querySelector('.compra-subtotal, [data-tipo="subtotal"]');
        const ivaDisplay = document.querySelector('.compra-iva-total, [data-tipo="iva"]');
        const totalDisplay = document.querySelector('.compra-total, [data-tipo="total"]');
        
        if (subtotalDisplay) subtotalDisplay.textContent = `$${subtotalGeneral.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
        if (ivaDisplay) ivaDisplay.textContent = `$${ivaTotal.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
        if (totalDisplay) totalDisplay.textContent = `$${totalGeneral.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
    }
    
    // 🔄 Opción 3: Si usas el mismo patrón que otras funciones
    const subtotalGeneralEl = document.getElementById('subtotal-display');
    const ivaGeneralEl = document.getElementById('iva-display');
    const totalGeneralEl = document.getElementById('total-display');
    
    if (subtotalGeneralEl) {
        subtotalGeneralEl.textContent = `$${subtotalGeneral.toFixed(2)}`;
        console.log('✅ Subtotal alternativo actualizado');
    }
    
    if (ivaGeneralEl) {
        ivaGeneralEl.textContent = `$${ivaTotal.toFixed(2)}`;
        console.log('✅ IVA alternativo actualizado');
    }
    
    if (totalGeneralEl) {
        totalGeneralEl.textContent = `$${totalGeneral.toFixed(2)}`;
        console.log('✅ Total alternativo actualizado');
    }
    
    console.log('🎉 Cálculo de totales completado');
}

function establecerIva(boton, porcentaje) {
    const container = boton.closest('.producto-compra');
    const ivaInput = container.querySelector('.iva-input');
    
    ivaInput.value = porcentaje;
    calcularSubtotalProducto(ivaInput);
    
    // Feedback visual
    boton.classList.add('btn-success');
    setTimeout(() => {
        boton.classList.remove('btn-success');
    }, 500);
    calcularTotalesCompraDirecta();
}

async function cargarMercaderiasEnSelector(selectElement, proveedorId) {
    try {
        const response = await apiRequest(`/proveedores/${proveedorId}/mercaderias`);
        
        if (response.success) {
            selectElement.innerHTML = '<option value="">Seleccionar mercadería...</option>';
            
            response.data.forEach(mercaderia => {
                const option = document.createElement('option');
                option.value = mercaderia.mercaderia_id;
                option.textContent = `${mercaderia.codigo_sku} - ${mercaderia.descripcion}`;
                option.setAttribute('data-precio-proveedor', mercaderia.precio_compra || 0);
                option.setAttribute('data-codigo-proveedor', mercaderia.codigo_producto_proveedor || '');
                option.setAttribute('data-tiempo-entrega', mercaderia.tiempo_entrega_dias || 7);
                option.setAttribute('data-cantidad-minima', mercaderia.cantidad_minima_pedido || 1);
                selectElement.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error cargando mercaderías en selector:', error);
    }
}

function seleccionarProductoCompra(select) {
    const option = select.selectedOptions[0];
    if (!option.value) return;

    const container = select.closest('.producto-compra');
    const precioSugerido = parseFloat(option.getAttribute('data-precio')) || 0;
    
    // Mostrar precio anterior
    const precioAnterior = container.querySelector('.precio-anterior');
    precioAnterior.textContent = precioSugerido > 0 ? `$${precioSugerido.toLocaleString()}` : 'Sin precio';
    
    // Autocompletar precio si está vacío
    const precioInput = container.querySelector('.precio-input');
    if (!precioInput.value && precioSugerido > 0) {
        precioInput.value = precioSugerido;
        calcularSubtotalCompra(precioInput);
    }
}

function calcularSubtotalCompra(id) {
            const producto = productosCompraData.find(p => p.id === id);
            if (producto) {
                producto.subtotal = producto.cantidad * producto.precio;
                
                // Actualizar display
                const elemento = document.getElementById(`producto-compra-${id}`);
                const subtotalDisplay = elemento?.querySelector('.subtotal-display');
                if (subtotalDisplay) {
                    subtotalDisplay.value = `$${producto.subtotal.toLocaleString()}`;
                }
                
            }
        }







// =============================================
// 💾 GUARDAR COMPRA DIRECTA
// =============================================

async function guardarCompraDirecta() {
    try {
        // Validaciones básicas
        const proveedor = document.getElementById('compra-proveedor').value;
        const fecha = document.getElementById('compra-fecha').value;
        const fechaVencimiento = document.getElementById('compra-fecha-vencimiento').value; // 🆕 NUEVO
        const productos = document.querySelectorAll('.producto-compra');

        if (!proveedor) {
            showAlert('Debe seleccionar un proveedor', 'warning');
            return;
        }

        if (!fecha) {
            showAlert('Debe ingresar la fecha de recepción', 'warning');
            return;
        }

        if (productos.length === 0) {
            showAlert('Debe agregar al menos un producto', 'warning');
            return;
        }

        // Preparar items con IVA
        const items = [];
        let hasErrors = false;

        productos.forEach((producto, index) => {
            const mercaderia_id = producto.querySelector('.producto-select').value;
            const cantidad = parseFloat(producto.querySelector('.cantidad-input').value);
            const precio = parseFloat(producto.querySelector('.precio-input').value);
            const ivaPorc = parseFloat(producto.querySelector('.iva-input').value) || 0; // 🆕 IVA por defecto 0

            if (!mercaderia_id || !cantidad || precio < 0) {
                hasErrors = true;
                showAlert(`Error en producto ${index + 1}: Complete todos los campos requeridos`, 'warning');
                return;
            }

            // Validar IVA
            if (ivaPorc < 0 || ivaPorc > 100) {
                hasErrors = true;
                showAlert(`Error en producto ${index + 1}: IVA debe estar entre 0% y 100%`, 'warning');
                return;
            }

            items.push({
                mercaderia_id: parseInt(mercaderia_id),
                cantidad_recibida: cantidad,
                precio_unitario: precio,
                porcentaje_iva: ivaPorc, // 🆕 NUEVO CAMPO
                iva_unitario: precio * (ivaPorc / 100), // 🆕 CALCULADO
                precio_con_iva: precio + (precio * (ivaPorc / 100)), // 🆕 CALCULADO
                numero_lote: producto.querySelector('.lote-input').value || null,
                fecha_vencimiento: producto.querySelector('.vencimiento-input').value || null,
                deposito_id: parseInt(producto.querySelector('.deposito-select').value) || null,
                observaciones: null
            });
        });

        if (hasErrors) {
            return;
        }

        // Preparar datos de compra - MANTENER TU ESTRUCTURA ACTUAL
        const datosCompra = {
            proveedor_id: parseInt(proveedor),
            fecha_recepcion: fecha,
            fecha_vencimiento_documento: fechaVencimiento || null, // 🆕 NUEVO CAMPO
            numero_remito: document.getElementById('compra-remito').value || null,
            numero_factura: document.getElementById('compra-factura').value || null,
            observaciones: document.getElementById('compra-observaciones').value || null,
            items: items
        };

        console.log('🛒 Enviando compra con IVA y fecha vencimiento:', datosCompra);

        // 🆕 USAR TU ENDPOINT EXISTENTE
        const response = await apiRequest('/compras/recepciones', 'POST', datosCompra);
        
        if (response.success) {
            showAlert('Compra registrada exitosamente con IVA detallado', 'success');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCompraDirecta'));
            modal.hide();
            
            // Refrescar datos si es necesario
            if (typeof refrescarStock === 'function') {
                refrescarStock();
            }
            
            // Mostrar resumen
            mostrarResumenCompra(datosCompra, response.data?.id);
            
        } else {
            throw new Error(response.message || 'Error al registrar la compra');
        }
        
    } catch (error) {
        console.error('Error guardando compra directa:', error);
        showAlert('Error al registrar la compra: ' + error.message, 'danger');
    }
}

function generarLoteAutomatico() {
    const fecha = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `AUTO-${fecha}-${random}`;
}

// =============================================
// 🔄 CARGAR COMPRAS RECIENTES
// =============================================

async function cargarComprasRecientes() {
    try {
        const response = await apiRequest('/compras/recepciones?limit=10');
        if (response.success) {
            comprasData.comprasRecientes = response.data || [];
            mostrarComprasRecientes();
        }
    } catch (error) {
        console.error('Error cargando compras recientes:', error);
    }
}

function mostrarComprasRecientes() {
    const container = document.getElementById('compras-recientes-list');
    if (!container) return;

    if (comprasData.comprasRecientes.length === 0) {
        container.innerHTML = '<p class="text-muted">No hay compras recientes</p>';
        return;
    }

    container.innerHTML = comprasData.comprasRecientes.map(compra => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${compra.proveedor_nombre || 'Proveedor desconocido'}</h6>
                    <p class="mb-1 text-muted">
                        ${new Date(compra.fecha_recepcion).toLocaleDateString('es-AR')}
                        ${compra.numero_factura ? `- Fact: ${compra.numero_factura}` : ''}
                    </p>
                </div>
                <span class="badge bg-success">${compra.total_items || 0} items</span>
            </div>
        </div>
    `).join('');
}

// =============================================
// 🚀 INICIALIZACIÓN
// =============================================

// Cargar datos cuando se accede al módulo de compras
document.addEventListener('DOMContentLoaded', function() {
    // Si hay un botón de compras, cargar datos cuando se haga clic
    const btnCompras = document.querySelector('[data-bs-target="#compras"], [onclick*="loadCompras"]');
    if (btnCompras) {
        btnCompras.addEventListener('click', cargarDatosCompras);
    }
    setTimeout(() => {
        configurarEventosCalculoCompra();
        calcularTotalesCompraDirecta(); // Calcular totales iniciales
        console.log('✅ Eventos de cálculo configurados automáticamente');
    }, 500);
});

console.log('✅ Módulo de Compras Directas cargado correctamente');

// Llama esta función cada vez que agregues un nuevo producto:
function actualizarEventosNuevoProducto() {
    configurarEventosCalculoCompra();
    calcularTotalesCompraDirecta();
}

// Hacer disponible globalmente
window.actualizarEventosNuevoProducto = actualizarEventosNuevoProducto;

// =============================================
// 📊 CARGAR Y MOSTRAR PROVEEDORES
// =============================================
async function loadProveedores() {
    try {
        const response = await apiRequest('/proveedores');
        if (response.success && response.data) {
            proveedores = response.data;
            console.log('🔄 Antes de renderizar tabla, proveedores:', proveedores.length);
            renderTablaProveedores();
            console.log('✅ renderTablaProveedores() ejecutada');
            actualizarEstadisticasProveedores();
            console.log('✅ Proveedores cargados desde API:', proveedores.length);
        }
    } catch (error) {
        console.error('❌ Error cargando proveedores desde API:', error);
        loadProveedoresDemo();
    }
}

function loadProveedoresDemo() {
    proveedores = [
        {
            proveedorId: 1,
            razonSocial: 'Proveedor Demo S.A.',
            cuit: '30-12345678-9',
            telefono: '11-4567-8901',
            email: 'contacto@demo.com',
            domicilio: 'Av. Ejemplo 123, CABA',
            activo: 1,
            fecha_creacion: '2024-01-15T10:30:00Z'
        },
        {
            proveedorId: 2,
            razonSocial: 'Distribuidora Norte',
            cuit: '30-98765432-1',
            telefono: '11-9876-5432',
            email: 'ventas@norte.com',
            domicilio: 'Calle Norte 456, Buenos Aires',
            activo: 1,
            fecha_creacion: '2024-02-20T14:15:00Z'
        },
        {
            proveedorId: 3,
            razonSocial: 'Materiales del Sur',
            cuit: '30-11223344-5',
            telefono: '11-2233-4455',
            email: 'info@materialesur.com',
            domicilio: 'Ruta 2 Km 45, Berazategui',
            activo: 0,
            fecha_creacion: '2024-01-10T09:20:00Z'
        }
    ];
    renderTablaProveedores();
    actualizarEstadisticasProveedores();
}


// =============================================
// FUNCIÓN PARA RENDERIZAR TABLA
// =============================================
function renderTablaProveedores() {
    const tbody = document.getElementById('tabla-proveedores');
    
    if (!tbody) {
        console.error('No se encontró el elemento tabla-proveedores');
        return;
    }
    
    if (!proveedores || proveedores.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-truck fa-2x mb-2"></i><br>
                    No se encontraron proveedores
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = proveedores.map(proveedor => {
        const activo = proveedor.activo !== undefined ? proveedor.activo : 1;
        const fechaCreacion = proveedor.fecha_creacion ? 
            new Date(proveedor.fecha_creacion).toLocaleDateString('es-AR') : 'N/A';
        
        return `
            <tr ${!activo ? 'class="table-secondary opacity-75"' : ''}>
                <td>
                    <div class="d-flex flex-column">
                        <span class="fw-medium">${proveedor.razonSocial || 'Sin nombre'}</span>
                        ${proveedor.domicilio ? 
                            `<small class="text-muted">${proveedor.domicilio}</small>` : ''
                        }
                    </div>
                </td>
                <td>
                    <span class="text-primary fw-medium">${proveedor.cuit || 'N/A'}</span>
                </td>
                <td>
                    <div class="d-flex flex-column small">
                        ${proveedor.email ? 
                            `<a href="mailto:${proveedor.email}" class="text-decoration-none text-truncate" style="max-width: 150px;">${proveedor.email}</a>` : 
                            '<span class="text-muted">Sin email</span>'
                        }
                        ${proveedor.telefono ? 
                            `<a href="tel:${proveedor.telefono}" class="text-decoration-none">${proveedor.telefono}</a>` : 
                            '<span class="text-muted">Sin teléfono</span>'
                        }
                    </div>
                </td>
                <td>
                    <span class="small">${fechaCreacion}</span>
                </td>
                <td class="text-center">
                    <span class="badge ${activo ? 'bg-success' : 'bg-secondary'}">
                        <i class="fas ${activo ? 'fa-check' : 'fa-times'} me-1"></i>
                        ${activo ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" onclick="verProveedor(${proveedor.proveedorId})" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editarProveedor(${proveedor.proveedorId})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-${activo ? 'warning' : 'success'}" 
                                onclick="toggleProveedorActivo(${proveedor.proveedorId}, ${activo})" 
                                title="${activo ? 'Desactivar' : 'Activar'}">
                            <i class="fas fa-${activo ? 'times' : 'check'}"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="eliminarProveedor(${proveedor.proveedorId})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// =============================================
// FUNCIÓN PARA ACTUALIZAR ESTADÍSTICAS
// =============================================
function actualizarEstadisticasProveedores() {
    const total = proveedores.length;
    const activos = proveedores.filter(p => p.activo === 1 || p.activo === true).length;
    const inactivos = total - activos;
    
    // Actualizar elementos del DOM
    const elementTotal = document.getElementById('stat-proveedores-total');
    const elementActivos = document.getElementById('stat-proveedores-activos');
    const elementInactivos = document.getElementById('stat-proveedores-inactivos');
    
    if (elementTotal) elementTotal.textContent = total;
    if (elementActivos) elementActivos.textContent = activos;
    if (elementInactivos) elementInactivos.textContent = inactivos;
}

// =============================================
// FUNCIONES DE FILTROS
// =============================================
async function aplicarFiltrosProveedores() {
    try {
        const busqueda = document.getElementById('filtro-proveedores-busqueda').value.trim();
        const estado = document.getElementById('filtro-proveedores-estado').value;
        
        // Crear parámetros para la API
        const params = new URLSearchParams();
        if (busqueda) params.append('search', busqueda);
        if (estado) params.append('activo', estado);
        
        const url = `/proveedores${params.toString() ? '?' + params.toString() : ''}`;
        const response = await apiRequest(url);
        
        if (response.success) {
            proveedores = response.data;
            renderTablaProveedores();
            actualizarEstadisticasProveedores();
            
            const totalResults = proveedores.length;
            actualizarInfoFiltrosProveedores(busqueda, estado);
            
            showAlert(`Se encontraron ${totalResults} proveedor(es)`, 'info');
        } else {
            showAlert('Error al aplicar filtros', 'danger');
        }
        
    } catch (error) {
        console.error('Error aplicando filtros de proveedores:', error);
        showAlert('Error al aplicar filtros', 'danger');
    }
}

// Función para limpiar filtros de proveedores
function limpiarFiltrosProveedores() {
    document.getElementById('filtro-proveedores-busqueda').value = '';
    document.getElementById('filtro-proveedores-estado').value = '';
    
    // Recargar todos los proveedores
    loadProveedores();
    
    showAlert('Filtros limpiados', 'info');
}

// Función para actualizar información de filtros
function actualizarInfoFiltrosProveedores(busqueda, estado) {
    const filtrosAplicados = [];
    if (busqueda) filtrosAplicados.push(`Búsqueda: "${busqueda}"`);
    if (estado === '1') filtrosAplicados.push('Estado: Activos');
    if (estado === '0') filtrosAplicados.push('Estado: Inactivos');
    
    const infoElement = document.getElementById('info-filtros-proveedores');
    if (infoElement) {
        if (filtrosAplicados.length > 0) {
            infoElement.textContent = `Filtros aplicados: ${filtrosAplicados.join(' | ')}`;
        } else {
            infoElement.textContent = 'Mostrando todos los proveedores';
        }
    }
}

console.log('✅ Módulo de Gestión de Proveedores cargado');


function verDetalleProveedor(id) {
    const proveedor = proveedores.find(p => (p.proveedorId || p.id) == id);
    
    if (!proveedor) {
        if (typeof showAlert === 'function') {
            showAlert('Proveedor no encontrado', 'warning');
        }
        return;
    }
    
    // TODO: Implementar modal de detalle
    if (typeof showAlert === 'function') {
        showAlert(`Detalles de ${proveedor.razonSocial} - Funcionalidad próximamente`, 'info');
    }
}

// Modal para crear/editar proveedor
function modalProveedor(id = null) {
    const modal = new bootstrap.Modal(document.getElementById('modalProveedor'));
    const titulo = document.getElementById('modalProveedorTitulo');
    const form = document.getElementById('formProveedor');
    
    // Limpiar formulario
    form.reset();
    document.getElementById('proveedorId').value = '';
    document.getElementById('proveedorActivo').checked = true;
    
    if (id) {
        titulo.textContent = 'Editar Proveedor';
        cargarDatosProveedor(id);
    } else {
        titulo.textContent = 'Nuevo Proveedor';
    }
    
    modal.show();
}

// Cargar datos del proveedor para edición
async function cargarDatosProveedor(id) {
    try {
        const response = await fetch(`/api/v1/proveedores/${id}`);
        const data = await response.json();
        
        if (data.success) {
            const proveedor = data.data;
            document.getElementById('proveedorId').value = proveedor.proveedorId;
            document.getElementById('proveedorRazonSocial').value = proveedor.razonSocial;
            document.getElementById('proveedorCuit').value = proveedor.cuit || '';
            document.getElementById('proveedorTelefono').value = proveedor.telefono || '';
            document.getElementById('proveedorEmail').value = proveedor.email || '';
            document.getElementById('proveedorDomicilio').value = proveedor.domicilio || '';
            document.getElementById('proveedorActivo').checked = proveedor.activo;
        }
    } catch (error) {
        showError('Error cargando datos del proveedor');
    }
}

// Guardar proveedor
async function guardarProveedor() {
    const form = document.getElementById('formProveedor');
    
    try {
        // Validar formulario
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }
        
        // Determinar si estamos editando correctamente
        const proveedorId = document.getElementById('proveedor_id').value;
        const isEditing = proveedorId && proveedorId !== '';
        
        // Recopilar datos del formulario - INCLUYENDO TODOS LOS CAMPOS NUEVOS
        const formData = {
            razonSocial: document.getElementById('proveedor_razonSocial').value.trim(),
            cuit: document.getElementById('proveedor_cuit').value.trim() || null,
            telefono: document.getElementById('proveedor_telefono').value.trim() || null,
            email: document.getElementById('proveedor_email').value.trim() || null,
            domicilio: document.getElementById('proveedor_domicilio').value.trim() || null,
            // ✅ CAMPOS NUEVOS AGREGADOS:
            condicionIVA: document.getElementById('proveedor_condicionIVA').value.trim(),
            localidad: document.getElementById('proveedor_localidad').value.trim(),
            provincia: document.getElementById('proveedor_provincia').value.trim(),
            codigoPostal: document.getElementById('proveedor_codigoPostal').value.trim(),
            contacto: document.getElementById('proveedor_contacto').value.trim(),
            sitioWeb: document.getElementById('proveedor_sitioWeb').value.trim(),
            activo: document.getElementById('proveedor_activo').checked
        };
        
        // Validaciones adicionales personalizadas
        if (!formData.razonSocial) {
            showAlert('La razón social es requerida', 'warning');
            document.getElementById('proveedor_razonSocial').focus();
            return;
        }

        if (!formData.condicionIVA) {
            showAlert('La condición IVA es requerida', 'warning');
            document.getElementById('proveedor_condicionIVA').focus();
            return;
        }

        /*if (!formData.localidad) {
            showAlert('La localidad es requerida', 'warning');
            document.getElementById('proveedor_localidad').focus();
            return;
        }

        if (!formData.provincia) {
            showAlert('La provincia es requerida', 'warning');
            document.getElementById('proveedor_provincia').focus();
            return;
        }

        if (!formData.codigoPostal) {
            showAlert('El código postal es requerido', 'warning');
            document.getElementById('proveedor_codigoPostal').focus();
            return;
        }

        if (!formData.contacto) {
            showAlert('El contacto es requerido', 'warning');
            document.getElementById('proveedor_contacto').focus();
            return;
        }

        if (!formData.sitioWeb) {
            showAlert('El sitio web es requerido', 'warning');
            document.getElementById('proveedor_sitioWeb').focus();
            return;
        }

        // Validar formato de CUIT (opcional)
        if (formData.cuit && !/^\d{2}-\d{8}-\d{1}$/.test(formData.cuit)) {
            if (!/^\d{11}$/.test(formData.cuit.replace(/\D/g, ''))) {
                showAlert('El CUIT debe tener un formato válido (XX-XXXXXXXX-X)', 'warning');
                document.getElementById('proveedor_cuit').focus();
                return;
            }
        }*/

        // Validar email si se proporciona
        if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
            showAlert('El email debe tener un formato válido', 'warning');
            document.getElementById('proveedor_email').focus();
            return;
        }
/*
        // Validar sitio web
        if (formData.sitioWeb && !/^https?:\/\/.+\..+/.test(formData.sitioWeb)) {
            showAlert('El sitio web debe tener un formato válido (ej: https://www.ejemplo.com)', 'warning');
            document.getElementById('proveedor_sitioWeb').focus();
            return;
        }

        // Validar código postal (solo números)
        if (!/^\d+$/.test(formData.codigoPostal)) {
            showAlert('El código postal debe contener solo números', 'warning');
            document.getElementById('proveedor_codigoPostal').focus();
            return;
        }*/
        
        console.log('💾 Guardando proveedor:', { isEditing, formData });
        
        // Determinar endpoint y método
        const endpoint = isEditing ? 
            `/proveedores/${proveedorId}` : 
            '/proveedores';
        const method = isEditing ? 'PUT' : 'POST';
        
        // Enviar datos al servidor
        const response = await apiRequest(endpoint, method, formData);
        
        if (response.success) {
            showAlert(
                isEditing ? 'Proveedor actualizado exitosamente' : 'Proveedor creado exitosamente',
                'success'
            );
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalProveedor'));
            if (modal) modal.hide();
            
            // Recargar datos
            await cargarProveedores();
            
        } else {
            throw new Error(response.message || 'Error al guardar proveedor');
        }
        
    } catch (error) {
        console.error('❌ Error guardando proveedor:', error);
        showAlert('Error al guardar proveedor: ' + error.message, 'danger');
    }
}


async function toggleActivoProveedor(id, nuevoEstado) {
    try {
        const proveedor = proveedores.find(p => (p.proveedorId || p.id) == id);
        const nombre = proveedor ? proveedor.razonSocial : `ID ${id}`;
        const accion = nuevoEstado ? 'activar' : 'desactivar';
        
        if (!confirm(`¿Está seguro que desea ${accion} el proveedor "${nombre}"?`)) {
            return;
        }
        
        const response = await apiRequest(`/proveedores/${id}`, 'PUT', {
            activo: nuevoEstado
        });
        
        if (response.success) {
            if (typeof showAlert === 'function') {
                showAlert(`Proveedor ${nuevoEstado ? 'activado' : 'desactivado'} exitosamente`, 'success');
            }
            await cargarProveedores();
        } else {
            throw new Error(response.message || 'Error al cambiar estado');
        }
        
    } catch (error) {
        console.error('❌ Error cambiando estado:', error);
        if (typeof showAlert === 'function') {
            showAlert('Error al cambiar estado: ' + error.message, 'danger');
        }
    }
}



// Toggle activo/inactivo
async function toggleActivoProveedor(id, activo) {
    try {
        const response = await fetch(`/api/v1/proveedores/${id}/toggle-active`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ activo })
        });

        const result = await response.json();

        if (result.success) {
            showSuccess(result.message);
            cargarProveedores(currentPageProveedores);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        showError('Error cambiando estado: ' + error.message);
    }
}



// Ver estadísticas del proveedor
async function verEstadisticasProveedor(id) {
    try {
        const modal = new bootstrap.Modal(document.getElementById('modalEstadisticasProveedor'));
        const contenido = document.getElementById('contenidoEstadisticasProveedor');
        
        contenido.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
        modal.show();

        const response = await fetch(`/api/v1/proveedores/${id}/estadisticas`);
        const data = await response.json();

        if (data.success) {
            const stats = data.data.resumen;
            const productos = data.data.top_productos;

            contenido.innerHTML = `
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <h6>Resumen de Compras</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">${stats.total_compras}</h5>
                                        <p class="card-text">Total Compras</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">$${formatNumber(stats.monto_total_compras)}</h5>
                                        <p class="card-text">Monto Total</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">$${formatNumber(stats.promedio_compra)}</h5>
                                        <p class="card-text">Promedio por Compra</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">${formatFecha(stats.ultima_compra)}</h6>
                                        <p class="card-text">Última Compra</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12">
                        <h6>Top Productos Comprados</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>SKU</th>
                                        <th>Cantidad Total</th>
                                        <th>Monto Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${productos.map(p => `
                                        <tr>
                                            <td>${p.descripcion}</td>
                                            <td>${p.codigo_sku}</td>
                                            <td>${p.cantidad_total}</td>
                                            <td>$${formatNumber(p.monto_total)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        showError('Error cargando estadísticas: ' + error.message);
    }
}



function limpiarFormularioProveedor() {
    const form = document.getElementById('formProveedor');
    if (form) {
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById('proveedor_id').value = '';
        
        // Remover clases de validación
        const inputs = form.querySelectorAll('.is-invalid, .is-valid');
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        
        // Restablecer valores por defecto
        document.getElementById('proveedor_activo').checked = true;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Validación para email
    const emailField = document.getElementById('proveedor_email');
    if (emailField) {
        emailField.addEventListener('blur', function() {
            const emailValue = this.value.trim();
            if (emailValue && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
                showAlert('El email debe tener un formato válido', 'warning');
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    // Validación para sitio web
    const sitioWebField = document.getElementById('proveedor_sitioWeb');
    if (sitioWebField) {
        sitioWebField.addEventListener('blur', function() {
            const urlValue = this.value.trim();
            if (urlValue && !/^https?:\/\/.+\..+/.test(urlValue)) {
                showAlert('El sitio web debe tener un formato válido (ej: https://www.ejemplo.com)', 'warning');
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    // Validación para código postal
    const codigoPostalField = document.getElementById('proveedor_codigoPostal');
    if (codigoPostalField) {
        codigoPostalField.addEventListener('input', function() {
            // Solo permitir números
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }

    // Validación para campos requeridos
    const camposRequeridos = [
        'proveedor_razonSocial',
        'proveedor_condicionIVA',
        'proveedor_localidad',
        'proveedor_provincia',
        'proveedor_codigoPostal',
        'proveedor_contacto'
    ];

    camposRequeridos.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });

            field.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                }
            });
        }
    });
});


// =============================================
// 📊 FUNCIONES ADICIONALES
// =============================================

function verComprasProveedor(id) {
    const proveedor = proveedores.find(p => p.proveedorId === id);
    
    if (!proveedor) {
        showAlert('Proveedor no encontrado', 'warning');
        return;
    }
    
    // TODO: Implementar vista de compras del proveedor
    showAlert(`Ver compras de ${proveedor.razonSocial} - Funcionalidad próximamente`, 'info');
}

// Función para ver detalles del proveedor
async function verProveedor(id) {
    try {
        const response = await apiRequest(`/proveedores/${id}`);
        
        if (response.success) {
            const proveedor = response.data;
            // Mostrar modal o página con detalles del proveedor
            showAlert(`Proveedor: ${proveedor.razonSocial}`, 'info');
            // Aquí puedes implementar un modal con los detalles
        } else {
            showAlert('Error al cargar detalles del proveedor', 'danger');
        }
    } catch (error) {
        console.error('Error cargando detalles:', error);
        showAlert('Error al cargar detalles del proveedor', 'danger');
    }
}

// Función para editar proveedor
async function editarProveedor(id) {
    try {
        const response = await apiRequest(`/proveedores/${id}`);
        
        if (response.success && response.data) {
            const proveedor = response.data;
            
            // Configurar modal para edición
            document.getElementById('modalProveedorTitle').textContent = 'Editar Proveedor';
            
            // Llenar formulario con datos del proveedor - TODOS LOS CAMPOS
            document.getElementById('proveedor_id').value = id;
            document.getElementById('proveedor_razonSocial').value = proveedor.razonSocial || '';
            document.getElementById('proveedor_cuit').value = proveedor.cuit || '';
            document.getElementById('proveedor_email').value = proveedor.email || '';
            document.getElementById('proveedor_telefono').value = proveedor.telefono || '';
            document.getElementById('proveedor_domicilio').value = proveedor.domicilio || '';
            
            // ✅ NUEVOS CAMPOS:
            document.getElementById('proveedor_condicionIVA').value = proveedor.condicionIVA || '';
            document.getElementById('proveedor_localidad').value = proveedor.localidad || '';
            document.getElementById('proveedor_provincia').value = proveedor.provincia || '';
            document.getElementById('proveedor_codigoPostal').value = proveedor.codigoPostal || '';
            document.getElementById('proveedor_contacto').value = proveedor.contacto || '';
            document.getElementById('proveedor_sitioWeb').value = proveedor.sitioWeb || '';
            
            document.getElementById('proveedor_activo').checked = proveedor.activo || false;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalProveedor'));
            modal.show();
            
        } else {
            showAlert('Error al cargar los datos del proveedor', 'danger');
        }
    } catch (error) {
        console.error('Error editando proveedor:', error);
        showAlert('Error al cargar los datos del proveedor', 'danger');
    }
}

// Función para eliminar proveedor
async function eliminarProveedor(id) {
    if (!confirm('¿Estás seguro de que quieres eliminar este proveedor? Esta acción no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await apiRequest(`/proveedores/${id}`, 'DELETE');
        
        if (response.success) {
            showAlert('Proveedor eliminado exitosamente', 'success');
            loadProveedores();
        } else {
            showAlert(response.message || 'Error al eliminar proveedor', 'danger');
        }
    } catch (error) {
        console.error('Error eliminando proveedor:', error);
        showAlert('Error al eliminar proveedor', 'danger');
    }
}

// Función para toggle activo/inactivo
async function toggleProveedorActivo(id, estadoActual) {
    const nuevoEstado = !estadoActual;
    const accion = nuevoEstado ? 'activar' : 'desactivar';
    
    if (!confirm(`¿Estás seguro de que quieres ${accion} este proveedor?`)) {
        return;
    }
    
    try {
        const response = await apiRequest(`/proveedores/${id}`, 'PUT', { activo: nuevoEstado ? 1 : 0 });
        
        if (response.success) {
            showAlert(`Proveedor ${accion}do exitosamente`, 'success');
            loadProveedores();
        } else {
            showAlert(`Error al ${accion} proveedor`, 'danger');
        }
    } catch (error) {
        console.error(`Error al ${accion} proveedor:`, error);
        showAlert(`Error al ${accion} proveedor`, 'danger');
    }
}

// Función para abrir modal de nuevo proveedor
function abrirModalProveedor() {
    // Limpiar formulario
    const form = document.getElementById('formProveedor');
    form.reset();
    form.classList.remove('was-validated');
    
    // Limpiar campo oculto
    document.getElementById('proveedor_id').value = '';
    
    // Configurar modal para nuevo proveedor
    document.getElementById('modalProveedorTitle').textContent = 'Nuevo Proveedor';
    document.getElementById('proveedor_activo').checked = true; // Por defecto activo
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalProveedor'));
    modal.show();
    
    // Enfocar primer campo
    setTimeout(() => {
        document.getElementById('proveedor_razonSocial').focus();
    }, 300);
}

// Función para exportar proveedores
function exportarProveedores() {
    if (!proveedores || proveedores.length === 0) {
        showAlert('No hay proveedores para exportar', 'warning');
        return;
    }

    // Crear CSV
    const headers = ['ID', 'Razón Social', 'CUIT', 'Email', 'Teléfono', 'Domicilio', 'Estado', 'Fecha Creación'];
    const csvContent = [
        headers.join(','),
        ...proveedores.map(proveedor => [
            proveedor.proveedorId || '',
            `"${proveedor.razonSocial || ''}"`,
            proveedor.cuit || '',
            proveedor.email || '',
            proveedor.telefono || '',
            `"${proveedor.domicilio || ''}"`,
            proveedor.activo ? 'Activo' : 'Inactivo',
            proveedor.fecha_creacion ? new Date(proveedor.fecha_creacion).toLocaleDateString('es-AR') : ''
        ].join(','))
    ].join('\n');

    // Descargar archivo
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `proveedores_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();

    showAlert(`Exportados ${proveedores.length} proveedores`, 'success');
}

// Función para actualizar proveedores
function actualizarProveedores() {
    showAlert('Actualizando proveedores...', 'info');
    loadProveedores();
}

function actualizarProveedores() {
    cargarProveedores();
}

// =============================================
// 🚀 INICIALIZACIÓN
// =============================================

document.addEventListener('DOMContentLoaded', function() {
    // Aplicar filtros al presionar Enter en el campo de búsqueda
    document.getElementById('filtro-proveedores-busqueda')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            aplicarFiltrosProveedores();
        }
    });
    
    // Aplicar filtros automáticamente al cambiar select de estado
    document.getElementById('filtro-proveedores-estado')?.addEventListener('change', function() {
        setTimeout(aplicarFiltrosProveedores, 300);
    });
});

console.log('✅ Módulo de gestión de proveedores cargado correctamente');

// Event listener para el formulario
document.addEventListener('DOMContentLoaded', function() {
    // Event listener para el formulario
    const formProveedor = document.getElementById('formProveedor');
    if (formProveedor) {
        formProveedor.addEventListener('submit', function(e) {
            e.preventDefault();
            guardarProveedor();
        });
    }
    
    // Event listeners para filtros
    const filtros = [
        'filtro-proveedores-busqueda',
        'filtro-proveedores-estado'
    ];
    
    filtros.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            if (elemento.type === 'text') {
                // Debounce para búsqueda
                let timeoutId;
                elemento.addEventListener('input', function() {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(aplicarFiltrosProveedores, 500);
                });
            } else {
                elemento.addEventListener('change', aplicarFiltrosProveedores);
            }
        }
    });
    
    // Formatear CUIT automáticamente
    const cuitInput = document.getElementById('proveedor_cuit');
    if (cuitInput) {
        cuitInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '-' + value.substring(2);
            }
            if (value.length >= 11) {
                value = value.substring(0, 11) + '-' + value.substring(11, 12);
            }
            e.target.value = value;
        });
    }
    
    console.log('✅ Gestión de Proveedores inicializada correctamente');
});




// Debounce para búsqueda
let timeoutFiltro;
function debounceFilter() {
    clearTimeout(timeoutFiltro);
    timeoutFiltro = setTimeout(aplicarFiltrosProveedores, 500);
}

console.log('✅ Módulo de Gestión de Proveedores cargado correctamente');
// =============================================
// SOLUCIÓN RÁPIDA: FUNCIONES MÍNIMAS NECESARIAS
// AGREGAR ESTO INMEDIATAMENTE DESPUÉS DE <script> en index.html
// =============================================

// Función para formatear fechas
function formatFecha(fecha, incluirHora = false) {
    if (!fecha) return '-';
    
    try {
        const date = new Date(fecha);
        if (isNaN(date.getTime())) return '-';
        
        const dia = date.getDate().toString().padStart(2, '0');
        const mes = (date.getMonth() + 1).toString().padStart(2, '0');
        const año = date.getFullYear();
        
        if (incluirHora) {
            const hora = date.getHours().toString().padStart(2, '0');
            const minuto = date.getMinutes().toString().padStart(2, '0');
            return `${dia}/${mes}/${año} ${hora}:${minuto}`;
        }
        
        return `${dia}/${mes}/${año}`;
    } catch (error) {
        console.error('Error formateando fecha:', error);
        return '-';
    }
}

// Función para formatear números
function formatNumber(numero, decimales = 2) {
    if (numero === null || numero === undefined || numero === '') return '0';
    
    try {
        const num = parseFloat(numero);
        if (isNaN(num)) return '0';
        
        return num.toLocaleString('es-AR', {
            minimumFractionDigits: decimales,
            maximumFractionDigits: decimales
        });
    } catch (error) {
        return '0';
    }
}

// Función para formatear moneda
function formatCurrency(monto) {
    if (monto === null || monto === undefined || monto === '') return '$0,00';
    
    try {
        const num = parseFloat(monto);
        if (isNaN(num)) return '$0,00';
        
        return '$' + num.toLocaleString('es-AR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    } catch (error) {
        return '$0,00';
    }
}

// Función para formatear estado activo/inactivo
function formatActiveStatus(activo) {
    const isActive = activo === true || activo === 1 || activo === '1';
    return {
        class: isActive ? 'bg-success' : 'bg-danger',
        text: isActive ? 'Activo' : 'Inactivo',
        icon: isActive ? 'fa-check' : 'fa-times'
    };
}

// Función para mostrar loading
function showLoading(elementId, message = 'Cargando...') {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `
            <tr>
                <td colspan="8" class="text-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">${message}</span>
                    </div>
                    ${message}
                </td>
            </tr>
        `;
    }
}

console.log('✅ Funciones mínimas para proveedores cargadas');
// Función para cargar datos de filtros
async function cargarDatosFiltrosProveedores() {
    try {
        // Cargar categorías/tipos de proveedores si existen
        // const categorias = await apiRequest('/proveedores/categorias');
        // if (categorias.success) {
        //     llenarSelectCategoriasProveedores(categorias.data);
        // }
        
        console.log('Datos de filtros de proveedores cargados');
    } catch (error) {
        console.error('Error cargando datos de filtros:', error);
    }
}


// Función para exportar proveedores filtrados
function exportarProveedoresFiltrados() {
    if (!window.proveedores || window.proveedores.length === 0) {
        showAlert('No hay proveedores para exportar', 'warning');
        return;
    }

    // Crear CSV
    const headers = ['Razón Social', 'CUIT', 'Email', 'Teléfono', 'Localidad', 'Fecha Creación', 'Estado'];
    const csvContent = [
        headers.join(','),
        ...window.proveedores.map(proveedor => [
            `"${proveedor.razonSocial || ''}"`,
            proveedor.cuit || '',
            proveedor.email || '',
            proveedor.telefono || '',
            proveedor.localidad || '',
            proveedor.fecha_creacion ? new Date(proveedor.fecha_creacion).toLocaleDateString('es-AR') : '',
            proveedor.activo ? 'Activo' : 'Inactivo'
        ].join(','))
    ].join('\n');

    // Descargar archivo
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `proveedores_filtrados_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();

    showAlert(`Exportados ${window.proveedores.length} proveedores`, 'success');
}

// Event listeners para filtros automáticos
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar filtros al presionar Enter en el campo de búsqueda
    document.getElementById('filtro-proveedores-busqueda')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            aplicarFiltrosProveedores();
        }
    });
    
    // Aplicar filtros automáticamente al cambiar selects
    const selectsAutoFilter = [
        'filtro-proveedores-activo',
        'filtro-proveedores-categoria'
    ];
    
    selectsAutoFilter.forEach(selectId => {
        document.getElementById(selectId)?.addEventListener('change', function() {
            // Aplicar filtros con un pequeño delay para mejor UX
            setTimeout(aplicarFiltrosProveedores, 300);
        });
    });
    
    // Event listeners para campos de fecha
    document.getElementById('filtro-proveedores-fecha-desde')?.addEventListener('change', aplicarFiltrosProveedores);
    document.getElementById('filtro-proveedores-fecha-hasta')?.addEventListener('change', aplicarFiltrosProveedores);
});

// Debounce para búsqueda optimizada
let timeoutFiltroProveedores;
function debounceFilterProveedores() {
    clearTimeout(timeoutFiltroProveedores);
    timeoutFiltroProveedores = setTimeout(aplicarFiltrosProveedores, 500);
}

// Aplicar debounce al campo de búsqueda
document.getElementById('filtro-proveedores-busqueda')?.addEventListener('input', debounceFilterProveedores);


// =============================================
// CARGAR DATOS DE TRANSFERENCIAS
// =============================================
async function cargarTransferencias() {
    try {
        //showSpinner();
        const response = await apiRequest('/transferencias');
        
        if (response.success) {
            transferenciasData = response.data;
            mostrarTransferencias(transferenciasData);
            actualizarEstadisticasTransferencias();
        } else {
            throw new Error(response.message || 'Error al cargar transferencias');
        }
    } catch (error) {
        console.error('Error cargando transferencias:', error);
        showAlert('Error al cargar transferencias: ' + error.message, 'danger');
        // Mostrar datos demo en caso de error
        mostrarTransferenciasDemo();
    } finally {
       // hideSpinner();
    }
}

function mostrarTransferenciasDemo() {
    const demo = [
        {
            id: 1,
            numero_orden: 'ORD-2024-001',
            fecha_orden: '2024-01-15 10:30:00',
            deposito_origen_nombre: 'Central',
            deposito_destino_nombre: 'Vendedor - Juan Pérez',
            estado: 'PENDIENTE',
            total_items: 3,
            progreso: 0
        },
        {
            id: 2,
            numero_orden: 'ORD-2024-002',
            fecha_orden: '2024-01-14 15:20:00',
            deposito_origen_nombre: 'Central',
            deposito_destino_nombre: 'Cliente - Empresa XYZ',
            estado: 'PARCIAL',
            total_items: 2,
            progreso: 60
        }
    ];
    
    transferenciasData = demo;
    mostrarTransferencias(demo);
    actualizarEstadisticasTransferencias();
}

function mostrarTransferencias(transferencias) {
    const tbody = document.getElementById('tablaTransferencias');
    
    if (!transferencias || transferencias.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                    No hay órdenes de transferencia registradas
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = transferencias.map(orden => {
        const fechaFormateada = new Date(orden.fecha_orden).toLocaleDateString();
        const estadoBadge = getEstadoBadge(orden.estado);
        const progreso = orden.progreso || 0;

        return `
            <tr>
                <td>
                    <strong>${orden.numero_orden}</strong>
                </td>
                <td>${fechaFormateada}</td>
                <td>
                    <small class="text-muted">De:</small><br>
                    ${orden.deposito_origen_nombre}
                </td>
                <td>
                    <small class="text-muted">Para:</small><br>
                    ${orden.deposito_destino_nombre}
                </td>
                <td>${estadoBadge}</td>
                <td>
                    <span class="badge bg-light text-dark">${orden.total_items || 0}</span>
                </td>
                <td>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-${getProgressColor(orden.estado)}" 
                             style="width: ${progreso}%" title="${progreso}%"></div>
                    </div>
                    <small class="text-muted">${progreso}%</small>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" 
                                onclick="verDetallesOrden(${orden.id})" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${orden.estado !== 'CANCELADA' && orden.estado !== 'COMPLETADA' ? `
                            <button type="button" class="btn btn-outline-warning" 
                                    onclick="editarOrden(${orden.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function getEstadoBadge(estado) {
    switch (estado?.toLowerCase()) {
        case 'pendiente':
            return '<span class="badge bg-secondary"><i class="fas fa-hourglass-start me-1"></i>PENDIENTE</span>';
        case 'parcial':
            return '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>PARCIAL</span>';
        case 'completada':
            return '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>COMPLETADA</span>';
        case 'cancelada':
            return '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>CANCELADA</span>';
        default:
            return '<span class="badge bg-secondary">DESCONOCIDO</span>';
    }
}

function getProgressColor(estado) {
    const colors = {
        'PENDIENTE': 'warning',
        'PARCIAL': 'info',
        'COMPLETADA': 'success',
        'CANCELADA': 'danger'
    };
    return colors[estado] || 'secondary';
}

function actualizarEstadisticasTransferencias() {
    const stats = transferenciasData.reduce((acc, orden) => {
        acc[orden.estado.toLowerCase()] = (acc[orden.estado.toLowerCase()] || 0) + 1;
        return acc;
    }, {});

    document.getElementById('stat-pendientes').textContent = stats.pendiente || 0;
    document.getElementById('stat-parciales').textContent = stats.parcial || 0;
    document.getElementById('stat-completadas').textContent = stats.completada || 0;
    document.getElementById('stat-canceladas').textContent = stats.cancelada || 0;
}

// =============================================
// FILTROS Y BÚSQUEDA
// =============================================
function filtrarTransferencias() {
    const estado = document.getElementById('filtro-estado-transferencia').value;
    const origen = document.getElementById('filtro-origen-transferencia').value;
    const destino = document.getElementById('filtro-destino-transferencia').value;
    const busqueda = document.getElementById('buscar-transferencia').value.toLowerCase();

    let filtradas = transferenciasData.filter(orden => {
        const cumpleEstado = !estado || orden.estado === estado;
        const cumpleOrigen = !origen || orden.deposito_origen_id == origen;
        const cumpleDestino = !destino || orden.deposito_destino_id == destino;
        const cumpleBusqueda = !busqueda || 
            orden.numero_orden.toLowerCase().includes(busqueda) ||
            orden.deposito_origen_nombre.toLowerCase().includes(busqueda) ||
            orden.deposito_destino_nombre.toLowerCase().includes(busqueda);

        return cumpleEstado && cumpleOrigen && cumpleDestino && cumpleBusqueda;
    });

    mostrarTransferencias(filtradas);
}

function limpiarFiltrosTransferencias() {
    document.getElementById('filtro-estado-transferencia').value = '';
    document.getElementById('filtro-origen-transferencia').value = '';
    document.getElementById('filtro-destino-transferencia').value = '';
    document.getElementById('buscar-transferencia').value = '';
    
    mostrarTransferencias(transferenciasData);
}

// =============================================
// MODAL NUEVA ORDEN
// =============================================
async function abrirModalNuevaOrden() {
    try {
        console.log('🚀 Abriendo modal nueva orden...');

        // Limpiar formulario primero
        const form = document.getElementById('formNuevaOrden');
        if (form) {
            form.reset();
        }

        // Limpiar contenedor de items
        const itemsContainer = document.getElementById('itemsOrden');
        if (itemsContainer) {
            itemsContainer.innerHTML = '';
        }
        
        // Resetear contador
        itemOrdenCounter = 0;

        // Cargar datos necesarios en paralelo
        console.log('📦 Cargando datos necesarios...');
        await Promise.all([
            cargarSelectoresDepositos('nuevo_origen'),
            cargarSelectoresDepositos('nuevo_destino'),
            cargarMercaderias() // Pre-cargar mercaderías para evitar múltiples llamadas
        ]);

        // Agregar primer item después de cargar los datos
        agregarItemOrden();

        // Mostrar modal
        const modalElement = document.getElementById('modalNuevaOrden');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log('✅ Modal nueva orden abierto exitosamente');
        } else {
            throw new Error('Elemento modal no encontrado');
        }

    } catch (error) {
        console.error('❌ Error abriendo modal nueva orden:', error);
        if (typeof showAlert === 'function') {
            showAlert('Error al abrir formulario: ' + error.message, 'danger');
        }
    }
}

// =============================================
// SISTEMA COMPLETO DE AUTOCOMPLETE CON STOCK PARA ÓRDENES DE TRANSFERENCIA
// =============================================

// ✅ INICIALIZAR VARIABLES GLOBALES
if (typeof window.autocompleteInstances === 'undefined') {
    window.autocompleteInstances = {};
}
if (typeof window.autocompletesProductos === 'undefined') {
    window.autocompletesProductos = {};
}

// =============================================
// FUNCIÓN PRINCIPAL: agregarItemOrden()
// =============================================
function agregarItemOrden() {
    itemOrdenCounter++;
    
    const autocompleteId = `autocomplete-mercaderia-${itemOrdenCounter}`;
    console.log(`🚀 Creando item ${itemOrdenCounter} con autocomplete: ${autocompleteId}`);
    
    const itemHtml = `
        <div class="row g-3 mb-3 item-orden" id="item-${itemOrdenCounter}">
            <div class="col-md-6">
                <label class="form-label">Mercadería *</label>
                <div id="${autocompleteId}" class="autocomplete-container"></div>
                <input type="hidden" class="mercaderia-id" name="mercaderia_id" required>
                <div class="invalid-feedback">Por favor selecciona una mercadería</div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Cantidad *</label>
                <input type="number" class="form-control cantidad-input" name="cantidad_solicitada" 
                       required min="0.01" step="0.01" value="1" placeholder="0.00">
                <div class="invalid-feedback">Ingresa una cantidad válida</div>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-outline-danger d-block" 
                        onclick="eliminarItemOrden(${itemOrdenCounter})" title="Eliminar item">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    // Insertar HTML
    document.getElementById('itemsOrden').insertAdjacentHTML('beforeend', itemHtml);
    
    // Crear autocomplete después de insertar HTML
    setTimeout(() => {
        crearAutocompleteConStock(itemOrdenCounter);
    }, 50);
    
    console.log(`✅ Item ${itemOrdenCounter} agregado`);
}

// =============================================
// FUNCIÓN PARA CREAR AUTOCOMPLETE CON STOCK
// =============================================
function crearAutocompleteConStock(itemNumber) {
    const autocompleteId = `autocomplete-mercaderia-${itemNumber}`;
    
    console.log(`🔧 Creando autocomplete con stock para item ${itemNumber}`);
    
    // Verificar que MercaderiaAutocomplete existe
    if (typeof window.MercaderiaAutocomplete === 'undefined') {
        console.error('❌ MercaderiaAutocomplete no está definida');
        return;
    }
    
    // Verificar contenedor
    const container = document.getElementById(autocompleteId);
    if (!container) {
        console.error(`❌ Contenedor ${autocompleteId} no encontrado`);
        return;
    }
    
    try {
        // ✅ CREAR INSTANCIA BÁSICA
        const autocomplete = new window.MercaderiaAutocomplete(autocompleteId, {
            placeholder: 'Buscar mercadería por código o descripción...',
            onSelect: (mercaderia) => {
                console.log(`🎯 Mercadería seleccionada:`, mercaderia);
                
                const itemContainer = document.getElementById(`item-${itemNumber}`);
                const hiddenInput = itemContainer?.querySelector('.mercaderia-id');
                const cantidadInput = itemContainer?.querySelector('.cantidad-input');
                
                if (hiddenInput) {
                    hiddenInput.value = mercaderia.mercaderia_id || mercaderia.id;
                    hiddenInput.classList.remove('is-invalid');
                    
                    // ✅ CONFIGURAR LÍMITE DE CANTIDAD SEGÚN STOCK
                    if (cantidadInput && mercaderia.stock_origen > 0) {
                        cantidadInput.max = mercaderia.stock_origen;
                        cantidadInput.title = `Stock disponible: ${mercaderia.stock_origen}`;
                        cantidadInput.focus();
                    }
                    
                    console.log(`✅ Mercadería guardada: ID=${hiddenInput.value}, Stock=${mercaderia.stock_origen}`);
                }
            }
        });
        
        // ✅ AGREGAR FUNCIONALIDAD DE STOCK AL AUTOCOMPLETE
        agregarCapacidadStock(autocomplete);
        
        // ✅ GUARDAR INSTANCIA EN LUGARES CORRECTOS
        window.autocompleteInstances[autocompleteId] = autocomplete;
        window.autocompletesProductos[autocompleteId] = autocomplete;
        
        // ✅ ASEGURAR MÉTODO selectProduct
        if (!autocomplete.selectProduct) {
            autocomplete.selectProduct = function(index) {
                console.log(`🎯 selectProduct llamado con índice: ${index}`);
                
                if (this.currentProducts && this.currentProducts[index]) {
                    const product = this.currentProducts[index];
                    
                    // Validar stock
                    if (product.stock_origen === 0) {
                        alert('⚠️ Este producto no tiene stock disponible en el depósito origen');
                        return;
                    }
                    
                    // Establecer valor
                    if (this.input) {
                        this.input.value = `${product.codigo_sku} - ${product.descripcion}`;
                    }
                    
                    // Ocultar resultados
                    if (this.results) {
                        this.results.style.display = 'none';
                    }
                    
                    // Ejecutar callback
                    if (this.onSelect) {
                        this.onSelect(product);
                    }
                    
                    console.log(`✅ Producto seleccionado: ${product.descripcion}`);
                } else {
                    console.warn(`⚠️ No se encontró producto en índice ${index}`);
                }
            };
        }
        
        console.log(`✅ Autocomplete con stock creado para item ${itemNumber}`);
        
    } catch (error) {
        console.error(`❌ Error creando autocomplete:`, error);
    }
}

// =============================================
// FUNCIÓN PARA AGREGAR CAPACIDAD DE STOCK
// =============================================
function agregarCapacidadStock(autocomplete) {
    console.log('🔧 Agregando capacidad de stock al autocomplete');
    
    // ✅ FUNCIÓN DE BÚSQUEDA CON STOCK
    autocomplete.buscarConStock = async function(termino) {
        try {
            const depositoOrigen = document.getElementById('nuevo_origen')?.value;
            
            if (!depositoOrigen) {
                console.warn('⚠️ No hay depósito origen, usando búsqueda normal');
                return await this.buscarNormal(termino);
            }
            
            console.log(`🔍 Buscando con stock del depósito ${depositoOrigen}`);
            
            const response = await fetch(`/api/v1/mercaderias/buscar-con-stock?q=${encodeURIComponent(termino)}&deposito_id=${depositoOrigen}`);
            
            if (!response.ok) {
                console.warn('⚠️ API de stock no disponible, usando búsqueda normal');
                return await this.buscarNormal(termino);
            }
            
            const data = await response.json();

            // ✅ AGREGAR DEBUGGING AQUÍ
console.log('📋 Respuesta completa de la API:', data);
console.log('📋 Tipo de data.data:', typeof data.data);
console.log('📋 Es array data.data?:', Array.isArray(data.data));
console.log('🔍 Estructura completa de data.data:', JSON.stringify(data.data, null, 2));

            
            if (data.success) {
                this.currentProducts = data.data.map(mercaderia => ({
                    ...mercaderia,
                    stock_origen: mercaderia.stock_deposito || 0
                }));
                
                console.log(`✅ ${this.currentProducts.length} productos con stock encontrados`);
                this.mostrarResultadosConStock();
            } else {
                await this.buscarNormal(termino);
            }
            
        } catch (error) {
            console.error('❌ Error búsqueda con stock:', error);
            await this.buscarNormal(termino);
        }
    };
    
    // ✅ FUNCIÓN DE BÚSQUEDA NORMAL (FALLBACK)
    autocomplete.buscarNormal = async function(termino) {
        try {
            const response = await fetch(`/api/v1/mercaderias/buscar?q=${encodeURIComponent(termino)}`);
            const data = await response.json();
            
            if (data.success) {
                this.currentProducts = data.data.map(mercaderia => ({
                    ...mercaderia,
                    stock_origen: 'N/A'
                }));
                this.mostrarResultadosConStock();
            } else {
                this.mostrarError('No se encontraron productos');
            }
        } catch (error) {
            console.error('Error búsqueda normal:', error);
            this.mostrarError('Error cargando productos');
        }
    };
    
    // ✅ FUNCIÓN PARA MOSTRAR RESULTADOS CON STOCK
    autocomplete.mostrarResultadosConStock = function() {
        if (!this.currentProducts.length) {
            this.mostrarError('No se encontraron productos');
            return;
        }
        
        const html = this.currentProducts.map((product, index) => {
            const stock = product.stock_origen;
            let badge = '';
            let clase = '';
            
            if (stock === 'N/A') {
                badge = '<span class="badge bg-secondary">Sin info</span>';
            } else if (stock === 0) {
                badge = '<span class="badge bg-danger">Sin stock</span>';
                clase = 'bg-light text-muted';
            } else if (stock <= 5) {
                badge = `<span class="badge bg-warning text-dark">${stock} unidades</span>`;
                clase = 'border-warning';
            } else {
                badge = `<span class="badge bg-success">${stock} unidades</span>`;
                clase = 'border-success';
            }
            
            return `
                <div class="autocomplete-item p-2 border-bottom ${clase}" 
                     style="cursor: pointer;" 
                     onclick="selectMercaderiaGlobal('${this.container.id}', ${index})"
                     onmouseover="this.style.backgroundColor='#f8f9fa'" 
                     onmouseout="this.style.backgroundColor='white'">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="fw-bold text-primary">${product.codigo_sku}</div>
                            <div class="text-dark">${product.descripcion}</div>
                            ${product.categoria ? `<small class="text-muted">${product.categoria}</small>` : ''}
                        </div>
                        <div class="text-end ms-2">
                            ${badge}
                            ${product.precio_venta ? `<div class="small text-muted">$${parseFloat(product.precio_venta).toLocaleString()}</div>` : ''}
                        </div>
                    </div>
                    ${stock === 0 ? '<div class="small text-danger mt-1"><i class="fas fa-exclamation-triangle"></i> No disponible para transferir</div>' : ''}
                </div>
            `;
        }).join('');
        
        if (this.results) {
            this.results.innerHTML = html;
            this.results.style.display = 'block';
        }
    };
    
    // ✅ RECONFIGURAR EVENT LISTENER DEL INPUT PARA USAR BÚSQUEDA CON STOCK
    if (autocomplete.input) {
        // Remover listeners anteriores clonando el input
        const nuevoInput = autocomplete.input.cloneNode(true);
        autocomplete.input.parentNode.replaceChild(nuevoInput, autocomplete.input);
        autocomplete.input = nuevoInput;
        
        // Agregar nuevo listener que usa búsqueda con stock
        let timeout;
        autocomplete.input.addEventListener('input', (e) => {
            const valor = e.target.value.trim();
            
            // Mostrar/ocultar botón limpiar
            if (autocomplete.clearBtn) {
                autocomplete.clearBtn.style.display = valor ? 'block' : 'none';
            }
            
            clearTimeout(timeout);
            
            if (valor.length >= 2) {
                timeout = setTimeout(() => {
                    autocomplete.buscarConStock(valor); // ✅ Usar búsqueda con stock
                }, 300);
            } else if (autocomplete.results) {
                autocomplete.results.style.display = 'none';
            }
        });
        
        console.log('✅ Event listener reconfigurado para usar búsqueda con stock');
    }
}

// =============================================
// FUNCIÓN selectMercaderiaGlobal MEJORADA
// =============================================
window.selectMercaderiaGlobal = function(containerId, index) {
    console.log(`🎯 selectMercaderiaGlobal: ${containerId}, índice: ${index}`);
    
    // Buscar en autocompleteInstances
    if (window.autocompleteInstances && window.autocompleteInstances[containerId]) {
        const autocomplete = window.autocompleteInstances[containerId];
        
        if (typeof autocomplete.selectProduct === 'function') {
            autocomplete.selectProduct(index);
            return true;
        }
    }
    
    // Buscar en autocompletesProductos (backup)
    if (window.autocompletesProductos && window.autocompletesProductos[containerId]) {
        const autocomplete = window.autocompletesProductos[containerId];
        
        if (typeof autocomplete.selectProduct === 'function') {
            autocomplete.selectProduct(index);
            return true;
        }
    }
    
    // Búsqueda exhaustiva
    const todasLasInstancias = [];
    if (window.autocompleteInstances) {
        todasLasInstancias.push(...Object.values(window.autocompleteInstances));
    }
    if (window.autocompletesProductos) {
        todasLasInstancias.push(...Object.values(window.autocompletesProductos));
    }
    
    const encontrada = todasLasInstancias.find(ac => 
        ac.container && ac.container.id === containerId
    );
    
    if (encontrada && typeof encontrada.selectProduct === 'function') {
        encontrada.selectProduct(index);
        return true;
    }
    
    console.error('❌ No se encontró instancia de autocomplete para:', containerId);
    return false;
};

// =============================================
// FUNCIONES AUXILIARES
// =============================================

function eliminarItemOrden(id) {
    const item = document.getElementById(`item-${id}`);
    const containerId = `autocomplete-mercaderia-${id}`;
    
    if (item) {
        // Limpiar referencias
        if (window.autocompleteInstances && window.autocompleteInstances[containerId]) {
            delete window.autocompleteInstances[containerId];
        }
        if (window.autocompletesProductos && window.autocompletesProductos[containerId]) {
            delete window.autocompletesProductos[containerId];
        }
        
        item.remove();
        console.log(`🗑️ Item ${id} eliminado`);
    }
    
    // Asegurar mínimo un item
    const items = document.querySelectorAll('.item-orden');
    if (items.length === 0) {
        setTimeout(agregarItemOrden, 100);
    }
}

function validarItemsOrden() {
    const items = document.querySelectorAll('.item-orden');
    let todosValidos = true;
    let errores = [];
    
    items.forEach((item, index) => {
        const hiddenInput = item.querySelector('.mercaderia-id');
        const cantidadInput = item.querySelector('.cantidad-input');
        
        // Limpiar errores previos
        hiddenInput?.classList.remove('is-invalid');
        cantidadInput?.classList.remove('is-invalid');
        
        // Validar mercadería
        if (!hiddenInput?.value) {
            todosValidos = false;
            errores.push(`Item ${index + 1}: Selecciona una mercadería`);
            hiddenInput?.classList.add('is-invalid');
        }
        
        // Validar cantidad
        const cantidad = parseFloat(cantidadInput?.value || 0);
        const maxStock = parseFloat(cantidadInput?.max || Infinity);
        
        if (cantidad <= 0) {
            todosValidos = false;
            errores.push(`Item ${index + 1}: La cantidad debe ser mayor a 0`);
            cantidadInput?.classList.add('is-invalid');
        } else if (maxStock !== Infinity && cantidad > maxStock) {
            todosValidos = false;
            errores.push(`Item ${index + 1}: Cantidad excede stock disponible (máx: ${maxStock})`);
            cantidadInput?.classList.add('is-invalid');
        }
    });
    
    if (!todosValidos && typeof showAlert === 'function') {
        showAlert('Errores:\n• ' + errores.join('\n• '), 'danger');
    }
    
    return todosValidos;
}

function obtenerDatosItemsOrden() {
    const items = document.querySelectorAll('.item-orden');
    const datos = [];
    
    items.forEach(item => {
        const mercaderiaId = item.querySelector('.mercaderia-id')?.value;
        const cantidad = parseFloat(item.querySelector('.cantidad-input')?.value || 0);
        
        if (mercaderiaId && cantidad > 0) {
            datos.push({
                mercaderia_id: parseInt(mercaderiaId),
                cantidad_solicitada: cantidad
            });
        }
    });
    
    return datos;
}

async function guardarNuevaOrden() {
    try {
        if (!validarItemsOrden()) return;

        const btnGuardar = document.querySelector('#modalNuevaOrden .btn-primary');
        const textoOriginal = btnGuardar?.innerHTML;
        
        if (btnGuardar) {
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            btnGuardar.disabled = true;
        }

        const datosOrden = {
            deposito_origen_id: parseInt(document.getElementById('nuevo_origen').value),
            deposito_destino_id: parseInt(document.getElementById('nuevo_destino').value),
            observaciones: document.getElementById('nuevo_observaciones')?.value?.trim() || '',
            items: obtenerDatosItemsOrden()
        };

        if (datosOrden.items.length === 0) {
            throw new Error('Debe agregar al menos un item a la orden');
        }

        console.log('💾 Guardando orden con stock validado:', datosOrden);

        const response = await fetch('/api/v1/transferencias', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datosOrden)
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || 'Error del servidor');
        }

        console.log('✅ Orden guardada:', result.data);
        
        if (typeof showAlert === 'function') {
            showAlert(`✅ Orden #${result.data.id} creada exitosamente`, 'success');
        }

        // Cerrar modal y recargar
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevaOrden'));
        modal?.hide();
        
        if (typeof cargarOrdenes === 'function') {
            await cargarOrdenes();
        }

    } catch (error) {
        console.error('❌ Error:', error);
        if (typeof showAlert === 'function') {
            showAlert('❌ Error: ' + error.message, 'danger');
        }
    } finally {
        const btnGuardar = document.querySelector('#modalNuevaOrden .btn-primary');
        if (btnGuardar && textoOriginal) {
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
        }
    }
}

// =============================================
// FUNCIÓN PARA ESCUCHAR CAMBIOS EN DEPÓSITO ORIGEN
// =============================================
function configurarDepositoListener() {
    const selectDeposito = document.getElementById('nuevo_origen');
    
    if (selectDeposito) {
        selectDeposito.addEventListener('change', function() {
            const nuevoDeposito = this.value;
            console.log(`🔄 Depósito origen cambió a: ${nuevoDeposito}`);
            
            // Limpiar autocompletes existentes
            const items = document.querySelectorAll('.item-orden');
            items.forEach(item => {
                const hiddenInput = item.querySelector('.mercaderia-id');
                const autocompleteInput = item.querySelector('.autocomplete-container input');
                
                if (hiddenInput) hiddenInput.value = '';
                if (autocompleteInput) autocompleteInput.value = '';
            });
            
            if (nuevoDeposito && typeof showAlert === 'function') {
                showAlert(`Depósito actualizado. Los autocompletes ahora mostrarán stock de ${this.selectedOptions[0]?.text}`, 'info');
            }
        });
    }
}

// =============================================
// FUNCIÓN DE DIAGNÓSTICO
// =============================================
window.debugAutocomplete = function() {
    console.log('🔍 DIAGNÓSTICO AUTOCOMPLETE:');
    console.log('- MercaderiaAutocomplete:', typeof window.MercaderiaAutocomplete);
    console.log('- autocompleteInstances:', window.autocompleteInstances);
    console.log('- selectMercaderiaGlobal:', typeof window.selectMercaderiaGlobal);
    
    if (window.autocompleteInstances) {
        Object.entries(window.autocompleteInstances).forEach(([key, instance]) => {
            console.log(`  ${key}:`, {
                hasContainer: !!instance.container,
                hasSelectProduct: typeof instance.selectProduct === 'function',
                hasCurrentProducts: Array.isArray(instance.currentProducts)
            });
        });
    }
};

// =============================================
// INICIALIZACIÓN
// =============================================
document.addEventListener('DOMContentLoaded', configurarDepositoListener);

console.log('✅ Sistema de autocomplete con stock para órdenes inicializado');
console.log('💡 Usa debugAutocomplete() para diagnóstico');


// Event listener para el formulario
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formNuevaOrden');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            guardarNuevaOrden();
        });
    }
});




// =============================================
// VER DETALLES DE ORDEN
// =============================================
async function verDetallesOrden(ordenId) {
    try {
        showSpinner();
        const response = await apiRequest(`/transferencias/${ordenId}`);
        
        if (response.success) {
            ordenActual = response.data;
            
            // Usar las funciones corregidas
            renderizarDetallesOrden(response.data.detalles);
            actualizarResumenOrden(response.data.orden, response.data.detalles);
            
            // Mostrar modal si existe
            const modal = document.getElementById('modalDetallesOrden');
            if (modal) {
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            }
            
        } else {
            throw new Error(response.message || 'Error al cargar detalles');
        }
        
    } catch (error) {
        console.error('Error viendo detalles:', error);
        showAlert('Error al cargar detalles: ' + error.message, 'danger');
    } finally {
        hideSpinner();
    }
}

function mostrarDetallesOrden(data) {
    try {
        console.log('📋 Mostrando detalles de orden:', data);
        
        // Manejar diferentes estructuras de datos
        const orden = data.orden || data;
        const detalles = data.detalles || [];
        const resumen = data.resumen || {};

        // Verificar que orden tenga las propiedades necesarias
        if (!orden || !orden.numero_orden) {
            console.error('Error: Datos de orden no válidos:', orden);
            showAlert('Error: Datos de orden no válidos', 'danger');
            return;
        }

        // Información general (tu código existente)
        document.getElementById('detalle_numero_orden').textContent = orden.numero_orden || 'N/A';
        
        const estadoElement = document.getElementById('detalle_estado');
        if (estadoElement) {
            estadoElement.innerHTML = getEstadoBadge(orden.estado || 'PENDIENTE');
        }
        
        const fechaElement = document.getElementById('detalle_fecha');
        if (fechaElement) {
            const fecha = orden.fecha_orden ? 
                new Date(orden.fecha_orden).toLocaleDateString('es-AR') : 'N/A';
            fechaElement.textContent = fecha;
        }
        
        document.getElementById('detalle_origen').textContent = orden.deposito_origen_nombre || 'N/A';
        document.getElementById('detalle_destino').textContent = orden.deposito_destino_nombre || 'N/A';

        // ✅ USAR FUNCIONES MEJORADAS
        cargarTablaDetalles(detalles);
        actualizarResumenDetalles(orden, detalles);
        
        // Actualizar botones según estado (tu función existente)
        if (typeof actualizarBotonesOrden === 'function') {
            actualizarBotonesOrden(orden);
        }
        
        console.log('✅ Detalles mostrados correctamente');
        
    } catch (error) {
        console.error('❌ Error mostrando detalles:', error);
        showAlert('Error al mostrar detalles: ' + error.message, 'danger');
    }
}

// Función auxiliar para cargar la tabla de detalles
function cargarTablaDetalles(detalles) {
    const tbody = document.getElementById('tablaDetalleItems');
    if (!tbody) {
        console.warn('No se encontró el elemento tablaDetalleItems');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (!detalles || detalles.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay detalles disponibles</td></tr>';
        return;
    }
    
    detalles.forEach(detalle => {
        const row = document.createElement('tr');
        
        // ✅ CALCULAR ESTADO CORRECTO basado en cantidades reales
        const cantidadSolicitada = parseFloat(detalle.cantidad_solicitada) || 0;
        const cantidadEnviada = parseFloat(detalle.cantidad_enviada) || 0;
        const cantidadPendiente = cantidadSolicitada - cantidadEnviada;
        
        // Calcular progreso y estado visual
        const progreso = cantidadSolicitada > 0 ? 
            Math.round(cantidadEnviada * 100 / cantidadSolicitada) : 0;
        
        // ✅ DETERMINAR ESTADO REAL (no usar campo 'estado' de BD que puede estar incorrecto)
        let estadoDetalle, colorBarra, colorEstado, iconoEstado;
        
        if (cantidadEnviada >= cantidadSolicitada) {
            estadoDetalle = 'COMPLETADO';
            colorBarra = 'bg-success';
            colorEstado = 'text-success';
            iconoEstado = '<i class="fas fa-check-circle me-1"></i>';
        } else if (cantidadEnviada > 0) {
            estadoDetalle = 'PARCIAL';
            colorBarra = 'bg-warning';
            colorEstado = 'text-warning';
            iconoEstado = '<i class="fas fa-clock me-1"></i>';
        } else {
            estadoDetalle = 'PENDIENTE';
            colorBarra = 'bg-secondary';
            colorEstado = 'text-muted';
            iconoEstado = '<i class="fas fa-hourglass-start me-1"></i>';
        }

        row.innerHTML = `
            <td>
                <div class="fw-bold">${detalle.mercaderia_descripcion || 'N/A'}</div>
                ${detalle.codigo_sku ? `<small class="text-muted">SKU: ${detalle.codigo_sku}</small>` : ''}
            </td>
            <td class="text-center">
                <span class="fw-bold">${cantidadSolicitada}</span>
            </td>
            <td class="text-center">
                <span class="fw-bold text-primary">${cantidadEnviada}</span>
                <div class="${colorEstado} small mt-1">
                    ${iconoEstado}${estadoDetalle}
                </div>
            </td>
            <td class="text-center">
                <span class="${cantidadPendiente > 0 ? 'fw-bold text-warning' : 'text-muted'}">${cantidadPendiente}</span>
            </td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${colorBarra}" role="progressbar" 
                         style="width: ${progreso}%" 
                         aria-valuenow="${progreso}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${progreso}%
                    </div>
                </div>
                <div class="text-center mt-1">
                    <small class="${colorEstado}">${estadoDetalle}</small>
                </div>
            </td>
            <td class="text-center">
                ${cantidadPendiente > 0 ? 
                    `<button class="btn btn-sm btn-primary" onclick="enviarMercaderia(${detalle.id})">
                        <i class="fas fa-shipping-fast me-1"></i> Enviar
                    </button>` : 
                    `<span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Completo
                    </span>`
                }
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Función auxiliar para actualizar botones según estado
function actualizarBotonesOrden(orden) {
    const estado = orden.estado || '';
    
    // Botón cancelar
    const btnCancelar = document.getElementById('btn-cancelar-orden');
    if (btnCancelar) {
        btnCancelar.style.display = ['PENDIENTE', 'PARCIAL'].includes(estado) ? 'inline-block' : 'none';
    }
    
    // Botón completar
    const btnCompletar = document.getElementById('btn-completar-orden');
    if (btnCompletar) {
        btnCompletar.style.display = estado === 'PARCIAL' ? 'inline-block' : 'none';
    }
    
    // Otros botones según el estado
    const botonesAccion = document.querySelectorAll('.botones-accion-orden button');
    botonesAccion.forEach(btn => {
        if (estado === 'COMPLETADA' || estado === 'CANCELADA') {
            btn.disabled = true;
        } else {
            btn.disabled = false;
        }
    });
}
// =============================================
// ENVÍO PARCIAL
// =============================================
async function abrirModalEnvioParcial(detalleId) {
    try {
        // Buscar el detalle en los datos actuales
        const detalle = ordenActual.detalles.find(d => d.id === detalleId);
        if (!detalle) {
            throw new Error('Detalle no encontrado');
        }

        // ✅ VALIDACIÓN SEGURA: Calcular cantidad pendiente
        const cantidadSolicitada = parseFloat(detalle.cantidad_solicitada) || 0;
        const cantidadEnviada = parseFloat(detalle.cantidad_enviada) || 0;
        const cantidadPendiente = cantidadSolicitada - cantidadEnviada;

        // Validar que hay cantidad pendiente para enviar
        if (cantidadPendiente <= 0) {
            showAlert('No hay cantidad pendiente para enviar', 'warning');
            return;
        }

        // Llenar formulario con los datos del detalle
        document.getElementById('envio_detalle_id').value = detalle.id;
        document.getElementById('envio_orden_id').value = ordenActual.orden.id;
        document.getElementById('envio_mercaderia').value = detalle.mercaderia_descripcion || detalle.descripcion || 'N/A';
        
        // ✅ USAR VALORES SEGUROS (no los originales que pueden ser null)
        document.getElementById('envio_solicitada').value = cantidadSolicitada;
        document.getElementById('envio_enviada').value = cantidadEnviada;
        document.getElementById('envio_pendiente').value = cantidadPendiente;
        
        // Configurar campo de cantidad a enviar
        const inputCantidad = document.getElementById('envio_cantidad');
        inputCantidad.value = cantidadPendiente; // Valor por defecto: toda la cantidad pendiente
        inputCantidad.max = cantidadPendiente;   // Máximo: cantidad pendiente
        inputCantidad.min = 0.01;               // Mínimo: mayor que 0
        
        // ✅ AGREGAR VALIDACIÓN en tiempo real
        inputCantidad.addEventListener('input', function() {
            const valor = parseFloat(this.value) || 0;
            if (valor > cantidadPendiente) {
                this.value = cantidadPendiente;
                showAlert(`Máximo permitido: ${cantidadPendiente}`, 'warning');
            }
        });

        // Limpiar otros campos (usar nombres correctos del HTML)
        document.getElementById('envio_documento').value = '';
        // Nota: No hay campo de observaciones en este modal

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalEnvioParcial'));
        modal.show();

    } catch (error) {
        console.error('Error abriendo modal:', error);
        showAlert('Error al abrir formulario de envío: ' + error.message, 'danger');
    }
}

function validarElementosProveedores() {
    const elementos = [
        'tabla-proveedores',
        'paginacionProveedores'
    ];
    
    const faltantes = elementos.filter(id => !document.getElementById(id));
    
    if (faltantes.length > 0) {
        console.error('❌ Elementos faltantes:', faltantes);
        console.log('💡 Asegúrate de que tu HTML incluya estos elementos:');
        faltantes.forEach(id => {
            console.log(`   - <tbody id="${id}"></tbody> o <div id="${id}"></div>`);
        });
        return false;
    }
    
    console.log('✅ Todos los elementos necesarios están presentes');
    return true;
}




// =============================================
// CANCELAR ORDEN
// =============================================
async function cancelarOrden() {
    if (!ordenActual) return;

    const confirmacion = confirm(
        `¿Está seguro que desea cancelar la orden ${ordenActual.orden.numero_orden}?\n\n` +
        'Esta acción no se puede deshacer.'
    );

    if (!confirmacion) return;

    try {
        const response = await apiRequest(`/transferencias/${ordenActual.orden.id}/cancelar`, 'PUT');

        if (response.success) {
            showAlert('Orden cancelada exitosamente', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetallesOrden'));
            if (modal) modal.hide();
            
            await cargarTransferencias(); // Recargar lista
        } else {
            throw new Error(response.message || 'Error al cancelar orden');
        }
    } catch (error) {
        console.error('Error cancelando orden:', error);
        showAlert('Error al cancelar orden: ' + error.message, 'danger');
    }
}

/**
 * Envía mercadería de un detalle específico (CORREGIDO)
 */
async function enviarMercaderia(detalleId) {
    try {
        // ✅ VALIDACIÓN 1: Verificar parámetros
        if (!detalleId || isNaN(parseInt(detalleId))) {
            showAlert('ID de detalle no válido', 'danger');
            return;
        }
        
        if (!ordenActual || !ordenActual.orden) {
            showAlert('No hay orden seleccionada', 'danger');
            return;
        }
        
        // Buscar el detalle específico
        const detalle = ordenActual.detalles.find(d => d.id === parseInt(detalleId));
        if (!detalle) {
            showAlert('Detalle no encontrado', 'danger');
            return;
        }

        // ✅ VALIDACIÓN 2: Calcular cantidad pendiente de manera segura
        const cantidadSolicitada = parseFloat(detalle.cantidad_solicitada) || 0;
        const cantidadEnviada = parseFloat(detalle.cantidad_enviada) || 0;
        const cantidadPendiente = cantidadSolicitada - cantidadEnviada;

        console.log('📊 Debug detalle:', {
            detalleId: detalleId,
            cantidadSolicitada: cantidadSolicitada,
            cantidadEnviada: cantidadEnviada,
            cantidadPendiente: cantidadPendiente
        });

        if (cantidadPendiente <= 0) {
            showAlert('No hay cantidad pendiente para enviar', 'warning');
            return;
        }

        // Abrir modal con datos seguros
        await abrirModalEnvioParcial(detalleId);
        
    } catch (error) {
        console.error('Error en enviarMercaderia:', error);
        showAlert('Error al preparar envío: ' + error.message, 'danger');
    }
}


// =============================================
// INICIALIZACIÓN
// =============================================
function inicializarProveedores() {
    console.log('🚀 Inicializando módulo de proveedores...');
    
    // Configurar eventos de filtros
    const campoBusqueda = document.getElementById('filtro-proveedores-busqueda');
    const campoEstado = document.getElementById('filtro-proveedores-estado');
    
    if (campoBusqueda) {
        campoBusqueda.addEventListener('input', debounce(aplicarFiltrosProveedores, 300));
    }
    
    if (campoEstado) {
        campoEstado.addEventListener('change', aplicarFiltrosProveedores);
    }
    
    // Cargar datos iniciales
    cargarProveedores();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function inicializarTransferencias() {
    try {
        // Cargar datos para filtros
        await cargarSelectoresDepositos('filtro-origen-transferencia');
        await cargarSelectoresDepositos('filtro-destino-transferencia');
        
        // Cargar transferencias
        await cargarTransferencias();
        
        // Event listeners para filtros
        const filtros = ['filtro-estado-transferencia', 'filtro-origen-transferencia', 
                        'filtro-destino-transferencia', 'buscar-transferencia'];
        
        filtros.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.addEventListener('change', filtrarTransferencias);
                if (elemento.type === 'text') {
                    elemento.addEventListener('input', filtrarTransferencias);
                }
            }
        });
        
    } catch (error) {
        console.error('Error inicializando transferencias:', error);
    }
}

// Auto-inicializar cuando se muestra la página de transferencias
document.addEventListener('DOMContentLoaded', function() {
    // Observar cambios en la página activa
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const target = mutation.target;
                if (target.id === 'transferencias' && target.classList.contains('active')) {
                    inicializarTransferencias();
                }
            }
        });
    });

    const transferenciasPage = document.getElementById('transferencias');
    if (transferenciasPage) {
        observer.observe(transferenciasPage, { attributes: true });
        
        // Si ya está activa, inicializar inmediatamente
        if (transferenciasPage.classList.contains('active')) {
            inicializarTransferencias();
        }
    }
});


// =============================================
// FUNCIÓN PARA CARGAR TODOS LOS SELECTORES EXISTENTES
// =============================================

async function cargarTodosLosSelectoresMercaderias() {
    try {
        // Pre-cargar mercaderías si no están disponibles
        if (mercaderiasDisponibles.length === 0) {
            await cargarMercaderias();
        }

        // Encontrar todos los selectores de mercaderías en items de orden
        const selectores = document.querySelectorAll('.item-orden select[name="mercaderia_id"]');
        
        console.log(`🔄 Cargando ${selectores.length} selectores de mercaderías...`);
        
        // Cargar cada selector usando su ID
        for (const selector of selectores) {
            if (selector.id) {
                await cargarSelectoresMercaderias(selector.id);
            }
        }
        
        console.log('✅ Todos los selectores de mercaderías cargados');
        
    } catch (error) {
        console.error('❌ Error cargando selectores de mercaderías:', error);
    }
}

function actualizarSelectoresDinamicosMercaderias() {
    console.log('🔄 Actualizando selectores dinámicos de mercaderías...');
    
    // Buscar todos los selectores de mercaderías en items de orden
    const selectoresDinamicos = document.querySelectorAll('.item-orden select[name="mercaderia_id"]');
    
    selectoresDinamicos.forEach(select => {
        if (select.id && mercaderiasDisponibles.length > 0) {
            console.log(`📋 Actualizando selector dinámico: ${select.id}`);
            
            const valorActual = select.value; // Preservar selección actual
            
            select.innerHTML = '<option value="">Seleccionar mercadería...</option>';
            mercaderiasDisponibles.forEach(mercaderia => {
                const option = document.createElement('option');
                option.value = mercaderia.id;
                option.textContent = `${mercaderia.codigo_sku} - ${mercaderia.descripcion}`;
                option.setAttribute('data-precio-costo', mercaderia.precio_costo || 0);
                option.setAttribute('data-precio-venta', mercaderia.precio_venta || 0);
                select.appendChild(option);
            });
            
            // Restaurar selección si existía
            if (valorActual) {
                select.value = valorActual;
            }
        }
    });
    
    console.log(`✅ ${selectoresDinamicos.length} selectores dinámicos actualizados`);
}

// ✅ FUNCIÓN PARA ACTUALIZAR TODOS LOS SELECTORES (GENÉRICOS + DINÁMICOS)
function actualizarTodosLosSelectoresMercaderias() {
    console.log('🔄 Actualizando TODOS los selectores de mercaderías...');
    
    if (mercaderiasDisponibles.length === 0) {
        console.warn('⚠️ No hay mercaderías disponibles para actualizar selectores');
        return;
    }
    
    // Actualizar selectores genéricos
    actualizarSelectoresMercaderias();
    
    // Actualizar selectores dinámicos
    actualizarSelectoresDinamicosMercaderias();
    
    console.log('✅ Todos los selectores de mercaderías actualizados');
}

// =============================================
// EVENTOS PARA DETECTAR CAMBIOS EN MERCADERÍAS
// =============================================

// Event listener para detectar cuando se agregan nuevos items dinámicamente
function configurarObservadorSelectoresDinamicos() {
    const contenedorItems = document.getElementById('itemsOrden');
    if (!contenedorItems) return;

    // Observar cambios en el contenedor de items
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.classList.contains('item-orden')) {
                        // Se agregó un nuevo item, buscar su selector de mercaderías
                        const select = node.querySelector('select[name="mercaderia_id"]');
                        if (select && select.id) {
                            console.log(`🔍 Nuevo selector detectado: ${select.id}`);
                            cargarSelectoresMercaderias(select.id);
                        }
                    }
                });
            }
        });
    });

    observer.observe(contenedorItems, { childList: true });
    console.log('👁️ Observador de selectores dinámicos configurado');
}



// =============================================
// FUNCIONES DE SPINNER/LOADING
// =============================================

/**
 * Mostrar spinner global de carga
 * @param {string} message - Mensaje opcional a mostrar
 */
function showSpinner(message = 'Cargando...') {
    try {
        console.log('🔄 Mostrando spinner:', message);
        
        // Cancelar cualquier operación de ocultado pendiente
        if (spinnerHideTimeout) {
            clearTimeout(spinnerHideTimeout);
            spinnerHideTimeout = null;
        }
        
        // Si ya se está mostrando, solo actualizar mensaje
        if (isSpinnerShowing) {
            const spinner = document.getElementById('global-spinner-overlay');
            if (spinner) {
                const textElement = spinner.querySelector('.spinner-text');
                if (textElement) {
                    textElement.textContent = message;
                }
            }
            return;
        }
        
        isSpinnerShowing = true;
        
        // Remover spinner existente si hay alguno
        const existingSpinner = document.getElementById('global-spinner-overlay');
        if (existingSpinner) {
            existingSpinner.remove();
        }
        
        // Crear nuevo spinner
        const spinner = document.createElement('div');
        spinner.id = 'global-spinner-overlay';
        spinner.className = 'spinner-overlay';
        spinner.innerHTML = `
            <div class="spinner-backdrop">
                <div class="spinner-content">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="spinner-text mt-2">${message}</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(spinner);
        
        // Mostrar con delay mínimo pero asegurado
        spinnerShowTimeout = setTimeout(() => {
            if (spinner && isSpinnerShowing) {
                spinner.classList.add('show');
            }
        }, 10);
        
    } catch (error) {
        console.error('❌ Error mostrando spinner:', error);
        isSpinnerShowing = false;
    }
}

/**
 * Ocultar spinner global de carga
 */
function hideSpinner() {
    try {
        console.log('⏹️ Ocultando spinner');
        
        // Cancelar mostrado pendiente
        if (spinnerShowTimeout) {
            clearTimeout(spinnerShowTimeout);
            spinnerShowTimeout = null;
        }
        
        isSpinnerShowing = false;
        
        const spinner = document.getElementById('global-spinner-overlay');
        if (spinner) {
            spinner.classList.remove('show');
            
            // Usar timeout más corto y más confiable
            spinnerHideTimeout = setTimeout(() => {
                if (spinner.parentNode && !isSpinnerShowing) {
                    spinner.remove();
                }
                spinnerHideTimeout = null;
            }, 200); // Aumentado a 200ms para ser más seguro
        }
        
    } catch (error) {
        console.error('❌ Error ocultando spinner:', error);
        // En caso de error, forzar limpieza
        forceCleanSpinner();
    }
}

/**
 * Función de emergencia para limpiar spinner
 */
function forceCleanSpinner() {
    try {
        console.log('🚨 Limpieza forzada del spinner');
        
        isSpinnerShowing = false;
        
        if (spinnerShowTimeout) {
            clearTimeout(spinnerShowTimeout);
            spinnerShowTimeout = null;
        }
        
        if (spinnerHideTimeout) {
            clearTimeout(spinnerHideTimeout);
            spinnerHideTimeout = null;
        }
        
        const spinner = document.getElementById('global-spinner-overlay');
        if (spinner) {
            spinner.remove();
        }
    } catch (error) {
        console.error('❌ Error en limpieza forzada:', error);
    }
}

// =============================================
// 2. NUEVA FUNCIÓN PARA OPERACIONES ASYNC SEGURAS
// =============================================

/**
 * Wrapper seguro para operaciones async
 */
async function ejecutarConSpinnerSeguro(operacion, mensaje = 'Procesando...', delayMinimo = 150) {
    try {
        showSpinner(mensaje);
        
        // Asegurar delay mínimo para que el usuario vea el spinner
        const [resultado] = await Promise.all([
            operacion(),
            new Promise(resolve => setTimeout(resolve, delayMinimo))
        ]);
        
        return resultado;
        
    } catch (error) {
        console.error('❌ Error en operación async:', error);
        throw error;
    } finally {
        // Delay extra para asegurar que el spinner se oculte correctamente
        setTimeout(() => {
            hideSpinner();
        }, 50);
    }
}
/**
 * Mostrar spinner en un elemento específico
 * @param {string} elementId - ID del elemento donde mostrar el spinner
 * @param {string} message - Mensaje opcional
 */
function showElementSpinner(elementId, message = 'Cargando...') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Guardar contenido original
    if (!element.dataset.originalContent) {
        element.dataset.originalContent = element.innerHTML;
    }
    
    // Determinar colspan para tablas
    const isTableBody = element.tagName.toLowerCase() === 'tbody';
    const colspan = isTableBody ? getTableColspan(element) : '';
    
    const spinnerHTML = isTableBody ? `
        <tr>
            <td colspan="${colspan}" class="text-center py-4">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                ${message}
            </td>
        </tr>
    ` : `
        <div class="text-center py-4">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            ${message}
        </div>
    `;
    
    element.innerHTML = spinnerHTML;
}

/**
 * Ocultar spinner de un elemento específico
 * @param {string} elementId - ID del elemento
 */
function hideElementSpinner(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Restaurar contenido original si existe
    if (element.dataset.originalContent) {
        element.innerHTML = element.dataset.originalContent;
        delete element.dataset.originalContent;
    }
}

/**
 * Mostrar spinner en un botón
 * @param {string|Element} button - ID del botón o elemento del botón
 * @param {string} message - Texto del botón mientras carga
 */
function showButtonSpinner(button, message = 'Procesando...') {
    const btn = typeof button === 'string' ? document.getElementById(button) : button;
    if (!btn) return;
    
    // Guardar estado original
    if (!btn.dataset.originalText) {
        btn.dataset.originalText = btn.innerHTML;
        btn.dataset.originalDisabled = btn.disabled;
    }
    
    // Agregar spinner y deshabilitar
    btn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        ${message}
    `;
    btn.disabled = true;
}

/**
 * Ocultar spinner de un botón
 * @param {string|Element} button - ID del botón o elemento del botón
 */
function hideButtonSpinner(button) {
    const btn = typeof button === 'string' ? document.getElementById(button) : button;
    if (!btn) return;
    
    // Restaurar estado original
    if (btn.dataset.originalText) {
        btn.innerHTML = btn.dataset.originalText;
        btn.disabled = btn.dataset.originalDisabled === 'true';
        delete btn.dataset.originalText;
        delete btn.dataset.originalDisabled;
    }
}

/**
 * Función auxiliar para obtener el colspan de una tabla
 * @param {Element} tbody - Elemento tbody
 * @returns {number} - Número de columnas
 */
function getTableColspan(tbody) {
    const table = tbody.closest('table');
    if (!table) return 8; // Default
    
    const headerRow = table.querySelector('thead tr');
    if (headerRow) {
        return headerRow.children.length;
    }
    
    // Si no hay header, buscar en la primera fila del tbody
    const firstRow = tbody.querySelector('tr');
    if (firstRow && firstRow.children.length > 0) {
        return firstRow.children.length;
    }
    
    return 8; // Default fallback
}

// =============================================
// FUNCIONES DE CONVENIENCIA
// =============================================

/**
 * Función wrapper para operaciones async con spinner
 * @param {Function} asyncOperation - Operación asíncrona a ejecutar
 * @param {string} message - Mensaje del spinner
 * @returns {Promise} - Resultado de la operación
 */
async function withSpinner(asyncOperation, message = 'Procesando...') {
    try {
        showSpinner(message);
        const result = await asyncOperation();
        return result;
    } finally {
        hideSpinner();
    }
}

/**
 * Función wrapper para operaciones async con spinner en elemento
 * @param {string} elementId - ID del elemento
 * @param {Function} asyncOperation - Operación asíncrona
 * @param {string} message - Mensaje del spinner
 * @returns {Promise} - Resultado de la operación
 */
async function withElementSpinner(elementId, asyncOperation, message = 'Cargando...') {
    try {
        showElementSpinner(elementId, message);
        const result = await asyncOperation();
        return result;
    } finally {
        hideElementSpinner(elementId);
    }
}

/**
 * Función wrapper para operaciones async con spinner en botón
 * @param {string|Element} button - Botón
 * @param {Function} asyncOperation - Operación asíncrona
 * @param {string} message - Mensaje del botón
 * @returns {Promise} - Resultado de la operación
 */
async function withButtonSpinner(button, asyncOperation, message = 'Procesando...') {
    try {
        showButtonSpinner(button, message);
        const result = await asyncOperation();
        return result;
    } finally {
        hideButtonSpinner(button);
    }
}

// =============================================
// EJEMPLOS DE USO
// =============================================

/*
// Uso básico
showSpinner('Cargando datos...');
// ... operación async
hideSpinner();

// Con wrapper
await withSpinner(async () => {
    const response = await apiRequest('/datos');
    return response;
}, 'Cargando datos...');

// Spinner en tabla
showElementSpinner('tabla-mercaderias', 'Cargando mercaderías...');
// ... cargar datos
hideElementSpinner('tabla-mercaderias');

// Spinner en botón
const btnGuardar = document.getElementById('btn-guardar');
showButtonSpinner(btnGuardar, 'Guardando...');
// ... operación de guardado
hideButtonSpinner(btnGuardar);

// Con wrapper de botón
await withButtonSpinner('btn-enviar', async () => {
    await enviarDatos();
}, 'Enviando...');
*/

console.log('✅ Funciones de spinner cargadas correctamente');


// =============================================
// ENVÍO PARCIAL - FUNCIÓN PRINCIPAL
// =============================================

/**
 * Función principal para iniciar el envío parcial
 * @param {number} detalleId - ID del detalle de la orden
 */
function enviarParcial(detalleId) {
    console.log('Iniciando envío parcial para detalle:', detalleId);
    
    if (!detalleId) {
        showAlert('ID de detalle no válido', 'danger');
        return;
    }
    
    if (!ordenActual || !ordenActual.orden) {
        showAlert('No hay orden seleccionada', 'danger');
        return;
    }
    
    // Abrir modal de envío parcial
    abrirModalEnvioParcial(detalleId);
}



/**
 * Procesa el envío parcial (CORREGIDO)
 */
async function procesarEnvioParcial() {
    try {
        // ✅ OBTENER Y VALIDAR datos del formulario
        const detalleId = document.getElementById('envio_detalle_id').value;
        const cantidadEnviada = document.getElementById('envio_cantidad').value;
        const numeroDocumento = document.getElementById('envio_documento').value.trim(); // Nombre correcto

        // ✅ VALIDACIONES ESTRICTAS
        if (!detalleId || isNaN(parseInt(detalleId))) {
            throw new Error('ID de detalle no válido');
        }

        if (!cantidadEnviada || isNaN(parseFloat(cantidadEnviada)) || parseFloat(cantidadEnviada) <= 0) {
            throw new Error('La cantidad debe ser un número mayor a 0');
        }

        // ✅ PREPARAR datos seguros
        const datosEnvio = {
            detalle_id: parseInt(detalleId),           // Asegurar que es entero
            cantidad_enviada: parseFloat(cantidadEnviada), // Asegurar que es decimal
            numero_documento: numeroDocumento || null
            // Nota: observaciones no disponible en este modal
        };

        console.log('📤 Enviando datos seguros:', datosEnvio);

        // Enviar al servidor
        const response = await apiRequest('/transferencias/enviar', 'POST', datosEnvio);

        if (response.success) {
            showAlert('Mercadería enviada exitosamente', 'success');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEnvioParcial'));
            if (modal) modal.hide();
            
            // Recargar orden
            await verDetallesOrden(ordenActual.orden.id);
            
        } else {
            throw new Error(response.message || 'Error del servidor');
        }

    } catch (error) {
        console.error('Error procesando envío:', error);
        showAlert('Error: ' + error.message, 'danger');
    }
}

// =============================================
// EVENT LISTENERS
// =============================================


// =============================================
// FUNCIONES AUXILIARES
// =============================================

/**
 * Valida si hay una orden actual cargada
 * @returns {boolean} - true si hay orden actual
 */
function validarOrdenActual() {
    if (!ordenActual || !ordenActual.orden) {
        showAlert('No hay orden seleccionada', 'danger');
        return false;
    }
    return true;
}

/**
 * Formatea la cantidad para mostrar
 * @param {number} cantidad - Cantidad a formatear
 * @returns {string} - Cantidad formateada
 */
function formatearCantidad(cantidad) {
    return parseFloat(cantidad || 0).toLocaleString('es-AR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
}

// ✅ FUNCIÓN DE VALIDACIÓN GENERAL para números
function validarNumero(valor, nombre = 'valor') {
    if (valor === null || valor === undefined || valor === '') {
        throw new Error(`${nombre} es obligatorio`);
    }
    
    const numero = parseFloat(valor);
    if (isNaN(numero)) {
        throw new Error(`${nombre} debe ser un número válido`);
    }
    
    return numero;
}

// ✅ EVENT LISTENERS seguros
document.addEventListener('DOMContentLoaded', function() {
    // Formulario de envío parcial
    const formEnvio = document.getElementById('formEnvioParcial');
    if (formEnvio) {
        formEnvio.addEventListener('submit', function(e) {
            e.preventDefault();
            procesarEnvioParcial();
        });
    }

    // Validación en tiempo real del campo cantidad
    const inputCantidad = document.getElementById('envio_cantidad');
    if (inputCantidad) {
        inputCantidad.addEventListener('blur', function() {
            try {
                validarNumero(this.value, 'Cantidad');
            } catch (error) {
                showAlert(error.message, 'warning');
                this.focus();
            }
        });
    }
});

function limpiarModalBackdrops() {
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
}

document.addEventListener('hidden.bs.modal', function() {
    setTimeout(limpiarModalBackdrops, 100);
});

function renderizarDetallesOrden(detalles) {
    const tbody = document.getElementById('tablaDetalleItems');
    if (!tbody) {
        console.error('❌ Tabla de detalles no encontrada');
        return;
    }

    tbody.innerHTML = '';

    if (!detalles || detalles.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                    No hay detalles para mostrar
                </td>
            </tr>
        `;
        return;
    }

    detalles.forEach(detalle => {
        const row = document.createElement('tr');
        
        // ✅ CALCULAR ESTADO CORRECTO DEL DETALLE
        const cantidadSolicitada = parseFloat(detalle.cantidad_solicitada) || 0;
        const cantidadEnviada = parseFloat(detalle.cantidad_enviada) || 0;
        const cantidadPendiente = cantidadSolicitada - cantidadEnviada;
        
        // Determinar estado visual basado en las cantidades reales
        let estadoDetalle, badgeClass, iconoEstado;
        
        if (cantidadEnviada >= cantidadSolicitada) {
            estadoDetalle = 'COMPLETADO';
            badgeClass = 'bg-success';
            iconoEstado = '<i class="fas fa-check-circle me-1"></i>';
        } else if (cantidadEnviada > 0) {
            estadoDetalle = 'PARCIAL';
            badgeClass = 'bg-warning text-dark';
            iconoEstado = '<i class="fas fa-clock me-1"></i>';
        } else {
            estadoDetalle = 'PENDIENTE';
            badgeClass = 'bg-secondary';
            iconoEstado = '<i class="fas fa-hourglass-start me-1"></i>';
        }

        // Calcular porcentaje de completado
        const porcentajeCompletado = cantidadSolicitada > 0 ? 
            Math.round((cantidadEnviada / cantidadSolicitada) * 100) : 0;

        row.innerHTML = `
            <td>
                <div class="fw-bold">${detalle.mercaderia_descripcion || detalle.descripcion || 'N/A'}</div>
                ${detalle.codigo_sku ? `<small class="text-muted">SKU: ${detalle.codigo_sku}</small>` : ''}
            </td>
            <td class="text-center">
                <span class="fw-bold">${cantidadSolicitada}</span>
            </td>
            <td class="text-center">
                <span class="fw-bold text-primary">${cantidadEnviada}</span>
                ${porcentajeCompletado > 0 ? 
                    `<div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar ${porcentajeCompletado === 100 ? 'bg-success' : 'bg-primary'}" 
                             style="width: ${porcentajeCompletado}%"></div>
                    </div>
                    <small class="text-muted">${porcentajeCompletado}%</small>` 
                    : ''
                }
            </td>
            <td class="text-center">
                <span class="${cantidadPendiente > 0 ? 'fw-bold text-warning' : 'text-muted'}">${cantidadPendiente}</span>
            </td>
            <td class="text-center">
                <span class="badge ${badgeClass}">
                    ${iconoEstado}${estadoDetalle}
                </span>
            </td>
            <td class="text-center">
                ${cantidadPendiente > 0 ? 
                    `<button class="btn btn-sm btn-primary" onclick="enviarMercaderia(${detalle.id})">
                        <i class="fas fa-shipping-fast me-1"></i> Enviar
                    </button>` : 
                    `<span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Completo
                    </span>`
                }
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function actualizarResumenOrden(orden, detalles) {
    try {
        console.log('📊 Actualizando resumen de orden:', orden?.id);
        
        // Calcular estadísticas reales basadas en detalles
        const totalItems = detalles?.length || 0;
        let itemsCompletados = 0;
        let itemsParciales = 0;
        let itemsPendientes = 0;
        let cantidadTotalSolicitada = 0;
        let cantidadTotalEnviada = 0;

        // Procesar cada detalle para calcular estadísticas
        if (detalles && detalles.length > 0) {
            detalles.forEach(detalle => {
                const solicitada = parseFloat(detalle.cantidad_solicitada) || 0;
                const enviada = parseFloat(detalle.cantidad_enviada) || 0;
                
                cantidadTotalSolicitada += solicitada;
                cantidadTotalEnviada += enviada;
                
                // Clasificar estado del item
                if (enviada >= solicitada) {
                    itemsCompletados++;
                } else if (enviada > 0) {
                    itemsParciales++;
                } else {
                    itemsPendientes++;
                }
            });
        }

        // Calcular porcentaje general de completado
        const porcentajeGeneral = cantidadTotalSolicitada > 0 ?
            Math.round((cantidadTotalEnviada / cantidadTotalSolicitada) * 100) : 0;

        // ========================================
        // ACTUALIZAR ELEMENTOS DEL DOM
        // ========================================

        // Función auxiliar para actualizar elementos de forma segura
        const actualizarElemento = (id, valor, tipo = 'text') => {
            const elemento = document.getElementById(id);
            if (elemento) {
                if (tipo === 'text') {
                    elemento.textContent = valor;
                } else if (tipo === 'html') {
                    elemento.innerHTML = valor;
                }
                return true;
            } else {
                console.warn(`⚠️ Elemento no encontrado: ${id}`);
                return false;
            }
        };

        // RESUMEN GENERAL
        actualizarElemento('resumen_total_items', totalItems);
        actualizarElemento('resumen_items_completados', itemsCompletados);
        actualizarElemento('resumen_items_parciales', itemsParciales);
        actualizarElemento('resumen_items_pendientes', itemsPendientes);

        // CANTIDADES
        actualizarElemento('resumen_cantidad_solicitada', cantidadTotalSolicitada.toFixed(2));
        actualizarElemento('resumen_cantidad_enviada', cantidadTotalEnviada.toFixed(2));
        actualizarElemento('resumen_cantidad_pendiente', (cantidadTotalSolicitada - cantidadTotalEnviada).toFixed(2));

        // PORCENTAJE CON BARRA DE PROGRESO
        actualizarElemento('resumen_porcentaje', `${porcentajeGeneral}%`);
        
        // Actualizar barra de progreso si existe
        const barraProgreso = document.getElementById('barra_progreso_orden');
        if (barraProgreso) {
            barraProgreso.style.width = `${porcentajeGeneral}%`;
            barraProgreso.setAttribute('aria-valuenow', porcentajeGeneral);
            
            // Cambiar color según progreso
            barraProgreso.className = 'progress-bar';
            if (porcentajeGeneral === 100) {
                barraProgreso.classList.add('bg-success');
            } else if (porcentajeGeneral >= 50) {
                barraProgreso.classList.add('bg-primary');
            } else if (porcentajeGeneral > 0) {
                barraProgreso.classList.add('bg-warning');
            } else {
                barraProgreso.classList.add('bg-secondary');
            }
        }

        // ESTADO GENERAL DE LA ORDEN
        const estadoOrden = orden?.estado || 'PENDIENTE';
        const badgeEstado = `
            <span class="badge ${getEstadoColorClass(estadoOrden)}">
                <i class="${getEstadoIcon(estadoOrden)} me-1"></i>
                ${estadoOrden}
            </span>
        `;
        actualizarElemento('resumen_estado_orden', badgeEstado, 'html');

        // INFORMACIÓN ADICIONAL DE LA ORDEN
        actualizarElemento('resumen_numero_orden', orden?.numero_orden || 'N/A');
        
        if (orden?.fecha_orden) {
            const fechaFormateada = new Date(orden.fecha_orden).toLocaleDateString('es-AR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            actualizarElemento('resumen_fecha_orden', fechaFormateada);
        }

        // DEPÓSITOS
        actualizarElemento('resumen_deposito_origen', orden?.deposito_origen_nombre || 'N/A');
        actualizarElemento('resumen_deposito_destino', orden?.deposito_destino_nombre || 'N/A');

        // ESTADÍSTICAS VISUALES CON BADGES
        const estadisticasHTML = `
            <div class="row text-center">
                <div class="col-3">
                    <div class="card border-success">
                        <div class="card-body py-2">
                            <h5 class="text-success mb-0">${itemsCompletados}</h5>
                            <small class="text-muted">Completados</small>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card border-warning">
                        <div class="card-body py-2">
                            <h5 class="text-warning mb-0">${itemsParciales}</h5>
                            <small class="text-muted">Parciales</small>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card border-secondary">
                        <div class="card-body py-2">
                            <h5 class="text-secondary mb-0">${itemsPendientes}</h5>
                            <small class="text-muted">Pendientes</small>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card border-primary">
                        <div class="card-body py-2">
                            <h5 class="text-primary mb-0">${porcentajeGeneral}%</h5>
                            <small class="text-muted">Progreso</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        actualizarElemento('estadisticas_visuales', estadisticasHTML, 'html');

        console.log('✅ Resumen actualizado:', {
            orden_id: orden?.id,
            total_items: totalItems,
            completados: itemsCompletados,
            parciales: itemsParciales,
            pendientes: itemsPendientes,
            porcentaje: porcentajeGeneral,
            cantidades: {
                solicitada: cantidadTotalSolicitada,
                enviada: cantidadTotalEnviada,
                pendiente: cantidadTotalSolicitada - cantidadTotalEnviada
            }
        });

    } catch (error) {
        console.error('❌ Error actualizando resumen:', error);
        showAlert('Error al actualizar resumen: ' + error.message, 'warning');
    }
}

function obtenerEstadoVisualDetalle(cantidadSolicitada, cantidadEnviada) {
    const solicitada = parseFloat(cantidadSolicitada) || 0;
    const enviada = parseFloat(cantidadEnviada) || 0;
    
    if (enviada >= solicitada) {
        return {
            estado: 'COMPLETADO',
            clase: 'success',
            icono: 'check-circle',
            color: 'text-success'
        };
    } else if (enviada > 0) {
        return {
            estado: 'PARCIAL',
            clase: 'warning',
            icono: 'clock',
            color: 'text-warning'
        };
    } else {
        return {
            estado: 'PENDIENTE',
            clase: 'secondary',
            icono: 'hourglass-start',
            color: 'text-muted'
        };
    }
}

function onEnvioExitoso() {
    // Recargar detalles para mostrar estado actualizado
    if (window.ordenActual && window.ordenActual.orden) {
        verDetallesOrden(window.ordenActual.orden.id);
    }
    
    // También recargar la lista principal
    if (typeof cargarTransferencias === 'function') {
        cargarTransferencias();
    }
}

function actualizarResumenDetalles(orden, detalles) {
    try {
        // Calcular estadísticas reales
        const totalItems = detalles?.length || 0;
        let itemsCompletados = 0;
        let itemsParciales = 0; 
        let itemsPendientes = 0;
        let cantidadTotalSolicitada = 0;
        let cantidadTotalEnviada = 0;

        if (detalles && detalles.length > 0) {
            detalles.forEach(detalle => {
                const solicitada = parseFloat(detalle.cantidad_solicitada) || 0;
                const enviada = parseFloat(detalle.cantidad_enviada) || 0;
                
                cantidadTotalSolicitada += solicitada;
                cantidadTotalEnviada += enviada;
                
                // Usar misma lógica que en la tabla
                if (enviada >= solicitada) {
                    itemsCompletados++;
                } else if (enviada > 0) {
                    itemsParciales++;
                } else {
                    itemsPendientes++;
                }
            });
        }

        // Actualizar elementos del resumen si existen
        const actualizarElemento = (id, valor) => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = valor;
            }
        };

        actualizarElemento('detalle_total_items', totalItems);
        actualizarElemento('detalle_cantidad_solicitada', cantidadTotalSolicitada.toFixed(2));
        actualizarElemento('detalle_cantidad_enviada', cantidadTotalEnviada.toFixed(2));
        
        // Calcular porcentaje general
        const porcentajeGeneral = cantidadTotalSolicitada > 0 ? 
            Math.round((cantidadTotalEnviada / cantidadTotalSolicitada) * 100) : 0;
        
        console.log('📊 Resumen calculado:', {
            orden_id: orden?.id,
            total_items: totalItems,
            completados: itemsCompletados,
            parciales: itemsParciales, 
            pendientes: itemsPendientes,
            porcentaje: porcentajeGeneral,
            solicitada: cantidadTotalSolicitada,
            enviada: cantidadTotalEnviada
        });

    } catch (error) {
        console.error('Error actualizando resumen:', error);
    }
}

function getEstadoColorClass(estado) {
    const estados = {
        'PENDIENTE': 'bg-secondary',
        'PARCIAL': 'bg-warning text-dark',
        'COMPLETADA': 'bg-success',
        'CANCELADA': 'bg-danger'
    };
    return estados[estado] || 'bg-secondary';
}

function getEstadoIcon(estado) {
    const iconos = {
        'PENDIENTE': 'fas fa-hourglass-start',
        'PARCIAL': 'fas fa-clock',
        'COMPLETADA': 'fas fa-check-circle',
        'CANCELADA': 'fas fa-times-circle'
    };
    return iconos[estado] || 'fas fa-question-circle';
}

// Función para formatear números con separador de miles
function formatearNumero(numero) {
    return new Intl.NumberFormat('es-AR').format(numero);
}

// ========================================
// SOLUCIÓN COMPLETA SIN LIBRERÍAS EXTERNAS
// Esta solución NO requiere jsPDF ni ninguna librería externa
// ========================================

/**
 * GENERAR DOCUMENTO DE ORDEN DE TRANSFERENCIA
 * Versión que funciona con impresión directa - NO requiere librerías
 */
async function generarDocumentoOrden(ordenId) {
    try {
        console.log('📄 Generando documento para orden:', ordenId);
        
        // Validar parámetros
        if (!ordenId) {
            showAlert('ID de orden no válido', 'warning');
            return;
        }
        
        showSpinner(); // Mostrar cargando
        
        let orden, detalles;
        
        // OPCIÓN 1: Intentar usar datos ya cargados
        if (window.ordenActual && 
            window.ordenActual.orden && 
            window.ordenActual.orden.id == ordenId) {
            
            console.log('✅ Usando datos ya cargados de window.ordenActual');
            orden = window.ordenActual.orden;
            detalles = window.ordenActual.detalles || [];
            
        } else {
            // OPCIÓN 2: Cargar datos desde la API
            console.log('🔄 Cargando datos desde la API...');
            
            const response = await apiRequest(`/transferencias/${ordenId}`);
            
            if (!response.success) {
                throw new Error('No se pudieron cargar los datos de la orden: ' + (response.message || 'Error desconocido'));
            }
            
            // Manejar diferentes estructuras de respuesta
            if (response.data.orden && response.data.detalles) {
                // Estructura: { data: { orden: {...}, detalles: [...] } }
                orden = response.data.orden;
                detalles = response.data.detalles;
            } else if (response.data.id) {
                // Estructura: { data: {...} } donde data ES la orden
                orden = response.data;
                detalles = response.data.detalles || [];
            } else {
                throw new Error('Estructura de datos no reconocida');
            }
            
            console.log('✅ Datos cargados desde API:', { orden: orden.id, detalles: detalles.length });
        }
        
        hideSpinner(); // Ocultar cargando
        
        // Verificar que tenemos los datos necesarios
        if (!orden) {
            throw new Error('No se encontraron datos de la orden');
        }
        
        if (!detalles || !Array.isArray(detalles)) {
            console.warn('⚠️ No hay detalles de productos, continuando con array vacío');
            detalles = [];
        }
        
        // Calcular totales
        let totalItems = detalles.length;
        let totalSolicitado = 0;
        let totalEnviado = 0;
        let itemsPendientes = 0;

        detalles.forEach(detalle => {
            const solicitada = parseFloat(detalle.cantidad_solicitada) || 0;
            const enviada = parseFloat(detalle.cantidad_enviada) || 0;
            
            totalSolicitado += solicitada;
            totalEnviado += enviada;
            
            if ((solicitada - enviada) > 0) {
                itemsPendientes++;
            }
        });

        const totalPendiente = totalSolicitado - totalEnviado;
        
        const totales = {
            totalItems,
            totalSolicitado,
            totalEnviado,
            totalPendiente,
            itemsPendientes
        };
        
        console.log('📊 Totales calculados:', totales);
        
        // Crear contenido HTML
        const contenidoHTML = crearDocumentoHTML(orden, detalles, totales);
        
        // Abrir ventana de impresión
        const ventanaImpresion = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
        
        if (!ventanaImpresion) {
            throw new Error('El navegador bloqueó la ventana emergente. Permite ventanas emergentes para este sitio.');
        }
        
        ventanaImpresion.document.write(contenidoHTML);
        ventanaImpresion.document.close();
        
        // Configurar eventos
        ventanaImpresion.onload = function() {
            setTimeout(() => {
                ventanaImpresion.print();
            }, 500);
        };
        
        ventanaImpresion.onafterprint = function() {
            const cerrar = confirm('¿Desea cerrar la ventana del documento?');
            if (cerrar) {
                ventanaImpresion.close();
            }
        };
        
        showAlert('Documento generado exitosamente', 'success');
        console.log('✅ Documento generado exitosamente');
        
    } catch (error) {
        console.error('❌ Error generando documento:', error);
        showAlert('Error al generar documento: ' + error.message, 'danger');
    } finally {
        hideSpinner(); // Asegurar que se oculte el spinner
    }
}

/**
 * GENERAR LISTA DE PREPARACIÓN (solo productos pendientes)
 */
async function generarListaPreparacion(ordenId) {
    try {
        console.log('📋 Generando lista de preparación para orden:', ordenId);
        
        if (!ordenId) {
            showAlert('ID de orden no válido', 'warning');
            return;
        }
        
        showSpinner();
        
        let orden, detalles;
        
        // Intentar usar datos ya cargados
        if (window.ordenActual && 
            window.ordenActual.orden && 
            window.ordenActual.orden.id == ordenId) {
            
            orden = window.ordenActual.orden;
            detalles = window.ordenActual.detalles || [];
            
        } else {
            // Cargar desde API
            const response = await apiRequest(`/transferencias/${ordenId}`);
            
            if (!response.success) {
                throw new Error('No se pudieron cargar los datos: ' + (response.message || 'Error desconocido'));
            }
            
            if (response.data.orden && response.data.detalles) {
                orden = response.data.orden;
                detalles = response.data.detalles;
            } else if (response.data.id) {
                orden = response.data;
                detalles = response.data.detalles || [];
            } else {
                throw new Error('Estructura de datos no reconocida');
            }
        }
        
        hideSpinner();
        
        // Filtrar solo productos pendientes
        const detallesPendientes = detalles.filter(detalle => {
            const solicitada = parseFloat(detalle.cantidad_solicitada) || 0;
            const enviada = parseFloat(detalle.cantidad_enviada) || 0;
            return (solicitada - enviada) > 0;
        });

        if (detallesPendientes.length === 0) {
            showAlert('No hay productos pendientes para preparar en esta orden', 'info');
            return;
        }

        // Crear contenido HTML
        const contenidoHTML = crearListaPreparacionHTML(orden, detallesPendientes);
        
        const ventanaImpresion = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
        
        if (!ventanaImpresion) {
            throw new Error('El navegador bloqueó la ventana emergente');
        }
        
        ventanaImpresion.document.write(contenidoHTML);
        ventanaImpresion.document.close();
        
        ventanaImpresion.onload = function() {
            setTimeout(() => {
                ventanaImpresion.print();
            }, 500);
        };
        
        showAlert(`Lista de preparación generada con ${detallesPendientes.length} productos pendientes`, 'success');
        
    } catch (error) {
        console.error('❌ Error generando lista de preparación:', error);
        showAlert('Error al generar lista de preparación: ' + error.message, 'danger');
    } finally {
        hideSpinner();
    }
}

/**
 * CREAR HTML COMPLETO PARA ORDEN DE TRANSFERENCIA
 */
function crearDocumentoHTML(orden, detalles, totales) {
    const fechaActual = new Date().toLocaleDateString('es-AR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    const horaActual = new Date().toLocaleTimeString('es-AR', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const fechaOrden = orden.fecha_orden ? 
        new Date(orden.fecha_orden).toLocaleDateString('es-AR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }) : 'No especificada';

    // Generar filas de productos
    const filasProductos = detalles.map((detalle, index) => {
        const solicitada = parseFloat(detalle.cantidad_solicitada) || 0;
        const enviada = parseFloat(detalle.cantidad_enviada) || 0;
        const pendiente = solicitada - enviada;
        
        // Color de fondo alternado para mejor lectura
        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
        
        // Color de estado
        let estadoColor = '#6c757d'; // Gris por defecto
        let estadoTexto = 'PENDIENTE';
        
        if (enviada >= solicitada) {
            estadoColor = '#28a745'; // Verde
            estadoTexto = 'COMPLETO';
        } else if (enviada > 0) {
            estadoColor = '#ffc107'; // Amarillo
            estadoTexto = 'PARCIAL';
        }

        return `
            <tr style="background-color: ${bgColor};">
                <td style="padding: 12px; text-align: center; font-weight: bold;">${index + 1}</td>
                <td style="padding: 12px;">
                    <div style="font-weight: bold; color: #2c3e50;">
                        ${detalle.mercaderia_descripcion || detalle.descripcion || 'Sin descripción'}
                    </div>
                    ${detalle.codigo_sku ? `<small style="color: #6c757d;">SKU: ${detalle.codigo_sku}</small>` : ''}
                </td>
                <td style="padding: 12px; text-align: center; font-size: 16px; font-weight: bold;">${solicitada}</td>
                <td style="padding: 12px; text-align: center; font-size: 16px; color: #28a745; font-weight: bold;">${enviada}</td>
                <td style="padding: 12px; text-align: center; font-size: 16px; color: ${pendiente > 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">${pendiente}</td>
                <td style="padding: 12px; text-align: center;">
                    <span style="background-color: ${estadoColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                        ${estadoTexto}
                    </span>
                </td>
                <td style="padding: 12px; text-align: center;">
                    <div style="width: 20px; height: 20px; border: 2px solid #333; margin: 0 auto;"></div>
                </td>
            </tr>
        `;
    }).join('');

    return `
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Orden de Transferencia - ${orden.numero_orden}</title>
            <style>
                @media print {
                    @page {
                        margin: 15mm;
                        size: A4;
                    }
                    body {
                        margin: 0;
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                    }
                    .no-print {
                        display: none !important;
                    }
                }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 12px;
                    line-height: 1.4;
                    color: #333;
                    max-width: 210mm;
                    margin: 0 auto;
                    padding: 10mm;
                    background-color: #fff;
                }
                
                .header {
                    text-align: center;
                    border-bottom: 3px solid #007bff;
                    padding-bottom: 15px;
                    margin-bottom: 25px;
                }
                
                .header h1 {
                    margin: 0;
                    font-size: 28px;
                    color: #007bff;
                    font-weight: bold;
                }
                
                .header h2 {
                    margin: 5px 0 0 0;
                    font-size: 20px;
                    color: #333;
                }
                
                .info-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 25px;
                }
                
                .info-box {
                    border: 2px solid #e9ecef;
                    border-radius: 8px;
                    padding: 15px;
                    background-color: #f8f9fa;
                }
                
                .info-box h3 {
                    margin: 0 0 10px 0;
                    font-size: 14px;
                    color: #007bff;
                    font-weight: bold;
                    text-transform: uppercase;
                    border-bottom: 1px solid #dee2e6;
                    padding-bottom: 5px;
                }
                
                .info-box p {
                    margin: 5px 0;
                    font-size: 13px;
                }
                
                .info-box .value {
                    font-weight: bold;
                    color: #2c3e50;
                }
                
                .products-section h3 {
                    font-size: 18px;
                    color: #2c3e50;
                    margin: 25px 0 15px 0;
                    padding: 10px 0;
                    border-bottom: 2px solid #007bff;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 25px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    border-radius: 8px;
                    overflow: hidden;
                }
                
                th {
                    background: linear-gradient(135deg, #007bff, #0056b3);
                    color: white;
                    font-weight: bold;
                    padding: 15px 8px;
                    text-align: center;
                    font-size: 12px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                td {
                    border: 1px solid #dee2e6;
                    vertical-align: middle;
                }
                
                .summary-box {
                    background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
                    border: 2px solid #007bff;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 25px 0;
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                }
                
                .summary-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 8px 0;
                    border-bottom: 1px solid #dee2e6;
                }
                
                .summary-item:last-child {
                    border-bottom: none;
                }
                
                .summary-label {
                    font-weight: bold;
                    color: #495057;
                }
                
                .summary-value {
                    font-size: 16px;
                    font-weight: bold;
                    color: #007bff;
                }
                
                .signatures {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 40px;
                    margin-top: 40px;
                }
                
                .signature-box {
                    text-align: center;
                    border: 2px solid #dee2e6;
                    border-radius: 8px;
                    padding: 20px;
                    background-color: #f8f9fa;
                }
                
                .signature-title {
                    font-weight: bold;
                    color: #2c3e50;
                    margin-bottom: 20px;
                    font-size: 14px;
                    text-transform: uppercase;
                }
                
                .signature-line {
                    border-bottom: 2px solid #333;
                    height: 40px;
                    margin: 20px 0 10px 0;
                }
                
                .observations {
                    background-color: #fff3cd;
                    border: 2px solid #ffc107;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 20px 0;
                }
                
                .observations h4 {
                    margin: 0 0 10px 0;
                    color: #856404;
                    font-size: 14px;
                    text-transform: uppercase;
                }
                
                .footer {
                    margin-top: 30px;
                    padding-top: 15px;
                    border-top: 1px solid #dee2e6;
                    text-align: center;
                    font-size: 10px;
                    color: #6c757d;
                }
                
                .no-print {
                    text-align: center;
                    margin: 20px 0;
                }
                
                .btn {
                    background-color: #007bff;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    margin: 0 5px;
                }
                
                .btn:hover {
                    background-color: #0056b3;
                }
                
                .btn-secondary {
                    background-color: #6c757d;
                }
                
                .btn-secondary:hover {
                    background-color: #545b62;
                }
            </style>
        </head>
        <body>
            <!-- Botones de control (no se imprimen) -->
            <div class="no-print">
                <button class="btn" onclick="window.print()">🖨️ Imprimir</button>
                <button class="btn btn-secondary" onclick="window.close()">❌ Cerrar</button>
            </div>
            
            <!-- Encabezado -->
            <div class="header">
                <h1>ORDEN DE TRANSFERENCIA</h1>
                <h2>${orden.numero_orden || 'Sin número'}</h2>
            </div>
            
            <!-- Información general -->
            <div class="info-grid">
                <div class="info-box">
                    <h3>📋 Información General</h3>
                    <p><strong>Estado:</strong> <span class="value">${orden.estado || 'PENDIENTE'}</span></p>
                    <p><strong>Fecha Orden:</strong> <span class="value">${fechaOrden}</span></p>
                    <p><strong>Fecha Generación:</strong> <span class="value">${fechaActual}</span></p>
                    <p><strong>Hora:</strong> <span class="value">${horaActual}</span></p>
                </div>
                
                <div class="info-box">
                    <h3>📦 Depósito Origen</h3>
                    <p class="value" style="font-size: 16px; text-align: center; margin-top: 20px;">
                        ${orden.deposito_origen_nombre || 'No especificado'}
                    </p>
                </div>
                
                <div class="info-box">
                    <h3>🎯 Depósito Destino</h3>
                    <p class="value" style="font-size: 16px; text-align: center; margin-top: 20px;">
                        ${orden.deposito_destino_nombre || 'No especificado'}
                    </p>
                </div>
            </div>
            
            <!-- Tabla de productos -->
            <div class="products-section">
                <h3>📦 PRODUCTOS A TRANSFERIR</h3>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 8%;">Item</th>
                            <th style="width: 42%;">Descripción del Producto</th>
                            <th style="width: 10%;">Solicitado</th>
                            <th style="width: 10%;">Enviado</th>
                            <th style="width: 10%;">Pendiente</th>
                            <th style="width: 10%;">Estado</th>
                            <th style="width: 10%;">Preparado ✓</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filasProductos}
                    </tbody>
                </table>
            </div>
            
            <!-- Resumen -->
            <div class="summary-box">
                <div>
                    <div class="summary-item">
                        <span class="summary-label">Total de Items:</span>
                        <span class="summary-value">${totales.totalItems}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Items Pendientes:</span>
                        <span class="summary-value">${totales.itemsPendientes}</span>
                    </div>
                </div>
                <div>
                    <div class="summary-item">
                        <span class="summary-label">Cantidad Total Solicitada:</span>
                        <span class="summary-value">${totales.totalSolicitado.toFixed(2)}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cantidad Total Enviada:</span>
                        <span class="summary-value">${totales.totalEnviado.toFixed(2)}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Cantidad Pendiente:</span>
                        <span class="summary-value" style="color: #dc3545;">${totales.totalPendiente.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Observaciones -->
            ${orden.observaciones ? `
                <div class="observations">
                    <h4>📝 Observaciones</h4>
                    <p>${orden.observaciones}</p>
                </div>
            ` : ''}
            
            <!-- Firmas -->
            <div class="signatures">
                <div class="signature-box">
                    <div class="signature-title">👤 PREPARADO POR</div>
                    <div class="signature-line"></div>
                    <p><strong>Nombre y Firma</strong></p>
                    <p>Fecha: ___/___/___ Hora: ___:___</p>
                </div>
                
                <div class="signature-box">
                    <div class="signature-title">✅ CONTROLADO POR</div>
                    <div class="signature-line"></div>
                    <p><strong>Nombre y Firma</strong></p>
                    <p>Fecha: ___/___/___ Hora: ___:___</p>
                </div>
            </div>
            
            <!-- Pie de página -->
            <div class="footer">
                <p>Documento generado automáticamente el ${fechaActual} a las ${horaActual}</p>
                <p>Sistema de Gestión de Transferencias</p>
            </div>
        </body>
        </html>
    `;
}

/**
 * CREAR HTML PARA LISTA DE PREPARACIÓN (solo productos pendientes)
 */
function crearListaPreparacionHTML(orden, detallesPendientes) {
    const fechaActual = new Date().toLocaleDateString('es-AR');
    const horaActual = new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });

    const filasProductos = detallesPendientes.map((detalle, index) => {
        const solicitada = parseFloat(detalle.cantidad_solicitada) || 0;
        const enviada = parseFloat(detalle.cantidad_enviada) || 0;
        const pendiente = solicitada - enviada;
        
        const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';

        return `
            <tr style="background-color: ${bgColor};">
                <td style="padding: 15px; text-align: center; font-weight: bold; font-size: 16px;">${index + 1}</td>
                <td style="padding: 15px;">
                    <div style="font-weight: bold; font-size: 14px; color: #2c3e50; margin-bottom: 5px;">
                        ${detalle.mercaderia_descripcion || detalle.descripcion || 'Sin descripción'}
                    </div>
                    ${detalle.codigo_sku ? `<div style="color: #6c757d; font-size: 12px;">SKU: ${detalle.codigo_sku}</div>` : ''}
                </td>
                <td style="padding: 15px; text-align: center; font-size: 18px; font-weight: bold; color: #dc3545;">${pendiente}</td>
                <td style="padding: 15px; text-align: center;">
                    <div style="width: 25px; height: 25px; border: 3px solid #333; margin: 0 auto;"></div>
                </td>
            </tr>
        `;
    }).join('');

    return `
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Lista de Preparación - ${orden.numero_orden}</title>
            <style>
                @media print {
                    @page { margin: 15mm; size: A4; }
                    body { margin: 0; -webkit-print-color-adjust: exact; }
                    .no-print { display: none !important; }
                }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 14px;
                    line-height: 1.4;
                    color: #333;
                    max-width: 210mm;
                    margin: 0 auto;
                    padding: 15mm;
                    background-color: #fff;
                }
                
                .header {
                    text-align: center;
                    border-bottom: 3px solid #28a745;
                    padding-bottom: 15px;
                    margin-bottom: 25px;
                }
                
                .header h1 {
                    margin: 0;
                    font-size: 24px;
                    color: #28a745;
                    font-weight: bold;
                }
                
                .info-row {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-bottom: 25px;
                    padding: 15px;
                    background-color: #e8f5e8;
                    border-radius: 8px;
                    border: 2px solid #28a745;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 25px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    border-radius: 8px;
                    overflow: hidden;
                }
                
                th {
                    background: linear-gradient(135deg, #28a745, #20c997);
                    color: white;
                    font-weight: bold;
                    padding: 15px;
                    text-align: center;
                    font-size: 14px;
                    text-transform: uppercase;
                }
                
                td {
                    border: 1px solid #dee2e6;
                    vertical-align: middle;
                }
                
                .footer {
                    margin-top: 30px;
                    padding: 20px;
                    background-color: #f8f9fa;
                    border-radius: 8px;
                    border: 2px solid #28a745;
                }
                
                .btn {
                    background-color: #28a745;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    margin: 0 5px;
                }
                
                .btn:hover {
                    background-color: #1e7e34;
                }
                
                .btn-secondary {
                    background-color: #6c757d;
                }
            </style>
        </head>
        <body>
            <!-- Botones de control -->
            <div class="no-print" style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="window.print()">🖨️ Imprimir Lista</button>
                <button class="btn btn-secondary" onclick="window.close()">❌ Cerrar</button>
            </div>
            
            <!-- Encabezado -->
            <div class="header">
                <h1>📋 LISTA DE PREPARACIÓN</h1>
                <h2 style="margin: 10px 0 0 0; color: #333;">Orden: ${orden.numero_orden || 'Sin número'}</h2>
            </div>
            
            <!-- Información -->
            <div class="info-row">
                <div>
                    <p><strong>📅 Fecha:</strong> ${fechaActual}</p>
                    <p><strong>🕐 Hora:</strong> ${horaActual}</p>
                    <p><strong>📦 Origen:</strong> ${orden.deposito_origen_nombre || 'No especificado'}</p>
                </div>
                <div>
                    <p><strong>📍 Estado:</strong> ${orden.estado || 'PENDIENTE'}</p>
                    <p><strong>🎯 Destino:</strong> ${orden.deposito_destino_nombre || 'No especificado'}</p>
                    <p><strong>📊 Total Items:</strong> ${detallesPendientes.length}</p>
                </div>
            </div>
            
            <!-- Tabla de productos -->
            <table>
                <thead>
                    <tr>
                        <th style="width: 10%;">Item</th>
                        <th style="width: 60%;">📦 Producto a Preparar</th>
                        <th style="width: 15%;">📊 Cantidad</th>
                        <th style="width: 15%;">✅ Preparado</th>
                    </tr>
                </thead>
                <tbody>
                    ${filasProductos}
                </tbody>
            </table>
            
            <!-- Pie con firmas -->
            <div class="footer">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <p><strong>👤 Preparado por:</strong></p>
                        <div style="border-bottom: 2px solid #333; height: 30px; margin: 10px 0;"></div>
                        <p style="text-align: center;">Nombre y Firma</p>
                    </div>
                    <div>
                        <p><strong>📅 Fecha y hora de preparación:</strong></p>
                        <div style="border-bottom: 2px solid #333; height: 30px; margin: 10px 0;"></div>
                        <p style="text-align: center;">___/___/___ - ___:___</p>
                    </div>
                </div>
            </div>
        </body>
        </html>
    `;
}

// ========================================
// FUNCIONES DE VERIFICACIÓN Y AYUDA
// ========================================

/**
 * Verificar estado del sistema de documentos
 */
function verificarSistemaDocumentos() {
    console.log('🔍 Verificando sistema de documentos...');
    
    const verificaciones = {
        ordenActual: !!window.ordenActual,
        datosOrden: !!(window.ordenActual?.orden),
        datosDetalles: !!(window.ordenActual?.detalles),
        ventanasEmergentes: true // Asumimos que están permitidas
    };
    
    console.log('📊 Estado del sistema:', verificaciones);
    
    if (verificaciones.ordenActual && verificaciones.datosOrden && verificaciones.datosDetalles) {
        console.log('✅ Sistema listo para generar documentos');
        return true;
    } else {
        console.warn('⚠️ Sistema no está completamente listo');
        return false;
    }
}

/**
 * Función de ayuda para solucionar problemas
 */
function ayudaDocumentos() {
    const mensaje = `
🆘 AYUDA - SISTEMA DE DOCUMENTOS

Si los documentos no se generan:

1️⃣ PERMITIR VENTANAS EMERGENTES
   - El navegador puede estar bloqueando ventanas emergentes
   - Busca el ícono de bloqueo en la barra de direcciones
   - Permite ventanas emergentes para este sitio

2️⃣ VERIFICAR DATOS
   - Abre una orden de transferencia primero
   - Asegúrate de que tiene productos cargados

3️⃣ CONSOLA DEL NAVEGADOR
   - Presiona F12 para abrir herramientas de desarrollador
   - Ve a la pestaña "Console"
   - Busca mensajes de error en rojo

4️⃣ NAVEGADORES COMPATIBLES
   - Chrome ✅
   - Firefox ✅  
   - Edge ✅
   - Safari ✅

¿Necesitas más ayuda? Revisa la consola del navegador.
    `;
    
    alert(mensaje);
    console.log(mensaje);
}

console.log('✅ Sistema de documentos SIN librerías externas cargado correctamente');
console.log('🔧 Funciones disponibles: generarDocumentoOrden(), generarListaPreparacion(), verificarSistemaDocumentos(), ayudaDocumentos()');

// =============================================
// 📝 FUNCIONES COMPLETAS PARA AJUSTE DE STOCK
// =============================================

/**
 * Función principal para abrir ajuste rápido desde el botón
 * @param {number} mercaderiaId - ID de la mercadería a ajustar
 * @param {number} depositoId - ID del depósito (opcional)
 */
async function abrirAjusteRapido(mercaderiaId, depositoId = null) {
    try {
        console.log('🔧 Abriendo ajuste rápido para mercadería:', mercaderiaId);
        
        // Cargar selectores primero
        await cargarSelectoresMercaderias('ajuste_mercaderia');
        await cargarSelectoresDepositos('ajuste_deposito');
        
        // Pre-seleccionar mercadería
        const selectMercaderia = document.getElementById('ajuste_mercaderia');
        if (selectMercaderia && mercaderiaId) {
            selectMercaderia.value = mercaderiaId;
            
            // Disparar evento change para que se actualice cualquier lógica dependiente
            selectMercaderia.dispatchEvent(new Event('change'));
        }
        
        // Pre-seleccionar depósito si se proporciona
        const selectDeposito = document.getElementById('ajuste_deposito');
        if (selectDeposito && depositoId) {
            selectDeposito.value = depositoId;
            selectDeposito.dispatchEvent(new Event('change'));
        }
        
        // Cargar stock actual si ambos están seleccionados
        if (mercaderiaId && (depositoId || selectDeposito.value)) {
            await cargarStockActualAjuste();
        }
        
        // Configurar eventos del modal
        configurarEventosModalAjuste();
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalAjuste'));
        modal.show();
        
        // Limpiar formulario excepto las selecciones pre-configuradas
        limpiarFormularioAjuste(false);
        
    } catch (error) {
        console.error('Error abriendo ajuste rápido:', error);
        showAlert('Error al abrir modal de ajuste: ' + error.message, 'danger');
    }
}

/**
 * Cargar stock actual para mostrar información contextual
 */
async function cargarStockActualAjuste() {
    const mercaderiaId = document.getElementById('ajuste_mercaderia').value;
    const depositoId = document.getElementById('ajuste_deposito').value;
    const infoDiv = document.getElementById('stock-actual-info');
    
    if (!mercaderiaId || !depositoId) {
        if (infoDiv) {
            infoDiv.innerHTML = '<small class="text-muted">Selecciona mercadería y depósito para ver stock actual</small>';
        }
        return;
    }

    try {
        // Mostrar loading
        if (infoDiv) {
            infoDiv.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin"></i> Cargando stock actual...</small>';
        }
        
        const response = await apiRequest(`/stock/verificar-disponibilidad?mercaderia_id=${mercaderiaId}&deposito_id=${depositoId}`);
        
        if (response.success) {
            const stockActual = response.data.cantidad_disponible || 0;
            const mercaderiaNombre = response.data.mercaderia_nombre || 'Mercadería';
            const depositoNombre = response.data.deposito_nombre || 'Depósito';
            
            if (infoDiv) {
                const claseStock = stockActual > 0 ? 'text-success' : 'text-warning';
                infoDiv.innerHTML = `
                    <div class="alert alert-info py-2 mb-0">
                        <small>
                            <strong>${mercaderiaNombre}</strong> en <strong>${depositoNombre}</strong><br>
                            Stock actual: <span class="${claseStock}"><strong>${stockActual} unidades</strong></span>
                        </small>
                    </div>
                `;
            }
            
            // Habilitar preview de cantidad
            configurarPreviewAjuste();
            
        } else {
            throw new Error(response.message || 'No se pudo verificar el stock');
        }
    } catch (error) {
        console.error('Error cargando stock actual:', error);
        if (infoDiv) {
            infoDiv.innerHTML = '<small class="text-danger">Error al cargar stock actual</small>';
        }
    }
}

/**
 * Configurar preview en tiempo real del ajuste
 */
function configurarPreviewAjuste() {
    const tipoSelect = document.getElementById('ajuste_tipo');
    const cantidadInput = document.getElementById('ajuste_cantidad');
    const previewDiv = document.getElementById('preview-ajuste');
    
    if (!tipoSelect || !cantidadInput || !previewDiv) return;
    
    const actualizar = () => {
        const tipo = tipoSelect.value;
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const stockActualText = document.querySelector('#stock-actual-info .text-success, #stock-actual-info .text-warning');
        const stockActual = stockActualText ? 
            parseInt(stockActualText.textContent.match(/\d+/)?.[0] || '0') : 0;
        
        if (tipo && cantidad > 0) {
            let nuevoStock = stockActual;
            let operacion = '';
            let claseResultado = '';
            
            switch (tipo) {
                case 'INCREMENTO':
                    nuevoStock = stockActual + cantidad;
                    operacion = `${stockActual} + ${cantidad}`;
                    claseResultado = 'text-success';
                    break;
                case 'DECREMENTO':
                    nuevoStock = Math.max(0, stockActual - cantidad);
                    operacion = `${stockActual} - ${cantidad}`;
                    claseResultado = nuevoStock < stockActual ? 'text-warning' : 'text-danger';
                    break;
                case 'CORRECCION':
                    nuevoStock = cantidad;
                    operacion = `Ajustado a`;
                    claseResultado = 'text-info';
                    break;
            }
            
            previewDiv.innerHTML = `
                <div class="alert alert-light border py-2 mb-0">
                    <small>
                        <strong>Preview:</strong> ${operacion} = 
                        <span class="${claseResultado}"><strong>${nuevoStock} unidades</strong></span>
                        ${nuevoStock === 0 ? '<br><span class="text-danger">⚠️ El stock quedará en cero</span>' : ''}
                    </small>
                </div>
            `;
        } else {
            previewDiv.innerHTML = '';
        }
    };
    
    // Agregar eventos
    tipoSelect.addEventListener('change', actualizar);
    cantidadInput.addEventListener('input', actualizar);
}

/**
 * Configurar todos los eventos del modal de ajuste
 */
function configurarEventosModalAjuste() {
    // Eventos para actualizar stock actual
    const selectMercaderia = document.getElementById('ajuste_mercaderia');
    const selectDeposito = document.getElementById('ajuste_deposito');
    
    if (selectMercaderia) {
        selectMercaderia.addEventListener('change', cargarStockActualAjuste);
    }
    
    if (selectDeposito) {
        selectDeposito.addEventListener('change', cargarStockActualAjuste);
    }
    
    // Eventos para preview
    configurarPreviewAjuste();
    
    // Validación en tiempo real
    const form = document.getElementById('formAjuste');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            guardarAjuste();
        });
    }
    
    // Evento para limpiar al cerrar modal
    const modal = document.getElementById('modalAjuste');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            limpiarFormularioAjuste(true);
        });
    }
}

/**
 * Limpiar formulario de ajuste
 * @param {boolean} completo - Si debe limpiar todo o mantener selecciones
 */
function limpiarFormularioAjuste(completo = true) {
    const form = document.getElementById('formAjuste');
    if (!form) return;
    
    // Campos que siempre se limpian
    const camposLimpiar = [
        'ajuste_cantidad',
        'ajuste_motivo', 
        'ajuste_observaciones'
    ];
    
    camposLimpiar.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.value = '';
    });
    
    // Si es limpieza completa, limpiar selectores también
    if (completo) {
        const selectores = ['ajuste_mercaderia', 'ajuste_deposito', 'ajuste_tipo'];
        selectores.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) elemento.value = '';
        });
    }
    
    // Limpiar info y preview
    const infoDiv = document.getElementById('stock-actual-info');
    const previewDiv = document.getElementById('preview-ajuste');
    
    if (infoDiv) infoDiv.innerHTML = '';
    if (previewDiv) previewDiv.innerHTML = '';
    
    // Remover clases de validación
    form.classList.remove('was-validated');
    const inputs = form.querySelectorAll('.is-invalid, .is-valid');
    inputs.forEach(input => {
        input.classList.remove('is-invalid', 'is-valid');
    });
}

/**
 * Función mejorada para guardar ajuste con validaciones
 */
async function guardarAjuste() {
    try {
        const form = document.getElementById('formAjuste');
        if (!form) {
            throw new Error('Formulario no encontrado');
        }
        
        // Validar formulario HTML5
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Obtener datos del formulario
        const datosAjuste = {
            mercaderia_id: parseInt(document.getElementById('ajuste_mercaderia').value),
            deposito_id: parseInt(document.getElementById('ajuste_deposito').value),
            tipo_ajuste: document.getElementById('ajuste_tipo').value,
            cantidad: parseFloat(document.getElementById('ajuste_cantidad').value),
            motivo: document.getElementById('ajuste_motivo').value.trim(),
            observaciones: document.getElementById('ajuste_observaciones').value.trim()
        };
        
        // Validaciones adicionales
        if (!datosAjuste.mercaderia_id || isNaN(datosAjuste.mercaderia_id)) {
            throw new Error('Debe seleccionar una mercadería');
        }
        
        if (!datosAjuste.deposito_id || isNaN(datosAjuste.deposito_id)) {
            throw new Error('Debe seleccionar un depósito');
        }
        
        if (!datosAjuste.tipo_ajuste) {
            throw new Error('Debe seleccionar un tipo de ajuste');
        }
        
        if (!datosAjuste.cantidad || datosAjuste.cantidad <= 0) {
            throw new Error('La cantidad debe ser mayor a 0');
        }
        
        if (!datosAjuste.motivo) {
            throw new Error('Debe especificar un motivo para el ajuste');
        }
        
        // Confirmar acción si es decremento grande
        if (datosAjuste.tipo_ajuste === 'DECREMENTO' && datosAjuste.cantidad > 100) {
            const confirmar = await mostrarConfirmacion(
                '¿Confirmar decremento?',
                `Está a punto de decrementar ${datosAjuste.cantidad} unidades. ¿Está seguro?`
            );
            if (!confirmar) return;
        }
        
        // Mostrar loading en botón
        const btnGuardar = document.querySelector('#modalAjuste .btn-primary');
        const textoOriginal = btnGuardar ? btnGuardar.textContent : 'Guardar';
        if (btnGuardar) {
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        }
        
        // Realizar petición
        const response = await apiRequest('/stock/ajustar', 'POST', datosAjuste);
        
        if (response.success) {
            showAlert(
                `Ajuste realizado exitosamente. Stock actualizado: ${response.cantidad_nueva} unidades`, 
                'success'
            );
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAjuste'));
            if (modal) modal.hide();
            
            // Recargar datos
            await Promise.all([
                cargarStockGeneral(),
                cargarEstadisticasStock ? cargarEstadisticasStock() : Promise.resolve()
            ]);
            
        } else {
            throw new Error(response.message || 'Error al ajustar stock');
        }
        
    } catch (error) {
        console.error('Error guardando ajuste:', error);
        showAlert('Error al ajustar stock: ' + error.message, 'danger');
    } finally {
        // Restaurar botón
        const btnGuardar = document.querySelector('#modalAjuste .btn-primary');
        if (btnGuardar) {
            btnGuardar.disabled = false;
            btnGuardar.textContent = 'Guardar Ajuste';
        }
    }
}

/**
 * Función auxiliar para mostrar confirmaciones
 */
function mostrarConfirmacion(titulo, mensaje) {
    return new Promise((resolve) => {
        if (typeof Swal !== 'undefined') {
            // Si tienes SweetAlert2
            Swal.fire({
                title: titulo,
                text: mensaje,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, continuar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                resolve(result.isConfirmed);
            });
        } else {
            // Fallback a confirm nativo
            resolve(confirm(`${titulo}\n\n${mensaje}`));
        }
    });
}

// =============================================
// 📝 INICIALIZACIÓN
// =============================================

// Configurar eventos cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 Inicializando funciones de ajuste de stock...');
    
    // Configurar eventos si el modal ya existe
    const modalAjuste = document.getElementById('modalAjuste');
    if (modalAjuste) {
        configurarEventosModalAjuste();
    }
    
    console.log('✅ Funciones de ajuste de stock inicializadas');
});

console.log('📦 Módulo de ajuste de stock cargado completamente');

// =============================================
// 📝 FUNCIONES COMPLETAS PARA TRANSFERIR STOCK
// =============================================

/**
 * Función principal para abrir transferencia rápida desde el botón
 * @param {number} mercaderiaId - ID de la mercadería a transferir
 * @param {number} depositoOrigenId - ID del depósito origen (opcional)
 */
async function abrirTransferenciaRapida(mercaderiaId, depositoOrigenId = null) {
    try {
        console.log('🔄 Abriendo transferencia rápida para mercadería:', mercaderiaId);
        
        // Cargar selectores primero
        await cargarSelectoresMercaderias('trans_mercaderia');
        await cargarSelectoresDepositos('trans_origen');
        await cargarSelectoresDepositos('trans_destino');
        
        // Pre-seleccionar mercadería
        const selectMercaderia = document.getElementById('trans_mercaderia');
        if (selectMercaderia && mercaderiaId) {
            selectMercaderia.value = mercaderiaId;
            selectMercaderia.dispatchEvent(new Event('change'));
        }
        
        // Pre-seleccionar depósito origen si se proporciona
        const selectOrigen = document.getElementById('trans_origen');
        if (selectOrigen && depositoOrigenId) {
            selectOrigen.value = depositoOrigenId;
            selectOrigen.dispatchEvent(new Event('change'));
        }
        
        // Verificar stock disponible si tenemos mercadería y origen
        if (mercaderiaId && (depositoOrigenId || selectOrigen.value)) {
            await verificarStockDisponible();
        }
        
        // Configurar eventos del modal
        configurarEventosModalTransferencia();
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalTransferencia'));
        modal.show();
        
        // Limpiar formulario excepto las selecciones pre-configuradas
        limpiarFormularioTransferencia(false);
        
    } catch (error) {
        console.error('Error abriendo transferencia rápida:', error);
        showAlert('Error al abrir modal de transferencia: ' + error.message, 'danger');
    }
}

/**
 * Verificar stock disponible para transferencias
 */
async function verificarStockDisponible() {
    const mercaderiaId = document.getElementById('trans_mercaderia').value;
    const depositoId = document.getElementById('trans_origen').value;
    const infoDiv = document.getElementById('stock-disponible-info');
    
    if (!mercaderiaId || !depositoId) {
        if (infoDiv) {
            infoDiv.innerHTML = '<small class="text-muted">Selecciona mercadería y depósito origen para ver stock disponible</small>';
        }
        return;
    }

    try {
        // Mostrar loading
        if (infoDiv) {
            infoDiv.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin"></i> Verificando stock disponible...</small>';
        }
        
        const response = await apiRequest(`/stock/verificar-disponibilidad?mercaderia_id=${mercaderiaId}&deposito_id=${depositoId}`);
        
        if (response.success) {
            const stockDisponible = response.data.cantidad_disponible || 0;
            const mercaderiaNombre = response.data.mercaderia_nombre || 'Mercadería';
            const depositoNombre = response.data.deposito_nombre || 'Depósito';
            
            if (infoDiv) {
                const claseStock = stockDisponible > 0 ? 'text-success' : 'text-danger';
                const iconoStock = stockDisponible > 0 ? 'fa-check-circle' : 'fa-exclamation-triangle';
                
                infoDiv.innerHTML = `
                    <div class="alert ${stockDisponible > 0 ? 'alert-success' : 'alert-warning'} py-2 mb-0">
                        <small>
                            <i class="fas ${iconoStock} me-1"></i>
                            <strong>${mercaderiaNombre}</strong> en <strong>${depositoNombre}</strong><br>
                            Stock disponible: <span class="${claseStock}"><strong>${stockDisponible} unidades</strong></span>
                            ${stockDisponible === 0 ? '<br><span class="text-danger">⚠️ No hay stock disponible para transferir</span>' : ''}
                        </small>
                    </div>
                `;
            }
            
            // Configurar máximo en el input de cantidad
            const cantidadInput = document.getElementById('trans_cantidad');
            if (cantidadInput) {
                cantidadInput.max = stockDisponible;
                cantidadInput.placeholder = `Máximo: ${stockDisponible}`;
                
                // Si ya hay una cantidad ingresada, verificar que no exceda el disponible
                if (cantidadInput.value && parseFloat(cantidadInput.value) > stockDisponible) {
                    cantidadInput.value = stockDisponible;
                }
            }
            
            // Habilitar preview
            configurarPreviewTransferencia();
            
        } else {
            throw new Error(response.message || 'No se pudo verificar el stock');
        }
    } catch (error) {
        console.error('Error verificando stock disponible:', error);
        if (infoDiv) {
            infoDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Error al verificar stock disponible</small>';
        }
    }
}

/**
 * Configurar preview en tiempo real de la transferencia
 */
function configurarPreviewTransferencia() {
    const origenSelect = document.getElementById('trans_origen');
    const destinoSelect = document.getElementById('trans_destino');
    const cantidadInput = document.getElementById('trans_cantidad');
    const previewDiv = document.getElementById('preview-transferencia');
    
    if (!origenSelect || !destinoSelect || !cantidadInput || !previewDiv) return;
    
    const actualizar = () => {
        const origen = origenSelect.options[origenSelect.selectedIndex]?.text || '';
        const destino = destinoSelect.options[destinoSelect.selectedIndex]?.text || '';
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const stockActualText = document.querySelector('#stock-disponible-info .text-success, #stock-disponible-info .text-danger');
        const stockDisponible = stockActualText ? 
            parseInt(stockActualText.textContent.match(/\d+/)?.[0] || '0') : 0;
        
        if (origen && destino && cantidad > 0) {
            let alertClass = 'alert-info';
            let mensaje = '';
            
            if (cantidad > stockDisponible) {
                alertClass = 'alert-danger';
                mensaje = '<br><span class="text-danger">⚠️ La cantidad excede el stock disponible</span>';
            } else if (origenSelect.value === destinoSelect.value) {
                alertClass = 'alert-warning';
                mensaje = '<br><span class="text-warning">⚠️ El origen y destino son el mismo depósito</span>';
            }
            
            previewDiv.innerHTML = `
                <div class="alert ${alertClass} py-2 mb-0">
                    <small>
                        <strong>Preview de transferencia:</strong><br>
                        <i class="fas fa-arrow-right me-1"></i>
                        Transferir <strong>${cantidad} unidades</strong> de <strong>${origen}</strong> a <strong>${destino}</strong>
                        ${mensaje}
                    </small>
                </div>
            `;
        } else {
            previewDiv.innerHTML = '';
        }
    };
    
    // Agregar eventos
    origenSelect.addEventListener('change', actualizar);
    destinoSelect.addEventListener('change', actualizar);
    cantidadInput.addEventListener('input', actualizar);
}

/**
 * Configurar todos los eventos del modal de transferencia
 */
function configurarEventosModalTransferencia() {
    // Eventos para verificar stock disponible
    const selectMercaderia = document.getElementById('trans_mercaderia');
    const selectOrigen = document.getElementById('trans_origen');
    
    if (selectMercaderia) {
        selectMercaderia.addEventListener('change', verificarStockDisponible);
    }
    
    if (selectOrigen) {
        selectOrigen.addEventListener('change', verificarStockDisponible);
    }
    
    // Eventos para preview
    configurarPreviewTransferencia();
    
    // Validación de depósitos diferentes
    const selectDestino = document.getElementById('trans_destino');
    if (selectOrigen && selectDestino) {
        const validarDepositosDiferentes = () => {
            if (selectOrigen.value && selectDestino.value && selectOrigen.value === selectDestino.value) {
                selectDestino.setCustomValidity('El depósito destino debe ser diferente al origen');
            } else {
                selectDestino.setCustomValidity('');
            }
        };
        
        selectOrigen.addEventListener('change', validarDepositosDiferentes);
        selectDestino.addEventListener('change', validarDepositosDiferentes);
    }
    
    // Validación de cantidad
    const cantidadInput = document.getElementById('trans_cantidad');
    if (cantidadInput) {
        cantidadInput.addEventListener('input', function() {
            const cantidad = parseFloat(this.value) || 0;
            const max = parseFloat(this.max) || 0;
            
            if (cantidad > max && max > 0) {
                this.setCustomValidity(`La cantidad no puede ser mayor al stock disponible (${max})`);
            } else {
                this.setCustomValidity('');
            }
        });
    }
    
    // Evento de submit del formulario
    const form = document.getElementById('formTransferencia');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            guardarTransferencia();
        });
    }
    
    // Evento para limpiar al cerrar modal
    const modal = document.getElementById('modalTransferencia');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            limpiarFormularioTransferencia(true);
        });
    }
}

/**
 * Limpiar formulario de transferencia
 * @param {boolean} completo - Si debe limpiar todo o mantener selecciones
 */
function limpiarFormularioTransferencia(completo = true) {
    const form = document.getElementById('formTransferencia');
    if (!form) return;
    
    // Campos que siempre se limpian
    const camposLimpiar = [
        'trans_cantidad',
        'trans_motivo',
        'trans_documento',
        'trans_observaciones'
    ];
    
    camposLimpiar.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.value = '';
    });
    
    // Si es limpieza completa, limpiar selectores también
    if (completo) {
        const selectores = ['trans_mercaderia', 'trans_origen', 'trans_destino'];
        selectores.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) elemento.value = '';
        });
    }
    
    // Limpiar info y preview
    const infoDiv = document.getElementById('stock-disponible-info');
    const previewDiv = document.getElementById('preview-transferencia');
    
    if (infoDiv) infoDiv.innerHTML = '';
    if (previewDiv) previewDiv.innerHTML = '';
    
    // Remover clases de validación
    form.classList.remove('was-validated');
    const inputs = form.querySelectorAll('.is-invalid, .is-valid');
    inputs.forEach(input => {
        input.classList.remove('is-invalid', 'is-valid');
        input.setCustomValidity('');
    });
}

/**
 * Función mejorada para abrir modal de transferencia
 */
async function abrirModalTransferencia() {
    try {
        // Cargar selectores
        await cargarSelectoresMercaderias('trans_mercaderia');
        await cargarSelectoresDepositos('trans_origen');
        await cargarSelectoresDepositos('trans_destino');
        
        // Configurar eventos
        configurarEventosModalTransferencia();
        
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('modalTransferencia'));
        modal.show();
        
        // Limpiar formulario
        limpiarFormularioTransferencia(true);
        
    } catch (error) {
        console.error('Error abriendo modal de transferencia:', error);
        showAlert('Error al abrir modal de transferencia: ' + error.message, 'danger');
    }
}

/**
 * Función mejorada para guardar transferencia con validaciones
 */
async function guardarTransferencia() {
    try {
        const form = document.getElementById('formTransferencia');
        if (!form) {
            throw new Error('Formulario no encontrado');
        }
        
        // Validar formulario HTML5
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Obtener datos del formulario
        const datosTransferencia = {
            mercaderia_id: parseInt(document.getElementById('trans_mercaderia').value),
            deposito_origen_id: parseInt(document.getElementById('trans_origen').value),
            deposito_destino_id: parseInt(document.getElementById('trans_destino').value),
            cantidad: parseFloat(document.getElementById('trans_cantidad').value),
            motivo: document.getElementById('trans_motivo').value.trim(),
            numero_documento: document.getElementById('trans_documento').value.trim(),
            observaciones: document.getElementById('trans_observaciones').value.trim()
        };
        
        // Validaciones adicionales
        if (!datosTransferencia.mercaderia_id || isNaN(datosTransferencia.mercaderia_id)) {
            throw new Error('Debe seleccionar una mercadería');
        }
        
        if (!datosTransferencia.deposito_origen_id || isNaN(datosTransferencia.deposito_origen_id)) {
            throw new Error('Debe seleccionar un depósito origen');
        }
        
        if (!datosTransferencia.deposito_destino_id || isNaN(datosTransferencia.deposito_destino_id)) {
            throw new Error('Debe seleccionar un depósito destino');
        }
        
        if (datosTransferencia.deposito_origen_id === datosTransferencia.deposito_destino_id) {
            throw new Error('El depósito origen debe ser diferente al destino');
        }
        
        if (!datosTransferencia.cantidad || datosTransferencia.cantidad <= 0) {
            throw new Error('La cantidad debe ser mayor a 0');
        }
        
        if (!datosTransferencia.motivo) {
            throw new Error('Debe especificar un motivo para la transferencia');
        }
        
        // Confirmar transferencia si es una cantidad grande
        if (datosTransferencia.cantidad > 50) {
            const confirmar = await mostrarConfirmacion(
                '¿Confirmar transferencia?',
                `Está a punto de transferir ${datosTransferencia.cantidad} unidades. ¿Está seguro?`
            );
            if (!confirmar) return;
        }
        
        // Mostrar loading en botón
        const btnGuardar = document.querySelector('#modalTransferencia .btn-primary');
        const textoOriginal = btnGuardar ? btnGuardar.textContent : 'Guardar';
        if (btnGuardar) {
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando transferencia...';
        }
        
        // Realizar petición
        const response = await apiRequest('/stock/transferir', 'POST', datosTransferencia);
        
        if (response.success) {
            showAlert(
                `Transferencia realizada exitosamente. ${datosTransferencia.cantidad} unidades transferidas de ${response.origen || 'origen'} a ${response.destino || 'destino'}`, 
                'success'
            );
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalTransferencia'));
            if (modal) modal.hide();
            
            // Recargar datos
            await Promise.all([
                cargarStockGeneral(),
                cargarEstadisticasStock ? cargarEstadisticasStock() : Promise.resolve()
            ]);
            
        } else {
            throw new Error(response.message || 'Error al realizar transferencia');
        }
        
    } catch (error) {
        console.error('Error guardando transferencia:', error);
        showAlert('Error al realizar transferencia: ' + error.message, 'danger');
    } finally {
        // Restaurar botón
        const btnGuardar = document.querySelector('#modalTransferencia .btn-primary');
        if (btnGuardar) {
            btnGuardar.disabled = false;
            btnGuardar.textContent = 'Realizar Transferencia';
        }
    }
}

/**
 * Función auxiliar para mostrar confirmaciones
 */
function mostrarConfirmacion(titulo, mensaje) {
    return new Promise((resolve) => {
        if (typeof Swal !== 'undefined') {
            // Si tienes SweetAlert2
            Swal.fire({
                title: titulo,
                text: mensaje,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, continuar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                resolve(result.isConfirmed);
            });
        } else {
            // Fallback a confirm nativo
            resolve(confirm(`${titulo}\n\n${mensaje}`));
        }
    });
}

/**
 * Función para filtrar depósitos destino excluyendo el origen seleccionado
 */
function filtrarDepositosDestino() {
    const selectOrigen = document.getElementById('trans_origen');
    const selectDestino = document.getElementById('trans_destino');
    
    if (!selectOrigen || !selectDestino) return;
    
    const origenId = selectOrigen.value;
    const destinoActual = selectDestino.value;
    
    // Restaurar todas las opciones
    Array.from(selectDestino.options).forEach(option => {
        option.style.display = '';
        option.disabled = false;
    });
    
    // Ocultar/deshabilitar el depósito origen
    if (origenId) {
        const opcionOrigen = selectDestino.querySelector(`option[value="${origenId}"]`);
        if (opcionOrigen) {
            opcionOrigen.style.display = 'none';
            opcionOrigen.disabled = true;
        }
        
        // Si el destino actual es igual al origen, resetear
        if (destinoActual === origenId) {
            selectDestino.value = '';
        }
    }
}

// =============================================
// 📝 INICIALIZACIÓN
// =============================================

// Configurar eventos cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔄 Inicializando funciones de transferencia de stock...');
    
    // Configurar eventos si el modal ya existe
    const modalTransferencia = document.getElementById('modalTransferencia');
    if (modalTransferencia) {
        configurarEventosModalTransferencia();
    }
    
    // Configurar filtrado de depósitos
    const selectOrigen = document.getElementById('trans_origen');
    if (selectOrigen) {
        selectOrigen.addEventListener('change', filtrarDepositosDestino);
    }
    
    console.log('✅ Funciones de transferencia de stock inicializadas');
});

console.log('📦 Módulo de transferencia de stock cargado completamente');

// Contador de caracteres para observaciones
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('trans_observaciones');
    if (textarea) {
        const maxLength = textarea.getAttribute('maxlength') || 500;
        
        // Crear contador
        const counter = document.createElement('div');
        counter.className = 'char-counter';
        counter.innerHTML = `<small>0 / ${maxLength} caracteres</small>`;
        textarea.parentNode.appendChild(counter);
        
        // Actualizar contador
        textarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            counter.innerHTML = `<small>${currentLength} / ${maxLength} caracteres</small>`;
            
            if (currentLength > maxLength * 0.9) {
                counter.style.color = '#dc3545';
            } else if (currentLength > maxLength * 0.7) {
                counter.style.color = '#ffc107';
            } else {
                counter.style.color = '#6c757d';
            }
        });
    }
});

// Auto-generar número de documento si está vacío
function generarNumeroDocumento() {
    const campoDocumento = document.getElementById('trans_documento');
    if (campoDocumento && !campoDocumento.value.trim()) {
        const fecha = new Date();
        const numero = `TRF-${fecha.getFullYear()}${(fecha.getMonth() + 1).toString().padStart(2, '0')}${fecha.getDate().toString().padStart(2, '0')}-${Date.now().toString().slice(-6)}`;
        campoDocumento.value = numero;
    }
}

// Llamar auto-generación cuando se entra al campo y está vacío
document.addEventListener('DOMContentLoaded', function() {
    const campoDocumento = document.getElementById('trans_documento');
    if (campoDocumento) {
        campoDocumento.addEventListener('focus', function() {
            if (!this.value.trim()) {
                generarNumeroDocumento();
            }
        });
    }
});

let filtroMovimientosTimeout;
function filtrarMovimientosDebounced() {
    clearTimeout(filtroMovimientosTimeout);
    filtroMovimientosTimeout = setTimeout(filtrarMovimientos, 500);
}

// ✅ Event listeners para aplicar filtros automáticamente
document.addEventListener('DOMContentLoaded', function() {
    // Filtros que se aplican inmediatamente al cambiar
    const filtrosInmediatos = [
        'filtro-tipo-movimiento',
        'filtro-deposito-movimientos', 
        'filtro-usuario-movimientos'
    ];
    
    filtrosInmediatos.forEach(filtroId => {
        const elemento = document.getElementById(filtroId);
        if (elemento) {
            elemento.addEventListener('change', filtrarMovimientos);
        }
    });
    
    // Filtros de búsqueda con debounce (para no sobrecargar el servidor)
    const filtrosBusqueda = [
        'buscar-mercaderia-movimientos',
        'filtro-documento-movimientos'
    ];
    
    filtrosBusqueda.forEach(filtroId => {
        const elemento = document.getElementById(filtroId);
        if (elemento) {
            elemento.addEventListener('input', filtrarMovimientosDebounced);
            elemento.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(filtroMovimientosTimeout);
                    filtrarMovimientos();
                }
            });
        }
    });
    
    // Filtros de fecha se aplican inmediatamente
    const filtrosFecha = [
        'fecha-desde-movimientos',
        'fecha-hasta-movimientos'
    ];
    
    filtrosFecha.forEach(filtroId => {
        const elemento = document.getElementById(filtroId);
        if (elemento) {
            elemento.addEventListener('change', filtrarMovimientos);
        }
    });
});

function mostrarModalDetalleMovimiento(movimiento) {
    // Remover modal existente si existe
    const existingModal = document.getElementById('modalDetalleMovimiento');
    if (existingModal) {
        existingModal.remove();
    }

    // Formatear fecha
    const fecha = new Date(movimiento.movimiento.fecha_movimiento);
    const fechaFormateada = fecha.toLocaleDateString('es-AR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    // Determinar clase del badge según tipo
    const tipoClases = {
        'COMPRA': 'bg-success',
        'VENTA': 'bg-primary',
        'TRANSFERENCIA': 'bg-info',
        'AJUSTE': 'bg-warning text-dark',
        'DEVOLUCION': 'bg-danger',
        'INCREMENTO': 'bg-success',
        'DECREMENTO': 'bg-warning text-dark'
    };

    const tipoClase = tipoClases[movimiento.movimiento.tipo_movimiento] || 'bg-secondary';

    // Crear HTML del modal
    const modalHtml = `
        <div class="modal fade" id="modalDetalleMovimiento" tabindex="-1" aria-labelledby="modalDetalleMovimientoLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalDetalleMovimientoLabel">
                            <i class="fas fa-exchange-alt me-2"></i>
                            Detalle del Movimiento #${movimiento.movimiento.id}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Información Principal -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-info-circle me-1"></i>Información Principal
                                </h6>
                                <dl class="row">
                                    <dt class="col-4">Fecha:</dt>
                                    <dd class="col-8">${fechaFormateada}</dd>
                                    
                                    <dt class="col-4">Tipo:</dt>
                                    <dd class="col-8">
                                        <span class="badge ${tipoClase}">${movimiento.movimiento.tipo_movimiento}</span>
                                        ${movimiento.movimiento.categoria_movimiento ? `<br><small class="text-muted">${movimiento.movimiento.categoria_movimiento}</small>` : ''}
                                    </dd>
                                    
                                    <dt class="col-4">Cantidad:</dt>
                                    <dd class="col-8">
                                        <strong class="text-primary fs-5">${movimiento.movimiento.cantidad}</strong>
                                    </dd>
                                    
                                    <dt class="col-4">Precio Unit.:</dt>
                                    <dd class="col-8">
                                        ${movimiento.movimiento.precio_unitario ? 
                                            `$${parseFloat(movimiento.movimiento.precio_unitario).toLocaleString('es-AR')}` : 
                                            '<span class="text-muted">No especificado</span>'
                                        }
                                    </dd>
                                    
                                    <dt class="col-4">Valor Total:</dt>
                                    <dd class="col-8">
                                        <strong class="text-success">
                                            $${parseFloat(movimiento.movimiento.valor_total || 0).toLocaleString('es-AR')}
                                        </strong>
                                    </dd>
                                </dl>
                            </div>
                            
                            <!-- Información de Mercadería y Depósitos -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-box me-1"></i>Mercadería y Ubicación
                                </h6>
                                <dl class="row">
                                    <dt class="col-4">Mercadería:</dt>
                                    <dd class="col-8">
                                        <strong>${movimiento.movimiento.mercaderia_descripcion || movimiento.movimiento.descripcion}</strong>
                                        <br><code class="small">${movimiento.movimiento.codigo_sku}</code>
                                        ${movimiento.movimiento.categoria ? `<br><small class="text-muted">${movimiento.movimiento.categoria}</small>` : ''}
                                    </dd>
                                    
                                    ${movimiento.movimiento.deposito_origen_nombre ? `
                                    <dt class="col-4">Origen:</dt>
                                    <dd class="col-8">
                                        <i class="fas fa-warehouse me-1 text-muted"></i>
                                        ${movimiento.movimiento.deposito_origen_nombre}
                                        ${movimiento.movimiento.deposito_origen_tipo ? `<br><small class="text-muted">${movimiento.movimiento.deposito_origen_tipo}</small>` : ''}
                                    </dd>
                                    ` : ''}
                                    
                                    ${movimiento.movimiento.deposito_destino_nombre ? `
                                    <dt class="col-4">Destino:</dt>
                                    <dd class="col-8">
                                        <i class="fas fa-warehouse me-1 text-muted"></i>
                                        ${movimiento.movimiento.deposito_destino_nombre}
                                        ${movimiento.movimiento.deposito_destino_tipo ? `<br><small class="text-muted">${movimiento.movimiento.deposito_destino_tipo}</small>` : ''}
                                    </dd>
                                    ` : ''}
                                    
                                    ${movimiento.movimiento.usuario_nombre ? `
                                    <dt class="col-4">Usuario:</dt>
                                    <dd class="col-8">
                                        <i class="fas fa-user me-1 text-muted"></i>
                                        ${movimiento.movimiento.usuario_nombre}
                                    </dd>
                                    ` : ''}
                                </dl>
                            </div>
                        </div>
                        
                        <!-- Información Adicional -->
                        ${movimiento.movimiento.motivo || movimiento.movimiento.numero_documento || movimiento.movimiento.observaciones ? `
                        <hr>
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-clipboard me-1"></i>Información Adicional
                        </h6>
                        <dl class="row">
                            ${movimiento.movimiento.motivo ? `
                            <dt class="col-sm-3">Motivo:</dt>
                            <dd class="col-sm-9">${movimiento.movimiento.motivo}</dd>
                            ` : ''}
                            
                            ${movimiento.movimiento.numero_documento ? `
                            <dt class="col-sm-3">Documento:</dt>
                            <dd class="col-sm-9">
                                <code>${movimiento.movimiento.numero_documento}</code>
                            </dd>
                            ` : ''}
                            
                            ${movimiento.movimiento.observaciones ? `
                            <dt class="col-sm-3">Observaciones:</dt>
                            <dd class="col-sm-9">${movimiento.movimiento.observaciones}</dd>
                            ` : ''}
                        </dl>
                        ` : ''}
                        
                        <!-- Stock Context (si está disponible) -->
                        ${movimiento.stock_context && movimiento.stock_context.stock_actual_por_deposito ? `
                        <hr>
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-chart-bar me-1"></i>Stock Actual de esta Mercadería
                        </h6>
                        <div class="row">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Depósito</th>
                                                <th>Tipo</th>
                                                <th class="text-end">Stock</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${movimiento.stock_context.stock_actual_por_deposito.map(stock => `
                                                <tr>
                                                    <td>${stock.deposito_nombre}</td>
                                                    <td><span class="badge bg-light text-dark">${stock.deposito_tipo}</span></td>
                                                    <td class="text-end">
                                                        <strong class="${stock.stock_actual > 0 ? 'text-success' : 'text-muted'}">
                                                            ${stock.stock_actual}
                                                        </strong>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cerrar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="duplicarMovimiento(${movimiento.id})">
                            <i class="fas fa-copy me-1"></i>Duplicar
                        </button>
                        ${movimiento.tipo_movimiento !== 'COMPRA' ? `
                        <button type="button" class="btn btn-warning" onclick="anularMovimiento(${movimiento.id})">
                            <i class="fas fa-ban me-1"></i>Anular
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;

    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalDetalleMovimiento'));
    modal.show();

    // Limpiar modal del DOM cuando se cierre
    document.getElementById('modalDetalleMovimiento').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
    
    // Ocultar alerta de loading
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.textContent.includes('Cargando detalle')) {
                alert.remove();
            }
        });
    }, 500);
}

// ✅ AGREGAR función auxiliar para imprimir (si no existe)
function imprimirMovimiento(movimientoId) {
    console.log('Imprimiendo movimiento:', movimientoId);
    showAlert('Funcionalidad de impresión en desarrollo', 'info');
}

// =============================================
// FUNCIONES PRINCIPALES DE CATEGORÍAS
// =============================================

// Cargar categorías desde la API
async function cargarCategorias() {
    try {
        showSpinner();
        console.log('🔄 Cargando categorías...');
        
        const response = await apiRequest('/categorias');
        
        if (response.success) {
            categorias = response.data || [];
            categoriasFiltradas = [...categorias];
            
            console.log(`✅ Categorías cargadas: ${categorias.length}`);
            mostrarCategorias();
            actualizarInfoFiltrosCategorias();
        } else {
            throw new Error(response.message || 'Error al cargar categorías');
        }
    } catch (error) {
        console.error('❌ Error cargando categorías:', error);
        showAlert('Error al cargar categorías: ' + error.message, 'danger');
        categorias = [];
        categoriasFiltradas = [];
        mostrarCategorias();
    } finally {
        hideSpinner();
    }
}

// Mostrar categorías en la tabla
function mostrarCategorias() {
    const tbody = document.getElementById('tabla-categorias');
    if (!tbody) return;

    if (!categoriasFiltradas || categoriasFiltradas.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-inbox me-2"></i>
                    No hay categorías disponibles
                </td>
            </tr>
        `;
        return;
    }

    // Paginación
    const inicio = (paginaActualCategorias - 1) * categoriasPorPagina;
    const fin = inicio + categoriasPorPagina;
    const categoriasPagina = categoriasFiltradas.slice(inicio, fin);

    tbody.innerHTML = categoriasPagina.map(categoria => {
        const fechaCreacion = categoria.fecha_creacion ? 
            new Date(categoria.fecha_creacion).toLocaleDateString('es-AR') : 'N/A';
        
        const fechaModificacion = categoria.ultima_modificacion ? 
            new Date(categoria.ultima_modificacion).toLocaleDateString('es-AR') : 'N/A';

        const estadoBadge = categoria.activo == 1 ? 
            '<span class="badge bg-success">Activa</span>' : 
            '<span class="badge bg-secondary">Inactiva</span>';

        const mercaderiasCount = categoria.total_mercaderias || categoria.mercaderias_count || 0;
        const mercaderiasActivas = categoria.mercaderias_activas || 0;

        return `
            <tr>
                <td><strong>#${categoria.id}</strong></td>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-tag me-2 text-primary"></i>
                        <div>
                            <strong>${categoria.categoria}</strong>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-info">${mercaderiasCount} total</span>
                    ${mercaderiasActivas > 0 ? `<br><small class="text-muted">${mercaderiasActivas} activas</small>` : ''}
                </td>
                <td>${estadoBadge}</td>
                <td><small class="text-muted">${fechaCreacion}</small></td>
                <td><small class="text-muted">${fechaModificacion}</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button type="button" 
                                class="btn btn-outline-primary" 
                                onclick="editarCategoria(${categoria.id})"
                                title="Editar categoría">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-${categoria.activo == 1 ? 'warning' : 'success'}" 
                                onclick="toggleCategoriaActiva(${categoria.id}, ${categoria.activo == 1})"
                                title="${categoria.activo == 1 ? 'Desactivar' : 'Activar'} categoría">
                            <i class="fas fa-${categoria.activo == 1 ? 'ban' : 'check'}"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-danger" 
                                onclick="eliminarCategoria(${categoria.id})"
                                title="Eliminar categoría"
                                ${mercaderiasCount > 0 ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    // Actualizar paginación si es necesario
    actualizarPaginacionCategorias();
}

// Aplicar filtros
async function aplicarFiltrosCategorias() {
    try {
        const busqueda = document.getElementById('filtro-categoria-busqueda')?.value.trim().toLowerCase() || '';
        const activo = document.getElementById('filtro-categoria-activo')?.value || '';

        categoriasFiltradas = categorias.filter(categoria => {
            let cumpleFiltros = true;

            // Filtro de búsqueda
            if (busqueda) {
                const textosBusqueda = [
                    categoria.categoria?.toLowerCase() || '',
                    categoria.id?.toString() || ''
                ];
                cumpleFiltros = cumpleFiltros && textosBusqueda.some(texto => texto.includes(busqueda));
            }

            // Filtro de estado activo
            if (activo !== '') {
                cumpleFiltros = cumpleFiltros && (categoria.activo == activo);
            }

            return cumpleFiltros;
        });

        paginaActualCategorias = 1;
        mostrarCategorias();
        actualizarInfoFiltrosCategorias();
    } catch (error) {
        console.error('Error aplicando filtros:', error);
        showAlert('Error al aplicar filtros', 'danger');
    }
}

// Limpiar filtros
function limpiarFiltrosCategorias() {
    document.getElementById('filtro-categoria-busqueda').value = '';
    document.getElementById('filtro-categoria-activo').value = '';
    
    categoriasFiltradas = [...categorias];
    paginaActualCategorias = 1;
    mostrarCategorias();
    actualizarInfoFiltrosCategorias();
}

// Actualizar información de filtros
function actualizarInfoFiltrosCategorias() {
    const infoElement = document.getElementById('info-filtros-categorias');
    if (!infoElement) return;

    const total = categorias.length;
    const filtradas = categoriasFiltradas.length;
    
    if (filtradas === total) {
        infoElement.textContent = `Mostrando todas las categorías (${total})`;
    } else {
        infoElement.textContent = `Mostrando ${filtradas} de ${total} categorías`;
    }
}

// =============================================
// FUNCIONES DE MODAL Y CRUD
// =============================================

// Limpiar formulario de categoría
function limpiarFormularioCategoria() {
    const form = document.getElementById('formCategoria');
    if (form) {
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById('categoria_id').value = '';
        
        // Remover clases de validación
        const inputs = form.querySelectorAll('.is-invalid, .is-valid');
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        
        // Activar por defecto
        document.getElementById('categoria_activo').checked = true;
    }
}

// Abrir modal para nueva categoría
function abrirModalCategoria() {
    limpiarFormularioCategoria();
    
    document.getElementById('modalCategoriaTitle').innerHTML = '<i class="fas fa-tags me-2"></i>Nueva Categoría';
    document.getElementById('btnGuardarCategoriaText').textContent = 'Crear Categoría';
    document.getElementById('categoria_activo').checked = true;
    
    const modal = new bootstrap.Modal(document.getElementById('modalCategoria'));
    modal.show();
    
    // Enfocar primer campo
    setTimeout(() => {
        document.getElementById('categoria_nombre').focus();
    }, 300);
}

// Editar categoría
async function editarCategoria(id) {
    try {
        const response = await apiRequest(`/categorias/${id}`);
        
        if (!response.success) {
            showAlert('Error al cargar la categoría', 'danger');
            return;
        }
        
        const categoria = response.data;
        
        limpiarFormularioCategoria();
        
        document.getElementById('categoria_id').value = categoria.id;
        document.getElementById('categoria_nombre').value = categoria.categoria || '';
        document.getElementById('categoria_activo').checked = categoria.activo == 1;
        
        document.getElementById('modalCategoriaTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Categoría';
        document.getElementById('btnGuardarCategoriaText').textContent = 'Actualizar Categoría';
        
        const modal = new bootstrap.Modal(document.getElementById('modalCategoria'));
        modal.show();
        
        setTimeout(() => {
            document.getElementById('categoria_nombre').focus();
            document.getElementById('categoria_nombre').select();
        }, 300);
        
    } catch (error) {
        console.error('Error editando categoría:', error);
        
        // Fallback: buscar en datos locales
        if (typeof categorias !== 'undefined') {
            const categoria = categorias.find(c => c.id == id);
            if (categoria) {
                limpiarFormularioCategoria();
                
                document.getElementById('categoria_id').value = categoria.id;
                document.getElementById('categoria_nombre').value = categoria.categoria || '';
                document.getElementById('categoria_activo').checked = categoria.activo == 1;
                
                document.getElementById('modalCategoriaTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Categoría';
                document.getElementById('btnGuardarCategoriaText').textContent = 'Actualizar Categoría';
                
                const modal = new bootstrap.Modal(document.getElementById('modalCategoria'));
                modal.show();
                
                setTimeout(() => {
                    document.getElementById('categoria_nombre').focus();
                    document.getElementById('categoria_nombre').select();
                }, 300);
            } else {
                showAlert('Error al cargar los datos de la categoría', 'danger');
            }
        }
    }
}

// Guardar categoría (crear o actualizar)
async function guardarCategoria() {
    try {
        const form = document.getElementById('formCategoria');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const categoriaId = document.getElementById('categoria_id').value;
        const isEditing = categoriaId !== '';

        const categoriaData = {
            categoria: document.getElementById('categoria_nombre').value.trim(),
            activo: document.getElementById('categoria_activo').checked ? 1 : 0
        };

        // Validaciones adicionales
        if (!categoriaData.categoria) {
            showAlert('El nombre de la categoría es requerido', 'warning');
            document.getElementById('categoria_nombre').focus();
            return;
        }

        if (categoriaData.categoria.length < 2) {
            showAlert('El nombre de la categoría debe tener al menos 2 caracteres', 'warning');
            document.getElementById('categoria_nombre').focus();
            return;
        }

        if (categoriaData.categoria.length > 255) {
            showAlert('El nombre de la categoría no puede exceder 255 caracteres', 'warning');
            document.getElementById('categoria_nombre').focus();
            return;
        }

        // Verificar duplicados (excluyendo la misma categoría si estamos editando)
        const categoriaExistente = categorias.find(c => 
            c.categoria.toLowerCase() === categoriaData.categoria.toLowerCase() && 
            c.id != categoriaId
        );
        
        if (categoriaExistente) {
            showAlert('Ya existe una categoría con ese nombre', 'warning');
            document.getElementById('categoria_nombre').focus();
            return;
        }

        showSpinner();

        const url = isEditing ? `/categorias/${categoriaId}` : '/categorias';
        const method = isEditing ? 'PUT' : 'POST';
        
        const response = await apiRequest(url, method, categoriaData);

        if (response.success) {
            showAlert(
                isEditing ? 'Categoría actualizada exitosamente' : 'Categoría creada exitosamente', 
                'success'
            );
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCategoria'));
            if (modal) modal.hide();
            
            limpiarFormularioCategoria();
            await cargarCategorias();
            
            // Recargar selectores de categorías en otros módulos
            if (typeof cargarSelectoresCategorias === 'function') {
                cargarSelectoresCategorias();
            }
        } else {
            throw new Error(response.message || 'Error al guardar categoría');
        }
    } catch (error) {
        console.error('Error guardando categoría:', error);
        showAlert('Error al guardar categoría: ' + error.message, 'danger');
    } finally {
        hideSpinner();
    }
}

// Eliminar categoría
async function eliminarCategoria(id) {
    // Verificar si tiene mercaderías
    const categoria = categorias.find(c => c.id == id);
    const mercaderiasCount = categoria ? (categoria.total_mercaderias || categoria.mercaderias_count || 0) : 0;
    
    if (mercaderiasCount > 0) {
        showAlert('No se puede eliminar la categoría porque tiene mercaderías asignadas', 'warning');
        return;
    }
    
    if (!confirm('¿Estás seguro de que quieres eliminar esta categoría? Esta acción no se puede deshacer.')) {
        return;
    }
    
    try {
        showSpinner();
        const response = await apiRequest(`/categorias/${id}`, 'DELETE');
        
        if (response.success) {
            showAlert('Categoría eliminada exitosamente', 'success');
            await cargarCategorias();
            
            // Recargar selectores de categorías en otros módulos
            if (typeof cargarSelectoresCategorias === 'function') {
                cargarSelectoresCategorias();
            }
        } else {
            showAlert(response.message || 'Error al eliminar categoría', 'danger');
        }
    } catch (error) {
        console.error('Error eliminando categoría:', error);
        showAlert('Error al eliminar categoría: ' + error.message, 'danger');
    } finally {
        hideSpinner();
    }
}

// Toggle activo/inactivo
async function toggleCategoriaActiva(id, estadoActual) {
    const nuevoEstado = !estadoActual;
    const accion = nuevoEstado ? 'activar' : 'desactivar';
    
    if (!confirm(`¿Estás seguro de que quieres ${accion} esta categoría?`)) {
        return;
    }
    
    try {
        showSpinner();
        const response = await apiRequest(`/categorias/${id}`, 'PUT', { activo: nuevoEstado ? 1 : 0 });
        
        if (response.success) {
            showAlert(`Categoría ${accion === 'activar' ? 'activada' : 'desactivada'} exitosamente`, 'success');
            await cargarCategorias();
            
            // Recargar selectores de categorías en otros módulos
            if (typeof cargarSelectoresCategorias === 'function') {
                cargarSelectoresCategorias();
            }
        } else {
            showAlert(response.message || `Error al ${accion} categoría`, 'danger');
        }
    } catch (error) {
        console.error(`Error ${accion} categoría:`, error);
        showAlert(`Error al ${accion} categoría: ` + error.message, 'danger');
    } finally {
        hideSpinner();
    }
}
// =============================================
// FUNCIONES AUXILIARES
// =============================================

// Actualizar función de carga de página para incluir categorías
function mostrarPaginaCategorias() {
    cargarCategorias();
}

// Actualizar categorías (alias para cargarCategorias)
function actualizarCategorias() {
    cargarCategorias();
}

// Función para paginación (si se necesita)
function actualizarPaginacionCategorias() {
    // Implementar si se necesita paginación
    // Similar al patrón usado en otras páginas
}

// Exportar categorías (función básica)
function exportarCategorias() {
    try {
        const datosExportar = categoriasFiltradas.map(categoria => ({
            ID: categoria.id,
            Categoría: categoria.categoria,
            Estado: categoria.activo == 1 ? 'Activa' : 'Inactiva',
            'Total Mercaderías': categoria.total_mercaderias || 0,
            'Mercaderías Activas': categoria.mercaderias_activas || 0,
            'Fecha Creación': categoria.fecha_creacion ? new Date(categoria.fecha_creacion).toLocaleDateString('es-AR') : '',
            'Última Modificación': categoria.ultima_modificacion ? new Date(categoria.ultima_modificacion).toLocaleDateString('es-AR') : ''
        }));

        const csv = [
            Object.keys(datosExportar[0]).join(','),
            ...datosExportar.map(row => Object.values(row).join(','))
        ].join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `categorias_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showAlert('Categorías exportadas exitosamente', 'success');
    } catch (error) {
        console.error('Error exportando categorías:', error);
        showAlert('Error al exportar categorías', 'danger');
    }
}
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners de navegación existentes...
    
    // Agregar listener para filtros de categorías
    const filtroBusquedaCategorias = document.getElementById('filtro-categoria-busqueda');
    if (filtroBusquedaCategorias) {
        filtroBusquedaCategorias.addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                aplicarFiltrosCategorias();
            }, 300);
        });
    }

    const filtroActivoCategorias = document.getElementById('filtro-categoria-activo');
    if (filtroActivoCategorias) {
        filtroActivoCategorias.addEventListener('change', aplicarFiltrosCategorias);
    }
});
// Actualizar la función showPage para incluir categorías
const originalShowPage = window.showPage;
window.showPage = function(pageName) {
    if (originalShowPage) {
        originalShowPage(pageName);
    }
    
    // Cargar datos específicos para categorías
    if (pageName === 'categorias') {
        cargarCategorias();
    }
};

// Actualizar el objeto de títulos para incluir categorías
const originalTitles = {
    dashboard: 'Dashboard',
    mercaderias: 'Gestión de Mercaderías',
    depositos: 'Gestión de Depósitos',
    stock: 'Control de Stock',
    transferencias: 'Órdenes de Transferencia',
    movimientos: 'Movimientos de Stock',
    clientes: 'Gestión de Clientes',
    vendedores: 'Gestión de Vendedores',
    proveedores: 'Gestión de Proveedores',
    zonas: 'Gestión de Zonas',
    categorias: 'Gestión de Categorías', // ← NUEVO
    etiquetas: 'Generación de Etiquetas',
    reportes: 'Reportes y Análisis'
};

// =============================================
// FUNCIONES PRINCIPALES DE ZONAS
// =============================================

// Cargar zonas desde la API
async function cargarZonas() {
    try {
        showSpinner();
        console.log('🔄 Cargando zonas...');
        
        const response = await apiRequest('/zonas');
        
        if (response.success) {
            zonas = response.data || [];
            zonasFiltradas = [...zonas];
            
            console.log(`✅ Zonas cargadas: ${zonas.length}`);
            mostrarZonas();
            actualizarInfoFiltrosZonas();
        } else {
            throw new Error(response.message || 'Error al cargar zonas');
        }
    } catch (error) {
        console.error('❌ Error cargando zonas:', error);
        showAlert('Error al cargar zonas: ' + error.message, 'danger');
        zonas = [];
        zonasFiltradas = [];
        mostrarZonas();
    } finally {
        hideSpinner();
    }
}

// Mostrar zonas en la tabla
function mostrarZonas() {
    const tbody = document.getElementById('tabla-zonas');
    if (!tbody) return;

    if (!zonasFiltradas || zonasFiltradas.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-inbox me-2"></i>
                    No hay zonas disponibles
                </td>
            </tr>
        `;
        return;
    }

    // Paginación
    const inicio = (paginaActualZonas - 1) * zonasPorPagina;
    const fin = inicio + zonasPorPagina;
    const zonasPagina = zonasFiltradas.slice(inicio, fin);

    tbody.innerHTML = zonasPagina.map(zona => {
        const fechaCreacion = zona.fecha_creacion ? 
            new Date(zona.fecha_creacion).toLocaleDateString('es-AR') : 'N/A';

        const estadoBadge = zona.activo == 1 ?
            '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Activa</span>' :
            '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Inactiva</span>';

        return `
            <tr>
                <td><strong>${zona.zonaId}</strong></td>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                        <span>${zona.zona}</span>
                    </div>
                </td>
                <td>
                    <span class="badge bg-info">${zona.total_clientes || 0}</span>
                    ${zona.clientes_activos ? `<small class="text-muted ms-1">(${zona.clientes_activos} activos)</small>` : ''}
                </td>
                <td>${estadoBadge}</td>
                <td>${fechaCreacion}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" 
                                class="btn btn-outline-primary" 
                                onclick="editarZona(${zona.zonaId})"
                                title="Editar zona">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-${zona.activo == 1 ? 'warning' : 'success'}" 
                                onclick="toggleEstadoZona(${zona.zonaId}, ${zona.activo == 1 ? 0 : 1})"
                                title="${zona.activo == 1 ? 'Desactivar' : 'Activar'} zona">
                            <i class="fas fa-${zona.activo == 1 ? 'eye-slash' : 'eye'}"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// =============================================
// FUNCIONES DE FILTROS
// =============================================

// Aplicar filtros
function aplicarFiltrosZonas() {
    const busqueda = document.getElementById('filtro-zona-busqueda').value.toLowerCase().trim();
    const estadoFiltro = document.getElementById('filtro-zona-activo').value;

    zonasFiltradas = zonas.filter(zona => {
        // Filtro por búsqueda
        const coincideBusqueda = !busqueda || 
            zona.zona.toLowerCase().includes(busqueda) ||
            zona.zonaId.toString().includes(busqueda);

        // Filtro por estado
        const coincideEstado = estadoFiltro === '' || zona.activo.toString() === estadoFiltro;

        return coincideBusqueda && coincideEstado;
    });

    paginaActualZonas = 1;
    mostrarZonas();
    actualizarInfoFiltrosZonas();
}

// Limpiar filtros
function limpiarFiltrosZonas() {
    document.getElementById('filtro-zona-busqueda').value = '';
    document.getElementById('filtro-zona-activo').value = '';
    
    zonasFiltradas = [...zonas];
    paginaActualZonas = 1;
    mostrarZonas();
    actualizarInfoFiltrosZonas();
}

// Actualizar información de filtros
function actualizarInfoFiltrosZonas() {
    const infoElement = document.getElementById('info-filtros-zonas');
    if (!infoElement) return;

    const total = zonas.length;
    const filtradas = zonasFiltradas.length;
    
    if (filtradas === total) {
        infoElement.textContent = `Mostrando todas las zonas (${total})`;
    } else {
        infoElement.textContent = `Mostrando ${filtradas} de ${total} zonas`;
    }
}

// =============================================
// FUNCIONES DE MODAL Y CRUD
// =============================================

// Limpiar formulario de zona
function limpiarFormularioZona() {
    const form = document.getElementById('formZona');
    if (form) {
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById('zona_id').value = '';
        
        // Remover clases de validación
        const inputs = form.querySelectorAll('.is-invalid, .is-valid');
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        
        // Activar por defecto
        document.getElementById('zona_activo').checked = true;
    }
}

// Abrir modal para nueva zona
function abrirModalZona() {
    limpiarFormularioZona();
    
    document.getElementById('modalZonaTitle').innerHTML = '<i class="fas fa-map-marker-alt me-2"></i>Nueva Zona';
    document.getElementById('btnGuardarZonaText').textContent = 'Crear Zona';
    document.getElementById('zona_activo').checked = true;
    
    const modal = new bootstrap.Modal(document.getElementById('modalZona'));
    modal.show();
    
    // Enfocar primer campo
    setTimeout(() => {
        document.getElementById('zona_nombre').focus();
    }, 300);
}

// Editar zona
async function editarZona(id) {
    try {
        const response = await apiRequest(`/zonas/${id}`);
        
        if (!response.success) {
            showAlert('Error al cargar la zona', 'danger');
            return;
        }
        
        const zona = response.data;
        
        limpiarFormularioZona();
        
        document.getElementById('zona_id').value = zona.zonaId;
        document.getElementById('zona_nombre').value = zona.zona || '';
        document.getElementById('zona_activo').checked = zona.activo == 1;
        
        document.getElementById('modalZonaTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Zona';
        document.getElementById('btnGuardarZonaText').textContent = 'Actualizar Zona';
        
        const modal = new bootstrap.Modal(document.getElementById('modalZona'));
        modal.show();
        
        setTimeout(() => {
            document.getElementById('zona_nombre').focus();
            document.getElementById('zona_nombre').select();
        }, 300);
        
    } catch (error) {
        console.error('Error editando zona:', error);
        
        // Fallback: buscar en datos locales
        if (typeof zonas !== 'undefined') {
            const zona = zonas.find(z => z.zonaId == id);
            if (zona) {
                limpiarFormularioZona();
                
                document.getElementById('zona_id').value = zona.zonaId;
                document.getElementById('zona_nombre').value = zona.zona || '';
                document.getElementById('zona_activo').checked = zona.activo == 1;
                
                document.getElementById('modalZonaTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Zona';
                document.getElementById('btnGuardarZonaText').textContent = 'Actualizar Zona';
                
                const modal = new bootstrap.Modal(document.getElementById('modalZona'));
                modal.show();
                
                setTimeout(() => {
                    document.getElementById('zona_nombre').focus();
                    document.getElementById('zona_nombre').select();
                }, 300);
            } else {
                showAlert('Error al cargar los datos de la zona', 'danger');
            }
        }
    }
}

// Guardar zona (crear o actualizar)
async function guardarZona() {
    try {
        const form = document.getElementById('formZona');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const zonaId = document.getElementById('zona_id').value;
        const isEditing = zonaId !== '';

        const zonaData = {
            zona: document.getElementById('zona_nombre').value.trim(),
            activo: document.getElementById('zona_activo').checked ? 1 : 0
        };

        console.log('Guardando zona:', zonaData);
        showSpinner();

        const url = isEditing ? `/zonas/${zonaId}` : '/zonas';
        const method = isEditing ? 'PUT' : 'POST';
        
        const response = await apiRequest(url, method, zonaData);

        if (response.success) {
            const accion = isEditing ? 'actualizada' : 'creada';
            showAlert(`Zona ${accion} exitosamente`, 'success');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalZona'));
            modal.hide();
            
            // Recargar zonas
            await cargarZonas();
            
            // Recargar selectores de zonas en otros módulos
            if (typeof cargarSelectoresZonas === 'function') {
                cargarSelectoresZonas();
            }
        } else {
            showAlert(response.message || 'Error al guardar zona', 'danger');
        }
    } catch (error) {
        console.error('Error guardando zona:', error);
        showAlert('Error al guardar zona: ' + error.message, 'danger');
    } finally {
        hideSpinner();
    }
}

// Cambiar estado de zona (activar/desactivar)
async function toggleEstadoZona(id, nuevoEstado) {
    const accion = nuevoEstado ? 'activar' : 'desactivar';
    
    if (!confirm(`¿Estás seguro de que quieres ${accion} esta zona?`)) {
        return;
    }
    
    try {
        showSpinner();
        const response = await apiRequest(`/zonas/${id}`, 'PUT', { activo: nuevoEstado ? 1 : 0 });
        
        if (response.success) {
            showAlert(`Zona ${accion === 'activar' ? 'activada' : 'desactivada'} exitosamente`, 'success');
            await cargarZonas();
            
            // Recargar selectores de zonas en otros módulos
            if (typeof cargarSelectoresZonas === 'function') {
                cargarSelectoresZonas();
            }
        } else {
            showAlert(response.message || `Error al ${accion} zona`, 'danger');
        }
    } catch (error) {
        console.error(`Error ${accion} zona:`, error);
        showAlert(`Error al ${accion} zona: ` + error.message, 'danger');
    } finally {
        hideSpinner();
    }
}

// =============================================
// FUNCIONES AUXILIARES
// =============================================

// Actualizar función de carga de página para incluir zonas
function mostrarPaginaZonas() {
    cargarZonas();
}

// Actualizar zonas (alias para cargarZonas)
function actualizarZonas() {
    cargarZonas();
}

// Exportar zonas (función básica)
function exportarZonas() {
    try {
        const datosExportar = zonasFiltradas.map(zona => ({
            ID: zona.zonaId,
            Zona: zona.zona,
            Estado: zona.activo == 1 ? 'Activa' : 'Inactiva',
            'Total Clientes': zona.total_clientes || 0,
            'Clientes Activos': zona.clientes_activos || 0,
            'Fecha Creación': zona.fecha_creacion ? new Date(zona.fecha_creacion).toLocaleDateString('es-AR') : ''
        }));

        const csv = [
            Object.keys(datosExportar[0]).join(','),
            ...datosExportar.map(row => Object.values(row).join(','))
        ].join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `zonas_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showAlert('Zonas exportadas exitosamente', 'success');
    } catch (error) {
        console.error('Error exportando zonas:', error);
        showAlert('Error al exportar zonas', 'danger');
    }
}

// =============================================
// EVENT LISTENERS
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    // Agregar listener para filtros de zonas
    const filtroBusquedaZonas = document.getElementById('filtro-zona-busqueda');
    if (filtroBusquedaZonas) {
        filtroBusquedaZonas.addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                aplicarFiltrosZonas();
            }, 300);
        });
    }

    const filtroActivoZonas = document.getElementById('filtro-zona-activo');
    if (filtroActivoZonas) {
        filtroActivoZonas.addEventListener('change', aplicarFiltrosZonas);
    }

    // Verificar estado activo al cambiar checkbox
    const zonaActivoCheckbox = document.getElementById('zona_activo');
    if (zonaActivoCheckbox) {
        zonaActivoCheckbox.addEventListener('change', function() {
            if (!this.checked) {
                if (!confirm('Al desactivar esta zona, los clientes existentes mantendrán la asignación, pero no se podrán asignar nuevos clientes a esta zona.')) {
                    this.checked = true; // Revertir el cambio
                }
            }
        });
    }
});

// Actualizar la función showPage para incluir zonas
const originalShowPageZonas = window.showPage;
window.showPage = function(pageName) {
    if (originalShowPageZonas) {
        originalShowPageZonas(pageName);
    }
    
    // Cargar datos específicos para zonas
    if (pageName === 'zonas') {
        cargarZonas();
    }
};

console.log('✅ Gestión de zonas cargada exitosamente');

// =============================================
// FUNCIÓN PRINCIPAL - GESTIONAR PROVEEDORES
// =============================================
async function gestionarProveedores(mercaderiaId) {
    try {
        console.log('Gestionando proveedores para mercadería:', mercaderiaId);
        
        mercaderiaSeleccionada = mercaderiaId;
        editandoRelacion = null;
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalProveedoresMercaderia'));
        modal.show();
        
        // Cargar datos
        await Promise.all([
            cargarDatosMercaderia(mercaderiaId),
            cargarTodosProveedores(),
            cargarProveedoresMercaderia(mercaderiaId)
        ]);
        
    } catch (error) {
        console.error('Error gestionando proveedores:', error);
        showAlert('Error al cargar datos de proveedores', 'danger');
    }
}

// =============================================
// CARGAR DATOS DE LA MERCADERÍA
// =============================================
async function cargarDatosMercaderia(mercaderiaId) {
    try {
        const response = await apiRequest(`/mercaderias/${mercaderiaId}`);
        if (response.success && response.data) {
            const mercaderia = response.data;
            
            // Actualizar información en el modal
            document.getElementById('mercaderia-nombre').textContent = mercaderia.descripcion || 'Sin nombre';
            document.getElementById('mercaderia-sku').textContent = mercaderia.codigo_sku || 'N/A';
            document.getElementById('mercaderia-descripcion').textContent = mercaderia.descripcion || 'N/A';
            document.getElementById('mercaderia-precio-venta').textContent = mercaderia.precio_venta || '0.00';
            document.getElementById('mercaderia-stock').textContent = mercaderia.stock_actual || '0';
            document.getElementById('mercaderia-id-form').value = mercaderiaId;
        }
    } catch (error) {
        console.error('Error cargando datos de mercadería:', error);
    }
}

// =============================================
// CARGAR TODOS LOS PROVEEDORES
// =============================================
async function cargarTodosProveedores() {
    try {
        const response = await apiRequest('/proveedores?limit=1000&activo=true');
        if (response.success && response.data) {
            todosLosProveedores = response.data;
            
            const select = document.getElementById('select-proveedor');
            select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
            
            todosLosProveedores.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor.proveedorId;
                option.textContent = `${proveedor.razonSocial} (${proveedor.cuit})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error cargando proveedores:', error);
    }
}

// =============================================
// CARGAR PROVEEDORES DE LA MERCADERÍA
// =============================================
async function cargarProveedoresMercaderia(mercaderiaId) {
    try {
        const loadingDiv = document.getElementById('loading-proveedores');
        const tablaContainer = document.getElementById('tabla-proveedores-container');
        const noProveedores = document.getElementById('no-proveedores');
        
        // Mostrar loading
        loadingDiv.style.display = 'block';
        tablaContainer.style.display = 'none';
        noProveedores.style.display = 'none';
        
        console.log(`🔍 Cargando proveedores para mercadería ${mercaderiaId}...`);
        
        const response = await apiRequest(`/mercaderias/${mercaderiaId}/proveedores`);
        
        console.log('📦 Respuesta del servidor:', response);
        
        if (response.success) {
            proveedoresMercaderia = response.data || [];
            
            if (proveedoresMercaderia.length > 0) {
                console.log(`✅ Se encontraron ${proveedoresMercaderia.length} proveedores`);
                renderTablaProveedoresMercaderia();
                tablaContainer.style.display = 'block';
            } else {
                console.log('ℹ️ Esta mercadería no tiene proveedores asignados');
                // Actualizar el mensaje del div "no proveedores"
                const noProveedoresDiv = document.getElementById('no-proveedores');
                noProveedoresDiv.innerHTML = `
                    <i class="fas fa-truck fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No hay proveedores asignados</h6>
                    <p class="text-muted">${response.message || 'Esta mercadería no tiene proveedores. Utiliza el formulario de arriba para agregar proveedores.'}</p>
                `;
                noProveedores.style.display = 'block';
            }
        } else {
            console.error('❌ Error en la respuesta:', response.message);
            showAlert(response.message || 'Error al cargar proveedores', 'warning');
            noProveedores.style.display = 'block';
        }
        
    } catch (error) {
        console.error('❌ Error de conexión cargando proveedores:', error);
        showAlert('Error de conexión al cargar proveedores', 'danger');
        document.getElementById('no-proveedores').style.display = 'block';
    } finally {
        document.getElementById('loading-proveedores').style.display = 'none';
    }
}

// =============================================
// RENDERIZAR TABLA DE PROVEEDORES
// =============================================
function renderTablaProveedoresMercaderia() {
    const tbody = document.getElementById('tabla-proveedores-mercaderia');
    
    tbody.innerHTML = proveedoresMercaderia.map(relacion => {
        const fechaUltimoPrecio = relacion.fecha_ultimo_precio ? 
            new Date(relacion.fecha_ultimo_precio).toLocaleDateString('es-AR') : 'N/A';
        
        return `
            <tr>
                <td>
                    <div class="d-flex flex-column">
                        <strong class="text-primary">${relacion.razonSocial}</strong>
                        <small class="text-muted">${relacion.cuit}</small>
                        ${relacion.telefono ? `<small class="text-muted">${relacion.telefono}</small>` : ''}
                    </div>
                </td>
                <td>
                    <div class="d-flex flex-column">
                        <strong class="text-success">$${parseFloat(relacion.precio_compra || 0).toFixed(2)}</strong>
                        <small class="text-muted">${relacion.moneda || 'ARS'}</small>
                        ${relacion.descuento_porcentaje > 0 ? 
                            `<small class="text-info">Desc: ${relacion.descuento_porcentaje}%</small>` : ''
                        }
                    </div>
                </td>
                <td>
                    <span class="badge bg-info">${relacion.tiempo_entrega_dias || 0} días</span>
                </td>
                <td>
                    <span class="badge bg-secondary">${relacion.cantidad_minima_pedido || 1}</span>
                </td>
                <td>
                    <code class="small">${relacion.codigo_producto_proveedor || 'N/A'}</code>
                </td>
                <td>
                    ${relacion.es_proveedor_principal ? 
                        '<span class="badge bg-warning"><i class="fas fa-star"></i> Principal</span>' :
                        '<span class="badge bg-light text-dark">Secundario</span>'
                    }
                </td>
                <td>
                    ${relacion.activo ? 
                        '<span class="badge bg-success">Activo</span>' :
                        '<span class="badge bg-danger">Inactivo</span>'
                    }
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" 
                                onclick="editarRelacionProveedor(${relacion.relacion_id})"
                                title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" 
                                onclick="eliminarRelacionProveedor(${relacion.mercaderia_id}, ${relacion.proveedor_id})"
                                title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// =============================================
// MANEJAR FORMULARIO DE PROVEEDOR
// =============================================
document.getElementById('formProveedorMercaderia').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const btnGuardar = document.getElementById('btn-guardar-proveedor');
        const originalText = btnGuardar.innerHTML;
        
        // Mostrar estado de carga
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Convertir checkbox a boolean
        data.es_proveedor_principal = document.getElementById('es-principal').checked;
        
        // Validaciones del frontend
        if (!data.proveedor_id) {
            throw new Error('Debe seleccionar un proveedor');
        }
        
        if (!data.precio_compra || data.precio_compra < 0) {
            throw new Error('El precio de compra debe ser mayor o igual a 0');
        }
        
        const mercaderiaId = data.mercaderia_id;
        
        let response;
        if (editandoRelacion) {
            // Actualizar relación existente
            const relacion = proveedoresMercaderia.find(r => r.relacion_id == editandoRelacion);
            console.log(`🔄 Actualizando relación ${editandoRelacion}...`);
            response = await apiRequest(
                `/mercaderias/${mercaderiaId}/proveedores/${relacion.proveedor_id}`,
                'PUT',
                data
            );
        } else {
            // Crear nueva relación
            console.log(`➕ Creando nueva relación para mercadería ${mercaderiaId}...`);
            response = await apiRequest(`/mercaderias/${mercaderiaId}/proveedores`, 'POST', data);
        }
        
        if (response.success) {
            showAlert(
                response.message || (editandoRelacion ? 'Proveedor actualizado exitosamente' : 'Proveedor agregado exitosamente'),
                'success'
            );
            
            // Recargar datos y limpiar formulario
            await cargarProveedoresMercaderia(mercaderiaId);
            limpiarFormProveedor();
            
            console.log('✅ Operación completada exitosamente');
        } else {
            throw new Error(response.message || 'Error al guardar proveedor');
        }
        
    } catch (error) {
        console.error('❌ Error guardando proveedor:', error);
        showAlert(error.message || 'Error al guardar proveedor', 'danger');
    } finally {
        // Restaurar botón
        const btnGuardar = document.getElementById('btn-guardar-proveedor');
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = editandoRelacion ? 
            '<i class="fas fa-save me-2"></i>Actualizar Proveedor' : 
            '<i class="fas fa-save me-2"></i>Guardar Proveedor';
    }
});

// =============================================
// EDITAR RELACIÓN PROVEEDOR
// =============================================
function editarRelacionProveedor(relacionId) {
    const relacion = proveedoresMercaderia.find(r => r.relacion_id == relacionId);
    if (!relacion) {
        showAlert('Relación no encontrada', 'danger');
        return;
    }
    
    editandoRelacion = relacionId;
    
    // Llenar formulario con datos de la relación
    document.getElementById('select-proveedor').value = relacion.proveedor_id;
    document.getElementById('precio-compra').value = relacion.precio_compra || '';
    document.getElementById('moneda').value = relacion.moneda || 'ARS';
    document.getElementById('tiempo-entrega').value = relacion.tiempo_entrega_dias || 7;
    document.getElementById('cantidad-minima').value = relacion.cantidad_minima_pedido || 1;
    document.getElementById('descuento').value = relacion.descuento_porcentaje || 0;
    document.getElementById('codigo-proveedor').value = relacion.codigo_producto_proveedor || '';
    document.getElementById('condiciones-pago').value = relacion.condiciones_pago || '';
    document.getElementById('observaciones').value = relacion.observaciones || '';
    document.getElementById('es-principal').checked = relacion.es_proveedor_principal;
    
    // Cambiar título del formulario
    document.getElementById('form-title').textContent = 'Editar Proveedor';
    document.getElementById('btn-guardar-proveedor').innerHTML = 
        '<i class="fas fa-save me-2"></i>Actualizar Proveedor';
    
    // Hacer scroll al formulario
    document.querySelector('#formProveedorMercaderia').scrollIntoView({ behavior: 'smooth' });
}

// =============================================
// ELIMINAR RELACIÓN PROVEEDOR
// =============================================
function eliminarRelacionProveedor(mercaderiaId, proveedorId) {
    // Mostrar modal de confirmación
    const modalConfirmar = new bootstrap.Modal(document.getElementById('modalConfirmarEliminar'));
    modalConfirmar.show();
    
    // Configurar botón de confirmación
    document.getElementById('btn-confirmar-eliminar').onclick = async function() {
        try {
            const response =await apiRequest(`/mercaderias/${mercaderiaId}/proveedores/${proveedorId}`,'DELETE');

           
            
            if (response.success) {
                showAlert('Proveedor desvinculado exitosamente', 'success');
                await cargarProveedoresMercaderia(mercaderiaId);
                modalConfirmar.hide();
            } else {
                showAlert(response.message || 'Error al eliminar proveedor', 'danger');
            }
            
        } catch (error) {
            console.error('Error eliminando proveedor:', error);
            showAlert('Error al eliminar proveedor', 'danger');
        }
    };
}

// =============================================
// LIMPIAR FORMULARIO
// =============================================
function limpiarFormProveedor() {
    document.getElementById('formProveedorMercaderia').reset();
    document.getElementById('mercaderia-id-form').value = mercaderiaSeleccionada;
    editandoRelacion = null;
    
    // Restaurar título del formulario
    document.getElementById('form-title').textContent = 'Agregar Proveedor';
    document.getElementById('btn-guardar-proveedor').innerHTML = 
        '<i class="fas fa-save me-2"></i>Guardar Proveedor';
}

function generarInfoProveedores(mercaderia) {
    if (!mercaderia.proveedores || mercaderia.proveedores.length === 0) {
        return `
            <div class="text-center">
                <span class="text-muted small">Sin proveedores</span><br>
                <button class="btn btn-sm btn-outline-primary mt-1" onclick="gestionarProveedores(${mercaderia.id})" title="Agregar proveedores">
                    <i class="fas fa-plus"></i> Agregar
                </button>
            </div>
        `;
    }
    
    const principal = mercaderia.proveedor_principal;
    const total = mercaderia.total_proveedores;
    
    let html = `<div class="proveedores-info">`;
    
    if (principal) {
        html += `
            <div class="mb-1">
                <span class="badge bg-warning text-dark" title="Proveedor principal">
                    <i class="fas fa-star"></i> ${principal.razonSocial}
                </span>
                <div class="small text-success">$${parseFloat(principal.precio_compra || 0).toFixed(2)}</div>
            </div>
        `;
    } else if (mercaderia.proveedores.length > 0) {
        // Si no hay principal pero sí hay proveedores, mostrar el primero
        const primero = mercaderia.proveedores[0];
        html += `
            <div class="mb-1">
                <span class="badge bg-secondary" title="Proveedor">
                    ${primero.razonSocial}
                </span>
                <div class="small text-success">$${parseFloat(primero.precio_compra || 0).toFixed(2)}</div>
            </div>
        `;
    }
    
    if (total > 1) {
        html += `<span class="badge bg-info" title="${total} proveedores en total">+${total - 1} más</span><br>`;
    }
    
    html += `
        <button class="btn btn-sm btn-outline-primary mt-1" onclick="gestionarProveedores(${mercaderia.id})" title="Gestionar proveedores">
            <i class="fas fa-edit"></i> Gestionar
        </button>
    </div>`;
    
    return html;
}

console.log('✅ Módulo de gestión de proveedores cargado correctamente');

async function cargarProveedoresMercaderiaSeguro(mercaderiaId) {
    try {
        const response = await apiRequest(`/mercaderias/${mercaderiaId}/proveedores`);
        if (response.success) {
            return {
                proveedores: response.data || [],
                total_proveedores: response.data ? response.data.length : 0,
                proveedor_principal: response.data ? response.data.find(p => p.es_proveedor_principal) : null
            };
        } else {
            console.warn(`⚠️ No se pudieron cargar proveedores para mercadería ${mercaderiaId}:`, response.message);
            return {
                proveedores: [],
                total_proveedores: 0,
                proveedor_principal: null
            };
        }
    } catch (error) {
        console.warn(`⚠️ Error cargando proveedores para mercadería ${mercaderiaId}:`, error.message);
        return {
            proveedores: [],
            total_proveedores: 0,
            proveedor_principal: null
        };
    }
}

function actualizarEstadisticasMercaderias() {
    try {
        if (!mercaderias || !Array.isArray(mercaderias)) {
            console.warn('⚠️ No hay datos de mercaderías para calcular estadísticas');
            return;
        }

        console.log('📊 Calculando estadísticas de mercaderías con proveedores...');

        // Calcular estadísticas básicas
        const totalMercaderias = mercaderias.length;
        const mercaderiasActivas = mercaderias.filter(m => m.activo).length;
        const mercaderiasInactivas = totalMercaderias - mercaderiasActivas;

        // Calcular estadísticas de proveedores
        const mercaderiasConProveedores = mercaderias.filter(m => 
            m.proveedores && Array.isArray(m.proveedores) && m.proveedores.length > 0
        ).length;
        
        const mercaderiasSinProveedores = totalMercaderias - mercaderiasConProveedores;
        
        const mercaderiasConProveedorPrincipal = mercaderias.filter(m => 
            m.proveedor_principal
        ).length;

        // Calcular estadísticas de relaciones
        let totalRelacionesProveedores = 0;
        let mercaderiasConMultiplesProveedores = 0;
        let proveedoresUnicos = new Set();

        mercaderias.forEach(mercaderia => {
            if (mercaderia.proveedores && Array.isArray(mercaderia.proveedores)) {
                const numProveedores = mercaderia.proveedores.length;
                totalRelacionesProveedores += numProveedores;
                
                if (numProveedores > 1) {
                    mercaderiasConMultiplesProveedores++;
                }
                
                // Agregar proveedores únicos
                mercaderia.proveedores.forEach(proveedor => {
                    if (proveedor.proveedor_id) {
                        proveedoresUnicos.add(proveedor.proveedor_id);
                    }
                });
            }
        });

        // Calcular estadísticas de precios
        let menorPrecio = null;
        let mayorPrecio = null;
        let promedioPrecios = 0;
        let mercaderiasConPrecio = 0;
        let valorTotalInventario = 0;

        mercaderias.forEach(mercaderia => {
            const precio = parseFloat(mercaderia.precio_venta || 0);
            const stock = parseInt(mercaderia.stock_actual || 0);
            
            if (precio > 0) {
                mercaderiasConPrecio++;
                valorTotalInventario += precio * stock;
                
                if (menorPrecio === null || precio < menorPrecio) {
                    menorPrecio = precio;
                }
                if (mayorPrecio === null || precio > mayorPrecio) {
                    mayorPrecio = precio;
                }
                promedioPrecios += precio;
            }
        });

        if (mercaderiasConPrecio > 0) {
            promedioPrecios = promedioPrecios / mercaderiasConPrecio;
        }

        // Calcular estadísticas de stock
        const mercaderiasConStockBajo = mercaderias.filter(m => {
            const stock = parseInt(m.stock_actual || 0);
            const minimo = parseInt(m.stock_minimo || 0);
            return stock > 0 && stock <= minimo;
        }).length;

        const mercaderiasSinStock = mercaderias.filter(m => {
            const stock = parseInt(m.stock_actual || 0);
            return stock <= 0;
        }).length;

        // Preparar objeto con todas las estadísticas
        const estadisticas = {
            // Básicas
            total_mercaderias: totalMercaderias,
            mercaderias_activas: mercaderiasActivas,
            mercaderias_inactivas: mercaderiasInactivas,
            
            // Proveedores
            mercaderias_con_proveedores: mercaderiasConProveedores,
            mercaderias_sin_proveedores: mercaderiasSinProveedores,
            mercaderias_con_proveedor_principal: mercaderiasConProveedorPrincipal,
            mercaderias_con_multiples_proveedores: mercaderiasConMultiplesProveedores,
            total_relaciones_proveedores: totalRelacionesProveedores,
            proveedores_unicos_utilizados: proveedoresUnicos.size,
            
            // Precios
            precio_menor: menorPrecio,
            precio_mayor: mayorPrecio,
            precio_promedio: promedioPrecios,
            valor_total_inventario: valorTotalInventario,
            
            // Stock
            mercaderias_stock_bajo: mercaderiasConStockBajo,
            mercaderias_sin_stock: mercaderiasSinStock,
            
            // Porcentajes
            porcentaje_con_proveedores: totalMercaderias > 0 ? (mercaderiasConProveedores / totalMercaderias * 100) : 0,
            porcentaje_con_proveedor_principal: totalMercaderias > 0 ? (mercaderiasConProveedorPrincipal / totalMercaderias * 100) : 0,
            porcentaje_multiples_proveedores: mercaderiasConProveedores > 0 ? (mercaderiasConMultiplesProveedores / mercaderiasConProveedores * 100) : 0
        };

        console.log('📊 Estadísticas calculadas:', estadisticas);

        // Actualizar elementos en el DOM
        actualizarElementosEstadisticas(estadisticas);
        
        // Actualizar gráficos si existen
        actualizarGraficosProveedores(estadisticas);

        return estadisticas;

    } catch (error) {
        console.error('❌ Error calculando estadísticas de mercaderías:', error);
    }
}

// =============================================
// ACTUALIZAR ELEMENTOS EN EL DOM
// =============================================
function actualizarElementosEstadisticas(stats) {
    try {
        // Mapeo de estadísticas a elementos del DOM
        const elementos = {
            // Estadísticas básicas de mercaderías
            'stat-productos-total': stats.total_mercaderias,
            'stat-productos-activos': stats.mercaderias_activas,
            'stat-mercaderias-total': stats.total_mercaderias,
            'stat-mercaderias-activas': stats.mercaderias_activas,
            'totalMercaderias': stats.total_mercaderias,
            
            // Estadísticas de proveedores
            'stat-con-proveedores': stats.mercaderias_con_proveedores,
            'stat-sin-proveedores': stats.mercaderias_sin_proveedores,
            'stat-con-proveedor-principal': stats.mercaderias_con_proveedor_principal,
            'stat-multiples-proveedores': stats.mercaderias_con_multiples_proveedores,
            'stat-relaciones-total': stats.total_relaciones_proveedores,
            'stat-proveedores-unicos': stats.proveedores_unicos_utilizados,
            
            // Estadísticas de precios (formateadas)
            'stat-precio-menor': stats.precio_menor ? `$${stats.precio_menor.toFixed(2)}` : 'N/A',
            'stat-precio-mayor': stats.precio_mayor ? `$${stats.precio_mayor.toFixed(2)}` : 'N/A',
            'stat-precio-promedio': stats.precio_promedio ? `$${stats.precio_promedio.toFixed(2)}` : 'N/A',
            'stat-valor-total': `$${stats.valor_total_inventario.toLocaleString()}`,
            'stat-valor-total-inventario': `$${stats.valor_total_inventario.toLocaleString()}`,
            
            // Estadísticas de stock
            'stat-stock-bajo': stats.mercaderias_stock_bajo,
            'stat-sin-stock': stats.mercaderias_sin_stock,
            'stockBajo': stats.mercaderias_stock_bajo,
            
            // Porcentajes (formateados)
            'stat-porcentaje-proveedores': `${stats.porcentaje_con_proveedores.toFixed(1)}%`,
            'stat-porcentaje-principal': `${stats.porcentaje_con_proveedor_principal.toFixed(1)}%`,
            'stat-porcentaje-multiples': `${stats.porcentaje_multiples_proveedores.toFixed(1)}%`
        };

        // Actualizar cada elemento si existe en el DOM
        Object.entries(elementos).forEach(([id, valor]) => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = valor;
                console.log(`✅ Actualizado ${id}: ${valor}`);
            }
        });

        // Actualizar elementos con formato especial
        actualizarElementosEspeciales(stats);

    } catch (error) {
        console.error('❌ Error actualizando elementos de estadísticas:', error);
    }
}

// =============================================
// ACTUALIZAR ELEMENTOS CON FORMATO ESPECIAL
// =============================================
function actualizarElementosEspeciales(stats) {
    try {
        // Actualizar elementos que necesitan HTML especial
        const elementosEspeciales = [
            {
                id: 'resumen-proveedores',
                html: `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card text-center border-primary">
                                <div class="card-body">
                                    <h5 class="text-primary">${stats.mercaderias_con_proveedores}</h5>
                                    <small>Con Proveedores</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-warning">
                                <div class="card-body">
                                    <h5 class="text-warning">${stats.mercaderias_sin_proveedores}</h5>
                                    <small>Sin Proveedores</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-success">
                                <div class="card-body">
                                    <h5 class="text-success">${stats.mercaderias_con_proveedor_principal}</h5>
                                    <small>Con Principal</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-info">
                                <div class="card-body">
                                    <h5 class="text-info">${stats.mercaderias_con_multiples_proveedores}</h5>
                                    <small>Múltiples Proveedores</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'indicadores-proveedores',
                html: `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-chart-pie me-2"></i>Resumen de Proveedores</h6>
                        <ul class="mb-0">
                            <li><strong>${stats.porcentaje_con_proveedores.toFixed(1)}%</strong> de mercaderías tienen proveedores</li>
                            <li><strong>${stats.porcentaje_con_proveedor_principal.toFixed(1)}%</strong> tienen proveedor principal definido</li>
                            <li><strong>${stats.total_relaciones_proveedores}</strong> relaciones proveedor-mercadería en total</li>
                            <li><strong>${stats.proveedores_unicos_utilizados}</strong> proveedores únicos utilizados</li>
                        </ul>
                    </div>
                `
            }
        ];

        elementosEspeciales.forEach(({ id, html }) => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.innerHTML = html;
                console.log(`✅ Actualizado elemento especial: ${id}`);
            }
        });

    } catch (error) {
        console.error('❌ Error actualizando elementos especiales:', error);
    }
}

// =============================================
// ACTUALIZAR GRÁFICOS DE PROVEEDORES
// =============================================
function actualizarGraficosProveedores(stats) {
    try {
        // Gráfico de dona para distribución de proveedores
        const chartProveedores = document.getElementById('chart-proveedores');
        if (chartProveedores) {
            const ctx = chartProveedores.getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (window.chartProveedoresInstance) {
                window.chartProveedoresInstance.destroy();
            }
            
            // Crear nuevo gráfico
            window.chartProveedoresInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Con Proveedores', 'Sin Proveedores'],
                    datasets: [{
                        data: [stats.mercaderias_con_proveedores, stats.mercaderias_sin_proveedores],
                        backgroundColor: ['#28a745', '#ffc107'],
                        borderColor: ['#1e7e34', '#e0a800'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Proveedores'
                        }
                    }
                }
            });
        }

        // Gráfico de barras para tipos de relaciones
        const chartRelaciones = document.getElementById('chart-relaciones-proveedores');
        if (chartRelaciones) {
            const ctx = chartRelaciones.getContext('2d');
            
            if (window.chartRelacionesInstance) {
                window.chartRelacionesInstance.destroy();
            }
            
            window.chartRelacionesInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Sin Proveedores', 'Un Proveedor', 'Múltiples Proveedores', 'Con Principal'],
                    datasets: [{
                        label: 'Cantidad de Mercaderías',
                        data: [
                            stats.mercaderias_sin_proveedores,
                            stats.mercaderias_con_proveedores - stats.mercaderias_con_multiples_proveedores,
                            stats.mercaderias_con_multiples_proveedores,
                            stats.mercaderias_con_proveedor_principal
                        ],
                        backgroundColor: ['#dc3545', '#6c757d', '#007bff', '#28a745'],
                        borderColor: ['#c82333', '#5a6268', '#0056b3', '#1e7e34'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Tipos de Relaciones con Proveedores'
                        }
                    }
                }
            });
        }

    } catch (error) {
        console.error('❌ Error actualizando gráficos de proveedores:', error);
    }
}

// =============================================
// FUNCIÓN PARA OBTENER ESTADÍSTICAS DESDE LA API
// =============================================
async function cargarEstadisticasProveedoresDesdeAPI() {
    try {
        console.log('📡 Cargando estadísticas de proveedores desde la API...');
        
        const [responseMercaderias, responseSinProveedores] = await Promise.all([
            apiRequest('/mercaderias?include_proveedores=true'),
            apiRequest('/mercaderias/reportes/sin-proveedores')
        ]);
        
        if (responseMercaderias.success && responseSinProveedores.success) {
            const estadisticas = {
                total_mercaderias: responseMercaderias.total || 0,
                mercaderias_sin_proveedores: responseSinProveedores.total || 0,
                mercaderias_con_proveedores: (responseMercaderias.total || 0) - (responseSinProveedores.total || 0)
            };
            
            console.log('✅ Estadísticas cargadas desde API:', estadisticas);
            return estadisticas;
        }
        
    } catch (error) {
        console.error('❌ Error cargando estadísticas desde API:', error);
        return null;
    }
}

// =============================================
// INICIALIZACIÓN Y EVENTOS
// =============================================

// Llamar automáticamente cuando se carguen las mercaderías
document.addEventListener('DOMContentLoaded', function() {
    // Si ya hay mercaderías cargadas, actualizar estadísticas
    if (mercaderias && Array.isArray(mercaderias)) {
        setTimeout(actualizarEstadisticasMercaderias, 1000);
    }
});

// Escuchar evento personalizado cuando se carguen mercaderías
document.addEventListener('mercaderiasLoaded', function() {
    actualizarEstadisticasMercaderias();
});

console.log('✅ Función actualizarEstadisticasMercaderias() cargada correctamente');

// =============================================
// FUNCIONES DE IMPRESIÓN DE ETIQUETAS
// Agregar al final de tu JavaScript en index.html
// =============================================

// Variables globales para etiquetas
let mercaderiasParaImprimir = [];
let configImpresora = null;

// =============================================
// FUNCIÓN PRINCIPAL - ABRIR MODAL DE IMPRESIÓN
// =============================================
function imprimirEtiquetasMercaderias(mercaderiaIds = null) {
    try {
        console.log('🏷️ Iniciando proceso de impresión de etiquetas...');
        
        // Verificar y crear modal si no existe
        const modal = verificarModalEtiquetas();
        if (!modal) {
            console.error('❌ No se pudo crear o encontrar el modal de etiquetas');
            showAlert('Error interno: no se pudo cargar el modal de etiquetas', 'danger');
            return;
        }

        // Si no se pasan IDs específicos, usar mercaderías seleccionadas
        if (!mercaderiaIds) {
            mercaderiaIds = obtenerMercaderiasSeleccionadas();
        }
        
        if (!mercaderiaIds || mercaderiaIds.length === 0) {
            showAlert('Debe seleccionar al menos una mercadería para imprimir etiquetas', 'warning');
            return;
        }
        
        console.log(`📋 Procesando ${mercaderiaIds.length} mercaderías para impresión`);
        
        // Cargar datos de mercaderías
        cargarDatosMercaderiasParaImprimir(mercaderiaIds);
        
        // Mostrar modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        console.log('✅ Modal de etiquetas mostrado');
        
    } catch (error) {
        console.error('💥 Error en imprimirEtiquetasMercaderias:', error);
        showAlert('Error interno al abrir el sistema de etiquetas', 'danger');
    }
}


// =============================================
// CARGAR DATOS DE MERCADERÍAS PARA IMPRIMIR
// =============================================
function cargarDatosMercaderiasParaImprimir(mercaderiaIds) {
    try {
        console.log('🔄 Cargando datos de mercaderías para impresión...', mercaderiaIds);
        
        // Verificar que window.mercaderias existe
        if (!mercaderias || !Array.isArray(mercaderias)) {
            console.error('❌ mercaderias no está disponible');
            showAlert('Error: datos de mercaderías no disponibles', 'danger');
            return;
        }
        
        // Filtrar mercaderías seleccionadas
        mercaderiasParaImprimir = mercaderias.filter(m => 
            mercaderiaIds.includes(m.id?.toString()) || mercaderiaIds.includes(m.id)
        );
        
        console.log(`📦 Filtradas ${mercaderiasParaImprimir.length} mercaderías de ${mercaderias.length} total`);
        
        // Mostrar mercaderías en el modal
        mostrarMercaderiasSeleccionadas();
        
    } catch (error) {
        console.error('Error cargando datos para impresión:', error);
        showAlert('Error cargando datos de mercaderías', 'danger');
    }
}

// =============================================
// MOSTRAR MERCADERÍAS SELECCIONADAS EN EL MODAL
// =============================================
function mostrarMercaderiasSeleccionadas() {
    try {
        const contenedor = document.getElementById('lista-mercaderias-etiquetas');
        
        if (!contenedor) {
            console.error('❌ Contenedor lista-mercaderias-etiquetas no encontrado');
            // Intentar recrear el modal
            verificarModalEtiquetas();
            // Intentar de nuevo después de un breve delay
            setTimeout(() => {
                const contenedorNuevo = document.getElementById('lista-mercaderias-etiquetas');
                if (contenedorNuevo) {
                    mostrarMercaderiasSeleccionadasInterno(contenedorNuevo);
                } else {
                    console.error('❌ Aún no se puede encontrar el contenedor después de recrear modal');
                }
            }, 100);
            return;
        }
        
        mostrarMercaderiasSeleccionadasInterno(contenedor);
        
    } catch (error) {
        console.error('Error en mostrarMercaderiasSeleccionadas:', error);
    }
}

function mostrarMercaderiasSeleccionadasInterno(contenedor) {
    if (!mercaderiasParaImprimir || mercaderiasParaImprimir.length === 0) {
        contenedor.innerHTML = '<p class="text-muted text-center">No hay mercaderías seleccionadas</p>';
        return;
    }
    
    const html = mercaderiasParaImprimir.map(mercaderia => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <div>
                <strong>${mercaderia.codigo_sku || mercaderia.id}</strong>
                <br>
                <span class="text-muted">${mercaderia.descripcion || 'Sin descripción'}</span>
            </div>
            <div class="text-end">
                <span class="badge bg-primary">$${parseFloat(mercaderia.precio_venta || 0).toFixed(2)}</span>
                <br>
                <small class="text-muted">Stock: ${mercaderia.stock_actual || mercaderia.stock_total || 0}</small>
            </div>
        </div>
    `).join('');
    
    contenedor.innerHTML = html;
    console.log(`✅ Mostradas ${mercaderiasParaImprimir.length} mercaderías en el modal`);
}
// =============================================
// CARGAR CONFIGURACIÓN DE IMPRESORA
// =============================================
async function cargarConfiguracionImpresora() {
    try {
        console.log('🔧 Cargando configuración de impresora...');
        
        const response = await apiRequest('/etiquetas/configuracion', 'GET');
        
        if (response.success) {
            configImpresora = response.data;
            
            // ✅ NUEVA FUNCIONALIDAD: Usar configuración predeterminada del .env
            const config = response.data.impresoras.red;
            
            console.log('📋 Configuración recibida del backend:', {
                host: config.host,
                puerto: config.puerto,
                desde_env: config.desde_env ? '✅ .env' : '❌ predeterminado'
            });
            
            // ✅ ACTUALIZAR CAMPOS DEL MODAL CON VALORES DEL .env
            setTimeout(() => {
                actualizarCamposModalConEnv(config);
            }, 100); // Pequeño delay para asegurar que el modal esté cargado
            
            actualizarEstadoImpresora();
            
            if (response.data.usb_deshabilitado) {
                console.log('ℹ️ USB deshabilitado - usando solo impresoras de red');
            }
            
            console.log('✅ Configuración de impresora cargada');
        } else {
            console.warn('⚠️ Error cargando configuración:', response.message);
        }
    } catch (error) {
        console.error('❌ Error cargando configuración de impresora:', error);
    }
}

// =============================================
// NUEVA FUNCIÓN: Actualizar campos del modal con valores del .env
// =============================================
function actualizarCamposModalConEnv(config) {
    // Buscar los campos input
    const inputIP = document.getElementById('impresora-ip');
    const inputPuerto = document.getElementById('impresora-puerto');
    
    if (inputIP && config.host) {
        inputIP.value = config.host;
        inputIP.placeholder = config.host;
        
        // ✅ INDICADOR VISUAL si viene del .env
        if (config.desde_env) {
            inputIP.classList.add('border-success');
            inputIP.classList.add('bg-light');
            inputIP.title = '✅ Valor cargado desde archivo .env';
            
            // Agregar un pequeño badge verde
            const parent = inputIP.parentElement;
            let badge = parent.querySelector('.env-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'env-badge badge bg-success ms-2';
                badge.innerHTML = '<i class="fas fa-file-code"></i> .env';
                badge.title = 'Este valor viene del archivo .env';
                parent.querySelector('.form-text').appendChild(badge);
            }
        } else {
            // Valor predeterminado
            inputIP.classList.add('border-warning');
            inputIP.title = '⚠️ Valor predeterminado - Configure .env para personalizar';
        }
        
        console.log(`📍 Campo IP actualizado: ${config.host} ${config.desde_env ? '(desde .env)' : '(predeterminado)'}`);
    }
    
    if (inputPuerto && config.puerto) {
        inputPuerto.value = config.puerto;
        inputPuerto.placeholder = config.puerto;
        
        // Mismo tratamiento visual para el puerto
        if (config.desde_env) {
            inputPuerto.classList.add('border-success');
            inputPuerto.classList.add('bg-light');
            inputPuerto.title = '✅ Valor cargado desde archivo .env';
            
            const parent = inputPuerto.parentElement;
            let badge = parent.querySelector('.env-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'env-badge badge bg-success ms-2';
                badge.innerHTML = '<i class="fas fa-file-code"></i> .env';
                badge.title = 'Este valor viene del archivo .env';
                parent.querySelector('.form-text').appendChild(badge);
            }
        } else {
            inputPuerto.classList.add('border-warning');
            inputPuerto.title = '⚠️ Valor predeterminado - Configure .env para personalizar';
        }
        
        console.log(`🔌 Campo Puerto actualizado: ${config.puerto} ${config.desde_env ? '(desde .env)' : '(predeterminado)'}`);
    }
    
    // ✅ MENSAJE INFORMATIVO SEGÚN TIPO DE VPS/LOCAL
    mostrarMensajeSegunEntorno(config);
}

// =============================================
// NUEVA FUNCIÓN: Mostrar mensaje según entorno
// =============================================
function mostrarMensajeSegunEntorno(config) {
    const modalBody = document.querySelector('#modalConfigImpresora .modal-body');
    if (!modalBody) return;
    
    // Remover mensaje anterior si existe
    const mensajeAnterior = modalBody.querySelector('.mensaje-entorno');
    if (mensajeAnterior) {
        mensajeAnterior.remove();
    }
    
    // Detectar si estamos en VPS
    const esVPS = window.location.hostname !== 'localhost' && 
                  window.location.hostname !== '127.0.0.1' &&
                  !window.location.hostname.startsWith('192.168.');
    
    let mensaje = '';
    let tipoAlerta = 'info';
    
    if (esVPS) {
        // En VPS
        if (config.host.includes('.') && !config.host.match(/^\d+\.\d+\.\d+\.\d+$/)) {
            // Es un dominio (DynDNS)
            mensaje = `
                <div class="alert alert-success mensaje-entorno">
                    <h6><i class="fas fa-cloud me-2"></i>Configuración VPS con DynDNS</h6>
                    <small>
                        ✅ Dominio detectado: <strong>${config.host}</strong><br>
                        ✅ Perfecto para VPS con IP dinámica<br>
                        <em>Asegúrese de que el DynDNS esté actualizado y el port forwarding activo</em>
                    </small>
                </div>
            `;
        } else if (config.host.startsWith('192.168.') || config.host.startsWith('10.')) {
            // IP privada desde VPS (problemático)
            mensaje = `
                <div class="alert alert-warning mensaje-entorno">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>⚠️ Configuración problemática</h6>
                    <small>
                        <strong>IP privada (${config.host}) desde VPS no funcionará</strong><br>
                        <strong>Soluciones:</strong><br>
                        • Configure DynDNS: mi-empresa.hopto.org<br>
                        • Use IP pública con port forwarding<br>
                        • Instale bridge local
                    </small>
                </div>
            `;
            tipoAlerta = 'warning';
        } else {
            // IP pública o dominio
            mensaje = `
                <div class="alert alert-info mensaje-entorno">
                    <h6><i class="fas fa-globe me-2"></i>Configuración VPS</h6>
                    <small>
                        🌐 Dirección: <strong>${config.host}</strong><br>
                        ℹ️ Desde VPS - Verifique conectividad de red
                    </small>
                </div>
            `;
        }
    } else {
        // En local
        mensaje = `
            <div class="alert alert-info mensaje-entorno">
                <h6><i class="fas fa-home me-2"></i>Configuración Local</h6>
                <small>
                    🏠 Dirección local: <strong>${config.host}</strong><br>
                    ✅ Configuración ideal para red local
                </small>
            </div>
        `;
    }
    
    // Insertar mensaje después del alert de configuración
    const alertInfo = modalBody.querySelector('.alert-info');
    if (alertInfo && mensaje) {
        alertInfo.insertAdjacentHTML('afterend', mensaje);
    }
}
// =============================================
// ACTUALIZAR ESTADO DE IMPRESORA
// =============================================
function actualizarEstadoImpresora() {
    const estadoElement = document.getElementById('estado-impresora');
    
    if (!estadoElement) {
        console.warn('⚠️ Elemento estado-impresora no encontrado');
        return;
    }
    
    if (configImpresora && configImpresora.impresoras.red?.activa) {
        estadoElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Conectada';
        estadoElement.className = 'ms-2 text-success';
    } else {
        estadoElement.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> No conectada';
        estadoElement.className = 'ms-2 text-warning';
    }
    
    // Mostrar última verificación si está disponible
    if (configImpresora?.verificacion_automatica?.ultima_verificacion) {
        const fecha = new Date(configImpresora.verificacion_automatica.ultima_verificacion);
        estadoElement.title = `Última verificación: ${fecha.toLocaleTimeString()}`;
    }
}

// =============================================
// CONFIGURAR IMPRESORA DE RED
// =============================================
function configurarImpresoraRed() {
    const modal = document.getElementById('modalConfigImpresora');
    if (modal) {
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        // ✅ RECARGAR CONFIGURACIÓN AL ABRIR EL MODAL
        // Esto asegura que los valores del .env estén siempre actualizados
        setTimeout(() => {
            if (configImpresora && configImpresora.configuracion_predeterminada) {
                actualizarCamposModalConEnv(configImpresora.configuracion_predeterminada);
            } else {
                // Si no hay configuración cargada, cargarla ahora
                cargarConfiguracionImpresora();
            }
        }, 200);
        
    } else {
        console.error('❌ Modal de configuración no encontrado');
    }
}

async function guardarConfigImpresora() {
    try {
        const ip = document.getElementById('impresora-ip')?.value;
        const puerto = document.getElementById('impresora-puerto')?.value;
        
        if (!ip || !puerto) {
            showAlert('Debe completar la IP y puerto de la impresora', 'warning');
            return;
        }
        
        showSpinner('Probando conexión con impresora de red...');
        
        const response = await apiRequest('/etiquetas/configurar-impresora', 'POST', {
            tipo: 'red',
            host: ip,
            puerto: parseInt(puerto)
        });
        
        hideSpinner();
        
        if (response.success) {
            showAlert(response.message, response.data.activa ? 'success' : 'warning');
            
            // Actualizar configuración local
            //if (configImpresora) {
                configImpresora.impresoras.red.activa = response.data.activa;
                configImpresora.impresoras.red.host = ip;
                configImpresora.impresoras.red.puerto = parseInt(puerto);
                actualizarEstadoImpresora();
            //}
            
            // Cerrar modal
            const modalElement = document.getElementById('modalConfigImpresora');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
            
        } else {
            showAlert('Error configurando impresora: ' + response.message, 'danger');
        }
        
    } catch (error) {
        hideSpinner();
        console.error('Error configurando impresora:', error);
        showAlert('Error de conexión al configurar impresora', 'danger');
    }
}
// =============================================
// GENERAR VISTA PREVIA
// =============================================
async function generarVistaPrevia() {
    try {
        if (!mercaderiasParaImprimir || mercaderiasParaImprimir.length === 0) {
            showAlert('No hay mercaderías seleccionadas para vista previa', 'warning');
            return;
        }
        
        showSpinner('Generando vista previa...');
        
        const response = await apiRequest('/etiquetas/vista-previa', 'POST', {
            mercaderias: mercaderiasParaImprimir.slice(0, 3), // Solo primeras 3 para preview
            opciones: {
                incluir_precio: document.getElementById('incluir-precio')?.checked || false,
                incluir_stock: document.getElementById('incluir-stock')?.checked || false,
                incluir_codigo_barras: document.getElementById('incluir-codigo-barras')?.checked || false,
                formato: document.getElementById('formato-etiqueta')?.value || 'mediana'
            }
        });
        
        hideSpinner();
        
        if (response.success) {
            const contenedor = document.getElementById('vista-previa-etiqueta');
            if (contenedor) {
                contenedor.innerHTML = `
                    <div class="alert alert-success">
                        <strong>✅ Vista previa generada</strong><br>
                        Formato: ${document.getElementById('formato-etiqueta')?.value || 'mediana'}<br>
                        Mercaderías: ${mercaderiasParaImprimir.length}<br>
                        <small class="text-muted">La impresión real incluirá todas las mercaderías seleccionadas</small>
                    </div>
                `;
            }
        } else {
            showAlert('Error generando vista previa: ' + response.message, 'danger');
        }
        
    } catch (error) {
        hideSpinner();
        console.error('Error en vista previa:', error);
        showAlert('Error generando vista previa', 'danger');
    }
}

// =============================================
// EJECUTAR IMPRESIÓN
// =============================================
async function ejecutarImpresion() {
    try {
        if (!mercaderiasParaImprimir || mercaderiasParaImprimir.length === 0) {
            showAlert('No hay mercaderías seleccionadas para imprimir', 'warning');
            return;
        }
        
        if (!configImpresora || !configImpresora.impresoras.red.activa) {
            showAlert('Debe configurar y conectar una impresora de red primero', 'warning');
            return;
        }
        
        showSpinner(`Imprimiendo ${mercaderiasParaImprimir.length} etiquetas...`);
        
        const response = await apiRequest('/etiquetas/imprimir', 'POST', {
            mercaderias: mercaderiasParaImprimir,
            opciones: {
                incluir_precio: document.getElementById('incluir-precio')?.checked || false,
                incluir_stock: document.getElementById('incluir-stock')?.checked || false,
                incluir_codigo_barras: document.getElementById('incluir-codigo-barras')?.checked || false,
                formato: document.getElementById('formato-etiqueta')?.value || 'mediana',
                copias: parseInt(document.getElementById('copias-por-mercaderia')?.value || 1)
            },
            impresora: {
                tipo: 'red',
                host: configImpresora.impresoras.red.host,
                puerto: configImpresora.impresoras.red.puerto
            }
        });
        
        hideSpinner();
        
        if (response.success) {
            showAlert(response.message, 'success');
            
            // Cerrar modal después de impresión exitosa
            const modalElement = document.getElementById('modalImprimirEtiquetas');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
        } else {
            showAlert('Error imprimiendo: ' + response.message, 'danger');
        }
        
    } catch (error) {
        hideSpinner();
        console.error('Error en impresión:', error);
        showAlert('Error ejecutando impresión', 'danger');
    }
}

// =============================================
// FUNCIONES ACTUALIZADAS PARA ROLLO DOS COLUMNAS
// =============================================

// NUEVA FUNCIÓN: Actualizar vista previa según formato
function actualizarVistaPreviaFormato() {
    const formato = document.getElementById('formato-etiqueta').value;
    const infoRollo = document.getElementById('info-rollo-columnas');
    const descripcionFormato = document.getElementById('descripcion-formato');
    const labelCantidad = document.getElementById('label-cantidad-etiquetas');
    const ayudaCantidad = document.getElementById('ayuda-cantidad');
    
    if (formato === 'rollo_dos_columnas') {
        // Mostrar información específica del rollo
        infoRollo.style.display = 'block';
        descripcionFormato.textContent = 'Rollo continuo con dos etiquetas por fila';
        labelCantidad.textContent = 'Repeticiones por Mercadería';
        ayudaCantidad.textContent = 'Cada repetición generará una fila con la misma mercadería en ambas columnas (si es impar)';
        
        // Limpiar vista previa actual
        document.getElementById('vista-previa-etiqueta').innerHTML = `
            <button type="button" class="btn btn-outline-primary" onclick="generarVistaPrevia()">
                <i class="fas fa-eye me-2"></i>Ver Formato Rollo Dos Columnas
            </button>
        `;
    } else {
        // Ocultar información del rollo
        infoRollo.style.display = 'none';
        descripcionFormato.textContent = 'Etiquetas individuales estándar';
        labelCantidad.textContent = 'Cantidad por Mercadería';
        ayudaCantidad.textContent = 'Número de etiquetas a imprimir por cada mercadería';
        
        // Restaurar vista previa normal
        document.getElementById('vista-previa-etiqueta').innerHTML = `
            <button type="button" class="btn btn-outline-primary" onclick="generarVistaPrevia()">
                <i class="fas fa-eye me-2"></i>Generar Vista Previa
            </button>
        `;
    }
}

// =============================================
// OBTENER OPCIONES DE IMPRESIÓN
// =============================================
function obtenerOpcionesImpresion() {
    const formato = document.getElementById('formato-etiqueta').value;
    
    const opciones = {
        formato: formato,
        incluir_precio: document.getElementById('incluir-precio').checked,
        incluir_codigo_barras: document.getElementById('incluir-codigo-barras').checked,
        tipo_codigo: document.getElementById('tipo-codigo').value,
        cantidad_por_mercaderia: parseInt(document.getElementById('cantidad-etiquetas').value) || 1,
        incluir_stock: document.getElementById('incluir-stock')?.checked || false
    };
    
    // Configuraciones específicas para rollo dos columnas
    if (formato === 'rollo_dos_columnas') {
        opciones.modo_impresion = 'rollo_continuo';
        opciones.columnas = 2;
        opciones.ancho_rollo = 80;
        opciones.ancho_etiqueta = 40;
        opciones.alto_etiqueta = 20;
    }
    
    return opciones;
}
// =============================================
// OBTENER MERCADERÍAS SELECCIONADAS
// =============================================
function obtenerMercaderiasSeleccionadas() {
    const checkboxes = document.querySelectorAll('input[name="mercaderia-seleccionada"]:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    console.log(`📋 Obtenidas ${ids.length} mercaderías seleccionadas:`, ids);
    return ids;
}

// =============================================
// AGREGAR BOTONES A LA TABLA DE MERCADERÍAS
// =============================================

// Modificar la función renderTablaMercaderias existente para agregar checkbox y botón de etiquetas
function renderTablaMercaderias() {
    try {
        const tbody = document.getElementById('tabla-mercaderias');
        
        if (!tbody) {
            console.error('❌ No se encontró el elemento tabla-mercaderias');
            return;
        }
        
        if (!mercaderias || !Array.isArray(mercaderias) || mercaderias.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center text-muted py-4">
                        <i class="fas fa-box fa-2x mb-2"></i><br>
                        No se encontraron mercaderías
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = mercaderias.map(mercaderia => {
            const proveedoresInfo = generarInfoProveedores(mercaderia);
            const stock = parseInt(mercaderia.stock_total || 0);
            const minimo = parseInt(mercaderia.stock_minimo || 0);
            const estadoStock = stock <= 0 ? 'bg-danger' : (stock <= minimo ? 'bg-warning' : 'bg-success');
            
            return `
                <tr ${!mercaderia.activo ? 'class="table-secondary opacity-75"' : ''}>
                    <td>
                        <input type="checkbox" class="form-check-input" name="mercaderia-checkbox" value="${mercaderia.id}">
                    </td>
                    <td>
                        ${mercaderia.imagen ? 
                            `<img src="${mercaderia.imagen}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">` :
                            '<div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border-radius: 4px;"><i class="fas fa-image text-muted"></i></div>'
                        }
                    </td>
                    <td>
                        <span class="text-primary fw-medium">${mercaderia.codigo_sku || 'N/A'}</span>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-medium">${mercaderia.descripcion || 'Sin descripción'}</span>
                        </div>
                    </td>
                    
                    <td>
                        <span class="text-success fw-medium">$${parseFloat(mercaderia.precio_venta || 0).toFixed(2)}</span>
                    </td>
                    <td>
                        <span class="badge ${estadoStock}">${stock}</span>
                        ${minimo > 0 ? `<br><small class="text-muted">Mín: ${minimo}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-secondary">${mercaderia.categoria || 'Sin categoría'}</span>
                    </td>
                    <td>
                        ${proveedoresInfo}
                    </td>
                    <td>
                        <span class="badge ${mercaderia.activo ? 'bg-success' : 'bg-danger'}">
                            ${mercaderia.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editarMercaderia(${mercaderia.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="gestionarProveedores(${mercaderia.id})" title="Gestionar Proveedores">
                                <i class="fas fa-truck"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="imprimirEtiquetasMercaderias([${mercaderia.id}])" title="Imprimir Etiqueta">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="eliminarMercaderia(${mercaderia.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        console.log(`✅ Tabla renderizada con ${mercaderias.length} mercaderías (con funcionalidad de etiquetas)`);
        
    } catch (error) {
        console.error('❌ Error renderizando tabla de mercaderías:', error);
    }
}

// =============================================
// FUNCIONES ADICIONALES
// =============================================

// Seleccionar/deseleccionar todas las mercaderías
function toggleSeleccionarTodas() {
    const checkboxes = document.querySelectorAll('input[name="mercaderia-checkbox"]');
    const seleccionarTodas = document.getElementById('seleccionar-todas').checked;
    
    checkboxes.forEach(cb => {
        cb.checked = seleccionarTodas;
    });
}

// Imprimir etiquetas de mercaderías seleccionadas
function imprimirEtiquetasSeleccionadas() {
    const seleccionadas = obtenerMercaderiasSeleccionadas();
    if (seleccionadas.length === 0) {
        showAlert('Debe seleccionar al menos una mercadería', 'warning');
        return;
    }
    
    imprimirEtiquetasMercaderias(seleccionadas);
}

// Event listeners para cambios en configuración
document.addEventListener('DOMContentLoaded', function() {
    // Cambio en tipo de impresora
    const tipoImpresoraSelect = document.getElementById('tipo-impresora');
    if (tipoImpresoraSelect) {
        tipoImpresoraSelect.addEventListener('change', actualizarEstadoImpresora);
    }
    
    // Cambio en opciones para regenerar vista previa automáticamente
    const opcionesInputs = ['formato-etiqueta', 'incluir-precio', 'incluir-codigo-barras', 'tipo-codigo', 'incluir-stock'];
    opcionesInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                // Regenerar vista previa automáticamente si ya hay una
                const vistaPreviaElement = document.getElementById('vista-previa-etiqueta');
                if (vistaPreviaElement && vistaPreviaElement.innerHTML.includes('etiqueta-preview')) {
                    generarVistaPrevia();
                }
            });
        }
    });
});

console.log('✅ Sistema de impresión de etiquetas cargado correctamente');

// =============================================
// FUNCIÓN PRINCIPAL: CARGAR CATEGORÍAS PARA FILTROS
// =============================================
async function cargarCategoriasParaFiltros() {
    try {
        console.log('🔄 Cargando categorías para filtros...');
        
        const response = await apiRequest('/categorias');
        
        if (response.success && response.data) {
            categoriasMercaderias = response.data;
            console.log(`✅ Categorías cargadas: ${categoriasMercaderias.length}`);
            
            // Llenar todos los selectores de categorías
            llenarSelectoresCategorias();
            
        } else {
            console.warn('⚠️ No se pudieron cargar categorías desde API, usando datos demo');
            cargarCategoriasDemoParaFiltros();
        }
        
    } catch (error) {
        console.error('❌ Error cargando categorías:', error);
        cargarCategoriasDemoParaFiltros();
    }
}

// =============================================
// LLENAR SELECTORES DE CATEGORÍAS
// =============================================
function llenarSelectoresCategorias() {
    // Lista de IDs de selectores que necesitan categorías
    const selectoresCategorias = [
        'filtro-categoria',           // Filtro en mercaderías
        'id_categoria',              // Formulario de mercadería
        'filtro-categoria-stock',    // Filtro en stock (si existe)
        'categoria_filtro',          // Otros filtros
        'select-categoria'           // Selector genérico
    ];
    
    selectoresCategorias.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        if (select) {
            console.log(`📝 Llenando selector: ${selectorId}`);
            llenarSelectorCategoria(select, selectorId);
        }
    });
}

// =============================================
// LLENAR UN SELECTOR ESPECÍFICO
// =============================================
function llenarSelectorCategoria(select, selectorId) {
    try {
        // Limpiar select
        select.innerHTML = '';
        
        // Agregar opción por defecto
        let placeholderText;
        if (selectorId.includes('filtro')) {
            placeholderText = 'Todas las categorías';
        } else {
            placeholderText = 'Seleccionar categoría...';
        }
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = placeholderText;
        select.appendChild(defaultOption);
        
        // 🔧 CORREGIDO: Determinar cómo llenar el select
        if (categoriasMercaderias && Array.isArray(categoriasMercaderias) && categoriasMercaderias.length > 0) {
            categoriasMercaderias
                .filter(categoria => categoria.activo == 1)
                .sort((a, b) => (a.categoria || '').localeCompare(b.categoria || ''))
                .forEach(categoria => {
                    const option = document.createElement('option');
                    
                    // Para filtros: usar el nombre de la categoría como valor
                    if (selectorId.includes('filtro')) {
                        option.value = categoria.categoria;  // Usar el nombre, no el ID
                        option.textContent = categoria.categoria;
                    } else {
                        // Para formularios: usar el ID como valor
                        option.value = categoria.id;
                        option.textContent = categoria.categoria;
                    }
                    
                    select.appendChild(option);
                });
            
            console.log(`✅ Selector ${selectorId} llenado con ${categoriasMercaderias.length} categorías`);
        } else {
            // 🔧 ALTERNATIVA: Extraer categorías únicas de las mercaderías mismas
            if (mercaderias && Array.isArray(mercaderias)) {
                const categoriasUnicas = [...new Set(
                    mercaderias
                        .map(m => m.categoria)
                        .filter(cat => cat && cat.trim() !== '')
                )].sort();
                
                categoriasUnicas.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    select.appendChild(option);
                });
                
                console.log(`✅ Selector ${selectorId} llenado con ${categoriasUnicas.length} categorías únicas de mercaderías`);
            }
        }
        
    } catch (error) {
        console.error(`❌ Error llenando selector ${selectorId}:`, error);
    }
}

// =============================================
// FUNCIÓN PARA EXTRAER CATEGORÍAS DE MERCADERÍAS
// =============================================
function extraerCategoriasDeOmercaderias() {
    try {
        if (!mercaderias || !Array.isArray(mercaderias)) {
            return [];
        }
        
        // Extraer categorías únicas de las mercaderías
        const categoriasUnicas = [...new Set(
            mercaderias
                .map(m => m.categoria)
                .filter(cat => cat && cat.trim() !== '')
        )].sort();
        
        // Convertir a formato estándar
        return categoriasUnicas.map((categoria, index) => ({
            id: index + 1,
            categoria: categoria,
            activo: 1
        }));
        
    } catch (error) {
        console.error('❌ Error extrayendo categorías:', error);
        return [];
    }
}

// =============================================
// FUNCIÓN MEJORADA PARA CARGAR CATEGORÍAS
// =============================================
async function cargarCategoriasParaFiltrosMejorada() {
    try {
        console.log('🔄 Cargando categorías para filtros (mejorado)...');
        
        // Opción 1: Intentar cargar desde API
        try {
            const response = await apiRequest('/categorias');
            
            if (response.success && response.data && response.data.length > 0) {
                categoriasMercaderias = response.data;
                console.log(`✅ Categorías cargadas desde API: ${categoriasMercaderias.length}`);
                llenarSelectoresCategorias();
                return;
            }
        } catch (apiError) {
            console.warn('⚠️ Error con API de categorías:', apiError.message);
        }
        
        // Opción 2: Extraer categorías de las mercaderías si ya están cargadas
        if (mercaderias && Array.isArray(mercaderias) && mercaderias.length > 0) {
            categoriasMercaderias = extraerCategoriasDeOmercaderias();
            console.log(`✅ Categorías extraídas de mercaderías: ${categoriasMercaderias.length}`);
            llenarSelectoresCategorias();
            return;
        }
        
        // Opción 3: Usar datos demo
        console.warn('⚠️ Usando categorías demo');
        cargarCategoriasDemoParaFiltros();
        
    } catch (error) {
        console.error('❌ Error cargando categorías mejorado:', error);
        cargarCategoriasDemoParaFiltros();
    }
}
// =============================================
// DATOS DEMO PARA CATEGORÍAS (FALLBACK)
// =============================================
function cargarCategoriasDemoParaFiltros() {
    console.log('📋 Cargando categorías demo para filtros...');
    
    categoriasMercaderias = [
        { id: 1, categoria: 'Electrónicos', activo: 1 },
        { id: 2, categoria: 'Herramientas', activo: 1 },
        { id: 3, categoria: 'Materiales', activo: 1 },
        { id: 4, categoria: 'Repuestos', activo: 1 },
        { id: 5, categoria: 'Accesorios', activo: 1 },
        { id: 6, categoria: 'Suministros', activo: 1 }
    ];
    
    llenarSelectoresCategorias();
    console.log('✅ Categorías demo cargadas para filtros');
}

// =============================================
// INICIALIZAR FILTROS DE MERCADERÍAS
// =============================================
function inicializarFiltrosMercaderias() {
    try {
        console.log('🔧 Inicializando filtros de mercaderías con persistencia...');
        
        const filtros = ['filtro-busqueda', 'filtro-categoria', 'filtro-stock', 'filtro-activo'];
        
        let filtrosEncontrados = 0;
        filtros.forEach(filtroId => {
            const elemento = document.getElementById(filtroId);
            if (elemento) {
                filtrosEncontrados++;
                
                if (filtroId === 'filtro-busqueda') {
                    elemento.addEventListener('input', debounce(aplicarFiltrosMercaderias, 500));
                    elemento.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') aplicarFiltrosMercaderias();
                    });
                } else {
                    elemento.addEventListener('change', aplicarFiltrosMercaderias);
                }
            }
        });
        
        console.log(`✅ Filtros con persistencia: ${filtrosEncontrados}/${filtros.length}`);
        
        // 🆕 CAMBIO 5: Restaurar filtros con más tiempo
        setTimeout(() => {
            const restaurado = restaurarFiltrosMercaderias();
            if (!restaurado) {
                console.log('ℹ️ No se restauraron filtros - usando configuración por defecto');
            }
        }, 2500);
        
    } catch (error) {
        console.error('❌ Error inicializando filtros:', error);
    }
}


// =============================================
// FUNCIÓN PARA APLICAR FILTROS DE MERCADERÍAS
// =============================================
async function aplicarFiltrosMercaderias() {
    try {
        if (!mercaderias || !Array.isArray(mercaderias)) {
            console.warn('⚠️ No hay mercaderías para filtrar');
            return;
        }
        
        console.log('🔍 Aplicando filtros de mercaderías...');
        
        // Obtener valores de filtros
        const busqueda = document.getElementById('filtro-busqueda')?.value?.toLowerCase() || '';
        const categoria = document.getElementById('filtro-categoria')?.value || '';
        const stock = document.getElementById('filtro-stock')?.value || '';
        const activo = document.getElementById('filtro-activo')?.value || '';
        
        // 🆕 CAMBIO 7: Guardar filtros usando la función getFiltrosMercaderias()
        try {
            const filtrosInstance = getFiltrosMercaderias();
            const filtrosActuales = { busqueda, categoria, stock, activo };
            filtrosInstance.guardarFiltros(filtrosActuales);
            console.log('💾 Filtros de mercaderías guardados:', filtrosActuales);
        } catch (filterError) {
            console.warn('⚠️ No se pudieron guardar los filtros:', filterError);
        }
        
        console.log('🔍 Filtros aplicados:', { busqueda, categoria, stock, activo });
        
        // El resto de tu código de filtrado permanece igual...
        const mercaderiasFiltradas = mercaderias.filter(mercaderia => {
            let cumpleFiltros = true;
            
            // Filtro de búsqueda
            if (busqueda) {
                const textosBusqueda = [
                    mercaderia.descripcion?.toLowerCase() || '',
                    mercaderia.codigo_sku?.toLowerCase() || '',
                ];
                cumpleFiltros = cumpleFiltros && textosBusqueda.some(texto => texto.includes(busqueda));
            }
            
            // Filtro de categoría
            if (categoria) {
                cumpleFiltros = cumpleFiltros && (mercaderia.categoria === categoria);
                console.log(`Comparando categoría: "${mercaderia.categoria}" === "${categoria}"`, mercaderia.categoria === categoria);
            }
            
            // Filtro de stock
            if (stock) {
                const stockActual = parseInt(mercaderia.stock_total || 0);
                const stockMinimo = parseInt(mercaderia.stock_minimo || 0);
                
                switch (stock) {
                    case 'con_stock':
                        cumpleFiltros = cumpleFiltros && (stockActual > 0);
                        break;
                    case 'sin_stock':
                        cumpleFiltros = cumpleFiltros && (stockActual <= 0);
                        break;
                    case 'stock_bajo':
                        cumpleFiltros = cumpleFiltros && (stockActual <= stockMinimo && stockActual > 0);
                        break;
                }
            }
            
            // Filtro de estado activo
            if (activo !== '') {
                cumpleFiltros = cumpleFiltros && (mercaderia.activo == activo);
            }
            
            return cumpleFiltros;
        });
        
        // Actualizar tabla con resultados filtrados
        renderTablaMercaderiasFiltradas(mercaderiasFiltradas);
        
        // Actualizar contador
        actualizarContadorFiltros(mercaderiasFiltradas.length, mercaderias.length);
        
        console.log(`✅ Filtros aplicados: ${mercaderiasFiltradas.length}/${mercaderias.length} mercaderías`);
        
    } catch (error) {
        console.error('❌ Error aplicando filtros:', error);
    }
}
// =============================================
// RENDERIZAR TABLA CON FILTROS
// =============================================
function renderTablaMercaderiasFiltradas(mercaderiasFiltradas) {
    // Temporalmente reemplazar el array global para el renderizado
    const mercaderiasOriginales = mercaderias;
    mercaderias = mercaderiasFiltradas;
    
    // Usar la función de renderizado existente
    renderTablaMercaderias();
    
    // Restaurar el array original
    mercaderias = mercaderiasOriginales;
}

// =============================================
// ACTUALIZAR CONTADOR DE FILTROS
// =============================================
function actualizarContadorFiltros(filtrados, total) {
    // Buscar elemento de contador (puede tener diferentes IDs)
    const contadores = [
        'contador-mercaderias',
        'contador-productos',
        'contador-filtros',
        'info-filtros'
    ];
    
    contadores.forEach(contadorId => {
        const contador = document.getElementById(contadorId);
        if (contador) {
            contador.textContent = `Mostrando ${filtrados} de ${total} mercaderías`;
        }
    });
    
    // También actualizar en cualquier elemento con clase 'contador-filtros'
    const contadoresClase = document.querySelectorAll('.contador-filtros');
    contadoresClase.forEach(contador => {
        contador.textContent = `${filtrados} / ${total}`;
    });
}

// =============================================
// FUNCIÓN PARA RECARGAR CATEGORÍAS MANUALMENTE
// =============================================
async function recargarCategorias() {
    try {
        showSpinner('Recargando categorías...');
        await cargarCategoriasParaFiltros();
        showAlert('Categorías recargadas exitosamente', 'success');
    } catch (error) {
        console.error('Error recargando categorías:', error);
        showAlert('Error al recargar categorías', 'danger');
    } finally {
        hideSpinner();
    }
}

// =============================================
// INICIALIZACIÓN AUTOMÁTICA
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Sistema de categorías para filtros inicializado');
    
    // Si ya estamos en la página de mercaderías, cargar categorías
    if (window.location.hash === '#mercaderias' || 
        document.getElementById('mercaderias')?.style.display !== 'none') {
        setTimeout(cargarCategoriasParaFiltros, 1000);
    }
});

console.log('✅ Sistema de categorías para filtros de mercaderías cargado correctamente');

// =============================================
// FUNCIÓN cargarProveedoresEnSegundoPlano COMPLETA
// Agregar después de las otras funciones
// =============================================

// =============================================
// OPCIÓN 1: FUNCIÓN COMPLETA (RECOMENDADA)
// =============================================
async function cargarProveedoresEnSegundoPlano() {
    try {
        if (!mercaderias || !Array.isArray(mercaderias)) {
            console.warn('⚠️ No hay mercaderías para cargar proveedores');
            return;
        }
        
        console.log('🔍 Iniciando carga de proveedores en segundo plano...');
        
        // Procesar mercaderías en lotes para no bloquear la UI
        const BATCH_SIZE = 5; // Procesar de a 5
        const batches = [];
        
        for (let i = 0; i < mercaderias.length; i += BATCH_SIZE) {
            batches.push(mercaderias.slice(i, i + BATCH_SIZE));
        }
        
        let procesadas = 0;
        
        for (const batch of batches) {
            // Procesar lote actual
            await Promise.all(batch.map(async (mercaderia) => {
                try {
                    const infoProveedores = await cargarProveedoresMercaderiaSeguro(mercaderia.id);
                    
                    // Asignar información de proveedores
                    mercaderia.proveedores = infoProveedores.proveedores;
                    mercaderia.total_proveedores = infoProveedores.total_proveedores;
                    mercaderia.proveedor_principal = infoProveedores.proveedor_principal;
                    
                    procesadas++;
                    
                } catch (error) {
                    console.warn(`⚠️ Error cargando proveedores para ${mercaderia.descripcion}:`, error.message);
                    // Asignar valores por defecto en caso de error
                    mercaderia.proveedores = [];
                    mercaderia.total_proveedores = 0;
                    mercaderia.proveedor_principal = null;
                }
            }));
            
            // Pequeña pausa entre lotes para no saturar
            await new Promise(resolve => setTimeout(resolve, 100));
            
            console.log(`🔄 Progreso: ${procesadas}/${mercaderias.length} mercaderías procesadas`);
        }
        
        console.log('✅ Proveedores cargados en segundo plano completado');
        
    } catch (error) {
        console.error('❌ Error en carga de proveedores en segundo plano:', error);
    }
}

// =============================================
// FUNCIÓN AUXILIAR: cargarProveedoresMercaderiaSeguro
// =============================================
async function cargarProveedoresMercaderiaSeguro(mercaderiaId) {
    try {
        const response = await apiRequest(`/mercaderias/${mercaderiaId}/proveedores`);
        
        if (response.success && Array.isArray(response.data)) {
            return {
                proveedores: response.data,
                total_proveedores: response.data.length,
                proveedor_principal: response.data.find(p => p.es_proveedor_principal) || null
            };
        } else {
            return {
                proveedores: [],
                total_proveedores: 0,
                proveedor_principal: null
            };
        }
    } catch (error) {
        console.warn(`⚠️ Error cargando proveedores para mercadería ${mercaderiaId}:`, error.message);
        return {
            proveedores: [],
            total_proveedores: 0,
            proveedor_principal: null
        };
    }
}

// =============================================
// EVENTO PARA CARGAR MERCADERÍAS POR PROVEEDOR 

/*document.getElementById('compra-proveedor').addEventListener('change', function() {
    const proveedorId = this.value;
    cargarMercaderiasPorProveedor(proveedorId);
});*/

async function cargarMercaderiasPorProveedor(proveedorId) {
    const selectMercaderia = document.getElementById('producto-select'); // o el selector que uses
    
    if (!proveedorId) {
        // Si no hay proveedor seleccionado, limpiar mercaderías
        selectMercaderia.innerHTML = '<option value="">Primero seleccione un proveedor</option>';
        selectMercaderia.disabled = true;
        return;
    }
    
    try {
        // Mostrar loading
        selectMercaderia.innerHTML = '<option value="">Cargando mercaderías...</option>';
        selectMercaderia.disabled = true;
        
        // Hacer petición al backend
        const response = await apiRequest(`/proveedores/${proveedorId}/mercaderias`);
        
        if (response.success) {
            selectMercaderia.innerHTML = '<option value="">Seleccionar mercadería...</option>';
            
            response.data.forEach(mercaderia => {
                const option = document.createElement('option');
                option.value = mercaderia.mercaderia_id;
                option.textContent = `${mercaderia.codigo_sku} - ${mercaderia.descripcion}`;
                
                // Agregar datos específicos del proveedor
                option.setAttribute('data-precio-proveedor', mercaderia.precio_compra || 0);
                option.setAttribute('data-codigo-proveedor', mercaderia.codigo_producto_proveedor || '');
                option.setAttribute('data-tiempo-entrega', mercaderia.tiempo_entrega_dias || 7);
                option.setAttribute('data-cantidad-minima', mercaderia.cantidad_minima_pedido || 1);
                
                selectMercaderia.appendChild(option);
            });
            
            selectMercaderia.disabled = false;
            console.log(`✅ Cargadas ${response.data.length} mercaderías del proveedor`);
        }
    } catch (error) {
        console.error('Error cargando mercaderías del proveedor:', error);
        selectMercaderia.innerHTML = '<option value="">Error al cargar mercaderías</option>';
        showAlert('Error al cargar mercaderías del proveedor', 'warning');
    }
}
function actualizarDatosProveedor(selectElement, productIndex) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const productoCard = selectElement.closest('.producto-compra');
    
    if (selectedOption.value) {
        // Actualizar campos con datos del proveedor
        const codigoProveedorDisplay = productoCard.querySelector('.codigo-proveedor-display');
        const precioInput = productoCard.querySelector('.precio-input');
        const tiempoEntregaDisplay = productoCard.querySelector('.tiempo-entrega-display');
        const cantidadMinimaDisplay = productoCard.querySelector('.cantidad-minima-display');
        const cantidadInput = productoCard.querySelector('.cantidad-input');
        
        // Llenar datos
        codigoProveedorDisplay.value = selectedOption.getAttribute('data-codigo-proveedor') || '';
        precioInput.value = selectedOption.getAttribute('data-precio-proveedor') || 0;
        tiempoEntregaDisplay.textContent = selectedOption.getAttribute('data-tiempo-entrega') || 7;
        cantidadMinimaDisplay.textContent = selectedOption.getAttribute('data-cantidad-minima') || 1;
        
        // Establecer cantidad mínima
        const cantidadMinima = parseInt(selectedOption.getAttribute('data-cantidad-minima')) || 1;
        cantidadInput.min = cantidadMinima;
        cantidadInput.value = cantidadMinima;
        
        // Mostrar alerta si la cantidad mínima es alta
        if (cantidadMinima > 1) {
            showAlert(`Cantidad mínima para este producto: ${cantidadMinima} unidades`, 'info');
        }
        
    } else {
        // Limpiar campos
        productoCard.querySelector('.codigo-proveedor-display').value = '';
        productoCard.querySelector('.precio-input').value = 0;
        productoCard.querySelector('.tiempo-entrega-display').textContent = '-';
        productoCard.querySelector('.cantidad-minima-display').textContent = '-';
        productoCard.querySelector('.cantidad-input').value = 1;
    }
}

async function mostrarInfoProveedor(proveedorId) {
    const infoDiv = document.getElementById('info-proveedor-seleccionado');
    
    if (!proveedorId) {
        infoDiv.style.display = 'none';
        return;
    }
    
    try {
        const response = await apiRequest(`/proveedores/${proveedorId}/info-compras`);
        
        if (response.success) {
            const proveedor = response.data;
            
            document.getElementById('total-productos-proveedor').textContent = proveedor.total_productos || 0;
            document.getElementById('promedio-entrega').textContent = Math.round(proveedor.promedio_entrega) || 0;
            document.getElementById('compras-recientes').textContent = proveedor.compras_ultimos_6_meses || 0;
            document.getElementById('telefono-proveedor').textContent = proveedor.telefono || '-';
            
            infoDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Error cargando info del proveedor:', error);
    }
}

// Inicializar la actualización de formato al cargar la página
document.addEventListener('DOMContentLoaded', function() {

    // Configurar evento para el selector de formato
    const formatoSelect = document.getElementById('formato-etiqueta');
    if (formatoSelect) {
        formatoSelect.addEventListener('change', actualizarVistaPreviaFormato);
        // Llamar una vez para configurar el estado inicial
        actualizarVistaPreviaFormato();

    }
});

//chequera impresora**/

// Nueva función para verificación inicial
async function verificarImpresoraUSBInicial() {
    try {
        console.log('🖨️ Verificando impresora USB al iniciar...');
        
        const response = await apiRequest('/etiquetas/configurar-impresora', 'POST', {
            tipo: 'usb'
        });
        
        if (response.success) {
            console.log('USB Status:', response.message);
            // Actualizar configuración local
            if (configImpresora) {
                configImpresora.impresoras.usb.activa = response.data.activa;
                actualizarEstadoImpresora();
            }
        }
    } catch (error) {
        console.error('Error verificando USB inicial:', error);
    }
}

// =============================================
// VERIFICACIÓN AUTOMÁTICA AL CARGAR LA PÁGINA
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    // Verificar USB automáticamente al cargar
    setTimeout(() => {
        verificarImpresoraUSBInicial();
    }, 2000);
});

// =============================================
// VERIFICACIÓN INICIAL DE USB
// =============================================
async function verificarImpresoraUSBInicial() {
    try {
        console.log('🖨️ Verificando impresora USB al iniciar...');
        showSpinner('Detectando impresoras USB...');
        
        const response = await apiRequest('/etiquetas/configurar-impresora', 'POST', {
            tipo: 'usb'
        });
        
        hideSpinner();
        
        if (response.success) {
            estadoUSBGlobal = response.data;
            console.log('✅ Verificación USB completa:', response.data);
            
            // Actualizar interfaz
            actualizarEstadoImpresoraUSB(response.data);
            
            // Mostrar resultado
            if (response.data.activa) {
                showAlert(`USB detectada: ${response.message}`, 'success');
            } else {
                console.warn('⚠️ USB no detectada:', response.message);
            }
        } else {
            console.error('❌ Error verificando USB:', response.message);
        }
        
    } catch (error) {
        hideSpinner();
        console.error('💥 Error en verificación USB inicial:', error);
    }
}

// =============================================
// VERIFICACIÓN MANUAL DE USB
// =============================================
async function configurarImpresoraUSB() {
    try {
        showSpinner('Detectando impresora USB...');
        console.log('🔄 Iniciando verificación manual USB...');
        
        const response = await apiRequest('/etiquetas/configurar-impresora', 'POST', {
            tipo: 'usb'
        });
        
        hideSpinner();
        
        if (response.success) {
            estadoUSBGlobal = response.data;
            
            // Actualizar configuración global
            if (configImpresora) {
                configImpresora.impresoras.usb.activa = response.data.activa;
            }
            
            // Actualizar interfaz
            actualizarEstadoImpresoraUSB(response.data);
            
            // Mostrar resultado detallado
            const tipoAlerta = response.data.activa ? 'success' : 'warning';
            showAlert(response.message, tipoAlerta);
            
            // Log detallado
            console.log('📊 Estado USB actualizado:', {
                activa: response.data.activa,
                metodo_exitoso: response.data.metodo_exitoso,
                soporte_usb: response.data.soporte_usb,
                entorno: response.data.entorno,
                errores: response.data.errores
            });
            
        } else {
            showAlert('Error verificando impresora USB: ' + response.message, 'danger');
        }
        
    } catch (error) {
        hideSpinner();
        console.error('💥 Error en configuración USB manual:', error);
        showAlert('Error de conexión al verificar USB', 'danger');
    }
}

// =============================================
// DIAGNÓSTICO COMPLETO USB
// =============================================
async function ejecutarDiagnosticoUSB() {
    try {
        showSpinner('Ejecutando diagnóstico completo USB...');
        console.log('🔧 Iniciando diagnóstico completo USB...');
        
        const response = await apiRequest('/etiquetas/diagnostico-usb', 'GET');
        
        hideSpinner();
        
        if (response.success) {
            const diagnostico = response.data;
            
            // Mostrar resultados en consola
            console.group('📋 DIAGNÓSTICO USB COMPLETO');
            console.log('🖥️ Entorno:', diagnostico.entorno);
            console.log('📦 Dependencias:', diagnostico.dependencias);
            console.log('🧪 Pruebas individuales:', diagnostico.pruebas);
            console.log('🚀 Prueba robusta:', diagnostico.prueba_robusta);
            console.log('📊 Estado actual:', diagnostico.estado_actual);
            console.groupEnd();
            
            // Crear modal con resultados
            mostrarModalDiagnosticoUSB(diagnostico);
            
        } else {
            showAlert('Error ejecutando diagnóstico: ' + response.message, 'danger');
        }
        
    } catch (error) {
        hideSpinner();
        console.error('💥 Error en diagnóstico USB:', error);
        showAlert('Error de conexión en diagnóstico USB', 'danger');
    }
}

// =============================================
// ACTUALIZAR INTERFAZ USB
// =============================================
function actualizarEstadoImpresoraUSB(datosUSB) {
    const estadoElement = document.getElementById('estado-impresora');
    const tipoImpresora = document.getElementById('tipo-impresora')?.value;
    
    if (tipoImpresora === 'usb' && estadoElement) {
        if (datosUSB.activa) {
            const metodo = datosUSB.metodo_exitoso ? ` (${datosUSB.metodo_exitoso})` : '';
            estadoElement.innerHTML = `<i class="fas fa-check-circle text-success"></i> Conectada${metodo}`;
        } else {
            const razon = !datosUSB.soporte_usb ? ' (no soportada)' : ' (no detectada)';
            estadoElement.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> No conectada${razon}`;
        }
    }
    
    // Actualizar botones USB si existen
    actualizarBotonesUSB(datosUSB);
}

function actualizarBotonesUSB(datosUSB) {
    const configUSBDiv = document.getElementById('config-usb');
    
    if (configUSBDiv) {
        configUSBDiv.innerHTML = `
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="configurarImpresoraUSB()">
                <i class="fas fa-usb me-1"></i>Detectar USB
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" onclick="ejecutarDiagnosticoUSB()">
                <i class="fas fa-tools me-1"></i>Diagnóstico
            </button>
            <span id="estado-usb-detallado" class="ms-2 text-muted">
                ${datosUSB.activa ? 
                    `✅ Detectada (${datosUSB.metodo_exitoso || 'método desconocido'})` : 
                    '❌ No detectada'
                }
            </span>
        `;
    }
}

// =============================================
// MODAL DE DIAGNÓSTICO USB
// =============================================
function mostrarModalDiagnosticoUSB(diagnostico) {
    // Crear modal dinámicamente
    const modalHTML = `
        <div class="modal fade" id="modalDiagnosticoUSB" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">🔧 Diagnóstico USB Completo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${generarHTMLDiagnostico(diagnostico)}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="copiarDiagnosticoAlPortapapeles()">
                            <i class="fas fa-copy me-1"></i>Copiar Diagnóstico
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const modalAnterior = document.getElementById('modalDiagnosticoUSB');
    if (modalAnterior) {
        modalAnterior.remove();
    }
    
    // Agregar nuevo modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalDiagnosticoUSB'));
    modal.show();
    
    // Guardar diagnóstico para copiar
    window.ultimoDiagnosticoUSB = diagnostico;
}

function generarHTMLDiagnostico(diagnostico) {
    return `
        <div class="row">
            <!-- Entorno -->
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-desktop me-1"></i>Entorno del Sistema</h6>
                <div class="small">
                    <div><strong>Node.js:</strong> ${diagnostico.entorno.node_version}</div>
                    <div><strong>Plataforma:</strong> ${diagnostico.entorno.plataforma}</div>
                    <div><strong>Arquitectura:</strong> ${diagnostico.entorno.arquitectura}</div>
                    <div><strong>Ambiente:</strong> ${diagnostico.entorno.env}</div>
                    <div><strong>Soporte USB:</strong> 
                        <span class="badge bg-${diagnostico.entorno.soporte_usb ? 'success' : 'danger'}">
                            ${diagnostico.entorno.soporte_usb ? 'Sí' : 'No'}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Dependencias -->
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-puzzle-piece me-1"></i>Dependencias</h6>
                <div class="small">
                    ${Object.entries(diagnostico.dependencias).map(([key, value]) => 
                        `<div><strong>${key}:</strong> 
                            <span class="badge bg-${value === true ? 'success' : 'danger'}">
                                ${value === true ? 'OK' : (typeof value === 'string' ? value : 'Error')}
                            </span>
                        </div>`
                    ).join('')}
                </div>
            </div>
        </div>
        
        <!-- Pruebas Individuales -->
        <div class="mb-3">
            <h6><i class="fas fa-vials me-1"></i>Pruebas Individuales</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Método</th>
                            <th>Resultado</th>
                            <th>Duración</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(diagnostico.pruebas).map(([metodo, datos]) => `
                            <tr>
                                <td><code>${metodo}</code></td>
                                <td>
                                    <span class="badge bg-${datos.resultado ? 'success' : 'danger'}">
                                        ${datos.resultado ? 'Éxito' : 'Falló'}
                                    </span>
                                </td>
                                <td>${datos.duracion_ms || 'N/A'}ms</td>
                                <td>
                                    ${datos.error ? `<small class="text-danger">${datos.error}</small>` : datos.estado}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Prueba Robusta -->
        <div class="mb-3">
            <h6><i class="fas fa-shield-alt me-1"></i>Prueba Robusta Final</h6>
            <div class="alert alert-${diagnostico.prueba_robusta.resultado ? 'success' : 'warning'}">
                <strong>Resultado:</strong> 
                <span class="badge bg-${diagnostico.prueba_robusta.resultado ? 'success' : 'danger'}">
                    ${diagnostico.prueba_robusta.resultado ? 'ÉXITO' : 'FALLÓ'}
                </span>
                <br>
                <strong>Duración:</strong> ${diagnostico.prueba_robusta.duracion_ms}ms
                ${diagnostico.prueba_robusta.metodo_exitoso ? 
                    `<br><strong>Método exitoso:</strong> ${diagnostico.prueba_robusta.metodo_exitoso}` : 
                    ''
                }
                ${diagnostico.prueba_robusta.error ? 
                    `<br><strong>Error:</strong> <code>${diagnostico.prueba_robusta.error}</code>` : 
                    ''
                }
            </div>
        </div>
        
        <!-- Estado Actual -->
        <div class="mb-3">
            <h6><i class="fas fa-info-circle me-1"></i>Estado Actual del Sistema</h6>
            <div class="small">
                <div><strong>Verificado:</strong> ${diagnostico.estado_actual.verificado ? 'Sí' : 'No'}</div>
                <div><strong>Última verificación:</strong> ${diagnostico.estado_actual.ultima_verificacion || 'Nunca'}</div>
                <div><strong>Método exitoso:</strong> ${diagnostico.estado_actual.metodo_exitoso || 'Ninguno'}</div>
                ${diagnostico.estado_actual.errores_acumulados && diagnostico.estado_actual.errores_acumulados.length > 0 ? 
                    `<div><strong>Errores:</strong> <code>${diagnostico.estado_actual.errores_acumulados.join(', ')}</code></div>` : 
                    ''
                }
            </div>
        </div>
    `;
}

// =============================================
// UTILIDADES
// =============================================
function copiarDiagnosticoAlPortapapeles() {
    if (window.ultimoDiagnosticoUSB) {
        const texto = JSON.stringify(window.ultimoDiagnosticoUSB, null, 2);
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(texto).then(() => {
                showAlert('Diagnóstico copiado al portapapeles', 'success');
            }).catch(() => {
                fallbackCopiarTexto(texto);
            });
        } else {
            fallbackCopiarTexto(texto);
        }
    }
}

function fallbackCopiarTexto(texto) {
    const textarea = document.createElement('textarea');
    textarea.value = texto;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showAlert('Diagnóstico copiado al portapapeles', 'success');
}

// =============================================
// EVENTOS PARA CAMBIO DE TIPO DE IMPRESORA
// =============================================
document.addEventListener('change', function(e) {
    if (e.target.id === 'tipo-impresora') {
        const tipoSeleccionado = e.target.value;
        
        // Mostrar/ocultar configuraciones según el tipo
        const configRed = document.getElementById('config-red');
        const configUSB = document.getElementById('config-usb');
        
        if (configRed && configUSB) {
            if (tipoSeleccionado === 'red') {
                configRed.style.display = 'block';
                configUSB.style.display = 'none';
            } else if (tipoSeleccionado === 'usb') {
                configRed.style.display = 'none';
                configUSB.style.display = 'block';
                
                // Auto-verificar USB si hay datos
                if (estadoUSBGlobal) {
                    actualizarEstadoImpresoraUSB(estadoUSBGlobal);
                }
            }
        }
        
        // Actualizar estado general
        actualizarEstadoImpresora();
    }
});

console.log('✅ Sistema de verificación USB robusta cargado correctamente');
console.log('🛠️ Funciones disponibles: verificarImpresoraUSBInicial(), configurarImpresoraUSB(), ejecutarDiagnosticoUSB()');

document.addEventListener('DOMContentLoaded', function() {
    const tipoImpresora = document.getElementById('tipo-impresora');
    const configRed = document.getElementById('config-red');
    const configUSB = document.getElementById('config-usb');
    
    if (tipoImpresora) {
        tipoImpresora.addEventListener('change', function() {
            const tipo = this.value;
            
            if (configRed && configUSB) {
                if (tipo === 'red') {
                    configRed.style.display = 'block';
                    configUSB.style.display = 'none';
                } else if (tipo === 'usb') {
                    configRed.style.display = 'none';
                    configUSB.style.display = 'block';
                    
                    // Auto-verificar USB si no se ha hecho
                    if (!estadoUSBGlobal || !estadoUSBGlobal.verificado) {
                        setTimeout(() => {
                            configurarImpresoraUSB();
                        }, 500);
                    }
                }
            }
        });
    }
});

function verificarModalEtiquetas() {
    let modal = document.getElementById('modalImprimirEtiquetas');
    
    if (!modal) {
        console.log('📝 Creando modal de etiquetas...');
        
        const modalHTML = `
        <!-- Modal de Impresión de Etiquetas -->
        <!-- Modal Imprimir Etiquetas -->
<div class="modal fade" id="modalImprimirEtiquetas" tabindex="-1" aria-labelledby="modalEtiquetasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEtiquetasLabel">
                    <i class="fas fa-tags me-2"></i>Imprimir Etiquetas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Lista de mercaderías seleccionadas -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6><i class="fas fa-list me-1"></i>Mercaderías Seleccionadas</h6>
                        <div id="lista-mercaderias-etiquetas" class="border rounded p-3 bg-light">
                            <div class="text-muted text-center">
                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando mercaderías...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración de etiquetas -->
                <div class="row">
                    <!-- Columna izquierda: Opciones de etiqueta -->
                    <div class="col-md-6">
                        <h6><i class="fas fa-cog me-1"></i>Configuración de Etiquetas</h6>
                        
                        <!-- Formato de etiqueta -->
                        <div class="mb-3">
                            <label class="form-label">Formato de Etiqueta</label>
                            <select class="form-select" id="formato-etiqueta" onchange="actualizarVistaPreviaFormato()">
                                <option value="pequena">Pequeña (40x30mm)</option>
                                <option value="mediana" selected>Mediana (60x40mm)</option>
                                <option value="grande">Grande (80x50mm)</option>
                                <option value="rollo_dos_columnas">Rollo 80mm - 2 columnas</option>
                            </select>
                            <div class="form-text" id="descripcion-formato">
                                Etiquetas individuales estándar
                            </div>
                        </div>

                        <!-- Información específica para rollo dos columnas -->
                        <div class="alert alert-info" id="info-rollo-columnas" style="display: none;">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-1"></i>Formato Rollo Dos Columnas
                            </h6>
                            <p class="mb-2">Cada fila contiene la misma mercadería en ambas columnas:</p>
                            <ul class="mb-0 small">
                                <li>Optimizado para rollos de 80mm</li>
                                <li>Cada "repetición" = 1 fila con 2 etiquetas</li>
                                <li>Ideal para inventario rápido</li>
                            </ul>
                        </div>

                        <!-- Cantidad de etiquetas -->
                        <div class="mb-3">
                            <label class="form-label" id="label-cantidad-etiquetas">Cantidad por Mercadería</label>
                            <input type="number" class="form-control" id="cantidad-etiquetas" min="1" max="50" value="1">
                            <div class="form-text" id="ayuda-cantidad">
                                Número de etiquetas a imprimir por cada mercadería
                            </div>
                        </div>

                        <!-- Contenido de etiquetas -->
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="incluir-precio" checked>
                                    <label class="form-check-label" for="incluir-precio">
                                        Incluir precio
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="incluir-stock">
                                    <label class="form-check-label" for="incluir-stock">
                                        Incluir stock
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Código de barras -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="incluir-codigo-barras" checked>
                                <label class="form-check-label" for="incluir-codigo-barras">
                                    Incluir código de barras
                                </label>
                            </div>
                            <select class="form-select form-select-sm mt-2" id="tipo-codigo">
                                <option value="auto">Automático (Code 128)</option>
                                <option value="ean13">EAN-13</option>
                                <option value="code128">Code 128</option>
                            </select>
                        </div>

                        <!-- Vista previa -->
                        <div class="mb-3">
                            <label class="form-label">Vista Previa</label>
                            <div id="vista-previa-etiqueta" class="border rounded p-3 text-center bg-light">
                                <button type="button" class="btn btn-outline-primary" onclick="generarVistaPrevia()">
                                    <i class="fas fa-eye me-2"></i>Generar Vista Previa
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Columna derecha: Configuración de impresora -->
                    <div class="col-md-6">
                        <h6><i class="fas fa-print me-1"></i>Impresora</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de Impresora</label>
                            <select class="form-select" id="tipo-impresora" onchange="onTipoImpresoraChange()">
                                <option value="red" selected>Red/TCP (Impresora de red)</option>
                                <option value="qz-tray">QZ Tray (Impresoras Locales)</option>
                                <option value="usb" disabled>USB (No disponible)</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Seleccione el método de impresión preferido
                            </div>
                        </div>

                        <!-- Configuración RED -->
                        <div class="mb-3" id="config-red" style="display: block;">
                            <div class="row g-2">
                                <div class="col-8">
                                    <input type="text" class="form-control form-control-sm" id="ip-impresora" 
                                           placeholder="192.168.1.100" readonly>
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control form-control-sm" id="puerto-impresora" 
                                           placeholder="9100" readonly>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="configurarImpresoraRed()">
                                    <i class="fas fa-cog me-1"></i>Configurar IP
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm ms-2" onclick="verificarEstadoImpresora()">
                                    <i class="fas fa-sync me-1"></i>Verificar
                                </button>
                                <small id="estado-impresora" class="ms-2 text-muted">No verificada</small>
                            </div>
                        </div>

                        <!-- Configuración QZ TRAY -->
                        <div class="mb-3" id="config-qz-tray" style="display: none;">
                            <div class="row g-2">
                                <div class="col-8">
                                    <select class="form-select form-select-sm" id="impresora-qz-select">
                                        <option value="">Cargando impresoras...</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="verificarEstadoQZTray()">
                                        <i class="fas fa-sync me-1"></i>Actualizar
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small id="estado-qz-tray" class="text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Conectando a QZ Tray...
                                </small>
                                <button type="button" class="btn btn-link btn-sm p-0 ms-2" id="btn-conectar-qz" 
                                        onclick="inicializarQZTray()" style="display: none;">
                                    <i class="fas fa-plug me-1"></i>Conectar QZ Tray
                                </button>
                            </div>
                        </div>

                        <!-- Información QZ Tray -->
                        <div class="alert alert-info" id="info-qz-tray" style="display: none;">
                            <h6 class="alert-heading">
                                <i class="fas fa-desktop me-1"></i>QZ Tray - Impresión Local
                            </h6>
                            <p class="mb-2">QZ Tray permite imprimir directamente:</p>
                            <ul class="mb-2 small">
                                <li>✅ Impresión directa desde navegador</li>
                                <li>✅ Compatible con impresoras térmicas</li>
                                <li>✅ Sin configuración de red</li>
                                <li>✅ Soporte ZPL, EPL, ESC/POS</li>
                            </ul>
                            <div class="mt-2">
                                <a href="https://qz.io/" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-download me-1"></i>Descargar QZ Tray
                                </a>
                            </div>
                        </div>

                        <!-- Información sobre impresoras de red -->
                        <div class="alert alert-info" id="info-red" style="display: block;">
                            <h6 class="alert-heading">
                                <i class="fas fa-network-wired me-1"></i>Impresoras de Red
                            </h6>
                            <p class="mb-2">Sistema actual con impresoras TCP/IP:</p>
                            <ul class="mb-0 small">
                                <li>✅ Más estables y confiables</li>
                                <li>✅ Sin drivers USB requeridos</li>
                                <li>✅ Funcionan remotamente</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <!-- Botón QZ Tray -->
                <button type="button" class="btn btn-primary" id="btn-imprimir-qz" onclick="imprimirConQZTray()" style="display: none;">
                    <i class="fas fa-print me-2"></i>Imprimir con QZ Tray
                </button>
                
                <!-- Botón Red -->
                <button type="button" class="btn btn-success" id="btn-imprimir-red" onclick="procesarImpresionDirecta()" style="display: inline-block;">
                    <i class="fas fa-print me-2"></i>Imprimir en Red
                </button>
                
                <!-- Botón PDF -->
                <button type="button" class="btn btn-outline-primary" onclick="generarPDFEtiquetas()">
                    <i class="fas fa-file-pdf me-2"></i>Generar PDF
                </button>
                
                <!-- Botón Cancelar -->
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
            </div>
        </div>
    </div>
</div>
        `;
        
        // Agregar modal al final del body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        console.log('✅ Modal de etiquetas creado');
        
        // Recargar configuración después de crear el modal
        setTimeout(() => {
            cargarConfiguracionImpresora();
        }, 500);
    }
    
    return document.getElementById('modalImprimirEtiquetas');
}


console.log('✅ Sistema de etiquetas cargado (versión corregida con verificaciones)');

document.addEventListener('DOMContentLoaded', function() {
    console.log('🏷️ Inicializando sistema de etiquetas...');
    
    // Cargar configuración inmediatamente
    cargarConfiguracionImpresora();
    
    // También recargar cuando se abra cualquier modal de etiquetas
    const modalEtiquetas = document.getElementById('modalImprimirEtiquetas');
    if (modalEtiquetas) {
        modalEtiquetas.addEventListener('shown.bs.modal', function() {
            // Recargar configuración cada vez que se abre el modal
            cargarConfiguracionImpresora();
        });
    }
    
    console.log('✅ Sistema de etiquetas inicializado');
});

async function verificarEstadoImpresora() {
    try {
        showSpinner('Verificando estado de impresora...');
        
        const response = await apiRequest('/etiquetas/verificar-estado', 'GET');
        
        hideSpinner();
        
        if (response.success) {
            const data = response.data;
            
            // Actualizar configuración local
            if (configImpresora) {
                configImpresora.impresoras.red.activa = data.activa;
            }
            
            // Actualizar UI
            actualizarEstadoImpresora();
            
            // Mostrar resultado
            const mensaje = data.activa ? 
                `✅ ${data.mensaje}` : 
                `❌ ${data.mensaje}`;
                
            const tipo = data.activa ? 'success' : 'warning';
            showAlert(mensaje, tipo);
            
            if (data.cambio_detectado) {
                const cambioMsg = data.activa ? 
                    'La impresora se reconectó' : 
                    'La impresora se desconectó';
                showAlert(`🔄 ${cambioMsg}`, 'info');
            }
            
        } else {
            showAlert('Error verificando estado: ' + response.message, 'danger');
        }
        
    } catch (error) {
        hideSpinner();
        console.error('Error verificando estado:', error);
        showAlert('Error de conexión al verificar estado', 'danger');
    }
}

// =============================================
// 🔧 FUNCIONES PARA OTROS MÓDULOS
// =============================================



// Función para restaurar filtros de proveedores
function restaurarFiltrosProveedores() {
    const filtrosGuardados = filtrosProveedores.aplicarFiltrosGuardados();
    if (Object.keys(filtrosGuardados).length > 0) {
        setTimeout(() => aplicarFiltrosProveedores(), 500);
    }
}

// Función para restaurar filtros de mercaderías
function restaurarFiltrosMercaderias() {
    try {
        const filtrosInstance = getFiltrosMercaderias();
        
        if (!filtrosInstance || typeof filtrosInstance.aplicarFiltrosGuardados !== 'function') {
            console.log('⚠️ Sistema de filtros no disponible aún');
            return false;
        }
        
        const filtrosGuardados = filtrosInstance.aplicarFiltrosGuardados();
        
        if (Object.keys(filtrosGuardados).length > 0) {
            console.log('🔄 Restaurando filtros de mercaderías:', filtrosGuardados);
            
            const hayFiltros = Object.values(filtrosGuardados).some(valor => 
                valor !== '' && valor !== false && valor !== null && valor !== undefined
            );
            
            if (hayFiltros) {
                if (typeof aplicarFiltrosMercaderias === 'function') {
                    setTimeout(() => aplicarFiltrosMercaderias(), 500);
                    return true;
                } else {
                    console.log('⚠️ Función aplicarFiltrosMercaderias no disponible');
                }
            }
        }
        
        return false;
        
    } catch (error) {
        console.error('Error restaurando filtros de mercaderías:', error);
        return false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Configurar auto-guardado para campos de búsqueda
    const camposBusqueda = [
        'filtro-clientes-busqueda',
        'filtro-proveedores-busqueda', 
        'filtro-mercaderias-busqueda'
    ];
    
    camposBusqueda.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
            campo.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const modulo = campoId.split('-')[1]; // extrae 'clientes', 'proveedores', etc.
                    window[`aplicarFiltros${modulo.charAt(0).toUpperCase() + modulo.slice(1)}`]?.();
                }
            });
        }
    });
    
    // Configurar auto-guardado para selects
    const selectsAutoFilter = [
        'filtro-clientes-vendedor',
        'filtro-clientes-zona',
        'filtro-clientes-activo',
        'filtro-clientes-deposito',
        'filtro-clientes-iva',
        'filtro-proveedores-estado',
        'filtro-mercaderias-categoria'
    ];
    
    selectsAutoFilter.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.addEventListener('change', function() {
                const modulo = selectId.split('-')[1];
                setTimeout(() => {
                    window[`aplicarFiltros${modulo.charAt(0).toUpperCase() + modulo.slice(1)}`]?.();
                }, 300);
            });
        }
    });
});

// =============================================
// 🔧 FUNCIONES DE UTILIDAD
// =============================================

// Función para limpiar todos los filtros guardados
function limpiarTodosFiltrosGuardados() {
    ['clientes', 'proveedores', 'mercaderias', 'transferencias'].forEach(modulo => {
        localStorage.removeItem(`filtros_${modulo}`);
    });
    showAlert('Todos los filtros guardados han sido limpiados', 'info');
}

// Función para mostrar estado de filtros guardados (útil para debug)
function mostrarEstadoFiltros() {
    const modulos = ['clientes', 'proveedores', 'mercaderias'];
    const estado = {};
    
    modulos.forEach(modulo => {
        const filtros = localStorage.getItem(`filtros_${modulo}`);
        estado[modulo] = filtros ? JSON.parse(filtros) : 'Sin filtros guardados';
    });
    
    console.log('📊 Estado de filtros guardados:', estado);
    return estado;
}

// 🆕 NUEVA FUNCIÓN - Renderizar filtradas  
function renderTablaMercaderiasFiltradas(mercaderiasFiltradas) {
    const mercaderiasOriginales = mercaderias;
    mercaderias = mercaderiasFiltradas;
    renderTablaMercaderias();
    mercaderias = mercaderiasOriginales;
}

// 🆕 NUEVA FUNCIÓN - Actualizar contador
function actualizarContadorFiltrosMercaderias(filtrados, total) {
    const contadores = ['contador-mercaderias', 'contador-productos', 'contador-filtros'];
    contadores.forEach(contadorId => {
        const contador = document.getElementById(contadorId);
        if (contador) {
            contador.textContent = `Mostrando ${filtrados} de ${total} mercaderías`;
        }
    });
}

/***************************************/
function abrirCompraDirectaSimple() {
            // Crear modal dinámico (reemplaza tu función crearModalCompraDirecta)
            if (!document.getElementById('modalCompraDirectaSimple')) {
                // El modal ya está en el HTML, solo mostrarlo
            }
            
            // Limpiar formulario
            limpiarFormulario();
            
            // Cargar datos
            cargarProveedores();
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalCompraDirectaSimple'));
            modal.show();
        }

        // =============================================
        // CARGAR DATOS
        // =============================================
        async function cargarProveedores() {
            try {
                // Usar tu función existente si está disponible
                /*if (typeof comprasData !== 'undefined' && comprasData.proveedores) {
                    llenarSelectProveedores(comprasData.proveedores);
                    return;
                }*/
                
                // O hacer llamada a API
                const response = await apiRequest('/proveedores');
                if (response.success) {
                    llenarSelectProveedores(response.data);
                }
            } catch (error) {
                console.error('Error cargando proveedores:', error);
                // Datos de prueba
                llenarSelectProveedores([
                    { id: 1, razonSocial: 'Proveedor A SA' },
                    { id: 2, razonSocial: 'Distribuidora B SRL' },
                    { id: 3, razonSocial: 'Comercial C SAC' }
                ]);
            }
        }

        function llenarSelectProveedores(proveedores) {
            const select = document.getElementById('compra-proveedor');
            select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
            
            proveedores.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor.proveedorId || proveedor.id;
                option.textContent = proveedor.razonSocial;
                select.appendChild(option);
            });
        }

        // =============================================
        // GESTIÓN DE PRODUCTOS
        // =============================================
        

        function renderizarProducto(producto) {
            const html = `
                <div class="producto-fila" id="producto-${producto.id}">
                    <div class="row align-items-center">
                        <!-- Número -->
                        <div class="col-auto">
                            <div class="producto-numero">${producto.id}</div>
                        </div>
                        
                        <!-- Producto -->
                        <div class="col-md-4">
                            <label class="form-label small">Producto *</label>
                            <select class="form-select form-select-sm" onchange="seleccionarMercaderia(${producto.id}, this.value)">
                                <option value="">Seleccionar...</option>
                            </select>
                            <div class="mercaderia-info mt-1" id="info-${producto.id}"></div>
                        </div>
                        
                        <!-- Cantidad -->
                        <div class="col-md-1">
                            <label class="form-label small">Cantidad *</label>
                            <input type="number" class="form-control form-control-sm text-center" 
                                   value="${producto.cantidad}" min="0.01" step="0.01"
                                   onchange="actualizarCantidad(${producto.id}, this.value)">
                        </div>
                        
                        <!-- Precio -->
                        <div class="col-md-2">
                            <label class="form-label small">Precio Unit. *</label>
                            <input type="number" class="form-control form-control-sm input-precio" 
                                   value="${producto.precio}" min="0" step="0.01"
                                   onchange="actualizarPrecio(${producto.id}, this.value)">
                        </div>
                        
                        <!-- IVA -->
                        <div class="col-md-1">
                            <label class="form-label small">IVA %</label>
                            <select class="form-select form-select-sm" onchange="actualizarIva(${producto.id}, this.value)">
                                <option value="0">0%</option>
                                <option value="10.5">10.5%</option>
                                <option value="21" selected>21%</option>
                                <option value="27">27%</option>
                            </select>
                        </div>
                        
                        <!-- Subtotal -->
                        <div class="col-md-2">
                            <label class="form-label small">Subtotal</label>
                            <input type="text" class="form-control form-control-sm input-precio" 
                                   id="subtotal-${producto.id}" value="$0.00" readonly>
                        </div>
                        
                        <!-- IVA -->
                        <div class="col-md-1">
                            <label class="form-label small">IVA</label>
                            <input type="text" class="form-control form-control-sm input-precio" 
                                   id="iva-${producto.id}" value="$0.00" readonly>
                        </div>
                        
                        <!-- Total -->
                        <div class="col-md-1">
                            <label class="form-label small">Total</label>
                            <input type="text" class="form-control form-control-sm input-precio fw-bold" 
                                   id="total-${producto.id}" value="$0.00" readonly>
                        </div>
                        
                        <!-- Eliminar -->
                        <div class="col-auto">
                            <label class="form-label small">&nbsp;</label>
                            <button type="button" class="btn btn-outline-danger btn-eliminar d-block" 
                                    onclick="eliminarProducto(${producto.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('productos-container').insertAdjacentHTML('beforeend', html);
            cargarMercaderiasDirecta(producto.id);
        }

        async function cargarMercaderiasDirecta(productoId) {
            try {
                const select = document.querySelector(`#producto-${productoId} select`);
                
                // Usar datos existentes si están disponibles
                if (typeof mercaderiasDisponibles !== 'undefined' && mercaderiasDisponibles.length > 0) {
                    llenarSelectMercaderias(select, mercaderiasDisponibles);
                    return;
                }
                
                // O hacer llamada a API
                const response = await apiRequest('/mercaderias?activo=1');
                if (response.success) {
                    llenarSelectMercaderias(select, response.data);
                }
            } catch (error) {
                console.error('Error cargando mercaderías:', error);
                // Datos de prueba
                const select = document.querySelector(`#producto-${productoId} select`);
                llenarSelectMercaderias(select, [
                    { id: 1, descripcion: 'Producto A', codigo_sku: 'PA001', precio_costo: 100 },
                    { id: 2, descripcion: 'Producto B', codigo_sku: 'PB002', precio_costo: 150 },
                    { id: 3, descripcion: 'Producto C', codigo_sku: 'PC003', precio_costo: 200 }
                ]);
            }
        }

        function llenarSelectMercaderias(select, mercaderias) {
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            mercaderias.forEach(mercaderia => {
                const option = document.createElement('option');
                option.value = mercaderia.id;
                option.textContent = `${mercaderia.descripcion} (${mercaderia.codigo_sku || 'Sin código'})`;
                option.dataset.precio = mercaderia.precio_costo || 0;
                option.dataset.descripcion = mercaderia.descripcion;
                option.dataset.codigo = mercaderia.codigo_sku || '';
                select.appendChild(option);
            });
        }

        // =============================================
        // EVENTOS Y CÁLCULOS
        // =============================================
        function seleccionarMercaderia(productoId, mercaderiaId) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (!producto) return;

            const select = document.querySelector(`#producto-${productoId} select`);
            const option = select.querySelector(`option[value="${mercaderiaId}"]`);
            
            if (option) {
                producto.mercaderia_id = mercaderiaId;
                producto.descripcion = option.dataset.descripcion || '';
                producto.codigo_sku = option.dataset.codigo || '';
                
                // Autocompletar precio si está vacío
                const precioSugerido = parseFloat(option.dataset.precio) || 0;
                if (producto.precio === 0 && precioSugerido > 0) {
                    producto.precio = precioSugerido;
                    document.querySelector(`#producto-${productoId} input[type="number"]:nth-of-type(2)`).value = precioSugerido;
                }
                
                // Actualizar info
                const infoDiv = document.getElementById(`info-${productoId}`);
                infoDiv.innerHTML = `<small><strong>${producto.codigo_sku}</strong> - ${producto.descripcion}</small>`;
                
                calcularProducto(productoId);
            }
        }

        function actualizarCantidad(productoId, cantidad) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (producto) {
                producto.cantidad = parseFloat(cantidad) || 0;
                calcularProducto(productoId);
            }
        }

        function actualizarPrecio(productoId, precio) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (producto) {
                producto.precio = parseFloat(precio) || 0;
                calcularProducto(productoId);
            }
        }

        function actualizarIva(productoId, iva) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (producto) {
                producto.iva_porcentaje = parseFloat(iva) || 0;
                calcularProducto(productoId);
            }
        }

        function calcularProducto(productoId) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (!producto) return;

            // Calcular subtotal sin IVA
            producto.subtotal = producto.cantidad * producto.precio;
            
            // Calcular IVA
            producto.iva_monto = producto.subtotal * (producto.iva_porcentaje / 100);
            
            // Calcular total
            producto.total = producto.subtotal + producto.iva_monto;

            // Actualizar displays
            document.getElementById(`subtotal-${productoId}`).value = `$${producto.subtotal.toLocaleString()}`;
            document.getElementById(`iva-${productoId}`).value = `$${producto.iva_monto.toLocaleString()}`;
            document.getElementById(`total-${productoId}`).value = `$${producto.total.toLocaleString()}`;

            // Calcular totales generales
            calcularTotales();
        }

        function calcularTotales() {
    let subtotal = 0, iva = 0;
    
    document.querySelectorAll('.producto-item').forEach(row => {
        const cantidad = parseFloat(row.querySelector('.cantidad-input').value) || 0;
        const precio = parseFloat(row.querySelector('.precio-input').value) || 0;
        const ivaPorc = parseFloat(row.querySelector('.iva-select').value) || 0;
        
        const subtotalProducto = cantidad * precio;
        const ivaProducto = subtotalProducto * (ivaPorc / 100);
        
        row.querySelector('.subtotal-producto').textContent = `$${subtotalProducto.toFixed(2)}`;
        
        subtotal += subtotalProducto;
        iva += ivaProducto;
    });
    
    document.getElementById('subtotal-display').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('iva-display').textContent = `$${iva.toFixed(2)}`;
    document.getElementById('total-display').textContent = `$${(subtotal + iva).toFixed(2)}`;
}

        function eliminarProducto(productId) {
    document.getElementById(productId).remove();
    calcularTotales();
    
    // Mostrar mensaje vacío si no hay productos
    if (document.querySelectorAll('.producto-item').length === 0) {
        const mensajeVacio = document.getElementById('mensaje-vacio');
        if (mensajeVacio) mensajeVacio.style.display = 'block';
    }
}

        // =============================================
        // UTILIDADES
        // =============================================
        function ocultarMensajeVacio() {
            const mensaje = document.getElementById('mensaje-vacio');
            if (mensaje) {
                mensaje.style.display = 'none';
            }
        }

        function mostrarMensajeVacio() {
            const container = document.getElementById('productos-container');
            container.innerHTML = `
                <div class="text-center text-muted py-4" id="mensaje-vacio">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <p>No hay productos agregados. Haz clic en "Agregar Producto" para comenzar.</p>
                </div>
            `;
        }

        function limpiarFormulario() {
            // Limpiar campos
            document.getElementById('compra-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('compra-fecha-vencimiento').value = '';
            document.getElementById('compra-proveedor').value = '';
            document.getElementById('compra-remito').value = '';
            document.getElementById('compra-factura').value = '';
            document.getElementById('compra-observaciones').value = '';
            
            // Limpiar productos
            productosCompra = [];
            contadorProductos = 0;
            mostrarMensajeVacio();
            calcularTotales();
        }

        // =============================================
        // GUARDAR COMPRA
        // =============================================
        async function guardarCompra() {
            try {
                // Validaciones
                const proveedor = document.getElementById('compra-proveedor').value;
                const fecha = document.getElementById('compra-fecha').value;
                
                if (!proveedor) {
                    if (typeof showAlert === 'function') {
                        showAlert('Debe seleccionar un proveedor', 'warning');
                    } else {
                        alert('Debe seleccionar un proveedor');
                    }
                    return;
                }
                
                if (!fecha) {
                    if (typeof showAlert === 'function') {
                        showAlert('Debe ingresar la fecha del documento', 'warning');
                    } else {
                        alert('Debe ingresar la fecha del documento');
                    }
                    return;
                }
                
                if (productosCompra.length === 0) {
                    if (typeof showAlert === 'function') {
                        showAlert('Debe agregar al menos un producto', 'warning');
                    } else {
                        alert('Debe agregar al menos un producto');
                    }
                    return;
                }
                
                // Validar productos
                let errores = false;
                productosCompra.forEach(producto => {
                    if (!producto.mercaderia_id || producto.cantidad <= 0 || producto.precio <= 0) {
                        errores = true;
                    }
                });
                
                if (errores) {
                    if (typeof showAlert === 'function') {
                        showAlert('Complete todos los campos requeridos de los productos', 'warning');
                    } else {
                        alert('Complete todos los campos requeridos de los productos');
                    }
                    return;
                }
                
                // Preparar datos para enviar (compatible con tu estructura)
                const datosCompra = {
                    proveedor_id: parseInt(proveedor),
                    fecha_recepcion: fecha,
                    fecha_vencimiento_documento: document.getElementById('compra-fecha-vencimiento').value || null,
                    numero_remito: document.getElementById('compra-remito').value || null,
                    numero_factura: document.getElementById('compra-factura').value || null,
                    observaciones: document.getElementById('compra-observaciones').value || null,
                    items: productosCompra.map(producto => ({
                        mercaderia_id: parseInt(producto.mercaderia_id),
                        cantidad_recibida: producto.cantidad,
                        precio_unitario: producto.precio,
                        iva_porcentaje: producto.iva_porcentaje,
                        deposito_id: 1 // Siempre depósito central
                        // NO incluir lote ni fecha_vencimiento según tus requerimientos
                    }))
                };
                
                console.log('💾 Enviando compra:', datosCompra);
                
                // Enviar a tu API (usa tu función apiRequest existente)
                const response = await apiRequest('/compras/recepciones', 'POST', datosCompra);
                
                if (response.success) {
                    if (typeof showAlert === 'function') {
                        showAlert('Compra registrada exitosamente', 'success');
                    } else {
                        alert('Compra registrada exitosamente');
                    }
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalCompraDirectaSimple'));
                    modal.hide();
                    
                    // Refrescar datos si hay función disponible
                    if (typeof refrescarStock === 'function') {
                        refrescarStock();
                    }
                    
                } else {
                    throw new Error(response.message || 'Error al guardar la compra');
                }
                
            } catch (error) {
                console.error('❌ Error guardando compra:', error);
                if (typeof showAlert === 'function') {
                    showAlert('Error al guardar la compra: ' + error.message, 'danger');
                } else {
                    alert('Error al guardar la compra: ' + error.message);
                }
            }
        }

        // =============================================
        // INTEGRACIÓN CON TU PROYECTO
        // =============================================
        
        // Función para reemplazar tu función existente
        if (typeof window !== 'undefined') {
            window.abrirModalCompraDirect = abrirCompraDirectaSimple;
            window.crearModalCompraDirecta = () => {
                // No necesita crear nada, el modal ya está en el HTML
                return true;
            };
        }

         async function cargarDatosCompraSimple() {
            try {
                // Usar tu función existente cargarDatosCompras()
                if (typeof cargarDatosCompras === 'function') {
                    await cargarDatosCompras();
                    return;
                }
                
                // Fallback: cargar datos manualmente
                const response = await apiRequest('/proveedores');
                if (response.success) {
                    // Simular estructura comprasData
                    window.comprasData = window.comprasData || {};
                    window.comprasData.proveedores = response.data;
                    llenarSelectProveedoresSimple(response.data);
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                // Datos de prueba
                llenarSelectProveedoresSimple([
                    { id: 1, razonSocial: 'Proveedor A SA' },
                    { id: 2, razonSocial: 'Distribuidora B SRL' },
                    { id: 3, razonSocial: 'Comercial C SAC' }
                ]);
            }
        }



        

        // =============================================
        // EVENTOS Y CÁLCULOS
        // =============================================
        function seleccionarMercaderiaCompraSimple(productoId, mercaderiaId) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (!producto) return;

            const select = document.querySelector(`#producto-${productoId} select`);
            const option = select.querySelector(`option[value="${mercaderiaId}"]`);
            
            if (option) {
                producto.mercaderia_id = mercaderiaId;
                producto.descripcion = option.dataset.descripcion || '';
                producto.codigo_sku = option.dataset.codigo || '';
                
                // Autocompletar precio si está vacío
                const precioSugerido = parseFloat(option.dataset.precio) || 0;
                if (producto.precio === 0 && precioSugerido > 0) {
                    producto.precio = precioSugerido;
                    document.querySelector(`#producto-${productoId} input[type="number"]:nth-of-type(2)`).value = precioSugerido;
                }
                
                // Actualizar info
                const infoDiv = document.getElementById(`info-${productoId}`);
                infoDiv.innerHTML = `<small><strong>${producto.codigo_sku}</strong> - ${producto.descripcion}</small>`;
                
                calcularProductoCompraSimple(productoId);
            }
        }

        function actualizarCantidadCompraSimple(productoId, cantidad) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (producto) {
                producto.cantidad = parseFloat(cantidad) || 0;
                calcularProductoCompraSimple(productoId);
            }
        }

        function actualizarPrecioCompraSimple(productoId, precio) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (producto) {
                producto.precio = parseFloat(precio) || 0;
                calcularProductoCompraSimple(productoId);
            }
        }

        function actualizarIvaCompraSimple(productoId, iva) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (producto) {
                producto.iva_porcentaje = parseFloat(iva) || 0;
                calcularProductoCompraSimple(productoId);
            }
        }

        function calcularProductoCompraSimple(productoId) {
            const producto = productosCompra.find(p => p.id === productoId);
            if (!producto) return;

            // Calcular subtotal sin IVA
            producto.subtotal = producto.cantidad * producto.precio;
            
            // Calcular IVA
            producto.iva_monto = producto.subtotal * (producto.iva_porcentaje / 100);
            
            // Calcular total
            producto.total = producto.subtotal + producto.iva_monto;

            // Actualizar displays
            document.getElementById(`subtotal-${productoId}`).value = `$${producto.subtotal.toLocaleString()}`;
            document.getElementById(`iva-${productoId}`).value = `$${producto.iva_monto.toLocaleString()}`;
            document.getElementById(`total-${productoId}`).value = `$${producto.total.toLocaleString()}`;

            // Calcular totales generales
            calcularTotalesCompraSimple();
        }

        function calcularTotalesCompraSimple() {
            const subtotalTotal = productosCompra.reduce((sum, p) => sum + p.subtotal, 0);
            const ivaTotal = productosCompra.reduce((sum, p) => sum + p.iva_monto, 0);
            const total = subtotalTotal + ivaTotal;

            document.getElementById('subtotal-display').textContent = `$${subtotalTotal.toLocaleString()}`;
            document.getElementById('iva-display').textContent = `$${ivaTotal.toLocaleString()}`;
            document.getElementById('total-display').textContent = `$${total.toLocaleString()}`;
        }

        function eliminarProductoCompraSimple(productoId) {
            if (confirm('¿Eliminar este producto?')) {
                // Remover del array
                productosCompra = productosCompra.filter(p => p.id !== productoId);
                
                // Remover del DOM
                document.getElementById(`producto-${productoId}`).remove();
                
                // Mostrar mensaje si no hay productos
                if (productosCompra.length === 0) {
                    mostrarMensajeVacioCompraSimple();
                }
                
                calcularTotalesCompraSimple();
            }
        }

        // =============================================
        // UTILIDADES
        // =============================================
        function ocultarMensajeVacioCompraSimple() {
            const mensaje = document.getElementById('mensaje-vacio');
            if (mensaje) {
                mensaje.style.display = 'none';
            }
        }

        function mostrarMensajeVacioCompraSimple() {
            const container = document.getElementById('productos-container');
            container.innerHTML = `
                <div class="text-center text-muted py-4" id="mensaje-vacio">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <p>No hay productos agregados. Haz clic en "Agregar Producto" para comenzar.</p>
                </div>
            `;
        }

        function limpiarFormularioCompraSimple() {
            // Limpiar campos
            document.getElementById('compra-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('compra-fecha-vencimiento').value = '';
            document.getElementById('compra-proveedor').value = '';
            document.getElementById('compra-remito').value = '';
            document.getElementById('compra-factura').value = '';
            document.getElementById('compra-observaciones').value = '';
            
            // Limpiar productos
            productosCompra = [];
            contadorProductos = 0;
            mostrarMensajeVacioCompraSimple();
            calcularTotalesCompraSimple();
        }

        // =============================================
        // GUARDAR COMPRA
        // =============================================
        async function guardarCompraSimple() {
            try {
                // Validaciones
                const proveedor = document.getElementById('compra-proveedor').value;
                const fecha = document.getElementById('compra-fecha').value;

                const productos = validarProductosCompra();
                if (!productos) return;
                
                if (!proveedor) {
                    if (typeof showAlert === 'function') {
                        showAlert('Debe seleccionar un proveedor', 'warning');
                    } else {
                        alert('Debe seleccionar un proveedor');
                    }
                    return;
                }
                
                if (!fecha) {
                    if (typeof showAlert === 'function') {
                        showAlert('Debe ingresar la fecha del documento', 'warning');
                    } else {
                        alert('Debe ingresar la fecha del documento');
                    }
                    return;
                }
                
                if (productosCompra.length === 0) {
                    if (typeof showAlert === 'function') {
                        showAlert('Debe agregar al menos un producto', 'warning');
                    } else {
                        alert('Debe agregar al menos un producto');
                    }
                    return;
                }
                
                // Validar productos
                let errores = false;
                productosCompra.forEach(producto => {
                    if (!producto.mercaderia_id || producto.cantidad <= 0 || producto.precio <= 0) {
                        errores = true;
                    }
                });
                
                if (errores) {
                    if (typeof showAlert === 'function') {
                        showAlert('Complete todos los campos requeridos de los productos', 'warning');
                    } else {
                        alert('Complete todos los campos requeridos de los productos');
                    }
                    return;
                }
                
                // Preparar datos para enviar (compatible con tu estructura)
                const datosCompra = {
                    proveedor_id: parseInt(proveedor),
                    fecha_recepcion: fecha,
                    fecha_vencimiento_documento: document.getElementById('compra-fecha-vencimiento').value || null,
                    numero_remito: document.getElementById('compra-remito').value || null,
                    numero_factura: document.getElementById('compra-factura').value || null,
                    observaciones: document.getElementById('compra-observaciones').value || null,
                    items: productosCompra.map(producto => ({
                        mercaderia_id: parseInt(producto.mercaderia_id),
                        cantidad_recibida: producto.cantidad,
                        precio_unitario: producto.precio,
                        iva_porcentaje: producto.iva_porcentaje,
                        deposito_id: 1 // Siempre depósito central
                        // NO incluir lote ni fecha_vencimiento según tus requerimientos
                    }))
                };
                
                console.log('💾 Enviando compra:', datosCompra);
                
                // Enviar a tu API (usa tu función apiRequest existente)
                const response = await apiRequest('/compras/recepciones', 'POST', datosCompra);
                
                if (response.success) {
                    if (typeof showAlert === 'function') {
                        showAlert('Compra registrada exitosamente', 'success');
                    } else {
                        alert('Compra registrada exitosamente');
                    }
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalCompraDirectaSimple'));
                    modal.hide();
                    
                    // Refrescar datos si hay función disponible
                    if (typeof refrescarStock === 'function') {
                        refrescarStock();
                    }
                    
                } else {
                    throw new Error(response.message || 'Error al guardar la compra');
                }
                
            } catch (error) {
                console.error('❌ Error guardando compra:', error);
                if (typeof showAlert === 'function') {
                    showAlert('Error al guardar la compra: ' + error.message, 'danger');
                } else {
                    alert('Error al guardar la compra: ' + error.message);
                }
            }
        }

        // =============================================
        // 📋 INSTRUCCIONES DE INTEGRACIÓN
        // =============================================
        /*
        PARA INTEGRAR SIN CONFLICTOS:

        OPCIÓN A - Como modal alternativo:
        1. Agrega todo este código a tu proyecto
        2. Llama con: abrirCompraDirectaSimple()
        3. Mantiene tu modal actual intacto

        OPCIÓN B - Reemplazar modal actual:
        1. Cambia ID del modal HTML: "modalCompraDirecta"
        2. Descomenta las líneas de abajo:
           window.abrirModalCompraDirect = abrirCompraDirectaSimple;
           window.crearModalCompraDirecta = () => { return true; };
        3. Tu botón existente funcionará automáticamente

        VENTAJAS:
        ✅ Usa tus funciones: cargarDatosCompras(), comprasData, mercaderiasDisponibles
        ✅ Usa tus IDs: 'compra-proveedor', 'compra-fecha', etc.
        ✅ Usa tu apiRequest() y showAlert()
        ✅ Compatible con tu estructura de datos
        ✅ No sobreescribe funciones existentes
        */

        // =============================================
        // INTEGRACIÓN SEGURA CON TU PROYECTO
        // =============================================
        
        // Función para reemplazar tu función existente SIN conflictos
        if (typeof window !== 'undefined') {
            // Solo reemplazar si no quieres mantener tu función original
            // window.abrirModalCompraDirect = abrirCompraDirectaSimple;
            
            // O agregar como alternativa
            window.abrirCompraDirectaSimple = abrirCompraDirectaSimple;
            window.crearModalCompraDirectaSimple = () => {
                // No necesita crear nada, el modal ya está en el HTML
                return true;
            };

            function llenarSelectProveedoresSimple(proveedores) {
    console.log('🔄 Llenando select de proveedores simple...');
    
    // Usar el mismo ID que tu proyecto: 'compra-proveedor'
    const select = document.getElementById('compra-proveedor');
    if (!select) {
        console.error('❌ Element compra-proveedor not found');
        return;
    }
    
    select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
    
    proveedores.forEach(proveedor => {
        const option = document.createElement('option');
        // Usar la misma lógica que tu llenarSelectoresCompras()
        option.value = proveedor.proveedorId || proveedor.id;
        option.textContent = proveedor.razonSocial;
        select.appendChild(option);
    });
    
    console.log(`✅ Select proveedores cargado con ${proveedores.length} items`);
}
            
            // Funciones útiles sin conflictos
            window.cargarDatosCompraSimple = cargarDatosCompraSimple;
            window.llenarSelectProveedoresSimple = llenarSelectProveedoresSimple;
            window.cargarMercaderiasCompraSimple = cargarMercaderiasCompraSimple;
            window.llenarSelectMercaderiasCompraSimple = llenarSelectMercaderiasCompraSimple;
            window.guardarCompraSimple = guardarCompraSimple;
        }

        // PARA USAR COMO REEMPLAZO DIRECTO, descomenta esto:
        
        if (typeof window !== 'undefined') {
            window.abrirModalCompraDirect = abrirCompraDirectaSimple;
            window.crearModalCompraDirecta = () => { return true; };
        }

        
// Función para obtener mercadería seleccionada (reemplaza el .value del select)
function getMercaderiaSeleccionada(selectorId) {
    const autocomplete = autocompleteInstances[selectorId];
    return autocomplete ? autocomplete.getSelected() : null;
}

// Función para validar selección de mercadería
function validarMercaderiaSeleccionada(selectorId) {
    const autocomplete = autocompleteInstances[selectorId];
    return autocomplete ? autocomplete.isValid() : false;
}

// Función para limpiar selección
function limpiarMercaderiaSeleccionada(selectorId) {
    const autocomplete = autocompleteInstances[selectorId];
    if (autocomplete) {
        autocomplete.clear();
    }
}



if (typeof window.MercaderiaAutocomplete === 'undefined') {
    console.log('🔧 Definiendo MercaderiaAutocomplete limpia...');
    
    window.MercaderiaAutocomplete = class {
        constructor(containerOrOptions, callbackOrUndefined) {
            console.log('🔧 Constructor llamado con:', containerOrOptions, callbackOrUndefined);
            
            // Manejar ambos formatos: nuevo (options object) y antiguo (id, callback)
            if (typeof containerOrOptions === 'string') {
                // Formato antiguo: new MercaderiaAutocomplete(containerId, callback)
                console.log('📝 Usando formato antiguo: (containerId, callback)');
                this.container = document.getElementById(containerOrOptions);
                this.onSelect = callbackOrUndefined || function() {};
            } else if (containerOrOptions && typeof containerOrOptions === 'object') {
                // Formato nuevo: new MercaderiaAutocomplete({container: element, onSelect: callback})
                console.log('📝 Usando formato nuevo: options object');
                
                // Si se pasa un ID como string en options.container
                if (typeof containerOrOptions.container === 'string') {
                    this.container = document.getElementById(containerOrOptions.container);
                } else {
                    this.container = containerOrOptions.container;
                }
                
                this.onSelect = containerOrOptions.onSelect || function() {};
            } else {
                throw new Error('MercaderiaAutocomplete: formato de parámetros inválido');
            }
            
            // Validar que el contenedor existe
            if (!this.container) {
                console.error('❌ Contenedor no encontrado:', containerOrOptions);
                throw new Error('MercaderiaAutocomplete: contenedor no encontrado - ' + 
                    (typeof containerOrOptions === 'string' ? containerOrOptions : 'objeto inválido'));
            }
            
            // Validar que es un elemento DOM válido
            if (!this.container.nodeType || this.container.nodeType !== Node.ELEMENT_NODE) {
                console.error('❌ Contenedor inválido:', this.container);
                throw new Error('MercaderiaAutocomplete: contenedor debe ser un elemento DOM');
            }
            
            this.apiUrl = '/api/v1/mercaderias/buscar';
            this.currentProducts = [];
            
            console.log('✅ MercaderiaAutocomplete inicializando con contenedor:', this.container.id || this.container.tagName);
            this.init();
        }
        
        init() {
            this.container.innerHTML = `
                <div style="position: relative;">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" 
                               placeholder="Buscar por código o descripción..." 
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" 
                                style="display: none;" onclick="this.parentElement.querySelector('input').value = ''; this.style.display = 'none';">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="autocomplete-results" style="
                        position: absolute; 
                        top: 100%; 
                        left: 0; 
                        right: 0; 
                        background: white; 
                        border: 1px solid #ddd; 
                        border-top: none; 
                        max-height: 300px; 
                        overflow-y: auto; 
                        z-index: 1050; 
                        display: none;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    </div>
                </div>
            `;
            
            this.input = this.container.querySelector('input');
            this.clearBtn = this.container.querySelector('button');
            this.results = this.container.querySelector('.autocomplete-results');
            
            this.bindEvents();
        }
        
        bindEvents() {
            let searchTimeout;
            
            this.input.addEventListener('input', (e) => {
                const value = e.target.value.trim();
                this.clearBtn.style.display = value ? 'block' : 'none';
                
                clearTimeout(searchTimeout);
                
                if (value.length >= 2) {
                    searchTimeout = setTimeout(() => this.search(value), 300);
                } else {
                    this.hideResults();
                }
            });
            
            this.input.addEventListener('focus', () => {
                if (this.currentProducts.length > 0) {
                    this.showResults();
                }
            });
            
            // Cerrar resultados al hacer click fuera
            document.addEventListener('click', (e) => {
                if (!this.container.contains(e.target)) {
                    this.hideResults();
                }
            });
        }
        
        async search(term) {
            try {
                // Usar el sistema de API existente de tu proyecto
                const response = await fetch(`${this.apiUrl}?term=${encodeURIComponent(term)}`);
                
                if (!response.ok) throw new Error('Error en búsqueda');
                
                const data = await response.json();
                this.currentProducts = data.data || data || [];
                this.showResults();
                
            } catch (error) {
                console.error('Error buscando mercaderías:', error);
                this.results.innerHTML = '<div style="padding: 10px; color: red;">Error en búsqueda</div>';
                this.results.style.display = 'block';
            }
        }
        
        showResults() {
            if (this.currentProducts.length === 0) {
                this.results.innerHTML = '<div style="padding: 10px; color: #666;">Sin resultados</div>';
            } else {
                this.results.innerHTML = this.currentProducts.map((product, index) => `
                    <div class="autocomplete-item" 
                         data-index="${index}"
                         style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;"
                         onmouseover="this.style.backgroundColor='#f8f9fa'"
                         onmouseout="this.style.backgroundColor=''"
                         onclick="window.selectMercaderiaFromAutocomplete(${index}, '${this.container.id}')">
                        <div><strong>${product.codigo_sku || 'Sin código'}</strong></div>
                        <div style="color: #666;">${product.descripcion}</div>
                        <div style="font-size: 0.85em; color: #28a745;">
                            💰 $${parseFloat(product.precio_venta || 0).toFixed(2)} | 
                            📦 Stock: ${product.stock_actual || 0}
                        </div>
                    </div>
                `).join('');
            }
            this.results.style.display = 'block';
        }
        
        hideResults() {
            this.results.style.display = 'none';
        }
        
        selectProduct(index) {
            if (this.currentProducts[index]) {
                const product = this.currentProducts[index];
                this.input.value = `${product.codigo_sku} - ${product.descripcion}`;
                this.hideResults();
                this.onSelect(product);
            }
        }
        
        clear() {
            this.input.value = '';
            this.clearBtn.style.display = 'none';
            this.hideResults();
            this.currentProducts = [];
        }
        
        focus() {
            this.input.focus();
        }
    };
    
    // Función global para seleccionar desde autocomplete
    window.selectMercaderiaFromAutocomplete = function(index, containerId) {
        // Encontrar la instancia correcta del autocomplete
        if (window.currentAutocomplete && window.currentAutocomplete.container.id === containerId) {
            window.currentAutocomplete.selectProduct(index);
        }
    };
    
    console.log('✅ MercaderiaAutocomplete definida correctamente');
}

// 2. FUNCIÓN DEFINITIVA agregarProductoCompraSimple
window.agregarProductoCompraSimple = function() {
    console.log('🚀 Agregando producto con autocomplete...');
    
    try {
        // Verificar que MercaderiaAutocomplete esté definida
        if (typeof window.MercaderiaAutocomplete === 'undefined') {
            throw new Error('MercaderiaAutocomplete no está definida');
        }
        
      
        
        // Buscar el contenedor correcto (según tu HTML)
        const container = document.getElementById('productos-container');
        if (!container) {
            throw new Error('Contenedor productos-container no encontrado');
        }
        
        // Crear el producto HTML
        const productoId = `producto-${contadorProductosCompra}`;
        const autocompleteId = `autocomplete-${contadorProductosCompra}`;
        
        const productoHTML = `
            <div class="producto-item border rounded p-3 mb-3" id="${productoId}">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Mercadería *</label>
                        <div id="${autocompleteId}"></div>
                        <input type="hidden" class="mercaderia-id">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Cantidad *</label>
                        <input type="number" class="form-control cantidad-input" 
                               min="0.01" step="0.01" value="1" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Precio *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control precio-input" 
                                   min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">IVA</label>
                        <select class="form-select iva-select">
                            <option value="0">0%</option>
                            <option value="10.5">10.5%</option>
                            <option value="21" selected>21%</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="eliminarProductoCompra('${productoId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12 text-end">
                        <small class="text-muted">Subtotal: </small>
                        <strong class="subtotal-display">$0.00</strong>
                    </div>
                </div>
            </div>
        `;
        
        // Ocultar mensaje vacío si existe
        const mensajeVacio = document.getElementById('mensaje-vacio');
        if (mensajeVacio) {
            mensajeVacio.style.display = 'none';
        }
        
        // Agregar al contenedor
        container.insertAdjacentHTML('beforeend', productoHTML);
        
        // ⚠️ IMPORTANTE: Esperar un tick para que el DOM se actualice
        setTimeout(() => {
            try {
                // Crear autocomplete para este producto
                const autocompleteContainer = document.getElementById(autocompleteId);
                
                console.log('🔍 Buscando contenedor:', autocompleteId);
                console.log('📦 Contenedor encontrado:', autocompleteContainer);
                
                if (!autocompleteContainer) {
                    throw new Error(`Contenedor autocomplete no encontrado: ${autocompleteId}`);
                }
                
                const autocomplete = new window.MercaderiaAutocomplete({
                    container: autocompleteContainer,
                    onSelect: function(product) {
                        console.log('✅ Producto seleccionado:', product);
                        
                        // Llenar campos del producto
                        const productoRow = document.getElementById(productoId);
                        const mercaderiaIdInput = productoRow.querySelector('.mercaderia-id');
                        const precioInput = productoRow.querySelector('.precio-input');
                        
                        // Guardar ID de mercadería
                        mercaderiaIdInput.value = product.id;
                        
                        // Autocompletar precio si está disponible
                        if (!precioInput.value && product.precio_costo) {
                            precioInput.value = parseFloat(product.precio_costo).toFixed(2);
                        }
                        
                        // Calcular totales
                        calcularSubtotalProducto(productoId);
                    }
                });
                
                // Guardar referencia global
                if (!window.autocompletesProductos) window.autocompletesProductos = {};
                window.autocompletesProductos[contadorProductosCompra] = autocomplete;
                
                // Hacer foco
                setTimeout(() => autocomplete.focus(), 100);
                
                console.log(`✅ Autocomplete creado exitosamente para producto ${contadorProductosCompra}`);
                
            } catch (autocompleteError) {
                console.error('❌ Error creando autocomplete:', autocompleteError);
                // Fallback: convertir a input simple
                const autocompleteContainer = document.getElementById(autocompleteId);
                if (autocompleteContainer) {
                    autocompleteContainer.innerHTML = `
                        <input type="text" class="form-control" placeholder="Escriba el nombre del producto">
                        <small class="text-warning">⚠️ Autocomplete no disponible - modo manual</small>
                    `;
                }
            }
        }, 10); // Pequeña pausa para que el DOM se actualice
        
        // Agregar eventos para cálculos
        const productoRow = document.getElementById(productoId);
        const inputs = productoRow.querySelectorAll('.cantidad-input, .precio-input, .iva-select');
        inputs.forEach(input => {
            input.addEventListener('input', () => calcularSubtotalProducto(productoId));
            input.addEventListener('change', () => calcularSubtotalProducto(productoId));
        });
        
        console.log(`✅ Producto #${contadorProductosCompra} agregado correctamente`);
        
    } catch (error) {
        console.error('❌ Error agregando producto:', error);
        alert('Error al agregar producto: ' + error.message);
    }
};




function configurarEventosCalculoCompra() {
    // Buscar todos los inputs de productos de compra
    const inputs = document.querySelectorAll('.producto-compra .cantidad-input, .producto-compra .precio-input, .producto-compra .iva-input');
    
    inputs.forEach(input => {
        // Remover eventos existentes para evitar duplicados
        input.removeEventListener('input', handleCalculoChange);
        input.removeEventListener('change', handleCalculoChange);
        
        // Agregar eventos
        input.addEventListener('input', handleCalculoChange);
        input.addEventListener('change', handleCalculoChange);
    });
    
    function handleCalculoChange(event) {
        const productoRow = event.target.closest('.producto-compra');
        if (productoRow) {
            // Pequeño delay para asegurar que el DOM se actualizó
            setTimeout(() => {
                calcularTotalesCompraDirecta(); // Llamar directamente a tu función existente
            }, 10);
        }
    }
}

console.log('🎯 Sistema de autocomplete para compra directa cargado correctamente');

// 🚨 VERSIÓN ALTERNATIVA SIMPLE (usar si la anterior falla)
window.agregarProductoCompraSimpleAlternativo = function() {
    console.log('🔄 Usando versión alternativa simple...');
    
    try {
        
        const container = document.getElementById('productos-container');
        if (!container) {
            alert('Error: Contenedor no encontrado');
            return;
        }
        
        const productoHTML = `
            <div class="producto-item border rounded p-3 mb-3" id="producto-${contadorProductosCompra}">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Mercadería *</label>
                        <input type="text" class="form-control" placeholder="Escriba para buscar mercadería...">
                        <small class="text-info">Versión simplificada - escriba el nombre del producto</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Cantidad *</label>
                        <input type="number" class="form-control cantidad-input" 
                               min="0.01" step="0.01" value="1" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Precio *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control precio-input" 
                                   min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">IVA</label>
                        <select class="form-select iva-select">
                            <option value="21" selected>21%</option>
                            <option value="10.5">10.5%</option>
                            <option value="0">0%</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="this.closest('.producto-item').remove()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Ocultar mensaje vacío
        const mensajeVacio = document.getElementById('mensaje-vacio');
        if (mensajeVacio) {
            mensajeVacio.style.display = 'none';
        }
        
        container.insertAdjacentHTML('beforeend', productoHTML);
        
        console.log('✅ Producto alternativo agregado');
        
    } catch (error) {
        console.error('❌ Error en versión alternativa:', error);
        alert('Error: ' + error.message);
    }
};

// =============================================
// 1. FUNCIÓN PRINCIPAL: mostrarStockDetalladoDeposito
// =============================================
async function mostrarStockDetalladoDeposito(depositoId) {
    try {
        console.log('📦 Cargando stock detallado del depósito:', depositoId);
        
        // Actualizar título del modal
        const modalTitle = document.getElementById('modalStockTitle');
        if (modalTitle) {
            modalTitle.textContent = 'Cargando stock detallado...';
        }
        
        // Mostrar loading
        const tbody = document.getElementById('tabla-stock-deposito');
        if (!tbody) {
            console.error('❌ Tabla tabla-stock-deposito no encontrada');
            showAlert('Error: Tabla de stock no encontrada', 'danger');
            return;
        }
        
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    <span>Cargando stock detallado...</span>
                </td>
            </tr>
        `;
        
        // Actualizar encabezados de la tabla para vista detallada
        actualizarEncabezadosTablaDetallada();
        
        // Hacer petición al backend
        const response = await apiRequest(`/depositos/${depositoId}/stock?incluir_sin_stock=false`);
        
        if (!response.success) {
            throw new Error(response.message || 'Error obteniendo stock');
        }
        
        const stockData = response.stock || response.data || [];
        const deposito = response.deposito;
        
        // Actualizar título con nombre del depósito
        if (modalTitle && deposito) {
            modalTitle.textContent = `Stock Detallado: ${deposito.nombre}`;
        }
        
        // Renderizar tabla detallada
        if (stockData.length > 0) {
            tbody.innerHTML = stockData.map((item, index) => 
                generarFilaArticuloDetallada(item, index + 1, depositoId)
            ).join('');
            
            // Agregar estadísticas al final
            agregarResumenStockDetallado(stockData, depositoId);
            
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center py-4 text-muted">
                        <i class="fas fa-box-open fa-3x mb-3 d-block"></i>
                        <h6>No hay artículos con stock en este depósito</h6>
                        <small>El depósito está vacío o no tiene productos registrados</small>
                    </td>
                </tr>
            `;
        }
        
        // Abrir modal
        const modalElement = document.getElementById('modalStockDeposito');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Mostrar información adicional
        mostrarInfoAdicionalStock(response, modalElement);
        
        console.log(`✅ Stock detallado cargado: ${stockData.length} artículos`);
        
    } catch (error) {
        console.error('❌ Error cargando stock detallado:', error);
        
        const tbody = document.getElementById('tabla-stock-deposito');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2 d-block"></i>
                        <strong>Error cargando stock detallado</strong><br>
                        <small>${error.message}</small>
                    </td>
                </tr>
            `;
        }
        
        showAlert(`Error: ${error.message}`, 'danger');
    }
}

// =============================================
// 2. FUNCIÓN: actualizarEncabezadosTablaDetallada
// =============================================
function actualizarEncabezadosTablaDetallada() {
    const thead = document.querySelector('#modalStockDeposito thead tr');
    if (thead) {
        thead.innerHTML = `
            <th width="5%">#</th>
            <th width="25%">Artículo</th>
            <th width="10%">Códigos</th>
            <th width="8%">Categoría</th>
            <th width="8%">Stock</th>
            <th width="8%">Mín.</th>
            <th width="10%">Precio Costo</th>
            <th width="10%">Precio Venta</th>
            <th width="10%">Valor Total</th>
            <th width="6%">Acciones</th>
        `;
    }
}

// =============================================
// 3. FUNCIÓN: generarFilaArticuloDetallada
// =============================================
function generarFilaArticuloDetallada(item, numero, depositoId) {
    // Extraer datos del artículo
    const id = item.id;
    const descripcion = item.descripcion || 'Sin descripción';
    const marca = item.marca || null;
    const categoria = item.categoria || 'Sin categoría';
    const codigoSku = item.codigo_sku || 'N/A';
    const codigoEan = item.codigo_ean13 || item.codigo_ean || null;
    const cantidad = parseFloat(item.cantidad || 0);
    const stockMinimo = parseFloat(item.stock_minimo || 0);
    const precioCosto = parseFloat(item.precio_costo || 0);
    const precioVenta = parseFloat(item.precio_venta || 0);
    const valorTotal = cantidad * precioVenta;
    
    // Determinar estado del stock
    const estadoStock = determinarEstadoStockDetallado(cantidad, stockMinimo);
    
    // Calcular margen de ganancia
    const margen = precioCosto > 0 ? ((precioVenta - precioCosto) / precioCosto * 100) : 0;
    
    return `
        <tr class="align-middle" data-articulo-id="${id}">
            <!-- Número correlativo -->
            <td class="text-center">
                <span class="badge bg-secondary">${numero}</span>
            </td>
            
            <!-- Información del artículo -->
            <td>
                <div class="d-flex flex-column">
                    <strong class="text-primary" title="${descripcion}">
                        ${descripcion.length > 40 ? descripcion.substring(0, 40) + '...' : descripcion}
                    </strong>
                    ${marca ? `<small class="text-muted"><i class="fas fa-tag me-1"></i>${marca}</small>` : ''}
                    <small class="text-info">
                        <i class="fas fa-barcode me-1"></i>ID: ${id}
                    </small>
                </div>
            </td>
            
            <!-- Códigos -->
            <td>
                <div class="d-flex flex-column">
                    <code class="small bg-light p-1 rounded">${codigoSku}</code>
                    ${codigoEan ? `<code class="small bg-light p-1 rounded mt-1">${codigoEan}</code>` : ''}
                </div>
            </td>
            
            <!-- Categoría -->
            <td>
                <span class="badge bg-info">${categoria}</span>
            </td>
            
            <!-- Stock actual -->
            <td class="text-center">
                <div class="d-flex flex-column align-items-center">
                    <strong class="${estadoStock.claseTexto} fs-5">
                        ${cantidad}
                    </strong>
                    ${estadoStock.badge}
                </div>
            </td>
            
            <!-- Stock mínimo -->
            <td class="text-center">
                <span class="text-muted">${stockMinimo}</span>
                ${cantidad <= stockMinimo ? '<i class="fas fa-exclamation-triangle text-warning ms-1"></i>' : ''}
            </td>
            
            <!-- Precio costo -->
            <td class="text-end">
                <div class="d-flex flex-column">
                    <span>$${precioCosto.toLocaleString('es-AR', {minimumFractionDigits: 2})}</span>
                    ${margen > 0 ? `<small class="text-success">+${margen.toFixed(1)}%</small>` : ''}
                </div>
            </td>
            
            <!-- Precio venta -->
            <td class="text-end">
                <strong class="text-success">
                    $${precioVenta.toLocaleString('es-AR', {minimumFractionDigits: 2})}
                </strong>
            </td>
            
            <!-- Valor total -->
            <td class="text-end">
                <div class="d-flex flex-column">
                    <strong class="text-primary">
                        $${valorTotal.toLocaleString('es-AR', {minimumFractionDigits: 2})}
                    </strong>
                    <small class="text-muted">${cantidad} × $${precioVenta.toFixed(2)}</small>
                </div>
            </td>
            
            <!-- Acciones -->
            <td class="text-center">
                <div class="btn-group-vertical btn-group-sm" role="group">
                    <button type="button" 
                            class="btn btn-outline-primary btn-sm" 
                            onclick="verDetalleArticulo(${id}, ${depositoId})"
                            title="Ver detalle">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" 
                            class="btn btn-outline-warning btn-sm" 
                            onclick="ajustarStockArticulo(${id}, ${depositoId})"
                            title="Ajustar stock">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" 
                            class="btn btn-outline-info btn-sm" 
                            onclick="verHistorialArticulo(${id})"
                            title="Ver historial">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// =============================================
// 4. FUNCIÓN: determinarEstadoStockDetallado
// =============================================
function determinarEstadoStockDetallado(cantidad, stockMinimo) {
    if (cantidad === 0) {
        return {
            claseTexto: 'text-danger',
            badge: '<span class="badge bg-danger">Sin Stock</span>'
        };
    } else if (cantidad <= stockMinimo) {
        return {
            claseTexto: 'text-warning',
            badge: '<span class="badge bg-warning">Stock Bajo</span>'
        };
    } else if (cantidad <= stockMinimo * 1.5) {
        return {
            claseTexto: 'text-info',
            badge: '<span class="badge bg-info">Atención</span>'
        };
    } else {
        return {
            claseTexto: 'text-success',
            badge: '<span class="badge bg-success">OK</span>'
        };
    }
}

// =============================================
// 5. FUNCIÓN: agregarResumenStockDetallado
// =============================================
function agregarResumenStockDetallado(stockData, depositoId) {
    // Calcular estadísticas
    const totalArticulos = stockData.length;
    const totalUnidades = stockData.reduce((sum, item) => sum + parseFloat(item.cantidad || 0), 0);
    const valorTotalInventario = stockData.reduce((sum, item) => {
        const cantidad = parseFloat(item.cantidad || 0);
        const precio = parseFloat(item.precio_venta || 0);
        return sum + (cantidad * precio);
    }, 0);
    const articulosSinStock = stockData.filter(item => parseFloat(item.cantidad || 0) === 0).length;
    const articulosStockBajo = stockData.filter(item => {
        const cantidad = parseFloat(item.cantidad || 0);
        const minimo = parseFloat(item.stock_minimo || 0);
        return cantidad > 0 && cantidad <= minimo;
    }).length;
    
    // Agregar fila de resumen
    const tbody = document.getElementById('tabla-stock-deposito');
    tbody.innerHTML += `
        <tr class="table-dark">
            <td colspan="4" class="text-center">
                <strong><i class="fas fa-calculator me-2"></i>RESUMEN DEL DEPÓSITO</strong>
            </td>
            <td class="text-center">
                <strong>${totalUnidades}</strong><br>
                <small>unidades</small>
            </td>
            <td class="text-center">
                <span class="badge bg-warning">${articulosStockBajo}</span><br>
                <small>bajo stock</small>
            </td>
            <td class="text-center">
                <span class="badge bg-danger">${articulosSinStock}</span><br>
                <small>sin stock</small>
            </td>
            <td class="text-center">
                <strong>${totalArticulos}</strong><br>
                <small>artículos</small>
            </td>
            <td class="text-end">
                <strong class="text-success">
                    $${valorTotalInventario.toLocaleString('es-AR', {minimumFractionDigits: 2})}
                </strong><br>
                <small>valor total</small>
            </td>
            <td class="text-center">
                <button class="btn btn-success btn-sm" onclick="exportarStockDeposito(${depositoId})">
                    <i class="fas fa-download"></i>
                </button>
            </td>
        </tr>
    `;
}

// =============================================
// 6. FUNCIONES DE ACCIONES POR ARTÍCULO
// =============================================

// Ver detalle completo del artículo
function verDetalleArticulo(articuloId, depositoId) {
    console.log(`🔍 Viendo detalle del artículo ${articuloId} en depósito ${depositoId}`);
    showAlert(`Detalle del artículo ${articuloId} (función a implementar)`, 'info');
}

// Ajustar stock específico del artículo
function ajustarStockArticulo(articuloId, depositoId) {
    console.log(`⚙️ Ajustando stock del artículo ${articuloId} en depósito ${depositoId}`);
    
    // Si tienes una función de ajuste existente, usarla
    if (typeof abrirModalAjuste === 'function') {
        abrirModalAjuste(articuloId, depositoId);
    } else if (typeof abrirAjusteRapido === 'function') {
        abrirAjusteRapido(articuloId, depositoId);
    } else {
        showAlert(`Ajustar stock del artículo ${articuloId} (función a implementar)`, 'warning');
    }
}

// Ver historial del artículo
function verHistorialArticulo(articuloId) {
    console.log(`📈 Viendo historial del artículo ${articuloId}`);
    showAlert(`Historial del artículo ${articuloId} (función a implementar)`, 'info');
}

// Exportar stock del depósito
function exportarStockDeposito(depositoId) {
    console.log(`📊 Exportando stock del depósito ${depositoId}`);
    showAlert(`Exportar stock del depósito ${depositoId} (función a implementar)`, 'info');
}

async function verStockDeposito(depositoId) {
    try {
        console.log('📦 Iniciando verStockDeposito CORREGIDA para depósito:', depositoId);
        
        // ⭐ CAMBIO CRÍTICO: Obtener el modal PRIMERO
        const modalElement = document.getElementById('modalStockDeposito');
        if (!modalElement) {
            console.error('❌ Modal modalStockDeposito no encontrado');
            showAlert('Error: Modal de stock no encontrado', 'danger');
            return;
        }
        
        // ⭐ CAMBIO CRÍTICO: Buscar tbody DENTRO del modal específicamente
        const tbody = modalElement.querySelector('#tabla-stock-deposito');
        //                    ⬆️ ⬆️ ⬆️ 
        // EN LUGAR DE: document.getElementById('tabla-stock-deposito')
        // USAR: modalElement.querySelector('#tabla-stock-deposito')
        
        if (!tbody) {
            console.error('❌ Tbody no encontrado DENTRO del modal');
            showAlert('Error: Tabla de stock no encontrada en el modal', 'danger');
            return;
        }
        
        console.log('✅ Tbody correcto encontrado DENTRO del modal:', tbody);
        
        // 1. Actualizar título del modal
        const modalTitle = document.getElementById('modalStockTitle');
        if (modalTitle) {
            modalTitle.textContent = `Cargando stock del depósito ${depositoId}...`;
        }
        
        // 2. Mostrar indicador de carga
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Cargando stock del depósito...</span>
                </td>
            </tr>
        `;
        
        console.log('🔄 Loading asignado al tbody del modal');
        
        // 3. Hacer petición al backend
        console.log('🔡 Realizando petición al backend...');
        const response = await apiRequest(`/depositos/${depositoId}/stock`);
        
        console.log('📋 Respuesta del backend:', response);
        
        // 4. Verificar respuesta exitosa
        if (!response.success) {
            throw new Error(response.message || 'Error al obtener stock del depósito');
        }
        
        // 5. Extraer datos de stock
        const stockData = response.stock || response.data || [];
        const deposito = response.deposito;
        
        console.log('📊 Datos de stock recibidos:', stockData);
        
        // 6. Actualizar título con nombre del depósito
        if (modalTitle && deposito) {
            modalTitle.textContent = `Stock del Depósito: ${deposito.nombre}`;
        }
        
        // 7. Renderizar datos o mensaje vacío
        if (stockData.length > 0) {
            tbody.innerHTML = stockData.map(item => {
                console.log('🏷️ Procesando item:', item);
                
                // Extraer datos del item
                const cantidad = parseFloat(item.cantidad || 0);
                const stockMinimo = parseFloat(item.stock_minimo || 0);
                const precioVenta = parseFloat(item.precio_venta || item.precio_unitario || 0);
                const descripcion = item.descripcion || item.mercaderia || item.nombre_mercaderia || 'Sin descripción';
                const codigoSku = item.codigo_sku || item.sku || item.codigo || 'N/A';
                const marca = item.marca || null;
                
                // Calcular valor total
                const valorTotal = cantidad * precioVenta;
                
                // Determinar estado del stock
                const estadoStock = cantidad === 0 ? 
                    '<span class="badge bg-danger">Sin Stock</span>' : 
                    cantidad <= stockMinimo ? 
                        '<span class="badge bg-warning">Stock Bajo</span>' : 
                        '<span class="badge bg-success">OK</span>';
                
                // Determinar clase de color para cantidad
                const claseTexto = cantidad === 0 ? 'text-danger' : 
                                 cantidad <= stockMinimo ? 'text-warning' : 'text-success';
                
                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${descripcion}</strong>
                                ${marca ? `<br><small class="text-muted">${marca}</small>` : ''}
                            </div>
                        </td>
                        <td>
                            <code class="small">${codigoSku}</code>
                        </td>
                        <td class="text-center">
                            <strong class="${claseTexto}">
                                ${cantidad}
                            </strong>
                        </td>
                        <td class="text-center text-muted">
                            ${stockMinimo}
                        </td>
                        <td class="text-end">
                            $${precioVenta.toLocaleString('es-AR', {minimumFractionDigits: 2})}
                        </td>
                        <td class="text-end">
                            <strong>$${valorTotal.toLocaleString('es-AR', {minimumFractionDigits: 2})}</strong>
                        </td>
                        <td class="text-center">
                            ${estadoStock}
                        </td>
                    </tr>
                `;
            }).join(''); // ✅ .join('') convierte array en string
            
            console.log(`✅ Tabla poblada con ${stockData.length} items en el tbody del MODAL`);
            
        } else {
            // Mostrar mensaje cuando no hay stock
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        <i class="fas fa-box-open fa-2x mb-2 d-block"></i>
                        <span>No hay stock registrado en este depósito</span>
                    </td>
                </tr>
            `;
            console.log('ℹ️ No hay stock en el depósito - mensaje mostrado en el modal');
        }
        
        // 8. Abrir modal
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        console.log('✅ Modal abierto con datos cargados en la tabla CORRECTA');
        
        // 9. Mostrar información adicional si está disponible
        if (typeof mostrarInfoAdicionalStock === 'function') {
            mostrarInfoAdicionalStock(response, modalElement);
        }
        establecerDepositoActual(depositoId);
        if (response && response.deposito && response.deposito.nombre) {
            establecerDepositoActual(depositoId, response.deposito.nombre);
        }
        
    } catch (error) {
        console.error('❌ Error en verStockDeposito:', error);
        
        // Mostrar error en la tabla DEL MODAL
        const modalElement = document.getElementById('modalStockDeposito');
        if (modalElement) {
            const tbody = modalElement.querySelector('#tabla-stock-deposito');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2 d-block"></i>
                            <strong>Error cargando stock</strong><br>
                            <small>${error.message}</small>
                        </td>
                    </tr>
                `;
            }
            
            // Abrir modal para mostrar el error
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // Mostrar alerta global
        if (typeof showAlert === 'function') {
            showAlert(`Error al cargar stock del depósito: ${error.message}`, 'danger');
        }
    }
}

function establecerDepositoActual(id, nombre = null) {
    // Establecer ID del depósito
    depositoActualId = id;
    
    if (nombre) {
        // Si se proporciona nombre, usarlo
        nombreDepositoActual = nombre;
    } else {
        // Si no se proporciona nombre, intentar obtenerlo del modal
        inicializarVariablesDeposito();
    }
    
    console.log('✅ Depósito establecido:', { 
        depositoActualId, 
        nombreDepositoActual 
    });
}


function inicializarVariablesDeposito() {
    try {
        // Obtener nombre del título del modal
        const modalTitle = document.getElementById('modalStockTitle');
        if (modalTitle) {
            const tituloTexto = modalTitle.textContent || modalTitle.innerText || '';
            
            // Extraer nombre del depósito del título
            // Ejemplos:
            // "Stock Detallado: Depósito Central" → "Depósito Central"
            // "Stock del depósito 123" → "depósito 123"
            const match = tituloTexto.match(/Stock.*?:\s*(.+)/i);
            if (match) {
                nombreDepositoActual = match[1].trim();
            } else if (tituloTexto.includes('depósito')) {
                nombreDepositoActual = tituloTexto.replace(/.*stock.*?depósito\s*/i, '').trim() || 'Depósito';
            }
            
            // Intentar extraer ID si está en el título
            const idMatch = tituloTexto.match(/(\d+)/);
            if (idMatch && !depositoActualId) {
                depositoActualId = idMatch[1];
            }
        }
        
        // Valores por defecto si no se pudo obtener
        if (!nombreDepositoActual || nombreDepositoActual === '') {
            nombreDepositoActual = 'Depósito Sin Nombre';
        }
        
        if (!depositoActualId) {
            depositoActualId = 'X';
        }
        
        console.log('✅ Variables inicializadas desde modal:', {
            depositoActualId,
            nombreDepositoActual
        });
        
    } catch (error) {
        console.warn('⚠️ Error inicializando variables:', error);
        nombreDepositoActual = 'Depósito';
        depositoActualId = 'X';
    }
}







// =============================================
// FUNCIÓN AUXILIAR: EXTRAER DATOS DE LA TABLA
// =============================================
function extraerDatosTablaStock() {
    try {
        console.log('🔍 Extrayendo datos del modalStockDeposito (estructura real)...');
        
        // Buscar el modal específico
        const modal = document.getElementById('modalStockDeposito');
        if (!modal) {
            console.error('❌ Modal modalStockDeposito no encontrado');
            return [];
        }
        
        // Buscar el tbody dentro del modal
        const tbody = modal.querySelector('#tabla-stock-deposito');
        if (!tbody) {
            console.error('❌ Tbody #tabla-stock-deposito no encontrado');
            return [];
        }
        
        const filas = tbody.querySelectorAll('tr');
        const datos = [];
        
        console.log(`📊 Procesando ${filas.length} filas...`);
        
        filas.forEach((fila, index) => {
            const celdas = fila.querySelectorAll('td');
            
            // Verificar que la fila tenga 7 columnas
            if (celdas.length !== 7) {
                console.log(`⚠️ Fila ${index} omitida: ${celdas.length} columnas (esperaba 7)`);
                return;
            }
            
            // Verificar que no sea fila especial (loading, error, etc.)
            const textoFila = fila.textContent.toLowerCase();
            const esFilaEspecial = 
                textoFila.includes('cargando') || 
                textoFila.includes('error') || 
                textoFila.includes('no hay') ||
                textoFila.includes('resumen') ||
                fila.classList.contains('table-dark') ||
                fila.querySelector('.spinner-border');
            
            if (esFilaEspecial) {
                console.log(`⚠️ Fila ${index} omitida: fila especial`);
                return;
            }
            
            try {
                // ESTRUCTURA REAL SEGÚN EL HTML PROPORCIONADO:
                // 0: Mercadería (descripción en <strong>)
                // 1: SKU (código en <code>)
                // 2: Cantidad (número en <strong>)
                // 3: Stock Mínimo (número simple)
                // 4: Precio Unit. (precio con formato argentino)
                // 5: Valor Total (precio total en <strong>)
                // 6: Estado (badge con estado)
                
                // COLUMNA 0: Mercadería
                const strongMercaderia = celdas[0].querySelector('strong');
                const descripcion = strongMercaderia ? strongMercaderia.textContent.trim() : 
                                   celdas[0].textContent.trim();
                
                // COLUMNA 1: SKU
                const codeSKU = celdas[1].querySelector('code');
                const codigoSKU = codeSKU ? codeSKU.textContent.trim() : 
                                 celdas[1].textContent.trim();
                
                // COLUMNA 2: Cantidad
                const strongCantidad = celdas[2].querySelector('strong');
                const stockActual = strongCantidad ? 
                    extraerNumeroArgentino(strongCantidad.textContent) : 
                    extraerNumeroArgentino(celdas[2].textContent);
                
                // COLUMNA 3: Stock Mínimo
                const stockMinimo = extraerNumeroArgentino(celdas[3].textContent);
                
                // COLUMNA 4: Precio Unitario
                const precioUnitario = extraerPrecioArgentino(celdas[4].textContent);
                
                // COLUMNA 5: Valor Total
                const strongTotal = celdas[5].querySelector('strong');
                const valorTotal = strongTotal ? 
                    extraerPrecioArgentino(strongTotal.textContent) : 
                    extraerPrecioArgentino(celdas[5].textContent);
                
                // COLUMNA 6: Estado
                const badgeEstado = celdas[6].querySelector('.badge');
                const estado = badgeEstado ? badgeEstado.textContent.trim() : 
                              celdas[6].textContent.trim();
                
                // Crear objeto de datos
                const itemDatos = {
                    numero: index + 1,
                    descripcion: descripcion,
                    codigoSKU: codigoSKU,
                    codigoEAN: '', // No está en esta estructura
                    marca: '', // No está separada en esta estructura
                    categoria: '', // No está en esta estructura
                    stockActual: stockActual,
                    stockMinimo: stockMinimo,
                    precioCosto: 0, // No está disponible
                    precioVenta: precioUnitario, // Usamos precio unitario
                    valorTotal: valorTotal,
                    estadoStock: estado
                };
                
                datos.push(itemDatos);
                console.log(`✅ Procesado: ${descripcion.substring(0, 40)}...`);
                
            } catch (error) {
                console.warn(`⚠️ Error en fila ${index + 1}:`, error);
                console.log('Contenido fila:', fila.innerHTML.substring(0, 200));
            }
        });
        
        console.log(`🎉 Extracción completada: ${datos.length} registros válidos`);
        return datos;
        
    } catch (error) {
        console.error('❌ Error general extrayendo datos:', error);
        return [];
    }
}

// =============================================
// FUNCIONES AUXILIARES PARA FORMATO ARGENTINO
// =============================================

// Extraer número con formato argentino (puntos como separadores de miles)
function extraerNumeroArgentino(texto) {
    if (!texto) return 0;
    
    try {
        // Remover todo excepto números, comas y puntos
        let numeroLimpio = texto.toString().trim();
        
        // Remover símbolos de moneda y espacios
        numeroLimpio = numeroLimpio.replace(/[\$\s]/g, '');
        
        // En formato argentino: 1.234,56 
        // Puntos son separadores de miles, coma es decimal
        if (numeroLimpio.includes(',')) {
            // Hay decimales
            const partes = numeroLimpio.split(',');
            const entero = partes[0].replace(/\./g, ''); // Remover puntos de miles
            const decimal = partes[1] || '0';
            numeroLimpio = entero + '.' + decimal; // Formato estándar
        } else {
            // Solo entero, remover puntos de miles
            numeroLimpio = numeroLimpio.replace(/\./g, '');
        }
        
        const numero = parseFloat(numeroLimpio);
        return isNaN(numero) ? 0 : numero;
        
    } catch (error) {
        console.warn('Error parseando número:', texto, error);
        return 0;
    }
}

// Extraer precio con formato argentino
function extraerPrecioArgentino(texto) {
    return extraerNumeroArgentino(texto);
}

// Determinar estado del stock
function determinarEstadoStock(stockActual, stockMinimo) {
    if (stockActual === 0) return 'Sin Stock';
    if (stockActual <= stockMinimo) return 'Stock Bajo';
    return 'Normal';
}

// =============================================
// FUNCIONES DE EXPORTACIÓN ACTUALIZADAS
// =============================================

// Actualizar función de exportar Excel para la estructura real
function exportarStockExcel() {
    try {
        console.log('📊 Iniciando exportación a Excel...');
        
        const datosTabla = extraerDatosTablaStock();
        if (!datosTabla || datosTabla.length === 0) {
            showAlert('No hay datos para exportar', 'warning');
            return;
        }
        
        // Preparar datos para Excel con la estructura real
        const datosExcel = datosTabla.map((fila, index) => ({
            'N°': index + 1,
            'Descripción': fila.descripcion || '',
            'Código SKU': fila.codigoSKU || '',
            'Stock Actual': fila.stockActual || 0,
            'Stock Mínimo': fila.stockMinimo || 0,
            'Precio Unitario': fila.precioVenta || 0,
            'Valor Total Stock': fila.valorTotal || 0,
            'Estado': fila.estadoStock || 'N/A'
        }));
        
        // Agregar información del depósito
        const infoDeposito = [
            { 'N°': 'REPORTE DE STOCK POR DEPÓSITO' },
            { 'N°': `Depósito: ${nombreDepositoActual || 'Depósito'}` },
            { 'N°': `Fecha: ${new Date().toLocaleDateString('es-AR')}` },
            { 'N°': `Hora: ${new Date().toLocaleTimeString('es-AR')}` },
            { 'N°': `Total artículos: ${datosTabla.length}` },
            { 'N°': '' }
        ];
        
        const datosCompletos = [...infoDeposito, ...datosExcel];
        
        // Crear libro de trabajo
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(datosCompletos);
        
        // Configurar ancho de columnas
        const columnWidths = [
            { wch: 5 },   // N°
            { wch: 50 },  // Descripción
            { wch: 20 },  // Código SKU
            { wch: 12 },  // Stock Actual
            { wch: 12 },  // Stock Mínimo
            { wch: 15 },  // Precio Unitario
            { wch: 18 },  // Valor Total
            { wch: 12 }   // Estado
        ];
        ws['!cols'] = columnWidths;
        
        XLSX.utils.book_append_sheet(wb, ws, "Stock Depósito");
        
        const fecha = new Date().toISOString().split('T')[0];
        const filename = `stock_deposito_${depositoActualId || 'X'}_${fecha}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        showAlert('✅ Excel exportado exitosamente', 'success');
        
    } catch (error) {
        console.error('❌ Error exportando Excel:', error);
        showAlert('Error al exportar Excel: ' + error.message, 'danger');
    }
}

// Actualizar función de exportar PDF para la estructura real
function exportarStockPDF() {
    try {
        console.log('📄 Iniciando exportación a PDF...');
        
        if (typeof window.jspdf === 'undefined') {
            showAlert('Error: Librería PDF no disponible', 'danger');
            return;
        }
        
        const datosTabla = extraerDatosTablaStock();
        if (!datosTabla || datosTabla.length === 0) {
            showAlert('No hay datos para exportar', 'warning');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });
        
        const margenIzq = 10;
        let yPos = 20;
        
        // TÍTULO
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('REPORTE DE STOCK POR DEPÓSITO', margenIzq, yPos);
        yPos += 8;
        
        // INFORMACIÓN
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text(`Depósito: ${nombreDepositoActual || 'Depósito'}`, margenIzq, yPos);
        yPos += 6;
        doc.text(`Fecha: ${new Date().toLocaleDateString('es-AR')} - ${new Date().toLocaleTimeString('es-AR')}`, margenIzq, yPos);
        yPos += 6;
        doc.text(`Total de artículos: ${datosTabla.length}`, margenIzq, yPos);
        yPos += 10;
        
        // HEADERS DE LA TABLA
        const headers = ['#', 'Descripción', 'SKU', 'Stock', 'Mín.', 'Precio Unit.', 'Valor Total', 'Estado'];
        const columnWidths = [10, 80, 25, 15, 15, 25, 30, 20];
        
        // Headers
        let xPos = margenIzq;
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        
        headers.forEach((header, index) => {
            doc.text(header, xPos, yPos);
            xPos += columnWidths[index];
        });
        yPos += 8;
        
        // Línea separadora
        doc.setDrawColor(0, 0, 0);
        doc.line(margenIzq, yPos - 2, margenIzq + columnWidths.reduce((a, b) => a + b, 0), yPos - 2);
        
        // DATOS
        doc.setFont(undefined, 'normal');
        doc.setFontSize(8);
        
        datosTabla.forEach((fila, index) => {
            if (yPos > 180) {
                doc.addPage();
                yPos = 20;
            }
            
            xPos = margenIzq;
            const valores = [
                (index + 1).toString(),
                (fila.descripcion || '').substring(0, 40),
                (fila.codigoSKU || '').substring(0, 15),
                (fila.stockActual || 0).toString(),
                (fila.stockMinimo || 0).toString(),
                `$${(fila.precioVenta || 0).toLocaleString('es-AR')}`,
                `$${(fila.valorTotal || 0).toLocaleString('es-AR')}`,
                fila.estadoStock || 'N/A'
            ];
            
            valores.forEach((valor, colIndex) => {
                doc.text(valor, xPos, yPos);
                xPos += columnWidths[colIndex];
            });
            
            yPos += 6;
        });
        
        // RESUMEN
        const valorTotalStock = datosTabla.reduce((sum, item) => sum + (item.valorTotal || 0), 0);
        
        yPos += 10;
        doc.setFont(undefined, 'bold');
        doc.text(`RESUMEN: ${datosTabla.length} artículos - Valor total: $${valorTotalStock.toLocaleString('es-AR')}`, margenIzq, yPos);
        
        const fecha = new Date().toISOString().split('T')[0];
        const filename = `stock_deposito_${depositoActualId || 'X'}_${fecha}.pdf`;
        doc.save(filename);
        
        showAlert('✅ PDF exportado exitosamente', 'success');
        
    } catch (error) {
        console.error('❌ Error exportando PDF:', error);
        showAlert('Error al exportar PDF: ' + error.message, 'danger');
    }
}

// Función de prueba para debugging
function debugExtraerDatos() {
    console.log('🔧 Probando extracción de datos...');
    const datos = extraerDatosTablaStock();
    console.table(datos);
    return datos;
}

console.log('✅ Funciones corregidas para estructura real del modalStockDeposito');
console.log('🧪 Usar debugExtraerDatos() para probar');



// =============================================
// INICIALIZACIÓN QZ TRAY
// =============================================
async function inicializarQZTray() {
    try {
        console.log('🔗 Inicializando QZ Tray...');
        
        // Verificar si QZ está disponible
        if (typeof qz === 'undefined') {
            console.warn('❌ QZ Tray no está disponible. Asegúrate de:');
            console.warn('1. Tener QZ Tray instalado y ejecutándose');
            console.warn('2. Incluir el script qz-tray.js');
            return false;
        }

        // Establecer configuración de seguridad
        qz.security.setCertificatePromise(function(resolve) {
            // Certificado de ejemplo - en producción usar certificado real
            resolve("-----BEGIN CERTIFICATE-----\n" +
                "MIIEDzCCAvegAwIBAgIJALm151zs7zQZMA0GCSqGSIb3DQEBCwUAMIGZMQswCQYD\n" +
                // ... resto del certificado
                "-----END CERTIFICATE-----");
        });

        // Configurar firma
        qz.security.setSignaturePromise(function(toSign) {
            return function(resolve) {
                // Firma de ejemplo - en producción usar clave privada real
                resolve("sample-signature");
            };
        });

        // Conectar a QZ Tray
        await qz.websocket.connect();
        qzTrayReady = true;
        
        // Cargar lista de impresoras
        await cargarImpresorasQZ();
        
        console.log('✅ QZ Tray conectado exitosamente');
        actualizarUIQZTray(true);
        
        return true;
        
    } catch (error) {
        console.error('💥 Error conectando a QZ Tray:', error);
        qzTrayReady = false;
        actualizarUIQZTray(false);
        return false;
    }
}

// =============================================
// CARGAR IMPRESORAS DISPONIBLES
// =============================================
async function cargarImpresorasQZ() {
    try {
        if (!qzTrayReady) return [];
        
        impresoresQZ = await qz.printers.find();
        console.log(`🖨️ Encontradas ${impresoresQZ.length} impresoras:`, impresoresQZ);
        
        // Actualizar select de impresoras en el modal
        actualizarSelectImpresoras();
        
        return impresoresQZ;
        
    } catch (error) {
        console.error('❌ Error cargando impresoras QZ:', error);
        return [];
    }
}

// =============================================
// ACTUALIZAR UI SEGÚN ESTADO QZ TRAY
// =============================================
function actualizarUIQZTray(conectado) {
    const estadoQZ = document.getElementById('estado-qz-tray');
    const btnConectar = document.getElementById('btn-conectar-qz');
    const tipoImpresora = document.getElementById('tipo-impresora');
    
    if (estadoQZ) {
        estadoQZ.innerHTML = conectado 
            ? '<i class="fas fa-check-circle text-success"></i> QZ Tray Conectado'
            : '<i class="fas fa-times-circle text-danger"></i> QZ Tray No Disponible';
    }
    
    if (btnConectar) {
        btnConectar.style.display = conectado ? 'none' : 'inline-block';
    }
    
    // Agregar opción QZ Tray al select
    if (tipoImpresora && conectado) {
        const optionQZ = tipoImpresora.querySelector('option[value="qz-tray"]');
        if (!optionQZ) {
            const option = document.createElement('option');
            option.value = 'qz-tray';
            option.textContent = 'QZ Tray (Impresoras Locales)';
            tipoImpresora.appendChild(option);
        }
    }
}

// =============================================
// ACTUALIZAR SELECT DE IMPRESORAS
// =============================================
function actualizarSelectImpresoras() {
    const selectImpresora = document.getElementById('impresora-qz-select');
    if (!selectImpresora) return;
    
    selectImpresora.innerHTML = '<option value="">Seleccione impresora...</option>';
    
    impresoresQZ.forEach(impresora => {
        const option = document.createElement('option');
        option.value = impresora;
        option.textContent = impresora;
        selectImpresora.appendChild(option);
    });
}

// =============================================
// EVENTO CAMBIO DE TIPO DE IMPRESORA
// =============================================
function onTipoImpresoraChange() {
    const tipoImpresora = document.getElementById('tipo-impresora');
    const configRed = document.getElementById('config-red');
    const configQZ = document.getElementById('config-qz-tray');
    
    if (!tipoImpresora) return;
    
    // Ocultar todas las configuraciones
    if (configRed) configRed.style.display = 'none';
    if (configQZ) configQZ.style.display = 'none';
    
    // Mostrar configuración según selección
    if (tipoImpresora.value === 'red') {
        if (configRed) configRed.style.display = 'block';
    } else if (tipoImpresora.value === 'qz-tray') {
        if (configQZ) configQZ.style.display = 'block';
        if (!qzTrayReady) {
            inicializarQZTray();
        }
    }
}

// =============================================
// IMPRIMIR CON QZ TRAY
// =============================================
async function imprimirConQZTray() {
    try {
        if (!qzTrayReady) {
            showAlert('QZ Tray no está conectado. Verifique la instalación.', 'warning');
            return;
        }
        
        const impresoraSeleccionada = document.getElementById('impresora-qz-select').value;
        if (!impresoraSeleccionada) {
            showAlert('Debe seleccionar una impresora', 'warning');
            return;
        }
        
        // Obtener opciones de impresión
        const opciones = obtenerOpcionesImpresion();
        
        // Mostrar indicador de carga
        const btnImprimir = document.getElementById('btn-imprimir-qz');
        const textoOriginal = btnImprimir.innerHTML;
        btnImprimir.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Imprimiendo...';
        btnImprimir.disabled = true;
        
        // Solicitar comandos al backend
        const response = await fetch('/api/v1/etiquetas/comandos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mercaderias: mercaderiasParaImprimir.map(m => m.id),
                opciones: opciones
            })
        });
        
        if (!response.ok) {
            throw new Error('Error obteniendo comandos de impresión');
        }
        
        const resultado = await response.json();
        
        if (!resultado.success) {
            throw new Error(resultado.message || 'Error generando comandos');
        }
        
        // Configurar QZ para impresión
        const config = qz.configs.create(impresoraSeleccionada);
        
        // Enviar comandos a la impresora
        await qz.print(config, resultado.data.comandos);
        
        // Mostrar éxito
        showAlert(`Etiquetas enviadas exitosamente a ${impresoraSeleccionada}`, 'success');
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalEtiquetas'));
        if (modal) modal.hide();
        
    } catch (error) {
        console.error('💥 Error imprimiendo con QZ Tray:', error);
        showAlert(`Error imprimiendo: ${error.message}`, 'danger');
    } finally {
        // Restaurar botón
        const btnImprimir = document.getElementById('btn-imprimir-qz');
        if (btnImprimir) {
            btnImprimir.innerHTML = '<i class="fas fa-print me-2"></i>Imprimir con QZ Tray';
            btnImprimir.disabled = false;
        }
    }
}

// =============================================
// FUNCIONES DE EVENTOS
// =============================================

// Conectar eventos cuando se carga el documento
document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listener para cambio de tipo de impresora
    const tipoImpresora = document.getElementById('tipo-impresora');
    if (tipoImpresora) {
        tipoImpresora.addEventListener('change', onTipoImpresoraChange);
    }
    
    // Intentar conectar QZ Tray automáticamente
    setTimeout(() => {
        inicializarQZTray();
    }, 1000);
});

// =============================================
// FUNCIONES DE UTILIDAD
// =============================================

// Verificar estado de QZ Tray
async function verificarEstadoQZTray() {
    try {
        if (!qzTrayReady) {
            await inicializarQZTray();
        } else {
            await cargarImpresorasQZ();
            showAlert('QZ Tray verificado correctamente', 'success');
        }
    } catch (error) {
        showAlert('Error verificando QZ Tray: ' + error.message, 'danger');
    }
}

// Desconectar QZ Tray
async function desconectarQZTray() {
    try {
        if (qzTrayReady && typeof qz !== 'undefined') {
            await qz.websocket.disconnect();
        }
        qzTrayReady = false;
        impresoresQZ = [];
        actualizarUIQZTray(false);
        console.log('🔌 QZ Tray desconectado');
    } catch (error) {
        console.error('Error desconectando QZ Tray:', error);
    }
}

// Limpiar al cerrar la página
window.addEventListener('beforeunload', function() {
    desconectarQZTray();
});

console.log('✅ QZ Tray integration cargado correctamente');

function onTipoImpresoraChange() {
    const tipoImpresora = document.getElementById('tipo-impresora');
    const configRed = document.getElementById('config-red');
    const configQZ = document.getElementById('config-qz-tray');
    const infoQZ = document.getElementById('info-qz-tray');
    const btnImprimirRed = document.getElementById('btn-imprimir-red');
    const btnImprimirQZ = document.getElementById('btn-imprimir-qz');
    
    if (!tipoImpresora) return;
    
    // Ocultar todas las configuraciones
    if (configRed) configRed.style.display = 'none';
    if (configQZ) configQZ.style.display = 'none';
    if (infoQZ) infoQZ.style.display = 'none';
    if (btnImprimirRed) btnImprimirRed.style.display = 'none';
    if (btnImprimirQZ) btnImprimirQZ.style.display = 'none';
    
    // Mostrar configuración y botón según selección
    if (tipoImpresora.value === 'red') {
        if (configRed) configRed.style.display = 'block';
        if (btnImprimirRed) btnImprimirRed.style.display = 'inline-block';
    } else if (tipoImpresora.value === 'qz-tray') {
        if (configQZ) configQZ.style.display = 'block';
        if (infoQZ) infoQZ.style.display = 'block';
        if (btnImprimirQZ) btnImprimirQZ.style.display = 'inline-block';
        
        // Inicializar QZ Tray si no está listo
        if (!qzTrayReady) {
            inicializarQZTray();
        }
    }
}

// Inicializar eventos cuando el modal se abre
document.addEventListener('DOMContentLoaded', function() {
    const modalEtiquetas = document.getElementById('modalEtiquetas');
    if (modalEtiquetas) {
        modalEtiquetas.addEventListener('shown.bs.modal', function() {
            // Configurar estado inicial
            onTipoImpresoraChange();
        });
    }
});

// Eventos específicos del modal
document.addEventListener('DOMContentLoaded', function() {
    const modalEtiquetas = document.getElementById('modalImprimirEtiquetas');
    if (modalEtiquetas) {
        modalEtiquetas.addEventListener('shown.bs.modal', function() {
            console.log('🏷️ Modal de etiquetas abierto - configurando estado inicial');
            
            // Configurar estado inicial del tipo de impresora
            setTimeout(() => {
                onTipoImpresoraChange();
            }, 500);
        });

        modalEtiquetas.addEventListener('hidden.bs.modal', function() {
            console.log('🏷️ Modal de etiquetas cerrado');
        });
    }
});

// Función auxiliar para mostrar/ocultar información de red
function toggleInfoRed() {
    const tipoImpresora = document.getElementById('tipo-impresora');
    const infoRed = document.getElementById('info-red');
    const infoQZ = document.getElementById('info-qz-tray');
    
    if (tipoImpresora && infoRed && infoQZ) {
        if (tipoImpresora.value === 'red') {
            infoRed.style.display = 'block';
            infoQZ.style.display = 'none';
        } else if (tipoImpresora.value === 'qz-tray') {
            infoRed.style.display = 'none';
            infoQZ.style.display = 'block';
        }
    }
}

// Mejorar la función onTipoImpresoraChange para incluir el toggle de información
const originalOnTipoImpresoraChange = onTipoImpresoraChange;
onTipoImpresoraChange = function() {
    if (originalOnTipoImpresoraChange) {
        originalOnTipoImpresoraChange();
    }
    toggleInfoRed();
};

    </script>
</body>
</html>